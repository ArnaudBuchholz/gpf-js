
(function(root,factory){"use strict";if(typeof define==="function"&&define.amd){define(["exports"],factory);}else if(typeof exports!=="undefined"){factory(exports);}else if(typeof module!=="undefined"&&module.exports){factory(module.exports);}else{factory(root.gpf={});}}(this,function(gpf){"use strict";var _gpfVersion="0.1",_gpfHost,_gpfDosPath=false,_gpfContext,_gpfExit,_gpfResolveScope=function(scope){if(null===scope||"object"!==typeof scope){return _gpfContext;}return scope;},_gpfInNode=false,_gpfInBrowser=false,_gpfWebWindow,_gpfWebDocument,_gpfWebHead,_gpfMsFSO,_gpfNodeFS,_gpfEmptyFunc=function(){};if("undefined"!==typeof WScript){_gpfHost="wscript";_gpfDosPath=true;_gpfContext=function(){return this;}.apply(null,[]);_gpfExit=function(code){WScript.Quit(code);};_gpfContext.console={log:function(t){WScript.Echo("    "+t);},info:function(t){WScript.Echo("[?] "+t);},warn:function(t){WScript.Echo("/!\\ "+t);},error:function(t){WScript.Echo("(X) "+t);}};}else if("undefined"!==typeof phantom&&phantom.version){_gpfHost="phantomjs";_gpfDosPath=require("fs").separator==="\\";_gpfContext=window;_gpfInNode=true;_gpfInBrowser=true;_gpfExit=phantom.exit;}else if("undefined"!==typeof module&&module.exports){_gpfHost="nodejs";_gpfDosPath=require("path").sep==="\\";_gpfContext=global;_gpfInNode=true;_gpfExit=process.exit;}else if("undefined"!==typeof window){_gpfHost="browser";_gpfContext=window;_gpfInBrowser=true;_gpfExit=_gpfEmptyFunc;}else{_gpfHost="unknown";_gpfContext=this;_gpfExit=_gpfEmptyFunc;}if(_gpfInNode){gpf.node={};}gpf.web={};if(_gpfInBrowser){_gpfWebWindow=window;_gpfWebDocument=document;_gpfWebHead=_gpfWebDocument.getElementsByTagName("head")[0]||_gpfWebDocument.documentElement;}gpf.version=function(){return _gpfVersion;};gpf.host=function(){return _gpfHost;};function _getOrCreateChild(parent,name,createMissingParts){var result=parent[name];if(undefined===result&&createMissingParts){result=parent[name]={};}return result;}gpf.context=function(path,createMissingParts){var len,idx,result;if(undefined===path){return _gpfContext;}else{if("string"===typeof path){path=path.split(".");}len=path.length;idx=0;if(path[0]==="gpf"){result=gpf;++idx;}else{result=_gpfContext;}for(;result&&idx<len;++idx){result=_getOrCreateChild(result,path[idx],true===createMissingParts);}return result;}};gpf.loaded=function(callback){if(callback){callback();}return true;};gpf.ASSERT=function(){};var _gpfArraySlice=Array.prototype.slice;if(undefined===Array.prototype.every){Array.prototype.every=function(callback,thisArg){var len=this.length,idx;for(idx=0;idx<len;++idx){if(!callback.apply(thisArg,[this[idx],idx,this])){return false;}}return true;};}if(undefined===Array.prototype.forEach){Array.prototype.forEach=function(callback,thisArg){var len=this.length,idx;for(idx=0;idx<len;++idx){callback.apply(thisArg,[this[idx],idx,this]);}};}if(undefined===Array.prototype.indexOf){Array.prototype.indexOf=function(searchElement,fromIndex){var idx,len=this.length;if(undefined!==fromIndex){idx=fromIndex;}else{idx=0;}while(idx<len){if(this[idx]===searchElement){return idx;}++idx;}return-1;};}if(undefined===Array.prototype.map){Array.prototype.map=function(callback,thisArg){var len=this.length,result=new Array(len),idx;for(idx=0;idx<len;++idx){result[idx]=callback.apply(thisArg,[this[idx],idx,this]);}return result;};}if(undefined===Function.prototype.bind){Function.prototype.bind=function(thisArg){var thisFn=this,prependArgs=_gpfArraySlice.apply(arguments,[1]);return function(){var args=_gpfArraySlice.apply(arguments,[0]);thisFn.apply(thisArg,prependArgs.concat(args));};};}if(function(){function functionName(){}if(functionName.name!=="functionName"){return true;}else{return false;}}()){(function(){var comments=new RegExp("//.*$|/\\*.*\\*/","g");Function.prototype.compatibleName=function(){var src=""+this,pos=src.indexOf("function"),paramList=src.indexOf("(",pos);return src.substr(pos+9,paramList-pos-9).replace(comments,"").trim();};}());}else{Function.prototype.compatibleName=function(){return this.name;};}if(undefined===Object.defineProperty){gpf.setReadOnlyProperty=function(obj,name,value){obj[name]=value;return obj;};}else{gpf.setReadOnlyProperty=function(obj,name,value){Object.defineProperty(obj,name,{enumerable:true,configurable:false,writable:false,value:value});return obj;};}if(undefined===String.prototype.trim){(function(){var rtrim=new RegExp("^[\\s\uFEFF\xA0]+|[\\s\uFEFF\xA0]+$","g");String.prototype.trim=function(){return this.replace(rtrim,"");};}());}var _GPF_EVENT_ERROR="error",_GPF_EVENT_READY="ready",_GPF_EVENT_DATA="data",_GPF_EVENT_END_OF_DATA="endOfData",_GPF_EVENT_CONTINUE="continue",_GPF_EVENT_STOP="stop",_GPF_EVENT_STOPPED="stopped",_gpfSetReadOnlyProperty=gpf.setReadOnlyProperty,_GpfFunc=Function,_gpfIgnore=_gpfEmptyFunc,_gpfFalseFunc=function(){return false;},_gpfFunc=function(params,source){var args;if(undefined===source){source=params;params=[];}gpf.ASSERT("string"===typeof source&&source.length,"Source expected (or use _gpfEmptyFunc)");if(0===params.length){return _GpfFunc(source);}else{args=[].concat(params);args.push(source);return _GpfFunc.apply(null,args);}},_gpfAlpha="abcdefghijklmnopqrstuvwxyz",_gpfALPHA="ABCDEFGHIJKLMNOPQRSTUVWXYZ",_gpfDigit="0123456789",_gpfIdentifierFirstChar=_gpfAlpha+_gpfALPHA+"_$",_gpfIdentifierOtherChars=_gpfAlpha+_gpfALPHA+_gpfDigit+"_$",_gpfJsKeywords=("break,case,catch,continue,debugger,default,delete,do,"+"else,finally,for,function,if,in,instanceof,new,return,switch,"+"this,throw,try,typeof,var,void,while,with").split(",");gpf.events={};(function(){var gpfEvents=gpf.events,mappings={EVENT_ERROR:_GPF_EVENT_ERROR,EVENT_READY:_GPF_EVENT_READY,EVENT_DATA:_GPF_EVENT_DATA,EVENT_END_OF_DATA:_GPF_EVENT_END_OF_DATA,EVENT_CONTINUE:_GPF_EVENT_CONTINUE,EVENT_STOP:_GPF_EVENT_STOP,EVENT_STOPPED:_GPF_EVENT_STOPPED},key;for(key in mappings){if(mappings.hasOwnProperty(key)){_gpfSetReadOnlyProperty(gpfEvents,key,mappings[key]);}}}());var _GpfEvent=gpf.events.Event=function(type,params,scope){gpf.setReadOnlyProperty(this,"type",type);gpf.setReadOnlyProperty(this,"scope",_gpfResolveScope(scope));if(undefined!==params){this._params=params;}},_gpfEventsFiring=0,_gpfEventsFireCall=function(event,eventsHandler){var scope=event.scope,eventHandler;gpf.ASSERT(eventsHandler,"Expected eventsHandler");if("function"===typeof eventsHandler._dispatchEvent){eventsHandler._dispatchEvent(event);}else if("function"===typeof eventsHandler.apply){eventsHandler.apply(scope,[event]);}else{eventHandler=eventsHandler[event.type];if(undefined===eventHandler){eventHandler=eventsHandler["*"];}if(undefined!==eventHandler){eventHandler.apply(eventsHandler.scope||eventsHandler,[event]);}}},_gpfEventsFire=function(event,params,eventsHandler){var scope=_gpfResolveScope(this);if(!(event instanceof _GpfEvent)){event=new gpf.events.Event(event,params,scope);}if(++_gpfEventsFiring>10){gpf.defer(_gpfEventsFireCall,0,null,[event,eventsHandler]);}else{_gpfEventsFireCall(event,eventsHandler);}--_gpfEventsFiring;return event;},_gpfLookForEventsHandler=function(thatArgs,defaultArgs,callback){var lastExpectedIdx=defaultArgs.length,argIdx=thatArgs.length-1;if(argIdx!==lastExpectedIdx){thatArgs=_gpfArraySlice.apply(thatArgs,[0]);thatArgs[lastExpectedIdx]=thatArgs[argIdx];--argIdx;--lastExpectedIdx;while(lastExpectedIdx>argIdx){thatArgs[lastExpectedIdx]=defaultArgs[lastExpectedIdx];--lastExpectedIdx;}}return callback.apply(this,thatArgs);};_GpfEvent.prototype={constructor:_GpfEvent,type:"",scope:null,_params:{},get:function(name){return this._params[name];},fire:function(eventsHandler){return gpf.events.fire(this,eventsHandler);}};gpf.events.fire=function(){var scope=this;if(scope===gpf.events){scope=undefined;}return _gpfLookForEventsHandler.apply(scope,[arguments,[0,{}],_gpfEventsFire]);};var _GpfIncludeContext=function(src,eventsHandler){this.id=++_GpfIncludeContext.id;this.src=src;this.eventsHandler=eventsHandler;_GpfIncludeContext.map[this.id]=this;},_gpfWebIncludeInsert=function(domScript){_gpfWebHead.insertBefore(domScript,_gpfWebHead.firstChild);},_gpfWebIncludeAsyncResult=function(parameters){_gpfEventsFire.apply(_gpfContext,parameters);},_gpfWebInclude=function(src,eventsHandler){var context=new _GpfIncludeContext(src,eventsHandler),domScript=_gpfWebDocument.createElement("script");domScript.language="javascript";domScript.src=src;domScript.id=context.id;domScript.onload=domScript.onreadystatechange=_GpfIncludeContext.onLoad;domScript.onerror=_GpfIncludeContext.onError;if(undefined!==domScript.async){domScript.async=true;}setTimeout(_gpfWebIncludeInsert,0,domScript);};_GpfIncludeContext.prototype={id:0,src:"",eventsHandler:null,clean:function(domScript){var parent=domScript.parentNode;domScript.onerror=domScript.onload=domScript.onreadystatechange=null;if(parent){parent.removeChild(domScript);}delete _GpfIncludeContext.map[this.id];},check:function(domScript){var readyState=domScript.readyState;if(!readyState||-1<["loaded","complete"].indexOf(readyState)){this.clean(domScript);setTimeout(_gpfWebIncludeAsyncResult,0,[_GPF_EVENT_READY,{url:this.src},this.eventsHandler]);}},failed:function(domScript){this.clean(domScript);setTimeout(_gpfWebIncludeAsyncResult,0,[_GPF_EVENT_ERROR,{url:this.src},this.eventsHandler]);}};_GpfIncludeContext.id=0;_GpfIncludeContext.map={};_GpfIncludeContext.onLoad=function(){var context=_GpfIncludeContext.map[this.id];if(context){context.check(this);}};_GpfIncludeContext.onError=function(){var context=_GpfIncludeContext.map[this.id];if(context){context.failed(this);}};if(_gpfInBrowser){gpf.web.include=_gpfWebInclude;}var _gpfArrayEachWithResult=function(array,memberCallback,defaultResult){var result,len=array.length,idx;for(idx=0;idx<len;++idx){result=memberCallback.apply(this,[idx,array[idx],len]);if(undefined!==result){return result;}}return defaultResult;},_gpfArrayEach=function(array,memberCallback){var len=array.length,idx;for(idx=0;idx<len;++idx){memberCallback.apply(this,[idx,array[idx],len]);}},_gpfArrayOrItem=function(array,idx){if(undefined===idx){return Array.prototype.slice.call(array,0);}else if(0===array.length){return undefined;}else if(-1===idx){return array[array.length-1];}else if(idx<-1||idx>array.length-1){return undefined;}else{return array[idx];}},_gpfDictionaryEachWithResult=function(dictionary,memberCallback,defaultResult){var result,member;for(member in dictionary){if(dictionary.hasOwnProperty(member)){result=memberCallback.apply(this,[member,dictionary[member]]);if(undefined!==result){return result;}}}return defaultResult;},_gpfDictionaryEach=function(dictionary,memberCallback){var member;for(member in dictionary){if(dictionary.hasOwnProperty(member)){memberCallback.apply(this,[member,dictionary[member]]);}}},_gpfAssign=function(member,value){this[0][member]=value;},_gpfAssignOrCall=function(member,value){var dictionary=this[0],overwriteCallback=this[2];if(undefined!==dictionary[member]){overwriteCallback(dictionary,member,value);}else{dictionary[member]=value;}},_gpfValues={boolean:function(value,valueType,defaultValue){if("string"===valueType){if("yes"===value||"true"===value){return true;}return 0!==parseInt(value,10);}if("number"===valueType){return 0!==value;}return defaultValue;},number:function(value,valueType,defaultValue){if("string"===valueType){return parseFloat(value);}return defaultValue;},string:function(value,valueType,defaultValue){gpf.interfaces.ignoreParameter(valueType);gpf.interfaces.ignoreParameter(defaultValue);if(value instanceof Date){return gpf.dateToComparableFormat(value);}return value.toString();},object:function(value,valueType,defaultValue){if(defaultValue instanceof Date&&"string"===valueType){return gpf.dateFromComparableFormat(value);}return defaultValue;}},_gpfStringCapitalize=function(that){return that.charAt(0).toUpperCase()+that.substr(1);},_gpfStringReplaceEx=function(that,replacements){var result=that,key;for(key in replacements){if(replacements.hasOwnProperty(key)){if(-1<result.indexOf(key)){result=result.split(key).join(replacements[key]);}}}return result;},_gpfStringEscapes={javascript:{"\\":"\\\\","\"":"\\\"","\n":"\\n","\r":"\\r","\t":"\\t"},xml:{"&":"&amp;","<":"&lt;",">":"&gt;"},html:{"&":"&amp;","<":"&lt;",">":"&gt;","\xE9":"&eacute;","\xE8":"&egrave;","\xEA":"&ecirc;","\xE1":"&aacute;","\xE0":"&agrave;"}},_gpfStringEscapeFor=function(that,language){var replacements=_gpfStringEscapes[language];if(undefined!==replacements){that=_gpfStringReplaceEx(that,replacements);if("javascript"===language){that="\""+that+"\"";}}return that;},_gpfIsArrayLike;if("browser"===_gpfHost&&(window.HTMLCollection||window.NodeList)){_gpfIsArrayLike=function(obj){return obj instanceof Array||obj instanceof window.HTMLCollection||obj instanceof window.NodeList;};}else{_gpfIsArrayLike=function(obj){return obj instanceof Array;};}gpf.isArrayLike=_gpfIsArrayLike;gpf.each=function(dictionary,memberCallback,defaultResult){if(3>arguments.length){if(gpf.isArrayLike(dictionary)){_gpfArrayEach.apply(this,arguments);}else{_gpfDictionaryEach.apply(this,arguments);}return;}if(gpf.isArrayLike(dictionary)){return _gpfArrayEachWithResult.apply(this,arguments);}return _gpfDictionaryEachWithResult.apply(this,arguments);};gpf.extend=function(dictionary,additionalProperties,overwriteCallback){var callbackToUse;if(undefined===overwriteCallback){callbackToUse=_gpfAssign;}else{gpf.ASSERT("function"===typeof overwriteCallback,"Expected function");callbackToUse=_gpfAssignOrCall;}_gpfDictionaryEach.apply(arguments,[additionalProperties,callbackToUse]);return dictionary;};gpf.extend(gpf,{value:function(value,defaultValue,expectedType){var valueType=typeof value;if(!expectedType){expectedType=typeof defaultValue;}if(expectedType===valueType){return value;}if("undefined"===valueType||!value){return defaultValue;}return _gpfValues[expectedType](value,valueType,defaultValue);},clone:function(obj){return gpf.json.parse(gpf.json.stringify(obj));},test:function(dictionary,value){var idx;if(dictionary instanceof Array){idx=dictionary.length;while(idx>0){if(dictionary[--idx]===value){return idx;}}}else{for(idx in dictionary){if(dictionary.hasOwnProperty(idx)&&dictionary[idx]===value){return idx;}}}return undefined;},set:function(array,value){gpf.ASSERT(array instanceof Array,"gpf.set must be used with an Array");var idx=array.length;while(idx>0){if(array[--idx]===value){return array;}}array.push(value);return array;},clear:function(dictionary,value){var idx;if(dictionary instanceof Array){idx=dictionary.length;while(idx>0){if(dictionary[--idx]===value){dictionary.splice(idx,1);break;}}}else{for(idx in dictionary){if(dictionary.hasOwnProperty(idx)&&dictionary[idx]===value){break;}}}return dictionary;},xor:function(a,b){return a&&!b||!a&&b;},exit:function(exitCode){if(undefined===exitCode){exitCode=0;}_gpfExit(exitCode);}});if(_gpfInNode){gpf.node.buffer2JsArray=function(buffer){var result=[],len=buffer.length,idx;for(idx=0;idx<len;++idx){result.push(buffer.readUInt8(idx));}return result;};}var _GpfLikeContext=function(alike){this._pending=[];this._done=[];if(true!==alike){this._alike=_gpfFalseFunc;}else{this._haveDifferentPrototypes=_gpfFalseFunc;}};_GpfLikeContext.prototype={_pending:[],_done:[],_stack:function(a,b){var array=this._done,indexOfA,comparedWith;indexOfA=array.indexOf(a);while(-1<indexOfA){if(indexOfA%2){comparedWith=array[indexOfA-1];}else{comparedWith=array[indexOfA+1];}if(comparedWith===b){return;}indexOfA=array.indexOf(a,indexOfA+1);}array=this._pending;array.push(a);array.push(b);},_haveDifferentPrototypes:function(a,b){return a.prototype!==b.prototype;},explore:function(){var pending=this._pending,a,b,done=this._done,membersCount,member;while(0!==pending.length){b=pending.pop();a=pending.pop();if(this._haveDifferentPrototypes(a,b)){return false;}done.push(a,b);membersCount=0;for(member in a){if(a.hasOwnProperty(member)){++membersCount;if(!this.like(a,b)){return false;}}}for(member in b){if(b.hasOwnProperty(member)){--membersCount;}}if(0!==membersCount){return false;}}return true;},_downcast:function(a){if("object"===typeof a){if(a instanceof String){return a.toString();}if(a instanceof Number){return a.valueOf();}if(a instanceof Boolean){return!!a;}}return a;},_alike:function(a,b){return this._downcast(a)===this._downcast(b);},like:function(a,b){if(a===b){return true;}if(typeof a!==typeof b){return this._alike(a,b);}if(null===a||null===b||"object"!==typeof a){return false;}this._stack(a,b);return true;}};gpf.like=function(a,b,alike){var context=new _GpfLikeContext(alike);return context.like(a,b)&&context.explore();};var _gpfBuildParamArray=function(count,params){var len,result,idx;if(params){len=params.length;result=new Array(count+len);for(idx=0;idx<len;++idx){result[count]=params[idx];++count;}}else{result=new Array(count);}return result;},_gpfDoApply=function(callback,scope,paramArray){var len=arguments.length,idx=3,paramIdx=0;while(idx<len){paramArray[paramIdx]=arguments[idx];++idx;++paramIdx;}return callback.apply(scope,paramArray);};gpf.Callback=function(handler,scope){gpf.ASSERT(handler,"Handler expected");this._handler=handler;if(scope){this._scope=_gpfResolveScope(scope);}};gpf.extend(gpf.Callback.prototype,{_handler:_gpfEmptyFunc,_scope:null,handler:function(){return this._handler;},scope:function(){return this._scope;},call:function(){return this.apply(arguments[0],_gpfArraySlice.apply(arguments,[1]));},apply:function(scope,args){var finalScope=_gpfResolveScope(scope||this._scope);return this._handler.apply(finalScope,args||[]);}});gpf.extend(gpf.Callback,{resolveScope:_gpfResolveScope,buildParamArray:_gpfBuildParamArray,doApply:_gpfDoApply,bind:function(obj,method,dynamic){gpf.ASSERT("string"===typeof method,"Expected method name");gpf.ASSERT("function"===typeof obj[method],"Only methods can be bound");var boundMember=method+":boundToThis",result;result=obj[boundMember];if(undefined===result){if(true===dynamic){result=function(){return obj[method].apply(obj,arguments);};}else{result=obj[method].bind(obj);}obj[boundMember]=result;}return result;}});gpf.events.EventDispatcherImpl={_eventDispatcherListeners:null,addEventListener:function(event,eventsHandler,useCapture){var listeners=this._eventDispatcherListeners;if(!listeners){listeners=this._eventDispatcherListeners={};}if(!useCapture){useCapture=false;}if(undefined===listeners[event]){listeners[event]=[];}if(useCapture){listeners[event].unshift(eventsHandler);}else{listeners[event].push(eventsHandler);}return this;},removeEventListener:function(event,eventsHandler){var listeners=this._eventDispatcherListeners,eventListeners,idx;if(listeners){eventListeners=listeners[event];if(undefined!==eventListeners){idx=eventListeners.indexOf(eventsHandler);if(-1!==idx){eventListeners.splice(idx,1);}}}return this;},_dispatchEvent:function(event,params){var listeners=this._eventDispatcherListeners,eventObj,type,eventListeners,len,idx;if(!listeners){return this;}if(event instanceof gpf.events.Event){eventObj=event;type=event.type;}else{type=event;}eventListeners=this._eventDispatcherListeners[type];if(undefined===eventListeners){return this;}if(!eventObj){eventObj=new gpf.events.Event(type,params,this);}len=eventListeners.length;for(idx=0;idx<len;++idx){gpf.events.fire.apply(this,[eventObj,eventListeners[idx]]);}return this;}};var _gpfHardCodedMimeTypes={application:{javascript:"js"},image:{gif:0,jpeg:"jpg,jpeg",png:0},text:{css:0,html:"htm,html",plain:"txt,text,log"}},_gpfMimeTypesToExtension=null,_gpfMimeTypesFromExtension=null,_gpfBuildMimeTypeFromMappings=function(path,mappings){var key,mimeType,fileExtension,extensions,len,idx;for(key in mappings){if(mappings.hasOwnProperty(key)){if(path){mimeType=path+"/"+key;}else{mimeType=key;}extensions=mappings[key];if(0===extensions){fileExtension="."+key;_gpfMimeTypesFromExtension[fileExtension]=mimeType;if(undefined===_gpfMimeTypesToExtension[mimeType]){_gpfMimeTypesToExtension[mimeType]=fileExtension;}}else if("string"===typeof extensions){extensions=extensions.split(",");len=extensions.length;for(idx=0;idx<len;++idx){fileExtension="."+extensions[idx];_gpfMimeTypesFromExtension[fileExtension]=mimeType;if(undefined===_gpfMimeTypesToExtension[mimeType]){_gpfMimeTypesToExtension[mimeType]=fileExtension;}}}else{_gpfBuildMimeTypeFromMappings(mimeType,extensions);}}}},_gpfInitMimeTypes=function(){if(null===_gpfMimeTypesFromExtension){_gpfMimeTypesFromExtension={};_gpfMimeTypesToExtension={};_gpfBuildMimeTypeFromMappings("",_gpfHardCodedMimeTypes);}};gpf.web.getMimeType=function(fileExtension){var mimeType;_gpfInitMimeTypes();mimeType=_gpfMimeTypesFromExtension[fileExtension.toLowerCase()];if(undefined===mimeType){mimeType="application/octet-stream";}return mimeType;};gpf.web.getFileExtension=function(mimeType){var fileExtension;_gpfInitMimeTypes();fileExtension=_gpfMimeTypesToExtension[mimeType.toLowerCase()];if(undefined===fileExtension){fileExtension=".bin";}return fileExtension;};"use strict";var _gpfAsyncCallback=function(callback,scope,args){if("string"===typeof callback){callback=_gpfFunc(callback);}if(!_gpfIsArrayLike(args)){args=[];}return function(){callback.apply(_gpfResolveScope(scope),args);};},_gpfAsyncQueue=[],_gpfSortOnDt=function(a,b){return a._dt-b._dt;},_gpfDefer;gpf.runAsyncQueue=_gpfEmptyFunc;if("browser"===_gpfHost){_gpfAsyncCallback=function(parameters){parameters[0].apply(_gpfResolveScope(parameters[1]),parameters[2]);};_gpfDefer=function(callback,timeout,scope,args){if("string"===typeof callback){callback=_gpfFunc(callback);}if(!timeout){timeout=0;}setTimeout(_gpfAsyncCallback,timeout,[callback,scope,args]);};}else if("undefined"!==typeof setTimeout){_gpfDefer=function(callback,timeout,scope,args){if(!timeout){timeout=0;}setTimeout(_gpfAsyncCallback(callback,scope,args),timeout);};}else if("wscript"===_gpfHost){_gpfDefer=function(callback,timeout,scope,args){var item=_gpfAsyncCallback(callback,scope,args);if(!timeout){timeout=0;}item._dt=new Date(new Date- -timeout);_gpfAsyncQueue.push(item);_gpfAsyncQueue.sort(_gpfSortOnDt);};gpf.runAsyncQueue=function(){var queue=_gpfAsyncQueue,callback;while(queue.length){callback=queue.shift();if(callback._dt>new Date){WScript.Sleep(callback._dt-new Date);}callback();}};}else{console.warn("No implementation for gpf.defer");_gpfDefer=function(callback,timeout,scope,args){_gpfIgnore(timeout);_gpfAsyncCallback(callback,scope,args)();};}gpf.defer=_gpfDefer;var _b64=_gpfALPHA+_gpfAlpha+_gpfDigit+"+/",_b16="0123456789ABCDEF",_toBaseANY=function(base,value,length,safepad){var baseLength=base.length,pow=gpf.bin.isPow2(baseLength),bits,mask,result=[],digit;if(-1<pow&&(undefined===length||length*pow<=32)){if(undefined===length){bits=32;}else{bits=length*pow;}mask=(1<<bits-pow)-1;bits=(1<<pow)-1;while(0!==value){digit=value&bits;result.unshift(base.charAt(digit));value=value>>pow&mask;}}else{while(0!==value){digit=value%baseLength;result.unshift(base.charAt(digit));value=(value-digit)/baseLength;}}if(undefined!==length){if(undefined===safepad){safepad=base.charAt(0);}while(result.length<length){result.unshift(safepad.charAt(result.length%safepad.length));}}else if(0===result.length){result=[base.charAt(0)];}return result.join("");},_fromBaseANY=function(base,text,safepad){var baseLength=base.length,result=0,idx=0;if(undefined===safepad){safepad=base.charAt(0);}while(idx<text.length){if(-1===safepad.indexOf(text.charAt(idx))){break;}else{++idx;}}while(idx<text.length){result=baseLength*result+base.indexOf(text.charAt(idx++));}return result;};gpf.bin={pow2:function(n){return 1<<n;},isPow2:function(value){if(0<value&&0===(value&value-1)){var result=0;while(1<value){++result;value>>=1;}return result;}else{return-1;}},toBaseANY:_toBaseANY,fromBaseANY:_fromBaseANY,toHexa:function(value,length,safepad){return _toBaseANY(_b16,value,length,safepad);},fromHexa:function(text,safepad){return _fromBaseANY(_b16,text,safepad);},toBase64:function(value,length,safepad){return _toBaseANY(_b64,value,length,safepad);},fromBase64:function(text,safepad){return _fromBaseANY(_b64,text,safepad);},test:function(value,bitmask){return(value&bitmask)===bitmask;},clear:function(value,bitmask){return value&~bitmask;}};var _gpfJsonStringify,_gpfJsonParse;function _gpfObject2Json(object){var isArray,results,property,value;isArray=object instanceof Array;results=[];for(property in object){if("function"===typeof object[property]){continue;}value=_gpfJsonStringify(object[property]);if(isArray){results.push(value);}else{results.push(_gpfStringEscapeFor(property,"javascript")+":"+value);}}if(isArray){return"["+results.join(",")+"]";}else{return"{"+results.join(",")+"}";}}if("undefined"===typeof JSON){_gpfJsonStringify=function(object){var type=typeof object;if("undefined"===type||"function"===type){return;}else if("number"===type||"boolean"===type){return object.toString();}else if("string"===type){return _gpfStringEscapeFor(object,"javascript");}if(null===object){return"null";}else{return _gpfObject2Json(object);}};_gpfJsonParse=function(test){return _gpfFunc("return "+test)();};}else{_gpfJsonStringify=JSON.stringify;_gpfJsonParse=JSON.parse;}gpf.json={stringify:_gpfJsonStringify,parse:_gpfJsonParse,load:function(object,json){var prototype=object.constructor.prototype,attributes=new _gpfA.Map(object),member,jsonMember;for(member in prototype){if("function"===typeof prototype[member]||attributes.member(member).has(_gpfANoSerial)){continue;}if(0===member.indexOf("_")){jsonMember=member.substr(1);}else{jsonMember=member;}if(jsonMember in json){object[member]=json[jsonMember];}else{object[member]=prototype[member];}}return object;},save:function(object){var result={},prototype=object.constructor.prototype,attributes=new _gpfA.Map(object),member,jsonMember,value;for(member in prototype){if("function"===typeof prototype[member]||attributes.member(member).has(_gpfANoSerial)){continue;}if(0===member.indexOf("_")){jsonMember=member.substr(1);}else{jsonMember=member;}value=object[member];if(value!==prototype[member]){result[jsonMember]=value;}}return result;}};var _gpfPatternPartSplit=function(part){return part.split("*");},_GpfPathMatcher=function(pattern){if("!"===pattern.charAt(0)){this.negative=true;pattern=pattern.substr(1);}var pos=pattern.indexOf("**");if(-1===pos){this.start=pattern.split("/").map(_gpfPatternPartSplit);}else{if(0<pos){gpf.ASSERT(pattern.charAt(pos-1)==="/","** must be preceded by /");this.start=pattern.substr(0,pos-1).split("/").map(_gpfPatternPartSplit);}if(pos<pattern.length-2){gpf.ASSERT(pattern.charAt(pos+2)==="/","** must be followed by /");this.end=pattern.substr(pos+3).split("/").map(_gpfPatternPartSplit).reverse();}}},_gpfPathMatchCompilePattern=function(pattern){if(pattern instanceof _GpfPathMatcher){return pattern;}else{return new _GpfPathMatcher(pattern);}},_gpfPathMatchCompilePatterns=function(pattern){if(pattern instanceof Array){return pattern.map(_gpfPathMatchCompilePattern);}else{return[_gpfPathMatchCompilePattern(pattern)];}},_gpfPathMatchApply=function(pathMatcher){var negative=pathMatcher.negative;if(pathMatcher.match(this.parts)){this.result=!negative;return false;}if(negative){this.result=true;return false;}return true;},_gpfPathMatch=function(pattern,path){if(_gpfDosPath){path=path.toLowerCase().split("\\").join("/");}var parts=path.split("/"),matchers=_gpfPathMatchCompilePatterns(pattern),scope={parts:parts};matchers.every(_gpfPathMatchApply,scope);return scope.result;};_GpfPathMatcher.prototype={constructor:_GpfPathMatcher,negative:false,start:null,end:null,_matchName:function(fixedPatterns,part){var len=fixedPatterns.length,idx,fixedPattern,pos=0;for(idx=0;idx<len;++idx){fixedPattern=fixedPatterns[idx];if(fixedPattern){pos=part.indexOf(fixedPattern,pos);if(-1===pos){return false;}if(0===idx&&0<pos){return false;}}}return!fixedPattern||pos+fixedPattern.length===part.length;},match:function(parts){var partsLen=parts.length,startPos=0,endPos=partsLen-1,array,len,idx;if(this.start){array=this.start;len=array.length;for(idx=0;idx<len;++idx){if(this._matchName(array[idx],parts[startPos])){if(++startPos>=partsLen){return idx===len-1&&!this.end;}}else{return false;}}}if(this.end){array=this.end;len=array.length;for(idx=0;idx<len;++idx){if(-1<endPos&&this._matchName(array[idx],parts[endPos])){if(endPos--<startPos){return false;}}else{return false;}}}return true;}};gpf.path={match:function(pattern,path){return _gpfPathMatch(pattern,path)||false;},compileMatchPattern:function(pattern){return _gpfPathMatchCompilePatterns(pattern);}};var _GPF_ERRORS={"ClassMemberOverloadWithTypeChange":"You can't overload a member to change its type","ClassInvalidVisibility":"Invalid visibility keyword","PatternUnexpected":"Invalid syntax (unexpected)","PatternEmpty":"Empty pattern","PatternInvalidSyntax":"Invalid syntax","PatternEmptyGroup":"Syntax error (empty group)","HtmlHandlerMultiplicityError":"Too many $HtmlHandler attributes for '{member}'","HtmlHandlerMissing":"No $HtmlHandler attributes","HtmlHandlerNoDefault":"No default $HtmlHandler attribute","EngineStackUnderflow":"Stack underflow","EngineTypeCheck":"Type check","EncodingNotSupported":"Encoding not supported","EncodingEOFWithUnprocessedBytes":"Unexpected end of stream: unprocessed bytes","XmlInvalidName":"Invalid XML name","ParamsNameRequired":"Missing name","ParamsTypeUnknown":"Type unknown","ParamsRequiredMissing":"Required parameter '{name}' is missing","FileNotFound":"File not found"},_GpfError=gpf.Error=function(){},_gpfGenErrorName=function(code,name,message){var result=function(context){var error=new gpf.Error,finalMessage,replacements,key;gpf.setReadOnlyProperty(error,"code",code);gpf.setReadOnlyProperty(error,"name",name);if(context){replacements={};for(key in context){if(context.hasOwnProperty(key)){replacements["{"+key+"}"]=context[key].toString();}}finalMessage=_gpfStringReplaceEx(message,replacements);}else{finalMessage=message;}gpf.setReadOnlyProperty(error,"message",finalMessage);return error;};gpf.setReadOnlyProperty(result,"CODE",code);gpf.setReadOnlyProperty(result,"NAME",name);gpf.setReadOnlyProperty(result,"MESSAGE",message);return result;},_gpfLastErrorCode=0,_gpfErrorDeclare=function(module,list){var name,code;_gpfIgnore(module);for(name in list){if(list.hasOwnProperty(name)){code=++_gpfLastErrorCode;gpf.Error["CODE_"+name.toUpperCase()]=code;gpf.Error[name]=_gpfGenErrorName(code,name,list[name]);}}};_GpfError.prototype={constructor:_GpfError,code:0,name:"Error",message:""};_gpfErrorDeclare("boot",{NotImplemented:"Not implemented",Abstract:"Abstract",AssertionFailed:"Assertion failed: {message}"});_gpfIgnore(_GPF_ERRORS);gpf.js={keywords:function(){return[].concat(_gpfJsKeywords);}};_gpfErrorDeclare("csv",{CsvInvalid:"Invalid CSV syntax (bad quote sequence or missing end of file)"});var _gpfCsvSeparators=";,\t ",_gpfCsvComputeSeparator=function(header){var len=_gpfCsvSeparators.length,idx,separator;for(idx=0;idx<len;++idx){separator=_gpfCsvSeparators.charAt(idx);if(-1!==header.indexOf(separator)){return separator;}}return _gpfCsvSeparators.charAt(0);},_gpfCsvUnquote=function(value,quote){var pos=value.indexOf(quote),inQuotedString=true;while(-1<pos){if(pos===value.length-1){value=value.substr(0,pos);inQuotedString=false;break;}else{if(value.charAt(pos+1)===quote){value=value.substr(0,pos)+value.substr(pos+1);}else{throw gpf.Error.CsvInvalid();}}pos=value.indexOf(quote,pos+1);}return[value,inQuotedString];},_gpfCsvReadValues=function(lines,separator,quote){var values=[],line,inQuotedString=false,includeCarriageReturn,idx,value,previousValue,unQuoted;while(lines.length){line=lines.shift();line=line.split(separator);if(inQuotedString){includeCarriageReturn=true;line.unshift(values.pop());idx=1;}else{idx=0;includeCarriageReturn=false;}while(idx<line.length){value=line[idx];if(inQuotedString){previousValue=[line[idx-1]];if(includeCarriageReturn){previousValue.push("\r\n");}else{previousValue.push(separator);}unQuoted=_gpfCsvUnquote(value,quote);previousValue.push(unQuoted[0]);inQuotedString=unQuoted[1];line[idx-1]=previousValue.join("");includeCarriageReturn=false;line.splice(idx,1);}else{if(0===value.indexOf(quote)){inQuotedString=true;unQuoted=_gpfCsvUnquote(value.substr(1),quote);line[idx]=unQuoted[0];inQuotedString=unQuoted[1];}++idx;}}values=values.concat(line);if(inQuotedString){if(0===lines.length){throw gpf.Error.CsvInvalid();}}else{return values;}}},_trimFinalR=function(line){var len=line.length-1;if("\r"===line.charAt(len)){return line.substr(0,len);}return line;},_gpfCsvParse=function(content,options){options=options||{};var lines=content.split("\n").map(_trimFinalR),header=options.header||lines.shift(),headerLen,separator=options.separator||_gpfCsvComputeSeparator(header),values,record,idx,result=[];header=header.split(separator);headerLen=header.length;while(lines.length){values=_gpfCsvReadValues(lines,separator,options.quote||"\"");record={};for(idx=0;idx<headerLen;++idx){record[header[idx]]=values[idx];}result.push(record);}return result;};gpf.csv={parse:_gpfCsvParse};var _gpfVisibilityKeywords="public|protected|private|static".split("|"),_GPF_CLASSDEF_MARKER="_gpf",_GPF_VISIBILITY_PUBLIC=0,_GPF_VISIBILITY_PROTECTED=1,_GPF_VISIBILITY_STATIC=3,_gpfClassInitAllowed=true,_gpfClassDefUID=0,_gpfClassConstructorTpl=function(){var args=arguments,constructor=function(){args[0].apply(this,[constructor,arguments]);};return constructor;},_gpfNewClassConstructorSrc=function(name){var src=_gpfClassConstructorTpl.toString(),start,end;start=src.indexOf("{")+1;end=src.lastIndexOf("}")-1;src=src.substr(start,end-start+1);return src.replace("function","function "+name);},_gpfUsesSuper=function(member){var parts,len,idx;parts=member.toString().split("._super");len=parts.length;for(idx=1;idx<len;++idx){if(-1===_gpfIdentifierOtherChars.indexOf(parts[idx].charAt(0))){return true;}}return false;},_gpfGenSuperMember=function(superMember,member){return function(){var previousSuper=this._super,result;this._super=superMember;try{result=member.apply(this,arguments);}finally{if(undefined===previousSuper){delete this._super;}else{this._super=previousSuper;}}return result;};},_gpfGenDefHandler=function(ctxRoot,defaultBase){ctxRoot=ctxRoot+".";return function(name,base,definition){var result;if(undefined===definition&&"object"===typeof base){definition=base;base=ctxRoot+defaultBase;}else if(undefined===base){base=ctxRoot+defaultBase;}if(-1===name.indexOf(".")){name=ctxRoot+name;}result=gpf.define(name,base,definition);return result;};},_gpfClassDefinitions={},_GpfClassDefinition=function(name,Super,definition){this._uid=++_gpfClassDefUID;_gpfClassDefinitions[this._uid]=this;this._Subs=[];if("function"===typeof name){this._name="anonymous";this._Constructor=name;}else{this._name=name;this._Super=Super;this._definition=definition;this._build();}},_gpfGetClassDefinition=function(constructor){var classDef,uid=constructor[_GPF_CLASSDEF_MARKER];if(undefined===uid){classDef=new _GpfClassDefinition(constructor);gpf.setReadOnlyProperty(constructor,_GPF_CLASSDEF_MARKER,classDef.uid());}else{classDef=_gpfClassDefinitions[uid];}return classDef;},_gpfClassInit=function(constructor,args){if(_gpfClassInitAllowed){var classDef=_gpfGetClassDefinition(constructor);if(classDef._defConstructor){classDef._defConstructor.apply(this,args);}else{classDef._Super.apply(this,args);}}};_GpfClassDefinition.prototype={constructor:_GpfClassDefinition,_uid:0,uid:function(){return this._uid;},_name:"",name:function(){return this._name;},nameOnly:function(){var name=this._name,pos=name.lastIndexOf(".");if(-1===pos){return name;}else{return name.substr(pos+1);}},_Super:Object,Super:function(){return this._Super;},_Subs:[],Subs:function(){return this._Subs;},_attributes:null,attributes:function(){if(!this._attributes){this._attributes=new gpf.attributes.Map;}return this._attributes;},_Constructor:function(){},_defConstructor:null,Constructor:function(){return this._Constructor;},_definition:null,addMember:function(member,value,visibility){var newPrototype=this._Constructor.prototype;gpf.ASSERT(member!=="constructor","No constructor can be added");gpf.ASSERT(undefined===newPrototype[member],"No member can be overridden");if(undefined===visibility){visibility=_GPF_VISIBILITY_PUBLIC;}else if("string"===typeof visibility){visibility=_gpfVisibilityKeywords.indexOf(visibility);if(-1===visibility){visibility=_GPF_VISIBILITY_PUBLIC;}}this._addMember(member,value,visibility);},_addMember:function(member,value,visibility){var newPrototype=this._Constructor.prototype;if(_GPF_VISIBILITY_STATIC===visibility){gpf.setReadOnlyProperty(newPrototype.constructor,member,value);}else{newPrototype[member]=value;}},_processMember:function(member,visibility){var defMember=this._definition[member],isConstructor=member==="constructor",newType,baseMember,baseType;newType=typeof defMember;if(_GPF_VISIBILITY_STATIC===visibility){this._addMember(member,defMember,_GPF_VISIBILITY_STATIC);return;}if(isConstructor){baseMember=this._Super;}else{baseMember=this._Super.prototype[member];}baseType=typeof baseMember;if("undefined"!==baseType&&null!==baseMember&&newType!==baseType){throw gpf.Error.ClassMemberOverloadWithTypeChange();}if("function"===newType&&"undefined"!==baseType&&_gpfUsesSuper(defMember)){defMember=_gpfGenSuperMember(baseMember,defMember);}if(isConstructor){this._defConstructor=defMember;}else{this._addMember(member,defMember,visibility);}},_processAttribute:function(key){var attributeArray,newAttributeArray=this._definition[key];key=key.substr(1,key.length-2);if(!this._attributes){this._attributes={};}attributeArray=this._attributes[key];if(undefined===attributeArray){attributeArray=[];}this._attributes[key]=attributeArray.concat(newAttributeArray);},_processDefWithVisibility:function(visibility){var initialDefinition=this._definition,definition,member;member=_gpfVisibilityKeywords[visibility];definition=initialDefinition[member];this._definition=definition;try{for(member in definition){if(definition.hasOwnProperty(member)){if("["===member.charAt(0)&&"]"===member.charAt(member.length-1)){this._processAttribute(member);}else if("public"===member||"private"===member||"protected"===member||"static"===member){throw gpf.Error.ClassInvalidVisibility();}else{this._processMember(member,visibility);}}}if("wscript"===gpf.host()&&definition.constructor!==Object){this._processMember("constructor",visibility);}}finally{this._definition=initialDefinition;}},_processDefinition:function(){var definition=this._definition,member,visibility;for(member in definition){if(definition.hasOwnProperty(member)){if("["===member.charAt(0)&&"]"===member.charAt(member.length-1)){this._processAttribute(member);}else{visibility=_gpfVisibilityKeywords.indexOf(member);if(-1===visibility){if(member.charAt(0)==="_"){visibility=_GPF_VISIBILITY_PROTECTED;}else{visibility=_GPF_VISIBILITY_PUBLIC;}this._processMember(member,visibility);}else{this._processDefWithVisibility(visibility);}}}}if("wscript"===gpf.host()&&definition.constructor!==Object){this._processMember("constructor",_GPF_VISIBILITY_PUBLIC);}},_processAttributes:function(){var attributes=this._attributes,Constructor,newPrototype,attributeName;if(attributes){delete this._attributes;Constructor=this._Constructor;newPrototype=Constructor.prototype;for(attributeName in attributes){if(attributes.hasOwnProperty(attributeName)){if(attributeName in newPrototype||attributeName==="Class"){gpf.attributes.add(Constructor,attributeName,attributes[attributeName]);}else{console.error("gpf.define: Invalid attribute name '"+attributeName+"'");}}}}},_build:function(){var newClass,newPrototype,baseClassDef,name=this._name,constructorName;constructorName=name.substr(name.lastIndexOf(".")+1);newClass=_gpfFunc(_gpfNewClassConstructorSrc(constructorName))(_gpfClassInit);this._Constructor=newClass;gpf.setReadOnlyProperty(newClass,_GPF_CLASSDEF_MARKER,this._uid);_gpfClassInitAllowed=false;newPrototype=new this._Super;_gpfClassInitAllowed=true;newClass.prototype=newPrototype;newPrototype.constructor=newClass;baseClassDef=_gpfGetClassDefinition(this._Super);baseClassDef.Subs().push(newClass);this._processDefinition();this._processAttributes();}};gpf.define=function(name,base,definition){var result,path,ns,leafName,classDef;if("string"===typeof base){base=gpf.context(base);}else if("object"===typeof base){definition=base;base=undefined;}if(undefined===base){base=Object;}if(-1<name.indexOf(".")){path=name.split(".");leafName=path.pop();ns=gpf.context(path,true);}classDef=new _GpfClassDefinition(name,base,definition||{});result=classDef.Constructor();if(undefined!==ns){ns[leafName]=result;}return result;};var _gpfA=gpf.attributes={},_gpfEmptyMemberArray=0,_gpfAlias=function(objectClass,name){name="$"+name;gpf[name]=function(){var Proxy=_gpfFunc("return function "+name+"(args) {"+"this.constructor.apply(this, args);"+"};")();Proxy.prototype=objectClass.prototype;return function(){return new Proxy(arguments);};}();},_gpfDefAttrBase=_gpfGenDefHandler("gpf.attributes","Attribute"),_gpfDefAttr=function(name,base,definition){var isAlias=name.charAt(0)==="$",fullName,result;if(isAlias){name=name.substr(1);fullName=name+"Attribute";}else{fullName=name;}result=_gpfDefAttrBase(fullName,base,definition);if(isAlias){_gpfAlias(result,name);}return result;};_gpfDefAttr("Attribute",{protected:{_member:"",_alterPrototype:function(objPrototype){_gpfIgnore(objPrototype);}},public:{member:function(){return this._member;}}});_gpfDefAttr("$Alias",{private:{_name:""},protected:{_alterPrototype:function(objPrototype){_gpfAlias(objPrototype.constructor,this._name);}},public:{constructor:function(name){this._name=name;}}});gpf.define("gpf.attributes.Array",{private:{_array:[]},public:{constructor:function(){this._array=[];},getItemsCount:function(){return this._array.length;},getItem:function(index){return _gpfArrayOrItem(this._array,index);},has:function(expectedClass){gpf.ASSERT("function"===typeof expectedClass,"Expected a class parameter");gpf.ASSERT(expectedClass.prototype instanceof _gpfA.Attribute,"Expected an Attribute-like class parameter");var idx,array=this._array,len=array.length,item;for(idx=0;idx<len;++idx){item=array[idx];if(item instanceof expectedClass){return item;}}return null;},filter:function(expectedClass){gpf.ASSERT("function"===typeof expectedClass,"Expected a class parameter");gpf.ASSERT(expectedClass.prototype instanceof _gpfA.Attribute,"Expected an Attribute-like class parameter");var idx,array=this._array,len=array.length,attribute,result=new _gpfA.Array,resultArray=result._array;for(idx=0;idx<len;++idx){attribute=array[idx];if(attribute instanceof expectedClass){resultArray.push(attribute);}}return result;},each:function(callback){return _gpfArrayEachWithResult(this._array,callback,undefined);}}});gpf.define("gpf.attributes.Map",{private:{_members:{},_count:0,_copyTo:function(attributesMap,callback,param){var members=this._members,member,array,idx,attribute;if(this._count){for(member in members){if(members.hasOwnProperty(member)){array=members[member]._array;for(idx=0;idx<array.length;++idx){attribute=array[idx];if(!callback||callback(member,attribute,param)){attributesMap.add(member,attribute);}}}}}},_filterCallback:function(member,attribute,expectedClass){_gpfIgnore(member);return attribute instanceof expectedClass;}},public:{constructor:function(object){var classDef;this._members={};this._count=0;if(object instanceof Function){classDef=_gpfGetClassDefinition(object);this.fillFromClassDef(classDef);}else if(undefined!==object){this.fillFromObject(object);}},count:function(){return this._count;},add:function(member,attribute){var array=this._members[member];if(undefined===array){array=this._members[member]=new _gpfA.Array;}array._array.push(attribute);++this._count;},fillFromObject:function(object){var classDef=_gpfGetClassDefinition(object.constructor);return this.fillFromClassDef(classDef);},fillFromClassDef:function(classDef){var attributes,Super;while(classDef){attributes=classDef.attributes();if(attributes){attributes._copyTo(this);}Super=classDef.Super();if(Super!==Object){classDef=_gpfGetClassDefinition(Super);}else{break;}}return this._count;},filter:function(expectedClass){gpf.ASSERT("function"===typeof expectedClass,"Expected a class parameter");gpf.ASSERT(expectedClass.prototype instanceof _gpfA.Attribute,"Expected an Attribute-like class parameter");var result=new _gpfA.Map;this._copyTo(result,this._filterCallback,expectedClass);return result;},member:function(name){var result=this._members[name];if(undefined===result||!(result instanceof _gpfA.Array)){if(0===_gpfEmptyMemberArray){_gpfEmptyMemberArray=new _gpfA.Array;}result=_gpfEmptyMemberArray;}return result;},members:function(){var members=this._members,result=[],member;for(member in members){if(members.hasOwnProperty(member)){result.push(member);}}return result;},each:function(callback){return _gpfDictionaryEachWithResult(this._members,callback,undefined);},addTo:function(objectClass){var members=this._members,member;for(member in members){if(members.hasOwnProperty(member)){_gpfA.add(objectClass,member,members[member]);}}}}});_gpfA.add=function(objectClass,name,attributes){if(attributes instanceof _gpfA.Array){attributes=attributes._array;}else if(!(attributes instanceof Array)){attributes=[attributes];}var objectClassOwnAttributes,len,idx,attribute;objectClassOwnAttributes=_gpfGetClassDefinition(objectClass).attributes();len=attributes.length;for(idx=0;idx<len;++idx){attribute=attributes[idx];gpf.ASSERT(attribute instanceof _gpfA.Attribute,"Expected attribute");attribute._member=name;objectClassOwnAttributes.add(name,attribute);attribute._alterPrototype(objectClass.prototype);}};_gpfErrorDeclare("a_attributes",{OnlyForAttributeClass:"The attribute {attributeName} can be used only on an Attribute class",OnlyOnClassForAttributeClass:"The attribute {attributeName} must be used on Class",ClassOnlyAttribute:"The attribute {attributeName} can be used only for Class",MemberOnlyAttribute:"The attribute {attributeName} can be used only for members",UniqueAttributeConstraint:"Attribute {attributeName} already defined on {className}",UniqueMemberAttributeConstraint:"Attribute {attributeName} already defined on {className}::{memberName}"});var _GpfAttrOnly=_gpfDefAttr("AttrClassOnlyAttribute",{protected:{_alterPrototype:function(objPrototype){if(!(objPrototype instanceof _gpfA.Attribute)){throw gpf.Error.OnlyForAttributeClass({attributeName:_gpfGetClassDefinition(this.constructor).name()});}if(this._member!=="Class"){throw gpf.Error.OnlyOnClassForAttributeClass({attributeName:_gpfGetClassDefinition(this.constructor).name()});}}}}),_gpfAttrConstraint=_gpfDefAttr("AttrConstraintAttribute",_GpfAttrOnly,{static:{originalAlterPrototype:"_alterPrototype:checked"},private:{_checkAndAlterPrototype:function(objPrototype){var statics=_gpfA.AttrConstraintAttribute,originalAlterPrototype=statics.originalAlterPrototype,targetAttribute=this,attributes;attributes=new _gpfA.Map(this);attributes.filter(_gpfAttrConstraint).each(function(member,attributes){_gpfIgnore(member);var len=attributes.getItemsCount(),idx;for(idx=0;idx<len;++idx){attributes.getItem(idx)._check(targetAttribute,objPrototype);}});targetAttribute[originalAlterPrototype].apply(targetAttribute,[objPrototype]);}},protected:{_check:function(targetAttribute,objPrototype){_gpfIgnore(targetAttribute);_gpfIgnore(objPrototype);throw gpf.Error.Abstract();},_alterPrototype:function(objPrototype){var statics=_gpfA.AttrConstraintAttribute,originalAlterPrototype=statics.originalAlterPrototype;this._super(objPrototype);if(undefined===objPrototype[originalAlterPrototype]){objPrototype[originalAlterPrototype]=objPrototype._alterPrototype;objPrototype._alterPrototype=this._checkAndAlterPrototype;}}}});_gpfDefAttr("$ClassAttribute",_gpfAttrConstraint,{protected:{_check:function(targetAttribute){if(targetAttribute.member()!=="Class"){var attributeClass=targetAttribute.constructor,attributeClassDef=_gpfGetClassDefinition(attributeClass);throw gpf.Error.ClassOnlyAttribute({attributeName:attributeClassDef.name()});}}}});_gpfDefAttr("$MemberAttribute",_gpfAttrConstraint,{protected:{_check:function(targetAttribute){if(targetAttribute.member()==="Class"){var attributeClass=targetAttribute.constructor,attributeClassDef=_gpfGetClassDefinition(attributeClass);throw gpf.Error.MemberOnlyAttribute({attributeName:attributeClassDef.name()});}}}});_gpfDefAttr("$UniqueAttribute",_gpfAttrConstraint,{private:{_classScope:true},protected:{_check:function(targetAttribute,objPrototype){var objectClass,objectClassDef,objectClassAttributes,attributeClass,attributeClassDef,attributesInObj,member=targetAttribute.member();objectClass=objPrototype.constructor;objectClassDef=_gpfGetClassDefinition(objectClass);objectClassAttributes=new _gpfA.Map(objectClass);attributeClass=targetAttribute.constructor;attributeClassDef=_gpfGetClassDefinition(attributeClass);attributesInObj=objectClassAttributes.filter(attributeClass);if(this._classScope){if(1<attributesInObj.count()){throw gpf.Error.UniqueAttributeConstraint({attributeName:attributeClassDef.name(),className:objectClassDef.name()});}}else if(1<attributesInObj.member(member).getItemsCount()){throw gpf.Error.UniqueMemberAttributeConstraint({attributeName:attributeClassDef.name(),className:objectClassDef.name(),memberName:member});}}},public:{constructor:function(classScope){if(undefined!==classScope){this._classScope=true===classScope;}}}});var _gpfROProperty=function(){return this._MEMBER_;},_gpfRWProperty=function(){var result=this._MEMBER_;if(0<arguments.length){this._MEMBER_=arguments[0];}return result;},_gpfClassAttribute=_gpfDefAttr("ClassAttribute"),_gpfANoSerial;_gpfDefAttr("$ClassProperty",_gpfClassAttribute,{"[Class]":[gpf.$MemberAttribute(),gpf.$UniqueAttribute(false)],private:{_writeAllowed:false,_publicName:undefined,_visibility:undefined},protected:{_alterPrototype:function(objPrototype){var member=this._member,publicName=this._publicName,classDef=_gpfGetClassDefinition(objPrototype.constructor),params,src,start,end;if(!publicName){publicName=member.substr(1);}if(this._writeAllowed){params=["value"];src=_gpfRWProperty.toString();}else{params=[];src=_gpfROProperty.toString();}src=src.split("_MEMBER_").join(member);start=src.indexOf("{")+1;end=src.lastIndexOf("}")-1;src=src.substr(start,end-start+1);classDef.addMember(publicName,_gpfFunc(params,src),this._visibility);}},public:{constructor:function(writeAllowed,publicName,visibility){if(writeAllowed){this._writeAllowed=true;}if("string"===typeof publicName){this._publicName=publicName;}if("string"===typeof visibility){this._visibility=visibility;}}}});_gpfDefAttr("$ClassEventHandler",_gpfClassAttribute,{"[Class]":[gpf.$MemberAttribute(),gpf.$UniqueAttribute(false)]});_gpfANoSerial=_gpfDefAttr("$ClassNonSerialized",_gpfClassAttribute,{"[Class]":[gpf.$MemberAttribute(),gpf.$UniqueAttribute(false)]});_gpfDefAttr("$ClassExtension",_gpfClassAttribute,{private:{_ofClass:_gpfEmptyFunc,_publicName:""},public:{constructor:function(ofClass,publicName){this._ofClass=ofClass;if("string"===typeof publicName){this._publicName=publicName;}}}});_gpfErrorDeclare("interfaces",{InterfaceExpected:"Expected interface not implemented: {name}"});var _gpfI=gpf.interfaces={isImplementedBy:function(inspectedObject,interfaceDefinition){var member,memberReference,memberValue,memberType;if(inspectedObject instanceof Function){inspectedObject=inspectedObject.prototype;}for(member in interfaceDefinition.prototype){if("constructor"===member||"extend"===member){continue;}memberReference=interfaceDefinition.prototype[member];memberValue=inspectedObject[member];memberType=typeof memberValue;if(typeof memberReference!==memberType){return false;}if("function"===memberType&&memberReference.length!==memberValue.length){return false;}}return true;},query:function(objectInstance,interfaceDefinition,throwError){var result=null;if(gpf.interfaces.isImplementedBy(objectInstance,interfaceDefinition)){return objectInstance;}else if(gpf.interfaces.isImplementedBy(objectInstance,gpf.interfaces.IUnknown)){result=objectInstance.queryInterface(interfaceDefinition);}if(undefined===throwError){throwError=true;}if(null===result&&throwError){throw gpf.Error.InterfaceExpected({name:_gpfGetClassDefinition(interfaceDefinition).name()});}return result;}};var _gpfDefIntrf=_gpfGenDefHandler("gpf.interfaces","Interface");_gpfDefIntrf("Interface");_gpfDefIntrf("IEventDispatcher",{addEventListener:function(event,callback,useCapture){_gpfIgnore(event);_gpfIgnore(callback);_gpfIgnore(useCapture);return this;},removeEventListener:function(event,callback){_gpfIgnore(event);_gpfIgnore(callback);return this;}});_gpfDefIntrf("IUnknown",{queryInterface:function(interfaceDefinition){_gpfIgnore(interfaceDefinition);return null;}});function _queryInterface(interfaceDefinition){var array=new gpf.attributes.Map(this).member("Class").filter(gpf.attributes.InterfaceImplementAttribute),idx,attribute,builder;for(idx=0;idx<array.getItemsCount();++idx){attribute=array.getItem(idx);builder=attribute._builder;if(attribute._interfaceDefinition===interfaceDefinition&&builder){if("function"===typeof builder){return builder(this);}return this[builder]();}}return null;}function _wrapQueryInterface(orgQueryInterface){return function(){var result=_queryInterface.apply(this,arguments);if(null===result){result=orgQueryInterface.apply(this,arguments);}return result;};}_gpfDefAttr("$InterfaceImplement",{private:{"[_interfaceDefinition]":[gpf.$ClassProperty(false,"which")],_interfaceDefinition:_gpfEmptyFunc,"[_builder]":[gpf.$ClassProperty(false,"how")],_builder:null},protected:{_alterPrototype:function(objPrototype){var iProto=this._interfaceDefinition.prototype,iClassDef=_gpfGetClassDefinition(this._interfaceDefinition),member,attributes;attributes=new gpf.attributes.Map;attributes.fillFromClassDef(iClassDef);attributes.addTo(objPrototype.constructor);if(!this._builder){for(member in iProto){if(!(member in objPrototype)){objPrototype[member]=iProto[member];}}return;}if(undefined!==objPrototype.queryInterface){if(_queryInterface!==objPrototype.queryInterface){objPrototype.queryInterface=_wrapQueryInterface(objPrototype.queryInterface);}}else{objPrototype.queryInterface=_queryInterface;gpf.attributes.add(objPrototype.constructor,"Class",[gpf.$InterfaceImplement(gpf.interfaces.IUnknown)]);}}},public:{constructor:function(interfaceDefinition,queryInterfaceBuilder){this._interfaceDefinition=interfaceDefinition;if(queryInterfaceBuilder){this._builder=queryInterfaceBuilder;}}}});_gpfErrorDeclare("i_enumerator",{EnumerableInvalidMember:"$Enumerator can be associated to arrays only"});_gpfDefIntrf("IEnumerator",{reset:function(){},"[moveNext]":[gpf.$ClassEventHandler()],moveNext:function(eventsHandler){_gpfIgnore(eventsHandler);return false;},current:function(){return null;},static:{each:function(enumerator,callback,eventsHandler){var iEnumerator=_gpfI.query(enumerator,_gpfI.IEnumerator),end=function(event){_gpfEventsFire.apply(enumerator,[event,{},eventsHandler]);},process;if(1<callback.length){process=function(event){if(gpf.events.EVENT_CONTINUE===event.type){if(!iEnumerator.moveNext(process)){return;}}else if(gpf.events.EVENT_STOP===event.type){return end(gpf.events.EVENT_STOPPED);}else if(gpf.events.EVENT_DATA!==event.type){return end(event.type);}callback(iEnumerator.current(),process);};if(iEnumerator.moveNext(process)){callback(iEnumerator.current(),process);}}else{process=function(event){if(gpf.events.EVENT_DATA!==event.type){return end(event.type);}do{callback(iEnumerator.current());}while(iEnumerator.moveNext(process));};while(iEnumerator.moveNext(process)){callback(iEnumerator.current());}}}}});function _gpfArrayEnumerator(array){var pos=-1;return{reset:function(){pos=-1;},moveNext:function(eventsHandler){var result;++pos;result=pos<array.length;if(!result&&eventsHandler){_gpfEventsFire.apply(this,[_GPF_EVENT_END_OF_DATA,{},eventsHandler]);}return result;},current:function(){if(0>pos||pos>=array.length){return undefined;}return array[pos];}};}function _buildEnumeratorOnObjectArray(object){var attributes=new _gpfA.Map(object).filter(_gpfA.EnumerableAttribute),members=attributes.members();return _gpfArrayEnumerator(object[members[0]]);}_gpfDefAttr("$Enumerable",_gpfA.ClassAttribute,{"Class":[gpf.$UniqueAttribute(),gpf.$MemberAttribute()],_alterPrototype:function(objPrototype){if(!_gpfIsArrayLike(objPrototype[this._member])){throw gpf.Error.EnumerableInvalidMember();}_gpfA.add(objPrototype.constructor,"Class",[new _gpfA.InterfaceImplementAttribute(_gpfI.IEnumerator,_buildEnumeratorOnObjectArray)]);}});_gpfDefIntrf("IReadOnlyArray",{getItemsCount:function(){return 0;},getItem:function(idx){_gpfIgnore(idx);return undefined;}});_gpfDefAttr("$ClassIArray",_gpfA.ClassAttribute,{"Class":[gpf.$UniqueAttribute(),gpf.$MemberAttribute()],private:{_writeAllowed:false},protected:{_alterPrototype:function(objPrototype){var implementedInterface;if(this._writeAllowed){implementedInterface=_gpfI.IArray;}else{implementedInterface=_gpfI.IReadOnlyArray;}_gpfA.add(objPrototype.constructor,"Class",[gpf.$InterfaceImplement(implementedInterface)]);objPrototype.getItemsCount=_gpfFunc("return this."+this._member+".length;");objPrototype.getItem=_gpfFunc(["_gpfArrayOrItem"],"return function (idx) { return _gpfArrayOrItem(this. "+this._member+", idx); }")(_gpfArrayOrItem);if(this._writeAllowed){objPrototype.setItem=_gpfFunc("var i=arguments[0],"+"v=this."+this._name+"[i];this."+this._member+"[i]=arguments[1];return v;");}}},public:{constructor:function(writeAllowed){if(writeAllowed){throw gpf.Error.NotImplemented();}}}});_gpfA.add(_gpfA.Array,"_array",[gpf.$ClassIArray(false)]);}));