"use strict";!function(){function a(a,b,c){for(var d in a)a.hasOwnProperty(d)&&b.call(c,a[d],d,a)}function b(a,b){this[b]=a}function c(c,d,e){return c.prototype=new d,a(e,function(d,e){"statics"===e?a(d,b,c):c.prototype[e]=d},c),c}function d(a,b){void 0===b&&(b="log"),console.expects&&console.expects(b,a,!0),console[b](a)}function e(a,b){j[a].call(this,b)}var f=function(){return"object"==typeof global?global:"undefined"!=typeof window?window:this}(),g=c(function(a,b){void 0!==b&&(this.parent=b,b.hasOwnProperty("children")||(b.children=[]),b.children.push(this)),this.label=a},Object,{parent:null,children:[],label:""}),h=c(function(a,b){g.call(this,a,b)},g,{before:[],beforeEach:[],afterEach:[],after:[],statics:{root:null,current:null,addCallback:function(a,b){var c=h.current;c.hasOwnProperty(a)||(c[a]=[]),c[a].push(b)}}}),i=c(function(a,b,c){g.call(this,a,c),this.callback=b},g,{callback:null,failureExpected:!1});a({describe:function(a,b){null===h.root&&(h.current=h.root=new h),h.current=new h(a,h.current),b(),h.current=h.current.parent},before:function(a){h.addCallback("before",a)},beforeEach:function(a){h.addCallback("beforeEach",a)},it:function(a,b,c){var d=new i(a,b,h.current);c&&(d.failureExpected=!0)},afterEach:function(a){h.addCallback("afterEach",a)},after:function(a){h.addCallback("after",a)},assert:function(a){if(!a)throw new Error("ASSERTION failed")},exit:function(a){0===a?d("exit(0)","log"):d("exit("+a+")","error")}},function(a,b){f[b]||(f[b]=a)});var j={describe:function(a){d(new Array(a.depth+1).join("\t")+a.label)},it:function(a){var b=new Array(a.depth+1).join("\t");if(b+=a.pending?"-- ":a.result?"OK ":"KO ",b+=a.label,d(b),!1===a.result&&a.exception)for(var c in a.exception)a.exception.hasOwnProperty(c)&&d(c+": "+a.exception[c])},results:function(a){d("--- Results: ");for(var b in a)a.hasOwnProperty(b)&&d(b+"        : ".substr(b.length)+a[b]);a.fail?(d("KO","error"),exit(a.fail)):(d("OK"),exit(0))}},k=c(function a(b,c){this._state=a.STATE_DESCRIBE_BEFORE,this._callback=b||e,this._timeoutDelay=c||a.DEFAULT_TIMEOUT_DELAY,this._describes=[],this._describe=h.root,this._nextChildIndexes=[],this._beforeEach=[],this._afterEach=[],this._runAt=new Date,this._statistics={count:0,success:0,fail:0,pending:0},this.next=this.next.bind(this)},Object,{_state:0,_callback:null,_timeoutDelay:0,_describes:[],_describe:null,_nextChildIndexes:[],_nextChildIndex:0,_pendingCallbacks:[],_pendingCallbacksType:"",_beforeEach:[],_afterEach:[],_runAt:null,_statistics:{},_monitorCallback:function(a,b,c){var d={runner:this,doneExpected:0<a.length,callbackCompleted:b,callbackContext:c,error:null,startDate:new Date,numberOfCall:0,timeoutId:null,complete:this._complete},e=this._done.bind(d);try{return this._secureCall(a,d,e)}catch(a){d.error=a,d.doneExpected=!1,this._processCallResult(null,d,e)}return!1},_done:function(a){++this.numberOfCall,1<this.numberOfCall&&(a={message:"Done function called "+this.numberOfCall+" times"}),1<this.numberOfCall||this.timeoutId?this.complete(a):this.error=a,1===this.numberOfCall&&this.timeoutId&&(clearTimeout(this.timeoutId),setTimeout(this.runner.next,0))},_complete:function(a){this.callbackCompleted.call(this.runner,this.callbackContext,this.startDate,a)},_secureCall:function(a,b,c){var d;return b.doneExpected&&(d=c),this._processCallResult(a(d),b,c)},_processCallResult:function(a,b,c){var d=k.isPromise(a);return d||b.doneExpected?1===b.numberOfCall?(b.complete(b.error),!1):!(0<b.numberOfCall)&&(b.timeoutId=setTimeout(function(){c({message:"Timeout exceeded"})},this._timeoutDelay),d&&this._attachToPromise(a,c),!0):(b.complete(b.error),c(),!1)},_attachToPromise:function(a,b){function c(){b()}function d(a){a||(a={message:"Promise rejected with no reason"}),f=a,b(a)}function e(a){a!==f&&b(a)}var f;a.then(c,d);var g=a.catch;g&&g.call(a,e)},_processItCallback:function(a){return this._monitorCallback(a.callback,this._itCallbackCompleted,a)},_itCallbackCompleted:function(a,b,c){a.failureExpected&&(c=c?null:{message:"Failure was expected"}),c?this._fail(a.label,b,c):this._success(a.label,b)},_fail:function(a,b,c){++this._statistics.fail,this._callback("it",{depth:this._describes.length,label:a,result:!1,timeSpent:new Date-b,exception:c})},_success:function(a,b){++this._statistics.success,this._callback("it",{depth:this._describes.length,label:a,result:!0,timeSpent:new Date-b})},_processCallback:function(a){return this._monitorCallback(a,this._callbackCompleted)},_callbackCompleted:function(a,b,c){c&&(this._fail("UNEXPECTED error during "+this._pendingCallbacksType+"?",b,c),this._nextChildIndex=this._describe.children.length,this._describes=[])},next:function(){for(var a=!0;a;){for(;this._pendingCallbacks.length;)if(this._processCallback(this._pendingCallbacks.shift()))return;a=this[this._state]()}},_onDescribeBefore:function(){var a=this._describe;return this._state=k.STATE_DESCRIBE_CHILDREN,this._pendingCallbacks=[].concat(a.before),this._pendingCallbacksType="before",!0},_onDescribeChildren:function(){var a=this._describe.children;if(this._nextChildIndex<a.length){var b=a[this._nextChildIndex++];b instanceof h?this._stackDescribe(b):b instanceof i&&(this._state=k.STATE_DESCRIBE_CHILDIT_BEFORE)}else this._state=k.STATE_DESCRIBE_AFTER;return!0},_stackDescribe:function(a){this._state=k.STATE_DESCRIBE_BEFORE,this._callback("describe",{depth:this._describes.length,label:a.label}),this._describes.push(this._describe),this._nextChildIndexes.push(this._nextChildIndex),this._beforeEach=this._beforeEach.concat(a.beforeEach),this._afterEach=a.afterEach.concat(this._afterEach),this._describe=a,this._nextChildIndex=0},_onItBefore:function(){return this._state=k.STATE_DESCRIBE_CHILDIT_EXECUTE,this._pendingCallbacks=[].concat(this._beforeEach),this._pendingCallbacksType="beforeEach",!0},_onItExecute:function(){this._state=k.STATE_DESCRIBE_CHILDIT_AFTER;var a=this._describe.children[this._nextChildIndex-1];return++this._statistics.count,a.callback?!this._processItCallback(a):(++this._statistics.pending,this._callback("it",{depth:this._describes.length,label:a.label,pending:!0}),!0)},_onItAfter:function(){return this._state=k.STATE_DESCRIBE_CHILDREN,this._pendingCallbacks=[].concat(this._afterEach),this._pendingCallbacksType="afterEach",!0},_onDescribeAfter:function(){var a=this._describe;return this._state=k.STATE_DESCRIBE_DONE,this._pendingCallbacks=[].concat(a.after),this._pendingCallbacksType="after",!0},_onDescribeDone:function(){return 0<this._describes.length?(this._unstackDescribe(),!0):(this._state=k.STATE_FINISHED,this._statistics.timeSpent=new Date-this._runAt,this._callback("results",this._statistics),!1)},_unstackDescribe:function(){this._state=k.STATE_DESCRIBE_CHILDREN;var a=this._describe;this._beforeEach=this._beforeEach.slice(0,this._beforeEach.length-a.beforeEach.length),this._afterEach=this._afterEach.slice(a.afterEach.length),this._describe=this._describes.pop(),this._nextChildIndex=this._nextChildIndexes.pop()},_onFinished:function(){return!1},statics:{STATE_DESCRIBE_BEFORE:"_onDescribeBefore",STATE_DESCRIBE_CHILDREN:"_onDescribeChildren",STATE_DESCRIBE_CHILDIT_BEFORE:"_onItBefore",STATE_DESCRIBE_CHILDIT_EXECUTE:"_onItExecute",STATE_DESCRIBE_CHILDIT_AFTER:"_onItAfter",STATE_DESCRIBE_AFTER:"_onDescribeAfter",STATE_DESCRIBE_DONE:"_onDescribeDone",STATE_FINISHED:"_onFinished",DEFAULT_TIMEOUT_DELAY:2e3,isPromise:function(a){return null!==a&&"object"==typeof a&&"function"==typeof a.then}}});f.run=function(a,b){var c=new k(a,b);c.next()}}(),describe("assert",function(){describe("gpf.assert",function(){it("does not accept no message",function(){var a;try{console.expects&&console.expects("warn",/.*/),gpf.assert(!0)}catch(b){a=b}assert(void 0!==a)}),[!0,42,"Hello World!",{}].forEach(function(a){it("does nothing on a truthy condition - "+typeof a+" ("+a.toString()+")",function(){gpf.assert(a,"It works")})}),[!1,0,"",void 0,null].forEach(function(a){var b;b=void 0===b?"undefined":null===b?"null":a.toString(),it("throws an exception on a falsy condition - "+typeof a+" ("+b+")",function(){var b;try{console.expects&&console.expects("warn",/.*/),gpf.assert(a,"It fails")}catch(a){b=a}assert(void 0!==b)})})}),describe("gpf.asserts",function(){it("works with a message / boolean dictionary",function(){gpf.asserts({"It works":!0,"It also works":!0})}),it("fails on first falsy",function(){var a;try{gpf.asserts({"It works":!0,"It fails":!1})}catch(b){a=b}assert(void 0!==a)})})}),describe("constants",function(){describe("gpf",function(){it("does not expose any 'private' member",function(){function a(b,c){var d,e;for(d in b)b.hasOwnProperty(d)&&(assert("_"!==d.charAt(0)),e=b[d],"object"==typeof e&&-1===c.indexOf(e)&&(c.push(e),a(e,c)))}a(gpf,[gpf,gpf.internals])}),it("should expose a version",function(){assert("function"==typeof gpf.version),assert("string"==typeof gpf.version());var a=gpf.version();assert(-1!==a.indexOf(".")),assert(null!==a.match(/[0-9]+\.[0-9]+d?/))}),it("should expose the host type",function(){assert("function"==typeof gpf.host),assert("string"==typeof gpf.host());var a=gpf.host();assert(-1!==[gpf.hosts.browser,gpf.hosts.nodejs,gpf.hosts.phantomjs,gpf.hosts.rhino,gpf.hosts.unknown,gpf.hosts.wscript].indexOf(a))}),describe("gpf.hosts enumeration",function(){["browser","nodejs","phantomjs","unknown","wscript"].forEach(function(a){it("declares gpf.hosts."+a,function(){assert(void 0!==gpf.hosts[a])})})})}),gpf.internals&&describe("(internal) _gpfIsUnsignedByte",function(){var a=gpf.internals._gpfIsUnsignedByte;gpf.forEach({0:!0,"-25":!1,128:!0,256:!1,255:!0},function(b,c){var d=parseInt(c,10);b?it("accepts "+c,function(){assert(!0===a(d))}):it("rejects "+c,function(){assert(!1===a(d))})})})}),describe("arraylike",function(){describe("gpf.isArrayLike",function(){it("checks if an object looks like an array",function(){assert(!0===gpf.isArrayLike([]))})})}),describe("foreach",function(){var a="Hello World!",b=[0,1,2,3,4,5,6,7,8,9],c={"number":1,"string":a,"null":null,"object":{member:"value"},"function":function(){return a}},d="number,string,null,object,function";describe("gpf.forEach",function(){it("enumerates array content",function(){var a=0,c=0;gpf.forEach(b,function(d,e,f){assert("number"==typeof e),assert(f===b),++a,c+=d}),assert(b.length===a),assert(45===c)}),it("transmits scope on array content",function(){var a,d=0,e=0;a=gpf.forEach(b,function(a,f,g){assert(this===c),assert("number"==typeof f),assert(g===b),++d,e+=a},c),assert(void 0===a),assert(b.length===d),assert(45===e)}),it("enumerates object content and handles null value",function(){var a=[],b=!0;gpf.forEach(c,function(d,e,f){assert("string"==typeof e),assert(f===c),a.push(e),"null"===e&&null!==d&&(b=!1)}),a=a.join(","),assert(d===a),assert(!0===b)}),it("transmits scope on object content",function(){var a=gpf.forEach(c,function(){assert(this===c)},c);assert(void 0===a)})})}),describe("string/capitalize",function(){gpf.internals&&describe("(internal) _gpfStringCapitalize",function(){var a=gpf.internals._gpfStringCapitalize;it("does nothing on empty string",function(){assert(""===a(""))}),it("uppercases the first letter",function(){assert("Word"===a("word")),assert("Two words"===a("two words")),assert("Two words"===a("Two words"))}),it("also handles accents",function(){assert("\xc9ric"===a("\xe9ric"))})})}),describe("string/replaceex",function(){gpf.internals&&describe("(internal) _gpfStringReplaceEx",function(){var a=gpf.internals._gpfStringReplaceEx;it("replaces strings recursively",function(){assert("add"===a("abc",{"a":"abc","b":"dc","c":""}))})})}),describe("string/escapefor",function(){gpf.internals&&describe("(internal) _gpfStringEscapeFor",function(){var a=gpf.internals._gpfStringEscapeFor;it("escapes for JavaScript",function(){assert('"abc\\r\\ndef"'===a("abc\r\ndef","javascript"))}),it("escapes for xml",function(){assert("&lt;a&amp;b&gt;"===a("<a&b>","xml"))}),it("escapes for html",function(){assert("&lt;a&amp;b:&eacute;&egrave;&ecirc;&aacute;&agrave;&gt;"===a("<a&b:\xe9\xe8\xea\xe1\xe0>","html"))})})}),describe("compatibility",function(){function a(a){var b=new Array(5);b[2]=void 0,b[3]=3,a.call(b,function(a,b){assert(2===b||3===b),2===b?assert(void 0===a):assert(3===a)})}function b(a,b,c){var d="must expose the method "+b;a instanceof Function?it(d,function(){assert("function"==typeof a[b])}):it(d+" through prototype",function(){assert("function"==typeof a[b]),assert(!a.hasOwnProperty(b))}),-1!==c&&it(d+" with an expected arity of "+c,function(){assert(a[b].length===c)})}function c(a){var b,c,d,e=a.sample,f=a.testMethod,g=a.label,h=a.methodName,i=e[h];it(g,function(){f(i)}),gpf.internals&&(b=gpf.internals._gpfCompatibility[a.type],c=a.isStatic?b.statics:b.methods,c&&(d=c[h]),d&&d!==i&&it(g+" (compatible)",function(){f(d)}))}function d(a,d,e){return function(){var f,h,i=g[a];f=!0===e.isStatic?i:new i,b(f,d,e.length);for(h in e)e.hasOwnProperty(h)&&"function"==typeof e[h]&&c({type:a,sample:f,methodName:d,isStatic:e.isStatic,label:h,testMethod:e[h]})}}function e(a){var b,c=f[a];for(b in c)c.hasOwnProperty(b)&&describe(b,d(a,b,c[b]))}var f={Array:{every:{length:1,"must return true when it goes over all items":function(a){var b,c=[1,2,3,-6,10],d=0;b=a.call(c,function(a){return d+=a,!0}),assert(!0===b),assert(10===d)},"must return false when it stops on a given item":function(a){var b,c=[1,2,3,-6,10],d=0;b=a.call(c,function(a){return a>0&&(d+=a,!0)}),assert(!1===b),assert(6===d)},"must iterate with a bound context":function(a){var b,c=[1,2,3,-6,10],d={sum:0,index:0};b=a.call(c,function(a,b){var c=this;return assert(c===d),c.index=b,a>0&&(c.sum+=a,!0)},d),assert(!1===b),assert(6===d.sum),assert(3===d.index)},"must ignore undefined members":a},filter:{length:1,"must filter":function(a){var b,c=[1,2,3,4,5];b=a.call(c,function(a){return a%2===0}),assert(2===b.length),assert(2===b[0]),assert(4===b[1])},"must filter with a bound context":function(a){var b,c=[1,2,3,4,5],d={};b=a.call(c,function(a){return assert(this===d),a%2===0},d),assert(2===b.length),assert(2===b[0]),assert(4===b[1])},"must ignore undefined members":a},forEach:{length:1,"must iterate":function(a){var b=[1,2,3],c=0;assert("function"==typeof b.forEach),assert(!b.hasOwnProperty("forEach")),a.call(b,function(a){c+=a}),assert(6===c)},"must iterate with a bound context":function(a){var b=[1,2,3],c={sum:0};a.call(b,function(a){this.sum+=a},c),assert(6===c.sum)},"must ignore undefined members":a},indexOf:{length:1,"must expose indexOf()":function(a){var b={},c=[1,2,3,b,"abc"];assert(-1===a.call(c,4)),assert(0===a.call(c,1)),assert(3===a.call(c,b)),assert(-1===a.call(c,{})),assert(4===a.call(c,"abc"))}},map:{length:1,"must map with a bound context":function(a){var b,c={},d=[1,2,3,c,"abc"];assert("function"==typeof d.map),assert(!d.hasOwnProperty("map")),b=a.call(d,function(a,b){return assert(this===c),assert(a===d[b]),b},c),assert(b.length===d.length),assert(0===b[0]),assert(4===b[4])},"must ignore undefined members":a},reduce:{length:1,"must reduce with no initial value":function(a){function b(a,b,e,f){return assert(c===f),assert(d===e),++d,a+b}var c=[0,1,2,3,4],d=1;assert(10===a.call(c,b))},"must reduce with intial value":function(a){function b(a,b,e,f){return assert(c===f),assert(d===e),++d,a+b}var c=[0,1,2,3,4],d=0;assert(20===a.call(c,b,10))}},from:{isStatic:!0,length:1,"works on arguments":function(a){function b(){return a.call(Array,arguments)}var c=b(1,2,3);assert(c instanceof Array),assert(3===c.length),assert(1===c[0]),assert(2===c[1]),assert(3===c[2])},"works on strings":function(a){var b=a.call(Array,"foo");assert(b instanceof Array),assert(3===b.length),assert("f"===b[0]),assert("o"===b[1]),assert("o"===b[2])},"supports callback mapping":function(a){var b=a.call(Array,[1,2,3],function(a){return a+a});assert(b instanceof Array),assert(3===b.length),assert(2===b[0]),assert(4===b[1]),assert(6===b[2])},"generates a sequence of numbers":function(a){var b=a.call(Array,{length:3},function(a,b){return b});assert(b instanceof Array),assert(3===b.length),assert(0===b[0]),assert(1===b[1]),assert(2===b[2])}},isArray:{isStatic:!0,length:1,"detects an array":function(a){assert(!0===a.call(Array,[]))},"rejects other objects":function(a){assert(!1===a.call(Array,{length:0}))}}},Function:{bind:{length:1,"must bind to a context":function(a){function b(a){assert(this===d),this.member=a}var c,d={member:null};c=a.call(b,d),c(!0),assert(!0===d.member),c.call({},!1),assert(!1===d.member)},"must return the same result":function(a){function b(a){return a}var c=a.call(b,{});assert(!1===c(!1)),assert(!0===c(!0))},"must preserve function signature":function(a){function b(a,b,c){return a+b+c}assert(3===b.length);var c=a.call(b,{});assert(3===c.length)},"must allow additional parameters binding":function(a){function b(a,b,c){return a+b+c}assert(3===b.length);var c=a.call(b,{},1);assert(2===c.length),assert(6===c(2,3))}}},Object:{create:{isStatic:!0,length:-1,"allows creating objects with a given prototype":function(a){var b=a.call(Object,{method:function(){return"myMethod"}});assert(!b.hasOwnProperty("method")),assert("function"==typeof b.method),assert("myMethod"===b.method())},"is compatible with instanceof":function(a){function b(){}b.prototype={a:function(){return"a"}};var c=a.call(Object,b.prototype);assert("a"===c.a()),assert(c instanceof b)},"allows inheritance and use of instanceof":function(a){function b(){}function c(){}b.prototype={a:function(){return"a"}},c.prototype=new b;var d=a.call(Object,c.prototype);assert("a"===d.a()),assert(d instanceof b),assert(d instanceof c)}},getPrototypeOf:{isStatic:!0,length:1,"returns prototype passed to Object.create":function(a){var b,c;b={a:function(){return"a"}},c=Object.create(b),assert(a.call(Object,c)===b)},"returns prototype from constructor":function(a){function b(){}b.prototype={constructor:b,a:function(){return"a"}};var c=new b;assert(a.call(Object,c)===b.prototype)}},keys:{isStatic:!0,length:1,"returns list of indexes of an array":function(a){var b=["a","b","c"],c=a.call(Object,b);assert(3===c.length),assert("0"===c[0]),assert("1"===c[1]),assert("2"===c[2])},"returns list of indexes of an array-like object":function(a){var b={0:"a",1:"b",2:"c"},c=a.call(Object,b);assert(3===c.length),assert(-1<c.indexOf("0")),assert(-1<c.indexOf("1")),assert(-1<c.indexOf("2"))},"returns list of indexes of an array like object with random key ordering":function(a){var b={100:"a",2:"b",7:"c"},c=a.call(Object,b);assert(3===c.length),assert(-1<c.indexOf("2")),assert(-1<c.indexOf("7")),assert(-1<c.indexOf("100"))},"returns list of own keys of an object":function(a){function b(){}b.prototype={a:0,b:1};var c,d=new b;d.c=2,c=a.call(Object,d),assert(1===c.length),assert("c"===c[0])}},values:{isStatic:!0,length:1,"returns list of values of an object":function(a){var b={foo:"bar",baz:42},c=a.call(Object,b);assert(2===c.length),assert(-1<c.indexOf("bar")),assert(-1<c.indexOf(42))},"returns list of values of an array-like object":function(a){var b={0:"a",1:"b",2:"c"},c=a.call(Object,b);assert(3===c.length),assert(-1<c.indexOf("a")),assert(-1<c.indexOf("b")),assert(-1<c.indexOf("c"))},"returns list of values of an array like object with random key ordering":function(a){var b={100:"a",2:"b",7:"c"},c=a.call(Object,b);assert(3===c.length),assert(-1<c.indexOf("a")),assert(-1<c.indexOf("b")),assert(-1<c.indexOf("c"))},"returns list of own values of an object":function(a){function b(){}b.prototype={a:0,b:1};var c,d=new b;d.c=2,c=a.call(Object,d),assert(1===c.length),assert(2===c[0])}}},String:{trim:{length:0,"must trim left and right":function(a){var b=" \t  abc\t \t";assert("abc"===a.call(b))}}},Date:{toISOString:{length:0,"converts to UTC string":function(a){var b=new Date("2003-01-22T22:45:00.000Z");assert("2003-01-22T22:45:00.000Z"===a.call(b))}}}},g={Array:Array,Function:Function,Object:Object,String:String,Date:Date};describe("Array",function(){describe("default support",function(){it("must allow building an array with a given size",function(){var a,b=new Array(5);for(assert(5===b.length),a=0;a<5;++a)assert(void 0===b[a]);assert("    "===b.join(" "))}),it("provides standard slice",function(){var a=["Banana","Orange","Lemon","Apple","Mango"],b=a.slice(1,3);assert(2===b.length),assert("Orange"===b[0]),assert("Lemon"===b[1])})}),e("Array")}),describe("Function",function(){describe("default support",function(){it("allows creating function with parameters",function(){var a=Function("value","return value;");assert("function"==typeof a),assert(1===a.length),assert(123===a(123))}),it("must detect undefined parameter",function(){function a(a){assert(arguments.length===a)}a(1),a(2,"abc"),a(2,void 0),a(3,void 0,void 0)})}),describe("name support",function(){if(it("exposes a name",function(){var a=Function,b=new a("return function funcName () {}")();assert("funcName"===b.compatibleName())}),it("supports empty name",function(){assert(""===function(){}.compatibleName())}),gpf.internals&&Function.prototype.compatibleName!==gpf.internals._gpfGetFunctionName){var a=gpf.internals._gpfGetFunctionName;it("exposes a name (compatible)",function(){function b(){}assert("thisName"===a.call(b))}),it("supports empty name",function(){var b=function(){};assert(""===a.call(b))})}}),e("Function")}),describe("Object",function(){e("Object")}),describe("String",function(){e("String")}),describe("Date",function(){describe("constructor",function(){it("accepts UTC string",function(){var a=new Date("2003-01-22T22:45:00.000Z");assert(2003===a.getUTCFullYear()),assert(0===a.getUTCMonth()),assert(22===a.getUTCDate()),assert(22===a.getUTCHours()),assert(45===a.getUTCMinutes()),assert(0===a.getUTCSeconds())}),it("accepts a date only",function(){var a=new Date("2003-01-22");assert(2003===a.getUTCFullYear()),assert(0===a.getUTCMonth()),assert(22===a.getUTCDate()),assert(0===a.getUTCHours()),assert(0===a.getUTCMinutes()),assert(0===a.getUTCSeconds())})}),e("Date"),gpf.internals&&(describe("(internal) _gpfIsISO8601String",function(){function a(a,c){var d;d=c?"accepts":"rejects",d+=' "'+a+'"',it(d,function(){var d=b(a);c?(assert(d),assert(d.length===c.length),c.forEach(function(a,b){assert(d[b]===a)})):assert(!d)})}var b=gpf.internals._gpfIsISO8601String,c={"2016-02-17T23:13:00.000Z":[2016,1,17,23,13,0,0],"2003-01-22T22:45:34.075Z":[2003,0,22,22,45,34,75],"2003-13-22T22:45:34.075Z":null,"2003-1-22T22:45:34.075Z":null,"2003-01-32T22:45:34.075Z":null,"2003-01-2T22:45:34.075Z":null,"2003-01-22T25:45:34.075Z":null,"2003-01-22T22:60:34.075Z":null,"2003-01-22T22:45:60.075Z":null,"2003-01-22T22:45:34":[2003,0,22,22,45,34,0],"2003-01-22 22:45:34":null,"2003-01-22T22:45:34.075":null,"2016-02-17":[2016,1,17,0,0,0,0],"2003-13-22":null,"2003-01-32":null};for(var d in c)c.hasOwnProperty(d)&&a(d,c[d]);[!0,!1,0,1,{},new Date].forEach(function(a){it("rejects other formats - "+typeof a+" ("+a.toString()+")",function(){assert(void 0===b(a))})})}),describe("(internal) _GpfDate()",function(){var a=gpf.internals._GpfDate;it("allocates a Date object",function(){var b=new a;assert(b instanceof Date)}),it("detects and leverage ISO 8601 format",function(){var b=new a("2003-01-22T22:45:34.075Z");assert(2003===b.getUTCFullYear()),assert(0===b.getUTCMonth()),assert(22===b.getUTCDate()),assert(22===b.getUTCHours()),assert(45===b.getUTCMinutes()),assert(34===b.getUTCSeconds()),assert(75===b.getUTCMilliseconds())}),it("detects and leverage ISO 8601 short format",function(){var b=new a("2003-01-22");assert(2003===b.getUTCFullYear()),assert(0===b.getUTCMonth()),assert(22===b.getUTCDate()),assert(0===b.getUTCHours()),assert(0===b.getUTCMinutes()),assert(0===b.getUTCSeconds()),assert(0===b.getUTCMilliseconds())})}))})}),describe("compatibility/array",function(){}),describe("factory",function(){gpf.internals&&describe("_gpfNewApply",function(){var a=gpf.internals._gpfNewApply;it("calls any constructor",function(){function b(){this.value=42}var c=a(b,[]);assert(c instanceof b),assert(42===c.value)}),it("forwards parameters",function(){var b=a(Array,[42]);assert(b instanceof Array),assert(42===b.length)}),it("adapts to a very long list of parameters",function(){var b=a(Array,[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]);assert(b instanceof Array),assert(15===b.length)})})}),describe("compatibility/date",function(){}),describe("compatibility/function",function(){}),describe("compatibility/object",function(){}),describe("compatibility/string",function(){}),describe("compatibility/promise",function(){function a(a){describe("simple usage",function(){it("waits for synchronous fulfilment",function(b){new a(function(a){assert("function"==typeof a),a("ok")}).then(function(a){assert("ok"===a),b()}).catch(function(a){b(a)})}),it("waits for asynchronous fulfilment",function(b){new a(function(a){assert("function"==typeof a),setTimeout(function(){a("ok")},0)}).then(function(a){assert("ok"===a),b()}).catch(function(a){b(a)})}),it("waits for synchronous rejection (rejection handler)",function(b){var c=!1;new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),b("ko")}).then(function(){c=!0},function(a){assert(!1===c),assert("ko"===a),b()}).catch(function(a){b(a)})}),it("waits for asynchronous rejection (rejection handler)",function(b){var c=!1;new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),setTimeout(function(){b("ko")},0)}).then(function(){c=!0},function(a){assert(!1===c),assert("ko"===a),b()}).catch(function(a){b(a)})}),it("waits for synchronous rejection (catch handler)",function(b){new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),b("ko")}).then(function(){assert(!1)}).catch(function(a){try{assert("ko"===a),b()}catch(a){b(a)}})}),it("waits for asynchronous rejection (catch handler)",function(b){new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),setTimeout(function(){b("ko")},0)}).then(function(){assert(!1)}).catch(function(a){try{assert("ko"===a),b()}catch(a){b(a)}})}),it("rejects automatically on exception",function(b){new a(function(a,b){throw assert("function"==typeof a),assert("function"==typeof b),new Error("ko")}).then(function(){assert(!1)},function(a){assert(a instanceof Error),assert("ko"===a.message),b()}).catch(function(a){b(a)})}),it("catches exception from the fulfilment handler",function(b){new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),setTimeout(function(){a("ok")},0)}).then(function(a){throw assert("ok"===a),new Error("ko")}).catch(function(a){try{assert(a instanceof Error),assert("ko"===a.message),b()}catch(a){b(a)}})}),it("catches exception from the rejection handler",function(b){new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),setTimeout(function(){b("ko")},0)}).then(function(){assert(!1)},function(a){throw assert("ko"===a),new Error("ko")}).catch(function(a){try{assert(a instanceof Error),assert("ko"===a.message),b()}catch(a){b(a)}})})}),describe("shortcuts",function(){it("offers Promise.resolve",function(b){a.resolve("ok").then(function(a){assert("ok"===a),b()},function(){assert(!1)}).catch(function(a){b(a)})}),it("offers Promise.reject",function(b){a.reject("ko").then(function(){assert(!1)},function(a){assert("ko"===a),b()}).catch(function(a){b(a)})})}),describe("chaining",function(){it("chains by passing results from one handler to the other",function(b){new a(function(a){a("ok 1")}).then(function(a){return assert("ok 1"===a),"ok 2"}).then(void 0,function(a){b(a)}).then(function(a){return assert("ok 2"===a),"ok 3"}).then(function(a){return assert("ok 3"===a),"ok 4"}).then(function(a){assert("ok 4"===a),b()}).catch(function(a){b(a)})}),it("chains by returning a promise in the fulfilment handler",function(b){new a(function(a){a("ok 1")}).then(function(b){return assert("ok 1"===b),a.resolve("ok 2")}).then(function(b){return assert("ok 2"===b),new a(function(a){setTimeout(function(){a("ok 3")},0)})}).then(function(a){assert("ok 3"===a),b()}).catch(function(a){b(a)})}),it("stops on first error",function(b){new a(function(a){a("ok 1")}).then(function(a){return assert("ok 1"===a),"ok 2"}).then(function(a){throw assert("ok 2"===a),new Error("ko")}).then(function(){assert(!1)}).catch(function(a){try{assert(a instanceof Error),assert("ko"===a.message),b()}catch(a){b(a)}})})}),describe("synchronisation",function(){describe("Promise.all",function(){it("succeeds with an empty array",function(b){a.all([]).then(function(a){assert(0===a.length),b()}).catch(function(a){b(a)})}),it("works with one promise",function(b){a.all([a.resolve("ok")]).then(function(a){assert(1===a.length),assert("ok"===a[0]),b()}).catch(function(a){b(a)})}),it("waits for all promises to be resolved",function(b){var c,d=[];for(c=0;c<10;++c)d.push(a.resolve(c));a.all(d).then(function(a){assert(45===a.reduce(function(a,b){return a+b})),b()}).catch(function(a){b(a)})}),it("fails on the first error",function(b){function c(b){return 0===b%2?a.reject(b):a.resolve(b)}var d,e=[];for(d=0;d<10;++d)e.push(c(d));a.all(e).then(function(){assert(!1)}).catch(function(a){try{assert("number"==typeof a),assert(a<10),b()}catch(a){b(a)}})})}),describe("Promise.race",function(){it("waits for the first promise that is resolved",function(b){function c(b){return new a(function(a){setTimeout(function(){a(b)},20*(10-b))})}var d,e=[];for(d=0;d<10;++d)e.push(c(d));a.race(e).then(function(a){assert(9===a),b()}).catch(function(a){b(a)})}),it("waits for the first promise that is resolved or rejected",function(b){function c(b){return new a(function(a,c){5===b?setTimeout(function(){c(b)},20):setTimeout(function(){a(b)},50)})}var d,e=[];for(d=0;d<10;++d)e.push(c(d));a.race(e).then(function(){assert(!1)}).catch(function(a){try{assert("number"==typeof a),assert(5===a),b()}catch(a){b(a)}})})})}),describe("branching",function(){it("supports different branches",function(b){var c={};c.promise=new a(function(a,b){c.resolve=a,c.reject=b});var d=c.promise.then(function(a){return a+1}).then(function(a){return a+2}).then(function(a){return a+3}),e=c.promise.then(function(a){return 2*a}).then(function(a){return 3*a});a.all([d,e]).then(function(a){assert(7===a[0]),assert(6===a[1]),b()}).catch(function(a){b(a)}),c.resolve(1)})})}describe("Promise",function(){a(Promise)}),gpf.internals&&Promise!==gpf.internals._GpfPromise&&describe("(internal) _GpfPromise",function(){a(gpf.internals._GpfPromise)})}),describe("compatibility/timeout",function(){function a(a){var b=10,c=50,d=20;return function(){function e(a){if(-1!==s.indexOf(a))throw new Error("Denied");if(-1===r.indexOf(a))throw new Error("Not allowed")}function f(){if(p)throw new Error("Already triggered");if(!0!==o)throw new Error("Triggered too soon (synchronousFlag should be true)")}function g(c,d){var e=new Date-c;if(a.checkDelay&&e<d&&d-e>b)throw new Error("Triggered too soon ("+e+" does not respect the timeout delay of "+d+")")}function h(a,b,c){void 0===q&&console.error("Unexpected callback triggered when callbackDone is undefined"),e(a),f(),g(b,c),s.push(a)}function i(a){try{h(a,n,c),o=!1,p=!0,q()}catch(a){q(a)}}function j(b){s.push(b),a.clearTimeout(b)}function k(a){-1===s.indexOf(a)&&-1===r.indexOf(a)&&j(a)}function l(){m&&j(m),p=!1,n=new Date;var b=a.setTimeout(function(){i(b),m=void 0},c);m=b,o=!0}var m,n,o,p,q,r=[],s=[];beforeEach(function(){l()}),it("allocates a timeout id",function(){assert(void 0!==m)}),afterEach(function(){k(m)}),describe("clearing",function(){beforeEach(function(){s.push(m),a.clearTimeout(m)}),it("removes the callback from the queue",function(){a.handleTimeout()}),describe("again",function(){beforeEach(function(){a.clearTimeout(m)}),it("does not fail",function(){a.handleTimeout()})})}),describe("triggering",function(){beforeEach(function(b){r.push(m),q=b,a.handleTimeout()}),it("executes the callback from the queue",function(){assert(!0===p)}),it("removes the callback from the queue",function(){a.handleTimeout()})}),describe("sequencing with a second timeout",function(){function b(a){try{h(a,g,d),q()}catch(a){q(a)}}function e(a,b){r.push(f),r.push(m);var c=0;q=function(d){
d?a(d):b===++c&&a()}}var f,g;beforeEach(function(){g=new Date,l();var c=a.setTimeout(function(){b(c)},d);f=c}),it("allocates a different timeout id",function(){assert(void 0!==f),assert(f!==m)}),afterEach(function(){k(f)}),describe("clearing the second timeout",function(){beforeEach(function(){s.push(f),a.clearTimeout(f)}),describe("triggering",function(){beforeEach(function(b){r.push(m),q=b,a.handleTimeout()}),it("executes the remaining callback from the queue",function(){assert(!0===p)}),it("removes all callbacks from the queue",function(){a.handleTimeout()})})}),describe("creating and cleaning a third timeout",function(){it("prevents execution",function(b){e(b,3);var d=a.setTimeout(function(){q(new Error("The third timeout was triggered"))},10*c);a.clearTimeout(d),a.handleTimeout(),q()})}),describe("triggering",function(){beforeEach(function(b){e(b,2),a.handleTimeout()}),it("executes the callbacks from the queue",function(){assert(!0===p)}),it("removed all callbacks from the queue",function(){a.handleTimeout()})})})}}describe("exposed API",a({checkDelay:!0,setTimeout:function(a,b){return setTimeout(a,b)},clearTimeout:function(a){clearTimeout(a)},handleTimeout:function(){}})),gpf.internals&&setTimeout!==gpf.internals._gpSetTimeoutPolyfill&&describe("(internal)",a({checkDelay:!1,setTimeout:gpf.internals._gpSetTimeoutPolyfill,clearTimeout:gpf.internals._gpfClearTimeoutPolyfill,handleTimeout:gpf.internals._gpfHandleTimeout}))}),describe("compatibility/json",function(){function a(b,c){var d=typeof b;return d===typeof c&&("object"===d&&b&&c?Object.keys(b).every(function(d){return c.hasOwnProperty(d)&&a(b[d],c[d])}):b===c)}var b=[{label:"empty object",obj:{},json:"{}"},{label:"simple string property",obj:{a:"123"},json:'{"a":"123"}'},{label:"simple number property",obj:{a:123},json:'{"a":123}'},{label:"simple boolean properties",obj:{a:!0,b:!1},json:'{"a":true,"b":false}'},{label:"mixed simple properties",obj:{a:"123",b:123,c:!0,d:{}},json:'{"a":"123","b":123,"c":true,"d":{}}'},{label:"function",obj:{a:123,b:function(){}},json:'{"a":123}',parse:!1},{label:"array",obj:{a:[1,2,3]},json:'{"a":[1,2,3]}'},{label:"null",obj:{a:null},json:'{"a":null}'}];describe("JSON object",function(){it("exists",function(){assert("undefined"!=typeof JSON)})}),describe("JSON.stringify",function(){b.forEach(function(a){it("works on "+a.label,function(){assert(JSON.stringify(a.obj)===a.json)})})}),describe("JSON.parse",function(){b.forEach(function(b){!1!==b.parse&&it("works on "+b.label,function(){var c=JSON.parse(b.json);assert(!0===a(c,b.obj))})})}),gpf.internals&&describe("(internal)",function(){describe("_gpfJsonStringifyPolyfill",function(){b.forEach(function(a){it("works on "+a.label,function(){assert(gpf.internals._gpfJsonStringifyPolyfill(a.obj)===a.json)})})}),describe("_gpfJsonParsePolyfill",function(){b.forEach(function(b){!1!==b.parse&&it("works on "+b.label,function(){var c=gpf.internals._gpfJsonParsePolyfill(b.json);assert(!0===a(c,b.obj))})})})})}),describe("context",function(){describe("gpf.context",function(){it("resolves the global context",function(){if(assert("function"==typeof gpf.context),assert(null!==gpf.context()),gpf.hosts.browser===gpf.host())assert(window===gpf.context());else if(gpf.hosts.nodejs===gpf.host()||gpf.hosts.phantomjs===gpf.host())assert(global===gpf.context());else{var a=function(){return this}();assert(a===gpf.context())}}),it("resolves gpf",function(){assert(gpf===gpf.context("gpf"))}),it("resolves any symbol",function(){assert(gpf.context===gpf.context("gpf.context"))}),it("returns undefined if not existing",function(){assert(void 0===gpf.context("gpf.not-existing"))}),it("returns undefined if not existing (deep dive)",function(){assert(void 0===gpf.context("gpf.not-existing.really-not"))})}),gpf.internals&&describe("_gpfContext",function(){var a=gpf.internals._gpfContext;it("can build a context",function(){var b=gpf.context(),c={};b.testContextJS=c;var d=a(["testContextJS","folder","name"],!0);assert(b.testContextJS===c),assert(b.testContextJS.folder.name===d),delete b.testContextJS})})}),describe("extend",function(){describe("gpf.extend",function(){it("extends objects members",function(){var a={"member1":"member1","member2":2},b={"newMember":!0},c=gpf.extend(a,b);assert(c===a),assert("member1"===c.member1),assert(2===c.member2),assert(c.newMember===!0),assert(b.newMember===!0)}),it("overwrites existing members",function(){var a={"member1":"member1"},b={"member1":!1},c=gpf.extend(a,b);assert(c.member1===!1)}),it("supports more than one source parameter",function(){var a={"member1":"member1","member2":2},b=gpf.extend(a,{"source1":1,"member1":"member1.1"},{"source2":2,"member1":"member1.2"});assert("member1.2"===b.member1),assert(2===b.member2),assert(1===b.source1),assert(2===b.source2)})})}),describe("error",function(){describe("gpf.Error",function(){it("is used as an exception",function(){var a;try{gpf.Error.abstractMethod()}catch(b){a=b}assert(a instanceof Error),assert(a instanceof gpf.Error),assert(a instanceof gpf.Error.AbstractMethod),assert(a.constructor===gpf.Error.AbstractMethod)}),it("is documented",function(){var a;try{gpf.Error.abstractMethod()}catch(b){a=b}assert(a.code===gpf.Error.CODE_ABSTRACTMETHOD),assert(a.code===gpf.Error.abstractMethod.CODE),assert("abstractMethod"===a.name),assert("Abstract method"===a.message)}),it("can use substitution for message",function(){var a;try{gpf.Error.assertionFailed({message:"Test"})}catch(b){a=b}assert(a instanceof gpf.Error.AssertionFailed),assert(a.code===gpf.Error.CODE_ASSERTIONFAILED),assert(a.code===gpf.Error.assertionFailed.CODE),assert("assertionFailed"===a.name),assert("Assertion failed: Test"===a.message)})})});