"use strict";!function(){function a(a,b,c){for(var d in a)a.hasOwnProperty(d)&&b.apply(c,[a[d],d,a])}function b(a,b){this[b]=a}function c(c,d,e){return c.prototype=new d,a(e,function(d,e){"statics"===e?a(d,b,c):c.prototype[e]=d},c),c}function d(a,b){void 0===b&&(b="log"),console.expects&&console.expects(b,a,!0),console[b](a)}function e(a,b){j[a].apply(this,[b])}var f=function(){return"object"==typeof global?global:"undefined"!=typeof window?window:this}(),g=c(function(a,b){void 0!==b&&(this.parent=b,b.hasOwnProperty("children")||(b.children=[]),b.children.push(this)),this.label=a},Object,{parent:null,children:[],label:""}),h=c(function(){g.apply(this,arguments)},g,{before:[],beforeEach:[],afterEach:[],after:[],statics:{root:null,current:null,addCallback:function(a,b){var c=h.current;c.hasOwnProperty(a)||(c[a]=[]),c[a].push(b)}}}),i=c(function(a,b,c){g.apply(this,[a,c]),this.callback=b},g,{callback:null,failureExpected:!1});a({describe:function(a,b){null===h.root&&(h.current=h.root=new h),h.current=new h(a,h.current),b(),h.current=h.current.parent},before:function(a){h.addCallback("before",a)},beforeEach:function(a){h.addCallback("beforeEach",a)},it:function(a,b,c){var d=new i(a,b,h.current);c&&(d.failureExpected=!0)},afterEach:function(a){h.addCallback("afterEach",a)},after:function(a){h.addCallback("after",a)},assert:function(a){if(!a)throw new Error("ASSERTION failed")},exit:function(a){0===a?d("exit(0)","log"):d("exit("+a+")","error")}},function(a,b){f[b]||(f[b]=a)});var j={describe:function(a){d(new Array(a.depth+1).join("	")+a.label)},it:function(a){var b=new Array(a.depth+1).join("	");if(b+=a.pending?"-- ":a.result?"OK ":"KO ",b+=a.label,d(b),!1===a.result&&a.exception)for(var c in a.exception)a.exception.hasOwnProperty(c)&&d(c+": "+a.exception[c])},results:function(a){d("--- Results: ");for(var b in a)a.hasOwnProperty(b)&&d(b+"        : ".substr(b.length)+a[b]);a.fail?(d("KO","error"),exit(a.fail)):(d("OK"),exit(0))}},k=c(function l(a,b){this._state=l.STATE_DESCRIBE_BEFORE,this._callback=a||e,this._timeoutDelay=b||l.DEFAULT_TIMEOUT_DELAY,this._describes=[],this._describe=h.root,this._nextChildIndexes=[],this._beforeEach=[],this._afterEach=[],this._runAt=new Date,this._statistics={count:0,success:0,fail:0,pending:0},this.next=this.next.bind(this)},Object,{_state:0,_callback:null,_timeoutDelay:0,_describes:[],_describe:null,_nextChildIndexes:[],_nextChildIndex:0,_pendingCallbacks:[],_beforeEach:[],_afterEach:[],_runAt:null,_statistics:{},_monitorCallback:function(a,b,c){var d,e={runner:this,doneExpected:0<a.length,callbackCompleted:b,callbackContext:c,error:null,startDate:new Date,numberOfCall:0,timeoutId:null,complete:this._complete};try{return d=this._done.bind(e),this._secureCall(a,e,d)}catch(f){e.error=f,e.doneExpected=!1,this._processCallResult(null,e,d)}return!1},_done:function(a){++this.numberOfCall,1<this.numberOfCall&&(a={message:"Done function called "+this.numberOfCall+" times"}),1<this.numberOfCall||this.timeoutId?this.complete(a):this.error=a,1===this.numberOfCall&&this.timeoutId&&(clearTimeout(this.timeoutId),setTimeout(this.runner.next,0))},_complete:function(a){this.callbackCompleted.apply(this.runner,[this.callbackContext,this.startDate,a])},_secureCall:function(a,b,c){var d;return b.doneExpected&&(d=c),this._processCallResult(a(d),b,c)},_processCallResult:function(a,b,c){var d=k.isPromise(a);return d||b.doneExpected?1===b.numberOfCall?(b.complete(b.error),!1):0<b.numberOfCall?!1:(b.timeoutId=setTimeout(function(){c({message:"Timeout exceeded"})},this._timeoutDelay),d&&this._attachToPromise(a,c),!0):(b.complete(b.error),c(),!1)},_attachToPromise:function(a,b){function c(){b()}function d(a){a||(a={message:"Promise rejected with no reason"}),f=a,b(a)}function e(a){a!==f&&b(a)}var f;a.then(c,d);var g=a["catch"];g&&g.apply(a,[e])},_processItCallback:function(a){return this._monitorCallback(a.callback,this._itCallbackCompleted,a)},_itCallbackCompleted:function(a,b,c){a.failureExpected&&(c=c?null:{message:"Failure was expected"}),c?this._fail(a.label,b,c):this._success(a.label,b)},_fail:function(a,b,c){++this._statistics.fail,this._callback("it",{depth:this._describes.length,label:a,result:!1,timeSpent:new Date-b,exception:c})},_success:function(a,b){++this._statistics.success,this._callback("it",{depth:this._describes.length,label:a,result:!0,timeSpent:new Date-b})},_processCallback:function(a,b){return this._monitorCallback(b,this._callbackCompleted,a)},_callbackCompleted:function(a,b,c){c&&(this._fail("UNEXPECTED error during "+a+"?",b,c),this._nextChildIndex=this._describe.children.length,this._describes=[])},next:function(){for(var a=!0;a;){for(;this._pendingCallbacks.length;)if(this._processCallback(k.CALLBACKS_TYPE[this._state],this._pendingCallbacks.shift()))return;a=this[this._state]()}},_onDescribeBefore:function(){var a=this._describe;return this._state=k.STATE_DESCRIBE_CHILDREN,this._pendingCallbacks=[].concat(a.before),!0},_onDescribeChildren:function(){var a=this._describe.children;if(this._nextChildIndex<a.length){var b=a[this._nextChildIndex++];b instanceof h?this._stackDescribe(b):b instanceof i&&(this._state=k.STATE_DESCRIBE_CHILDIT_BEFORE)}else this._state=k.STATE_DESCRIBE_AFTER;return!0},_stackDescribe:function(a){this._state=k.STATE_DESCRIBE_BEFORE,this._callback("describe",{depth:this._describes.length,label:a.label}),this._describes.push(this._describe),this._nextChildIndexes.push(this._nextChildIndex),this._beforeEach=this._beforeEach.concat(a.beforeEach),this._afterEach=a.afterEach.concat(this._afterEach),this._describe=a,this._nextChildIndex=0},_onItBefore:function(){return this._state=k.STATE_DESCRIBE_CHILDIT_EXECUTE,this._pendingCallbacks=[].concat(this._beforeEach),!0},_onItExecute:function(){this._state=k.STATE_DESCRIBE_CHILDIT_AFTER;var a=this._describe.children[this._nextChildIndex-1];return++this._statistics.count,a.callback?!this._processItCallback(a):(++this._statistics.pending,this._callback("it",{depth:this._describes.length,label:a.label,pending:!0}),!0)},_onItAfter:function(){return this._state=k.STATE_DESCRIBE_CHILDREN,this._pendingCallbacks=[].concat(this._afterEach),!0},_onDescribeAfter:function(){var a=this._describe;return this._state=k.STATE_DESCRIBE_DONE,this._pendingCallbacks=[].concat(a.after),!0},_onDescribeDone:function(){return 0<this._describes.length?(this._unstackDescribe(),!0):(this._state=k.STATE_FINISHED,this._statistics.timeSpent=new Date-this._runAt,this._callback("results",this._statistics),!1)},_unstackDescribe:function(){this._state=k.STATE_DESCRIBE_CHILDREN;var a=this._describe;this._beforeEach=this._beforeEach.slice(0,this._beforeEach.length-a.beforeEach.length),this._afterEach=this._afterEach.slice(a.afterEach.length),this._describe=this._describes.pop(),this._nextChildIndex=this._nextChildIndexes.pop()},_onFinished:function(){return!1},statics:{STATE_DESCRIBE_BEFORE:"_onDescribeBefore",STATE_DESCRIBE_CHILDREN:"_onDescribeChildren",STATE_DESCRIBE_CHILDIT_BEFORE:"_onItBefore",STATE_DESCRIBE_CHILDIT_EXECUTE:"_onItExecute",STATE_DESCRIBE_CHILDIT_AFTER:"_onItAfter",STATE_DESCRIBE_AFTER:"_onDescribeAfter",STATE_DESCRIBE_DONE:"_onDescribeDone",STATE_FINISHED:"_onFinished",DEFAULT_TIMEOUT_DELAY:2e3,CALLBACKS_TYPE:{_onDescribeBefore:"before",_onItBefore:"beforeEach",_onItAfter:"afterEach",_onDescribeAfter:"after"},isPromise:function(a){return null!==a&&"object"==typeof a&&"function"==typeof a.then}}});f.run=function(a,b){var c=new k(a,b);c.next()}}(),describe("compatibility/array",function(){}),describe("compatibility/date",function(){}),describe("compatibility/function",function(){}),describe("compatibility/object",function(){}),describe("compatibility/string",function(){}),describe("compatibility/promise",function(){function a(a){describe("simple usage",function(){it("waits for synchronous fulfilment",function(b){new a(function(a){assert("function"==typeof a),a("ok")}).then(function(a){assert("ok"===a),b()})["catch"](function(a){b(a)})}),it("waits for asynchronous fulfilment",function(b){new a(function(a){assert("function"==typeof a),setTimeout(function(){a("ok")},0)}).then(function(a){assert("ok"===a),b()})["catch"](function(a){b(a)})}),it("waits for synchronous rejection (rejection handler)",function(b){var c=!1;new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),b("ko")}).then(function(){c=!0},function(a){assert(!1===c),assert("ko"===a),b()})["catch"](function(a){b(a)})}),it("waits for asynchronous rejection (rejection handler)",function(b){var c=!1;new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),setTimeout(function(){b("ko")},0)}).then(function(){c=!0},function(a){assert(!1===c),assert("ko"===a),b()})["catch"](function(a){b(a)})}),it("waits for synchronous rejection (catch handler)",function(b){new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),b("ko")}).then(function(){assert(!1)})["catch"](function(a){try{assert("ko"===a),b()}catch(c){b(c)}})}),it("waits for asynchronous rejection (catch handler)",function(b){new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),setTimeout(function(){b("ko")},0)}).then(function(){assert(!1)})["catch"](function(a){try{assert("ko"===a),b()}catch(c){b(c)}})}),it("rejects automatically on exception",function(b){new a(function(a,b){throw assert("function"==typeof a),assert("function"==typeof b),new Error("ko")}).then(function(){assert(!1)},function(a){assert(a instanceof Error),assert("ko"===a.message),b()})["catch"](function(a){b(a)})}),it("catches exception from the fulfilment handler",function(b){new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),setTimeout(function(){a("ok")},0)}).then(function(a){throw assert("ok"===a),new Error("ko")})["catch"](function(a){try{assert(a instanceof Error),assert("ko"===a.message),b()}catch(c){b(c)}})}),it("catches exception from the rejection handler",function(b){new a(function(a,b){assert("function"==typeof a),assert("function"==typeof b),setTimeout(function(){b("ko")},0)}).then(function(){assert(!1)},function(a){throw assert("ko"===a),new Error("ko")})["catch"](function(a){try{assert(a instanceof Error),assert("ko"===a.message),b()}catch(c){b(c)}})})}),describe("shortcuts",function(){it("offers Promise.resolve",function(b){a.resolve("ok").then(function(a){assert("ok"===a),b()},function(){assert(!1)})["catch"](function(a){b(a)})}),it("offers Promise.reject",function(b){a.reject("ko").then(function(){assert(!1)},function(a){assert("ko"===a),b()})["catch"](function(a){b(a)})})}),describe("chaining",function(){it("chains by passing results from one handler to the other",function(b){new a(function(a){a("ok 1")}).then(function(a){return assert("ok 1"===a),"ok 2"}).then(void 0,function(a){b(a)}).then(function(a){return assert("ok 2"===a),"ok 3"}).then(function(a){return assert("ok 3"===a),"ok 4"}).then(function(a){assert("ok 4"===a),b()})["catch"](function(a){b(a)})}),it("chains by returning a promise in the fulfilment handler",function(b){new a(function(a){a("ok 1")}).then(function(b){return assert("ok 1"===b),a.resolve("ok 2")}).then(function(b){return assert("ok 2"===b),new a(function(a){setTimeout(function(){a("ok 3")},0)})}).then(function(a){assert("ok 3"===a),b()})["catch"](function(a){b(a)})}),it("stops on first error",function(b){new a(function(a){a("ok 1")}).then(function(a){return assert("ok 1"===a),"ok 2"}).then(function(a){throw assert("ok 2"===a),new Error("ko")}).then(function(){assert(!1)})["catch"](function(a){try{assert(a instanceof Error),assert("ko"===a.message),b()}catch(c){b(c)}})})}),describe("synchronisation",function(){describe("Promise.all",function(){it("succeeds with an empty array",function(b){a.all([]).then(function(a){assert(0===a.length),b()})["catch"](function(a){b(a)})}),it("works with one promise",function(b){a.all([a.resolve("ok")]).then(function(a){assert(1===a.length),assert("ok"===a[0]),b()})["catch"](function(a){b(a)})}),it("waits for all promises to be resolved",function(b){var c,d=[];for(c=0;10>c;++c)d.push(a.resolve(c));a.all(d).then(function(a){assert(45===a.reduce(function(a,b){return a+b})),b()})["catch"](function(a){b(a)})}),it("fails on the first error",function(b){function c(b){return 0===b%2?a.reject(b):a.resolve(b)}var d,e=[];for(d=0;10>d;++d)e.push(c(d));a.all(e).then(function(){assert(!1)})["catch"](function(a){try{assert("number"==typeof a),assert(10>a),b()}catch(c){b(c)}})})}),describe("Promise.race",function(){it("waits for the first promise that is resolved",function(b){function c(b){return new a(function(a){setTimeout(function(){a(b)},10*(10-b))})}var d,e=[];for(d=0;10>d;++d)e.push(c(d));a.race(e).then(function(a){assert(9===a),b()})["catch"](function(a){b(a)})}),it("waits for the first promise that is resolved or rejected",function(b){function c(b){return new a(function(a,c){5===b?setTimeout(function(){c(b)},10):setTimeout(function(){a(b)},20)})}var d,e=[];for(d=0;10>d;++d)e.push(c(d));a.race(e).then(function(){assert(!1)})["catch"](function(a){try{assert("number"==typeof a),assert(5===a),b()}catch(c){b(c)}})})})}),describe("branching",function(){it("supports different branches",function(b){var c={};c.promise=new a(function(a,b){c.resolve=a,c.reject=b});var d=c.promise.then(function(a){return a+1}).then(function(a){return a+2}).then(function(a){return a+3}),e=c.promise.then(function(a){return 2*a}).then(function(a){return 3*a});a.all([d,e]).then(function(a){assert(7===a[0]),assert(6===a[1]),b()})["catch"](function(a){b(a)}),c.resolve(1)})})}describe("Promise",function(){a(Promise)}),gpf.internals&&Promise!==gpf.internals._GpfPromise&&describe("(internal) _GpfPromise",function(){a(gpf.internals._GpfPromise)})}),describe("compatibility",function(){function a(a,b,c){var d="should expose the method "+b;a instanceof Function?it(d,function(){assert("function"==typeof a[b])}):it(d+" through prototype",function(){assert("function"==typeof a[b]),assert(!a.hasOwnProperty(b))}),-1!==c&&it(d+" with an expected arity of "+c,function(){assert(a[b].length===c)})}function b(a){var b,c,d,e=a.sample,f=a.testMethod,g=a.label,h=a.methodName,i=e[h];it(g,function(){f(i)}),gpf.internals&&(b=gpf.internals._gpfCompatibility[a.type],c=a.isStatic?b.statics:b.methods,c&&(d=c[h]),d&&d!==i&&it(g+" (compatible)",function(){f(d)}))}function c(c,d,e){return function(){var g,h,i=f[c];g=!0===e.isStatic?i:new i,a(g,d,e.length);for(h in e)e.hasOwnProperty(h)&&"function"==typeof e[h]&&b({type:c,sample:g,methodName:d,isStatic:e.isStatic,label:h,testMethod:e[h]})}}function d(a){var b,d=e[a];for(b in d)d.hasOwnProperty(b)&&describe(b,c(a,b,d[b]))}var e={Array:{every:{length:1,"should return true when it goes over all items":function(a){var b,c=[1,2,3,-6,10],d=0;b=a.apply(c,[function(a){return d+=a,!0}]),assert(!0===b),assert(10===d)},"should return false when it stops on a given item":function(a){var b,c=[1,2,3,-6,10],d=0;b=a.apply(c,[function(a){return a>0?(d+=a,!0):!1}]),assert(!1===b),assert(6===d)},"should iterate with a bound context":function(a){var b,c=[1,2,3,-6,10],d={sum:0,index:0};b=a.apply(c,[function(a,b){var c=this;return assert(c===d),c.index=b,a>0?(c.sum+=a,!0):!1},d]),assert(!1===b),assert(6===d.sum),assert(3===d.index)}},filter:{length:1,"should filter":function(a){var b,c=[1,2,3,4,5];b=a.apply(c,[function(a){return a%2===0}]),assert(2===b.length),assert(2===b[0]),assert(4===b[1])},"should filter with a bound context":function(a){var b,c=[1,2,3,4,5],d={};b=a.apply(c,[function(a){return assert(this===d),a%2===0},d]),assert(2===b.length),assert(2===b[0]),assert(4===b[1])}},forEach:{length:1,"should iterate":function(a){var b=[1,2,3],c=0;assert("function"==typeof b.forEach),assert(!b.hasOwnProperty("forEach")),a.apply(b,[function(a){c+=a}]),assert(6===c)},"should iterate with a bound context":function(a){var b=[1,2,3],c={sum:0};a.apply(b,[function(a){this.sum+=a},c]),assert(6===c.sum)}},indexOf:{length:1,"should expose indexOf()":function(a){var b={},c=[1,2,3,b,"abc"];assert(-1===a.apply(c,[4])),assert(0===a.apply(c,[1])),assert(3===a.apply(c,[b])),assert(-1===a.apply(c,[{}])),assert(4===a.apply(c,["abc"]))}},map:{length:1,"should map with a bound context":function(a){var b,c={},d=[1,2,3,c,"abc"];assert("function"==typeof d.map),assert(!d.hasOwnProperty("map")),b=a.apply(d,[function(a,b){return assert(this===c),assert(a===d[b]),b},c]),assert(b.length===d.length),assert(0===b[0]),assert(4===b[4])}},reduce:{length:1,"should reduce with no initial value":function(a){function b(a,b,e,f){return assert(c===f),assert(d===e),++d,a+b}var c=[0,1,2,3,4],d=1;assert(10===a.apply(c,[b]))},"should reduce with intial value":function(a){function b(a,b,e,f){return assert(c===f),assert(d===e),++d,a+b}var c=[0,1,2,3,4],d=0;assert(20===a.apply(c,[b,10]))}},from:{isStatic:!0,length:1,"works on arguments":function(a){function b(){return a.call(Array,arguments)}var c=b(1,2,3);assert(c instanceof Array),assert(3===c.length),assert(1===c[0]),assert(2===c[1]),assert(3===c[2])},"works on strings":function(a){var b=a.call(Array,"foo");assert(b instanceof Array),assert(3===b.length),assert("f"===b[0]),assert("o"===b[1]),assert("o"===b[2])},"supports callback mapping":function(a){var b=a.call(Array,[1,2,3],function(a){return a+a});assert(b instanceof Array),assert(3===b.length),assert(2===b[0]),assert(4===b[1]),assert(6===b[2])},"generates a sequence of numbers":function(a){var b=a.call(Array,{length:3},function(a,b){return b});assert(b instanceof Array),assert(3===b.length),assert(0===b[0]),assert(1===b[1]),assert(2===b[2])}}},Function:{bind:{length:1,"should bind to a context":function(a){function b(a){assert(this===d),this.member=a}var c,d={member:null};c=a.apply(b,[d]),c(!0),assert(!0===d.member),c.apply({},[!1]),assert(!1===d.member)}}},Object:{create:{isStatic:!0,length:-1,"allows creating objects with a given prototype":function(a){var b=a.apply(Object,[{method:function(){return"myMethod"}}]);assert(!b.hasOwnProperty("method")),assert("function"==typeof b.method),assert("myMethod"===b.method())},"is compatible with instanceof":function(a){function b(){}b.prototype={a:function(){return"a"}};var c=a.apply(Object,[b.prototype]);assert("a"===c.a()),assert(c instanceof b)},"allows inheritance and use of instanceof":function(a){function b(){}function c(){}b.prototype={a:function(){return"a"}},c.prototype=new b;var d=a.apply(Object,[c.prototype]);assert("a"===d.a()),assert(d instanceof b),assert(d instanceof c)}},getPrototypeOf:{isStatic:!0,length:1,"returns prototype passed to Object.create":function(a){var b,c;b={a:function(){return"a"}},c=Object.create(b),assert(a.apply(Object,[c])===b)},"returns prototype from constructor":function(a){function b(){}b.prototype={constructor:b,a:function(){return"a"}};var c=new b;assert(a.apply(Object,[c])===b.prototype)}},keys:{isStatic:!0,length:1,"returns list of indexes of an array":function(a){var b=["a","b","c"],c=a.apply(Object,[b]);assert(3===c.length),assert("0"===c[0]),assert("1"===c[1]),assert("2"===c[2])},"returns list of indexes of an array-like object":function(a){var b={0:"a",1:"b",2:"c"},c=a.apply(Object,[b]);assert(3===c.length),assert(-1<c.indexOf("0")),assert(-1<c.indexOf("1")),assert(-1<c.indexOf("2"))},"returns list of indexes of an array like object with random key ordering":function(a){var b={100:"a",2:"b",7:"c"},c=a.apply(Object,[b]);assert(3===c.length),assert(-1<c.indexOf("2")),assert(-1<c.indexOf("7")),assert(-1<c.indexOf("100"))},"returns list of own keys of an object":function(a){function b(){}b.prototype={a:0,b:1};var c,d=new b;d.c=2,c=a.apply(Object,[d]),assert(1===c.length),assert("c"===c[0])}},values:{isStatic:!0,length:1,"returns list of values of an object":function(a){var b={foo:"bar",baz:42},c=a.apply(Object,[b]);assert(2===c.length),assert(-1<c.indexOf("bar")),assert(-1<c.indexOf(42))},"returns list of values of an array-like object":function(a){var b={0:"a",1:"b",2:"c"},c=a.apply(Object,[b]);assert(3===c.length),assert(-1<c.indexOf("a")),assert(-1<c.indexOf("b")),assert(-1<c.indexOf("c"))},"returns list of values of an array like object with random key ordering":function(a){var b={100:"a",2:"b",7:"c"},c=a.apply(Object,[b]);assert(3===c.length),assert(-1<c.indexOf("a")),assert(-1<c.indexOf("b")),assert(-1<c.indexOf("c"))},"returns list of own values of an object":function(a){function b(){}b.prototype={a:0,b:1};var c,d=new b;d.c=2,c=a.apply(Object,[d]),assert(1===c.length),assert(2===c[0])}}},String:{trim:{length:0,"should trim left and right":function(a){var b=" 	  abc	 	";assert("abc"===a.apply(b,[]))}}},Date:{toISOString:{length:0,"converts to UTC string":function(a){var b=new Date("2003-01-22T22:45:00.000Z");assert("2003-01-22T22:45:00.000Z"===a.apply(b,[]))}}}},f={Array:Array,Function:Function,Object:Object,String:String,Date:Date};describe("Array",function(){describe("default support",function(){it("should allow building an array with a given size",function(){var a,b=new Array(5);for(assert(5===b.length),a=0;5>a;++a)assert(void 0===b[a]);assert("    "===b.join(" "))}),it("provides standard slice",function(){var a=["Banana","Orange","Lemon","Apple","Mango"],b=a.slice(1,3);assert(2===b.length),assert("Orange"===b[0]),assert("Lemon"===b[1])})}),d("Array")}),describe("Function",function(){describe("default support",function(){it("allows creating function with parameters",function(){var a=Function("value","return value;");assert("function"==typeof a),assert(1===a.length),assert(123===a(123))}),it("should detect undefined parameter",function(){function a(a){assert(arguments.length===a)}a(1),a(2,"abc"),a(2,void 0),a(3,void 0,void 0)})}),describe("name support",function(){if(it("exposes a name",function(){var a=Function,b=new a("return function funcName () {}")();assert("funcName"===b.compatibleName())}),it("supports empty name",function(){var a=function(){};assert(""===a.compatibleName())}),gpf.internals&&Function.prototype.compatibleName!==gpf.internals._gpfGetFunctionName){var a=gpf.internals._gpfGetFunctionName;it("exposes a name (compatible)",function(){function b(){}assert("thisName"===a.call(b))}),it("supports empty name",function(){var b=function(){};assert(""===a.call(b))})}}),d("Function")}),describe("Object",function(){d("Object")}),describe("String",function(){d("String")}),describe("Date",function(){describe("constructor",function(){it("accepts UTC string",function(){var a=new Date("2003-01-22T22:45:00.000Z");assert(2003===a.getUTCFullYear()),assert(0===a.getUTCMonth()),assert(22===a.getUTCDate()),assert(22===a.getUTCHours()),assert(45===a.getUTCMinutes()),assert(0===a.getUTCSeconds())}),it("accepts a date only",function(){var a=new Date("2003-01-22");assert(2003===a.getUTCFullYear()),assert(0===a.getUTCMonth()),assert(22===a.getUTCDate()),assert(0===a.getUTCHours()),assert(0===a.getUTCMinutes()),assert(0===a.getUTCSeconds())})}),d("Date"),gpf.internals&&(describe("(internal) _gpfIsISO8601String",function(){function a(a,c){var d;d=c?"accepts":"rejects",d+=' "'+a+'"',it(d,function(){var d=b(a);c?(assert(d),assert(d.length===c.length),c.forEach(function(a,b){assert(d[b]===a)})):assert(!d)})}var b=gpf.internals._gpfIsISO8601String,c={"2016-02-17T23:13:00.000Z":[2016,1,17,23,13,0,0],"2003-01-22T22:45:34.075Z":[2003,0,22,22,45,34,75],"2003-13-22T22:45:34.075Z":null,"2003-1-22T22:45:34.075Z":null,"2003-01-32T22:45:34.075Z":null,"2003-01-2T22:45:34.075Z":null,"2003-01-22T25:45:34.075Z":null,"2003-01-22T22:60:34.075Z":null,"2003-01-22T22:45:60.075Z":null,"2003-01-22T22:45:34":[2003,0,22,22,45,34,0],"2003-01-22 22:45:34":null,"2003-01-22T22:45:34.075":null,"2016-02-17":[2016,1,17,0,0,0,0],"2003-13-22":null,"2003-01-32":null};for(var d in c)c.hasOwnProperty(d)&&a(d,c[d]);[!0,!1,0,1,{},new Date].forEach(function(a){it("rejects other formats - "+typeof a+" ("+a.toString()+")",function(){assert(void 0===b(a))})})}),describe("(internal) _GpfDate()",function(){var a=gpf.internals._GpfDate;it("allocates a Date object",function(){var b=new a;assert(b instanceof Date)}),it("detects and leverage ISO 8601 format",function(){var b=new a("2003-01-22T22:45:34.075Z");assert(2003===b.getUTCFullYear()),assert(0===b.getUTCMonth()),assert(22===b.getUTCDate()),assert(22===b.getUTCHours()),assert(45===b.getUTCMinutes()),assert(34===b.getUTCSeconds()),assert(75===b.getUTCMilliseconds())}),it("detects and leverage ISO 8601 short format",function(){var b=new a("2003-01-22");assert(2003===b.getUTCFullYear()),assert(0===b.getUTCMonth()),assert(22===b.getUTCDate()),assert(0===b.getUTCHours()),assert(0===b.getUTCMinutes()),assert(0===b.getUTCSeconds()),assert(0===b.getUTCMilliseconds())})}))})}),describe("constants",function(){describe("gpf",function(){it("does not expose any 'private' member",function(){function a(b,c){var d,e;for(d in b)b.hasOwnProperty(d)&&(assert("_"!==d.charAt(0)),e=b[d],"object"==typeof e&&-1===c.indexOf(e)&&(c.push(e),a(e,c)))}a(gpf,[gpf,gpf.internals])}),it("should expose a version",function(){assert("function"==typeof gpf.version),assert("string"==typeof gpf.version());var a=gpf.version();assert(-1!==a.indexOf(".")),assert(null!==a.match(/[0-9]+\.[0-9]+d?/))}),it("should expose the host type",function(){assert("function"==typeof gpf.host),assert("string"==typeof gpf.host());var a=gpf.host();assert(-1!==[gpf.HOST_BROWSER,gpf.HOST_NODEJS,gpf.HOST_PHANTOMJS,gpf.HOST_RHINO,gpf.HOST_UNKNOWN,gpf.HOST_WSCRIPT].indexOf(a))}),describe("gpf.HOST_xxx",function(){["BROWSER","NODEJS","PHANTOMJS","UNKNOWN","WSCRIPT"].forEach(function(a){it("declares gpf.HOST_"+a,function(){assert(void 0!==gpf["HOST_"+a])})})}),it("should provide a context resolver",function(){if(assert("function"==typeof gpf.context),assert(null!==gpf.context()),assert(gpf===gpf.context("gpf")),gpf.HOST_BROWSER===gpf.host())assert(window===gpf.context());else if(gpf.HOST_NODEJS===gpf.host()||gpf.HOST_PHANTOMJS===gpf.host())assert(global===gpf.context());else{var a=function(){return this}();assert(a===gpf.context())}})}),gpf.internals&&describe("(internal) _gpfIsUnsignedByte",function(){var a=gpf.internals._gpfIsUnsignedByte;gpf.forEach({0:!0,"-25":!1,128:!0,256:!1,255:!0},function(b,c){var d=parseInt(c,10);b?it("accepts"+c,function(){assert(!0===a(d))}):it("rejects "+c,function(){assert(!1===a(d))})})})}),describe("events",function(){describe("gpf.events.EVENT_xxx",function(){["ERROR","READY","DATA","END_OF_DATA","CONTINUE","STOP","STOPPED"].forEach(function(a){it("declares gpf.events.EVENT_"+a,function(){assert(void 0!==gpf.events["EVENT_"+a])})})}),describe("gpf.events.Event",function(){it("has a correct class structure",function(){var a=new gpf.events.Event("test");assert(a instanceof gpf.events.Event),assert(a.constructor===gpf.events.Event)}),it("should expose type and a default scope",function(){var a=new gpf.events.Event("test");assert("test"===a.type),assert(a.scope===gpf.context())}),it("should transmit parameters",function(){var a=new Date,b=new gpf.events.Event("test",{string:"Hello world!",number:123,"boolean":!0,object:a});assert("test"===b.type),assert("Hello world!"===b.get("string")),assert(123===b.get("number")),assert(!0===b.get("boolean")),assert(a===b.get("object")),assert(b.scope===gpf.context())}),it("should allow a custom event scope",function(){var a={},b=new Date,c=new gpf.events.Event("test",{string:"Hello world!",number:123,"boolean":!0,object:b},a);assert("test"===c.type),assert("Hello world!"===c.get("string")),assert(123===c.get("number")),assert(!0===c.get("boolean")),assert(b===c.get("object")),assert(c.scope===a)})}),describe("gpf.events.fire",function(){function a(){c=null,d=null}function b(b){it("triggers the handler",function(f){a(),gpf.events.fire("test",b).then(function(a){assert(a===c),assert("test"===c.type),assert(e||gpf.context()===d),assert(e||gpf.context()===c.scope),f()})["catch"](function(a){f(a)})}),it("triggers the handler using the event scope",function(a){var f={};gpf.events.fire.call(f,"test",b).then(function(b){assert(b===c),assert("test"===c.type),assert(e||f===d),assert(e||f===c.scope),a()})["catch"](function(b){a(b)})}),it("triggers the handler using only the event scope",function(a){var f={},g={},h=new gpf.events.Event("test",{},f);assert(f!==g),assert(h.scope===f),gpf.events.fire.call(g,h,b).then(function(b){assert(b===c),assert("test"===c.type),assert(e||f===d),assert(e||f===c.scope),a()})["catch"](function(b){a(b)})})}var c,d,e;describe("on a function",function(){b(function(a){c=a,d=this})}),describe("on an function dictionary",function(){var a={error:function(){assert(!1)},test:function(a){c=a,d=this}};before(function(){e=a}),b(a),after(function(){e=void 0})}),describe("on an function dictionary with a specific scope",function(){var a={},f={error:function(){assert(!1)},test:function(a){c=a,d=this}};before(function(){e=a}),b(f),after(function(){e=void 0})}),describe("on an function dictionary's default method",function(){var a={error:function(){assert(!1)},test2:function(){assert(!1)},tes:function(){assert(!1)},"*":function(a){c=a,d=this}};before(function(){e=a}),b(a),after(function(){e=void 0})}),describe("on a dispatcher-like object",function(){var a={dispatchEvent:function(a){c=a,d=this}};before(function(){e=a}),b(a),after(function(){e=void 0})}),it("triggers nothing on a non matching dictionary",function(a){var b=!1;gpf.events.fire("test",{any:function(){b=!0}}).then(function(c){assert("test"===c.type),assert(gpf.context()===c.scope),assert(!1===b),a()})["catch"](function(b){a(b)})}),it("supports triggering from the event",function(a){var b=new gpf.events.Event("test");b.fire({test:function(){assert("test"===b.type),assert(gpf.context()===b.scope),a()}})["catch"](function(b){a(b)})}),it("defers recursive calls to limit the stack usage",function(a){function b(e){try{if(c)return void a();assert(100>d),++d,c=!0,gpf.events.fire("test",b),c=!1}catch(f){a(f)}return e}var c=!1,d=0;b()})}),describe("gpf.events.isValidHandler",function(){[{label:"allows function with one parameter",param:function(a){return a},result:!0},{label:"rejects functions with no parameter",param:function(){},result:!1},{label:"rejects functions with more than one parameter",param:function(a,b){return a+b},result:!1},{label:"allows object with a valid dispatchEvent method",param:{dispatchEvent:function(a){return a}},result:!0},{label:"rejects object with an invalid dispatchEvent method",param:{dispatchEvent:function(){}},result:!1},{label:"allows object mapping any event (even none)",param:{},result:!0},{label:"rejects unexpected types (bool)",param:!1,result:!1},{label:"rejects unexpected types (number)",param:1,result:!1},{label:"rejects unexpected types (string)",param:"hello world!",result:!1}].forEach(function(a){it(a.label,function(){assert(a.result===gpf.events.isValidHandler(a.param))})})}),describe("gpf.events.getPromiseHandler",function(){it("converts an event handler function into a promise",function(a){gpf.events.getPromiseHandler(function(a){gpf.events.fire("test",a)}).then(function(b){assert("test"===b.type),assert(gpf.context()===b.scope),a()})["catch"](function(b){a(b)})}),it("rejects error events and provides the reason",function(a){gpf.events.getPromiseHandler(function(a){gpf.events.fire("error",{error:"KO!"},a)}).then(function(){a("Not expected")})["catch"](function(b){try{assert("KO!"===b),a()}catch(c){a(c)}})})})}),describe("include",function(){describe("gpf.web.include",function(){var a=gpf.web&&gpf.web.include;it("should exist only if in a browser environment",function(){var b=gpf.host();-1<[gpf.HOST_BROWSER,gpf.HOST_PHANTOMJS].indexOf(b)?assert(a):assert(!a)}),a&&(it("allows injection of any script"),it("signals successful script injection"),it("signals failed script injection"))})}),describe("base",function(){describe("gpf as a module",function(){gpf.HOST_NODEJS===gpf.host()?it("supports multiple instances (node)",function(){var a,b=require("path"),c=gpf;a=require(b.resolve(process.cwd(),"build/gpf-debug.js")),assert("object"==typeof a),assert(null!==a),assert(c===gpf)}):gpf.HOST_BROWSER!==gpf.host()&&gpf.HOST_PHANTOMJS!==gpf.host()||!window.gpfSourcesPath||it("supports multiple includes (browser)",function(a){
var b=gpf;gpf.web.include(gpfSourcesPath+"../build/gpf-debug.js",{ready:function(){var c=gpf.noConflict();assert("object"==typeof c),assert(null!==c),assert(b===gpf),a()}})})});var a="Hello World!",b=[0,1,2,3,4,5,6,7,8,9],c={number:1,string:a,"null":null,object:{member:"value"},"function":function(){return a}},d="number,string,null,object,function",e="number,string,object,function";describe("gpf.forEach",function(){it("enumerates array content",function(){var a=0,c=0;gpf.forEach(b,function(d,e,f){assert("number"==typeof e),assert(f===b),++a,c+=d}),assert(b.length===a),assert(45===c)}),it("transmits scope on array content",function(){var a,d=0,e=0;a=gpf.forEach(b,function(a,f,g){assert(this===c),assert("number"==typeof f),assert(g===b),++d,e+=a},c),assert(void 0===a),assert(b.length===d),assert(45===e)}),it("enumerates object content and handles null value",function(){var a=[],b=!0;gpf.forEach(c,function(d,e,f){assert("string"==typeof e),assert(f===c),a.push(e),"null"===e&&null!==d&&(b=!1)}),a=a.join(","),assert(d===a),assert(!0===b)}),it("transmits scope on object content",function(){var a=gpf.forEach(c,function(){assert(this===c)},c);assert(void 0===a)})}),describe("gpf.extend",function(){it("extends objects members",function(){var a={number:0,string:0,object:0,"function":0},b=[],e=gpf.extend(a,c);assert(a===e),gpf.forEach(c,function(c,d){c===a[d]&&b.push(d)}),b=b.join(","),assert(b===d)}),it("submits overwrite to a function",function(){var a={number:0,string:0,object:0,"function":0},b=[];gpf.extend(a,c,function(){b.push(arguments[1])}),b=b.join(","),assert(b===e)}),it("provides to the overwrite function all values",function(){var a={number:0,string:0,"null":5,object:0,"function":0},b=[];gpf.extend(a,c,function(a,c,d){0===a[c]&&(a[c]=d,b.push(c))}),b=b.join(","),assert(b===e)})}),describe("gpf.value",function(){var a=new Date(2003,0,22,23,45,0,0);[[0,1,void 0,0,"nothing on numbers"],["0",1,void 0,0,"number from string"],["0",!0,void 0,!1,"boolean from string (false)"],["yes",!1,void 0,!0,"boolean from string (true)"],[0,!0,void 0,!1,"boolean from number (false)"],[1,!1,void 0,!0,"boolean from number (true)"],[{},!1,void 0,!1,"boolean from anything else"],[void 0,"empty",void 0,"empty","nothing and use default value"],["1.2",1.1,void 0,1.2,"string to float"],["1.2",1,"number",1.2,"string to float as a number"],[{},1,void 0,1,"number from anything else"],[1,"",void 0,"1","string fron number"],[1,c,void 0,c,"object (only default)"],[new Date("2013-01-22"),"",void 0,"2013-01-22T00:00:00.000Z","string from date"],["2013-01-22T00:00:00.000Z",new Date,void 0,new Date("2013-01-22"),"date from string"]].forEach(function(a){it("converts "+a[4],function(){var b=gpf.value.apply(null,a.slice(0,3)),c=a[3];"object"==typeof b&&"object"==typeof c?assert(b.toString()===a[3].toString()):assert(b===a[3])})}),gpf.dateToComparableFormat?it("handles date conversions",function(){assert(gpf.like(gpf.value("2003-01-22 23:45:00",a),a)),assert("2003-01-22 23:45:00"===gpf.value(a,""))}):it("handles date conversions")}),describe("gpf.clone",function(){it("creates a shallow clone of an object",function(){var a=gpf.clone(c);assert(a.string===c.string),assert(a.object!==c.object),assert(a.object.member===c.object.member),assert(void 0===a["function"])})}),describe("gpf.test",function(){it("checks if an item exist in an Array",function(){assert(2===gpf.test(b,2)),assert(void 0===gpf.test(b,11))}),it("checks if a member value exist in an Object",function(){assert("null"===gpf.test(c,null)),assert("number"===gpf.test(c,1)),assert(void 0===gpf.test(c,"number"))})}),describe("gpf.set",function(){it("does not alter the Array if the value already exists",function(){var a=b.concat([]),c=gpf.set(a,2);assert(c===a),assert(c.length===b.length),assert(void 0!==gpf.test(c,2))}),it("adds the value to the Array",function(){var a=b.concat([]),c=gpf.set(a,11);assert(c===a),assert(c.length===b.length+1),assert(void 0!==gpf.test(c,11))})}),describe("gpf.clear",function(){it("does not change the Array if not found",function(){var a=b.concat([]),c=gpf.clear(a,11);assert(c===a),assert(c.length===a.length),assert(void 0===gpf.test(c,11))}),it("removes the value from the Array when found",function(){var a=b.concat([]),c=gpf.clear(a,2);assert(c===a),assert(c.length===b.length-1),assert(void 0===gpf.test(c,2)),assert("013456789"===c.join(""))}),it("does not change the dictionary if not found",function(){var a=gpf.clone(c),b=gpf.clear(a,11);assert(b===a),assert(void 0===gpf.test(a,11))}),it("removes the value from the Array when found",function(){var a=gpf.clone(c),b=gpf.clear(a,1);assert(b===a),assert(void 0===a.number),assert(void 0===gpf.test(a,1))})}),describe("gpf.xor",function(){it("implements XOR truth table",function(){assert(gpf.xor(!1,!1)===!1),assert(gpf.xor(!1,!0)===!0),assert(gpf.xor(!0,!1)===!0),assert(gpf.xor(!0,!0)===!1)})}),gpf.internals&&describe("(internal)",function(){describe("_gpfStringEscapeFor",function(){var a=gpf.internals._gpfStringEscapeFor;it("escape strings for javascript",function(){assert('"abc"'===a("abc","javascript")),assert('"a\\r\\nb"'===a("a\r\nb","javascript")),assert('"\\""'===a('"',"javascript")),assert('"\\\\"'===a("\\","javascript"))}),it("escape strings for xml",function(){assert("&lt;abc&gt;&amp;amp;&lt;/abc&gt;"===a("<abc>&amp;</abc>","xml"))}),it("escape strings for html",function(){var b="&lt;abc&gt;&aacute;&amp;&egrave;&lt;/abc&gt;";assert(a("<abc>á&è</abc>","html")===b)})}),gpf.HOST_NODEJS===gpf.host()&&describe("_gpfNodeBuffer2JsArray",function(){var a=gpf.internals._gpfNodeBuffer2JsArray;it("converts a NodeJS buffer into an array",function(){var b=new Buffer("abc"),c=a(b);assert(97===c[0]),assert(98===c[1]),assert(99===c[2])})})})}),describe("function",function(){gpf.internals&&describe("_GpfFunctionBuilder",function(){var a=gpf.internals._GpfFunctionBuilder,b=gpf.internals._gpfObjectForEach;b({Object:Object,Function:Function,String:String,Array:Array},function(b,c){it("detects native functions ("+c+")",function(){var c=new a(b);assert(!0===c.isNative)})}),it("parses a function",function(){function b(a,b){return a+b}var c=new a(b);assert("test"===c.name),assert(2===c.parameters.length),assert("a"===c.parameters[0]),assert("b"===c.parameters[1])}),it("parses a function (with comments)",function(){function b(a,b,c){return a+b+c}var c=new a(b);assert("test2"===c.name),assert(3===c.parameters.length),assert("a"===c.parameters[0]),assert("b"===c.parameters[1]),assert("c"===c.parameters[2])}),it("parses a function (no parameters)",function(){function b(){return 0}var c=new a(b);assert("test3"===c.name),assert(0===c.parameters.length)}),it("can be used to create an anonymous function",function(){var b,c=new a;c.body="return 1;",b=c.generate(),assert(""===b.compatibleName()),assert(1===b())}),it("can be used to create a named function",function(){var b,c=new a;c.name="test",c.body="return 2;",b=c.generate(),assert("test"===b.compatibleName()),assert(2===b())})})}),describe("like",function(){var a="Hello World!",b={number:1,string:a,"null":null,object:{member:"value"},"function":function(){return a}},c=gpf.extend({cloneOf:b},b);describe("gpf.like",function(){it("supports basic comparisons",function(){assert(!0===gpf.like(1,1)),assert(!1===gpf.like(1,new Number(1))),assert(!1===gpf.like(1,2)),assert(!0===gpf.like(1,1)),assert(!0===gpf.like("abc","abc")),assert(!1===gpf.like("abc",new String("abc"))),assert(!1===gpf.like("abc","abcd")),assert(!0===gpf.like(b,b))}),it("supports alike comparisons",function(){assert(!0===gpf.like(1,new Number(1),!0)),assert(!1===gpf.like("1",new Number(1),!0)),assert(!0===gpf.like("abc",new String("abc"),!0)),assert(!1===gpf.like(0,new String("0"),!0)),assert(!0===gpf.like(!0,new Boolean(!0),!0)),assert(!1===gpf.like(0,new Boolean(!1),!0))}),describe("objects",function(){it("compares object members",function(){assert(!1===gpf.like(b,gpf.extend({rigtOnly:!0},b))),assert(!1===gpf.like(gpf.extend({leftOnly:!0},b)),b)}),it("compares members' value",function(){var a=gpf.extend({},b),c=gpf.extend({},b);a.different=!0,c.different=!1,assert(!1===gpf.like(a,c))}),it("supports deep comparison",function(){assert(!0===gpf.like(b,gpf.extend({},b))),assert(!0===gpf.like(c,gpf.extend({},c)))}),it("supports recursive comparison",function(){var a=gpf.extend({},b),c=gpf.extend({},b);a.test1=a,c.test1=c,a.test2=c,c.test2=a,assert(!0===gpf.like(a,c))}),describe("class comparison",function(){function a(){this.value=0}function b(){this.value=0}var c=new a,d=new b;it("compares prototypes",function(){assert(!1===gpf.like(c,d))}),it("supports alike comparison",function(){assert(!0===gpf.like(c,d,!0))})})})})}),describe("error",function(){describe("gpf.Error",function(){it("is used as an exception",function(){try{throw gpf.Error.abstractMethod()}catch(a){assert(a instanceof gpf.Error),assert(a.constructor===gpf.Error)}}),it("is documented",function(){try{throw gpf.Error.abstractMethod()}catch(a){assert(a.code===gpf.Error.CODE_ABSTRACTMETHOD),assert(a.code===gpf.Error.abstractMethod.CODE),assert("abstractMethod"===a.name),assert("Abstract method"===a.message)}}),it("can use substitution for message",function(){try{throw gpf.Error.assertionFailed({message:"Test"})}catch(a){assert(a instanceof gpf.Error),assert(a.code===gpf.Error.CODE_ASSERTIONFAILED),assert(a.code===gpf.Error.assertionFailed.CODE),assert("assertionFailed"===a.name),assert("Assertion failed: Test"===a.message)}})})}),describe("dispatch",function(){var a;describe("gpf.mixins.EventDispatcher",function(){beforeEach(function(){a={},gpf.extend(a,gpf.mixins.EventDispatcher)}),it("exposes addEventListener method",function(){assert("function"==typeof a.addEventListener),assert(2===a.addEventListener.length)}),it("exposes removeEventListener method",function(){assert("function"==typeof a.removeEventListener),assert(2===a.removeEventListener.length)}),describe("without registering the event",function(){it("triggers no call",function(){a.dispatchEvent("test")}),it("doesn't fail if removing an unknown listener (event matching)",function(){a.removeEventListener("test",function(){})})}),describe("after registering a listener",function(){function b(b){var c;assert("test"===b.type),assert(b.scope===a),assert("first"===b.get("param1")),assert(b.get("param2")===!0),assert(0===b.get("param3")),c=b.get("done"),assert(c),c()}function c(b){var c;assert("test2"===b.type),assert(b.get("expected")),assert(b.scope===a),c=b.get("done"),assert(c),c()}beforeEach(function(){a.addEventListener("test",b)}),it("receives the event",function(b){a.dispatchEvent("test",{param1:"first",param2:!0,param3:0,done:b})}),it("triggers no call on unknown event",function(){a.dispatchEvent("test2")}),it("doesn't fail if removing an unknown listener (event not matching)",function(){a.removeEventListener("test2",function(){})}),it("doesn't fail if removing an unknown listener (function not matching)",function(){a.removeEventListener("test",function(){})}),describe("and registering another one",function(){beforeEach(function(){a.addEventListener("test",function(a){return a}),a.addEventListener("test2",c)}),it("still receives the initial event",function(b){a.dispatchEvent("test",{param1:"first",param2:!0,param3:0,done:b})}),it("receives the new event (gpf.events.Event version)",function(b){var c=new gpf.events.Event("test2",{expected:!0,done:b},a);a.dispatchEvent(c)}),describe("to finally remove it",function(){beforeEach(function(){a.removeEventListener("test2",c)}),it("ignores the last event",function(b){a.dispatchEvent("test2",{expected:!1,done:b}),b()}),it("still receives the initial event",function(b){a.dispatchEvent("test",{param1:"first",param2:!0,param3:0,done:b})})})})})})}),describe("mimetype",function(){describe("hard-coded mime types",function(){var a=gpf.web,b={"application/javascript":[".js"],"image/gif":[".gif"],"image/jpeg":[".jpg",".jpeg"],"image/png":[".png"],"text/css":[".css"],"text/html":[".htm",".html"],"text/plain":[".txt",".text",".log"]};it("supports a list of pre-defined mime types",function(){var c,d,e,f,g;for(c in b)if(b.hasOwnProperty(c))for(d=b[c],e=d.length,f=0;e>f;++f)g=d[f],assert(a.getMimeType(g)===c),0===f&&assert(a.getFileExtension(c)===g)}),it("supports a default mime type",function(){assert("application/octet-stream"===a.getMimeType(""))}),it("supports a default extension",function(){assert(".bin"===a.getFileExtension(""))})})}),describe("timeout",function(){function a(a){return function(){function b(a){assert(-1===i.indexOf(a)),assert(-1<h.indexOf(a)),assert(void 0!==g),assert(!0===e),assert(!1===f),i.push(a),e=!1,f=!0,g()}function c(b){-1===i.indexOf(b)&&-1===h.indexOf(b)&&(i.push(b),a.clearTimeout(b))}var d,e,f,g,h=[],i=[];beforeEach(function(){a.clearQueue(),f=!1;var c=a.setTimeout(function(){b(c)},20);d=c,e=!0}),it("allocates a timeout id",function(){assert(void 0!==d)}),it("allows queueing a callback",function(){a.testQueueLength(1)}),afterEach(function(){c(d)}),describe("clearing",function(){beforeEach(function(){i.push(d),a.clearTimeout(d)}),it("removes the callback from the queue",function(){a.testQueueLength(0)}),describe("again",function(){beforeEach(function(){a.clearTimeout(d)}),it("does not fail",function(){a.testQueueLength(0)})})}),describe("triggering",function(){beforeEach(function(b){h.push(d),g=b,a.handleTimeout()}),it("executes the callback from the queue",function(){assert(!0===f)}),it("removes the callback from the queue",function(){a.testQueueLength(0)})}),describe("sequencing with a second timeout",function(){function b(a){assert(-1===i.indexOf(a)),assert(-1<h.indexOf(a)),assert(void 0!==g),assert(!1===f),i.push(a),g()}var e;beforeEach(function(){var c=a.setTimeout(function(){b(c)},10);e=c}),it("allocates a different timeout id",function(){assert(void 0!==e),assert(e!==d)}),it("allows queueing a different callback",function(){a.testQueueLength(2)}),afterEach(function(){c(e)}),describe("clearing the second timeout",function(){beforeEach(function(){i.push(e),a.clearTimeout(e)}),describe("triggering",function(){beforeEach(function(b){h.push(d),g=b,a.handleTimeout()}),it("executes the remaining callback from the queue",function(){assert(!0===f)}),it("removes all callbacks from the queue",function(){a.testQueueLength(0)})}),describe("again",function(){beforeEach(function(){a.clearTimeout(e)}),it("does not fail",function(){a.testQueueLength(1)})})}),describe("triggering",function(){beforeEach(function(b){h.push(e),h.push(d);var c=0;g=function(){2===++c&&b()},a.handleTimeout()}),it("executes the callbacks from the queue",function(){assert(!0===f)}),it("removed all callbacks from the queue",function(){a.testQueueLength(0)})})})}}describe("exposed API",a({clearQueue:function(){},testQueueLength:function(){},setTimeout:function(a,b){return setTimeout(a,b)},clearTimeout:function(a){clearTimeout(a)},handleTimeout:function(){}})),gpf.internals&&describe("(internal)",a({clearQueue:function(){gpf.internals._gpfTimeoutQueue.length=0},testQueueLength:function(a){assert(a===gpf.internals._gpfTimeoutQueue.length)},setTimeout:gpf.internals._gpSetTimeoutPolyfill,clearTimeout:gpf.internals._gpfClearTimeoutPolyfill,handleTimeout:gpf.internals._gpfHandleTimeout}))}),describe("bin",function(){var a=[1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,536870912,1073741824,2147483648,4294967296,8589934592,17179869184];describe("gpf.bin.pow",function(){it("gives the powers of 2",function(){a.forEach(function(a,b){assert(gpf.bin.pow2(b)===a)})}),it("checks if a number is a power of 2",function(){[0,1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,32748,65536,65534,2147483648,4294967296].forEach(function(b){var c=a.indexOf(b);assert(gpf.bin.isPow2(b)===c)})})}),describe("gpf.bin.toAny",function(){describe("gpf.bin.toHexa",function(){it("converts zero to zero",function(){assert("0"===gpf.bin.toHexa(0))}),it("converts a number to its hexadecimal value",function(){assert("ABCDEF98"===gpf.bin.toHexa(2882400152))}),it("truncates the value if necessary",function(){assert("EF98"===gpf.bin.toHexa(2882400152,4))}),it("pads the value if necessary",function(){assert("00ABCDEF98"===gpf.bin.toHexa(2882400152,10))}),it("handles negative numbers",function(){assert("FFFFFFFF"===gpf.bin.toHexa(-1,8))})}),describe("gpf.bin.toBase64",function(){it("converts a number to its base64 value",function(){assert("Crze+Y"===gpf.bin.toBase64(2882400152))}),it("supports configurable padding",function(){assert("==Crze+Y"===gpf.bin.toBase64(2882400152,8,"="))})})}),describe("gpf.bin.fromAny",function(){describe("gpf.bin.fromHexa",function(){it("converts an hexadecimal value to a number",function(){assert(2882400152===gpf.bin.fromHexa("ABCDEF98","0"))}),it("supports padding",function(){assert(2882400152===gpf.bin.fromHexa("00ABCDEF98"))})}),describe("gpf.bin.fromBase64",function(){it("converts a base64 value to a number",function(){assert(2882400152===gpf.bin.fromBase64("Crze+Y"))}),it("supports configurable padding",function(){assert(2882400152===gpf.bin.fromBase64("==Crze+Y","="))})})}),describe("Binary values manipulation",function(){var a=gpf.bin.pow2(2),b=gpf.bin.pow2(3),c=gpf.bin.pow2(4);describe("gpf.bin.test",function(){it("tests bits in a value",function(){assert(!0===gpf.bin.test(c,c)),assert(!1===gpf.bin.test(b,c)),assert(!0===gpf.bin.test(255,a)),assert(!0===gpf.bin.test(255,a+b))})}),describe("gpf.bin.clear",function(){it("clears bits in a value",function(){assert(c===gpf.bin.clear(c+b,b))})})}),describe("gpf.bin.random",function(){it("generate random values between 0 and 2^32",function(){for(var a,b=[],c=gpf.bin.pow2(32);b.length<1e3;)a=gpf.bin.random(),assert(a>=0),assert(c>a),assert(-1===b.indexOf(a)),b.push(a)})})}),describe("json",function(){var a=[{label:"empty object",obj:{},json:"{}"},{label:"simple string property",obj:{a:"123"},json:'{"a":"123"}'},{label:"simple number property",obj:{a:123},json:'{"a":123}'},{label:"simple boolean properties",obj:{a:!0,b:!1},json:'{"a":true,"b":false}'},{label:"mixed simple properties",obj:{a:"123",b:123,c:!0,d:{}},json:'{"a":"123","b":123,"c":true,"d":{}}'},{label:"function",obj:{a:123,b:function(){}},json:'{"a":123}',parse:!1},{label:"array",obj:{a:[1,2,3]},json:'{"a":[1,2,3]}'},{label:"null",obj:{a:null},json:'{"a":null}'}];describe("JSON object",function(){it("exists",function(){assert("undefined"!=typeof JSON)})}),describe("JSON.stringify",function(){a.forEach(function(a){it("works on "+a.label,function(){assert(JSON.stringify(a.obj)===a.json)})})}),describe("JSON.parse",function(){a.forEach(function(a){!1!==a.parse&&it("works on "+a.label,function(){var b=JSON.parse(a.json);assert(!0===gpf.like(b,a.obj))})})}),gpf.internals&&describe("(internal)",function(){describe("_gpfJsonStringifyPolyfill",function(){a.forEach(function(a){it("works on "+a.label,function(){assert(gpf.internals._gpfJsonStringifyPolyfill(a.obj)===a.json)})})}),describe("_gpfJsonParsePolyfill",function(){a.forEach(function(a){!1!==a.parse&&it("works on "+a.label,function(){var b=gpf.internals._gpfJsonParsePolyfill(a.json);assert(!0===gpf.like(b,a.obj))})})})})}),describe("path",function(){function a(a){function c(a){return new e("assert(gpf.path."+a+");")}var d;d="/"===a?a:"\\\\",describe("gpf.path.join ("+a+")",function(){var c;c="/"===a?b.join:function(){var c=Array.from(arguments,function(b){return b.split("/").join(a)});return b.join.apply(b,c)},it("concatenates paths",function(){assert("abc/def/ghi/jkl"===c("abc/def","ghi/jkl"))}),it("handles trailing separator",function(){assert("abc/def/ghi/jkl"===c("abc/def/","ghi/jkl/"))}),it("handles relative paths",function(){assert("abc/ghi"===c("abc/def","../ghi"))}),it("handles multiple joins",function(){assert("abc/jkl"===c("abc","def","../ghi","../jkl"))}),it("resolves on known parent",function(){assert("ghi"===c("abc","../ghi"))}),it("goes up with ..",function(){assert("abc"===c("abc/def",".."))}),it("does not resolve on unknown parent",function(){assert(""===c("abc","../../ghi"))})}),describe("gpf.path.parent ("+a+")",function(){it("retrieves the parent path",function(){assert("abc"===b.parent("abc"+a+"def"))}),it("returns empty on a root",function(){assert(""===b.parent(a+"abc"))}),it("returns empty when no parent",function(){assert(""===b.parent("abc"))}),it("returns empty when empty",function(){assert(""===b.parent(""))})});var e=Function,f=[{label:"considers the last name of path",path:"abc"+d+"def.ghi",name:"def.ghi",nameOnly:"def",extension:".ghi"},{label:"handles trailing separator",path:"abc"+d+"def.ghi"+d,name:"def.ghi",nameOnly:"def",extension:".ghi"},{label:"handles trailing separator (no extension)",path:"abc"+d+"def"+d,name:"def",nameOnly:"def",extension:""},{label:"handles name only",path:"abc.defgh",name:"abc.defgh",nameOnly:"abc",extension:".defgh"},{label:"handles name only (no extension)",path:"abc",name:"abc",nameOnly:"abc",extension:""},{label:"handles root",path:"/",name:"",nameOnly:"",extension:""}];describe("gpf.path.name ("+a+")",function(){f.forEach(function(a){it(a.label,c('name("'+a.path+'") === "'+a.name+'"'))})}),describe("gpf.path.nameOnly ("+a+")",function(){f.forEach(function(a){it(a.label,c('nameOnly("'+a.path+'") === "'+a.nameOnly+'"'))})}),describe("gpf.path.extension ("+a+")",function(){f.forEach(function(a){it(a.label,c('extension("'+a.path+'") === "'+a.extension+'"'))})}),describe("gpf.path.relative ("+a+")",function(){var c;c="/"===a?b.relative:function(){var c=Array.from(arguments,function(b){return b.split("/").join(a)});return b.relative.apply(b,c)},it("solves the relative path",function(){assert("../ghi"===c("abc/def","abc/ghi"))}),it("handles trailing separator",function(){assert("../ghi"===c("abc/def/","abc/ghi"))}),it("works on non matching roots",function(){assert("../../ghi/jkl"===c("abc/def","ghi/jkl"))}),it("works on non matching roots (any level)",function(){assert("../../../g/h/i/jkl"===c("a/bc/def","g/h/i/jkl"))})})}var b=gpf.path;a("/"),a("\\"),gpf.internals&&describe("(internal)",function(){describe("_gpfPathNormalize",function(){var a={"a/":"a","/a/":"/a","a/b":"a/b","a\\b":"a/b","a\\":"a","\\a\\":"/a"};gpf.internals._gpfObjectForEach(a,function(a,b){it('transforms "'+b+'" into "'+a+'"',function(){assert(a===gpf.internals._gpfPathNormalize(b))})})})})}),describe("path/matcher",function(){describe("gpf.path.match",function(){var a=gpf.path.match,b=gpf.path.compileMatchPattern;it("matches simple file names",function(){assert(!0===a("test.js","test.js")),assert(!1===a("test.js","test.jsp")),assert(!1===a("test.js","new_test.js"))}),it("matches simple pattern",function(){assert(!0===a("*.js","test.js")),assert(!1===a("*.js","test.jsp")),assert(!1===a("*.txt","test.js"))}),it("matches negative pattern",function(){assert(!1===a("!*.js","test.js")),assert(!0===a("!*.txt","test.js"))}),it("matches multiple patterns",function(){var b=gpf.path.compileMatchPattern(["*.js","*.txt"]);assert(!0===a(b,"test.js")),assert(!0===a(b,"test.txt"))}),it("matches patterns that includes folders",function(){var c=b(["src/*.js","test/*.js"]);assert(!1===a(c,"test.js")),assert(!1===a(c,"src/test.txt")),assert(!0===a(c,"src/test.js")),assert(!1===a(c,"src/test/test.js")),assert(!1===a(c,"test/test.bin"))}),it("matches patterns that includes **",function(){var c=b(["src/**/*.js","src/data/**/*.json"]);assert(!1===a(c,"test.js")),assert(!0===a(c,"src/test.js")),assert(!0===a(c,"src/test/test.js")),assert(!0===a(c,"src/data/test.js")),assert(!0===a(c,"src/data/test.json")),assert(!1===a(c,"src/test/test.json")),assert(!0===a(c,"src/test/mocha/test.js"))}),it("matches patterns that starts with **",function(){var c=b(["**/*.js","**/data/*.json"]);assert(!0===a(c,"test.js")),assert(!0===a(c,"src/test.js")),assert(!0===a(c,"src/test/test.js")),assert(!1===a(c,"test.json")),assert(!1===a(c,"src/test.json")),assert(!0===a(c,"src/data/test.json"))}),it("matches patterns that ends with **",function(){var c=b(["src/**","lib/data/**"]);assert(!1===a(c,"test.js")),assert(!0===a(c,"src/test.js")),assert(!0===a(c,"src/test/test.js")),assert(!1===a(c,"lib/test.json")),assert(!0===a(c,"lib/data/test.json"))}),it("handles absolute patterns",function(){assert(!1===a("/test/rules/*.js","test.js")),assert(!0===a("/test/rules/*.js","/test/rules/any.js"))})})}),describe("javascript",function(){describe("gpf.js.keywords",function(){it("gives the list of JavaScript keywords",function(){assert(gpf.js.keywords()instanceof Array),assert("string"==typeof gpf.js.keywords()[0])})})}),describe("csv",function(){describe("gpf.csv.parse",function(){it("reads a one-column CSV file",function(){var a=gpf.csv.parse(["LINE","0","1"].join("\r\n"));assert(2===a.length),assert("0"===a[0].LINE),assert("1"===a[1].LINE)}),it("reads a CSV file",function(){var a=gpf.csv.parse(["LINE;VALUE","0;ABC","1;DEF"].join("\r\n"));assert(2===a.length),assert("0"===a[0].LINE),assert("ABC"===a[0].VALUE),assert("1"===a[1].LINE),assert("DEF"===a[1].VALUE)}),it("supports value quoting",function(){var a=gpf.csv.parse(["LINE;VALUE",'0;"ABC"',"1;DEF",'2;GH"I','3;"JK""L"','4;"MN','O"'].join("\r\n"));assert(5===a.length),assert("0"===a[0].LINE),assert("ABC"===a[0].VALUE),assert("1"===a[1].LINE),assert("DEF"===a[1].VALUE),assert("2"===a[2].LINE),assert('GH"I'===a[2].VALUE),assert("3"===a[3].LINE),assert('JK"L'===a[3].VALUE),assert("4"===a[4].LINE),assert("MN\r\nO"===a[4].VALUE)}),it("supports quoting the separator as well",function(){var a=gpf.csv.parse(["LINE;VALUE",'0;"A;BC"'].join("\r\n"));assert(1===a.length),assert("0"===a[0].LINE),assert("A;BC"===a[0].VALUE)}),it("supports header being specified as an option",function(){var a=gpf.csv.parse(["0;ABC","1;DEF"].join("\r\n"),{header:"LINE;VALUE"});assert(2===a.length),assert("0"===a[0].LINE),assert("ABC"===a[0].VALUE),assert("1"===a[1].LINE),assert("DEF"===a[1].VALUE)}),it("detects unterminated quoted string",function(){var a=!1;try{gpf.csv.parse(["LINE;VALUE",'0;"A',"BC"].join("\r\n"))}catch(b){assert(b instanceof gpf.Error),assert(b.code===gpf.Error.CODE_CSVINVALID),assert(b.code===gpf.Error.csvInvalid.CODE),assert("csvInvalid"===b.name),assert("Invalid CSV syntax (bad quote sequence or missing end of file)"===b.message),a=!0}assert(!0===a)}),it("detects invalid quoted string",function(){var a=!1;try{gpf.csv.parse(["LINE;VALUE",'0;"A"BC"'].join("\r\n"))}catch(b){assert(b instanceof gpf.Error),assert(b.code===gpf.Error.CODE_CSVINVALID),assert(b.code===gpf.Error.csvInvalid.CODE),assert("csvInvalid"===b.name),assert("Invalid CSV syntax (bad quote sequence or missing end of file)"===b.message),a=!0}assert(!0===a)})})}),describe("define",function(){describe("gpf.define",function(){gpf.context().test={};var a=gpf.define("A",{"protected":{_a:0},"public":{constructor:function(a){this._a=a},a:function(){return this._a}}}),b=gpf.define("B",a,{"private":{_b:0},"public":{constructor:function(a){this._b=a,this._super(a+1)},b:function(){return this._a+this._b}}});gpf.define("test.define.C",{}),describe("validate definitions",function(){it("generates constructor functions",function(){assert(a instanceof Function),assert("A"===a.compatibleName()),assert(b instanceof Function),assert("B"===b.compatibleName())}),it("extends namespaces",function(){assert(test.define.C instanceof Function),assert("C"===test.define.C.compatibleName())});var c="public|protected|private|static".split("|"),d="prevents combination of visibilities (";c.forEach(function(a){c.forEach(function(b){it(d+a+"/"+b+")",function(){var c,d={},e=d[a]={};e[b]={test:0};try{gpf.define("D",d)}catch(f){c=!0,assert(f.code===gpf.Error.CODE_CLASSINVALIDVISIBILITY)}assert(c)})})})}),describe("basic inheritance tests",function(){var c=new a(1),d=new b(1);it("handles instanceof",function(){assert(c instanceof a),assert(!(c instanceof b)),assert(d instanceof b)}),it("handles inherited instanceof",function(){assert(d instanceof a)}),it("exposes method A::a and provides access to A::_a",function(){assert(!c.hasOwnProperty("a")),assert(1===c.a())}),it("provides access to A::_a inside constructor of B",function(){assert(!d.hasOwnProperty("a")),assert(2===d.a())}),it("provides access to A::_a inside B::b",function(){assert(!d.hasOwnProperty("b")),assert(3===d.b())})}),describe("advanced inheritance tests",function(){var a=gpf.define("D",{"protected":{_dMember:0},"public":{constructor:function(a){this._dMember=a},dMember:function(){return this._dMember},overriddenMethod:function(a){return a+1}}}),b=gpf.define("E",a,{"public":{overriddenMethod:function(a){return this._super(a)+1}}});it("calls super constructor implicitly",function(){var a=new b(5);assert(5===a.dMember())}),it("allows calling super method",function(){var a=new b(0);assert(7===a.overriddenMethod(5))}),it("prevents overloading a member with a different type",function(){var a=!1;try{gpf.define("F",b,{"public":{overriddenMethod:"forbidden"}})}catch(c){assert(c instanceof gpf.Error),assert(c.code===gpf.Error.CODE_CLASSMEMBEROVERLOADWITHTYPECHANGE),assert(c.code===gpf.Error.classMemberOverloadWithTypeChange.CODE),assert("classMemberOverloadWithTypeChange"===c.name),assert("You can't overload a member and change its type"===c.message),a=!0}assert(!0===a)})}),describe("static members",function(){var a=gpf.define("D",{"static":{test:1}});it("declares members on the 'class'",function(){assert(1===a.test)})}),gpf.internals&&describe("(internal)",function(){describe("_gpfGetClassDefinition",function(){var b;before(function(){b=gpf.internals._gpfGetClassDefinition(a)}),it("provides information on the class defined with gpf.define",function(){assert(void 0!==b),assert("A"===b._name),assert(Object===b._Super),assert(1===b._Subs.length)}),it("provides information on the instance constructor defined with gpf.define",function(){var c=new a,d=gpf.internals._gpfGetClassDefinition(c.constructor);assert(void 0!==d),assert(b===d)}),describe("_gpfGetClassDefinition.addMember",function(){it("allows to add a member dynamically",function(){var c=new a;b.addMember("test","rulez"),assert("rulez"===c.test),b.addMember("staticTest","rulez","static"),assert("rulez"===a.staticTest)}),it("validates member visibility",function(){var a=!1;try{b.addMember("test2","fails","anything")}catch(c){assert(c instanceof gpf.Error),assert(c.code===gpf.Error.CODE_CLASSINVALIDVISIBILITY),assert(c.code===gpf.Error.classInvalidVisibility.CODE),assert("classInvalidVisibility"===c.name),assert("Invalid visibility keyword"===c.message),a=!0}assert(!0===a)})})})})})}),describe("attributes",function(){var a=gpf.define("TestAttribute","gpf.attributes.Attribute"),b=gpf.define("Test1ValueAttribute",a),c=gpf.define("Test2ValueAttribute",a),d=gpf.define("A",{"protected":{"[_a]":[new b],_a:0,"[_c]":[new b],_c:0},"public":{"[constructor]":[new b],constructor:function(a){this._a=a},a:function(){return this._a}}}),e=new d,f=gpf.define("B",d,{"protected":{"[_b]":[new c],_b:0,"[_c]":[new c],_c:0},"public":{constructor:function(a){this._super(a-1),this._b=a},b:function(){return this._b}}}),g=new f;describe("gpf.attributes.Attribute",function(){it("is available through gpf.attributes.Map",function(){var a,b=new gpf.attributes.Map(e);assert(3===b.getCount()),assert(1===b.getMemberAttributes("_a").getItemsCount()),a=b.getMemberAttributes("_a").getItem(0),assert("_a"===a.getMemberName()),assert(0===b.getMemberAttributes("_b").getItemsCount()),assert(1===b.getMemberAttributes("_c").getItemsCount()),assert(1===b.getMemberAttributes("constructor").getItemsCount())}),it("inherits from base class",function(){var a=new gpf.attributes.Map(g);assert(5===a.getCount()),assert(1===a.getMemberAttributes("_a").getItemsCount()),assert(1===a.getMemberAttributes("_b").getItemsCount()),assert(2===a.getMemberAttributes("_c").getItemsCount())}),it("signals any use on non-existing member",function(){var a=null;console.expects&&console.expects("error","gpf.define: Invalid attribute name '_b'",!1);try{gpf.define("C",d,{"[_b]":[new b]})}catch(c){a=c}assert(null===a);
})}),describe("gpf.attributes.Array",function(){it("allows to test the presence of an attribute",function(){var a=new gpf.attributes.Map(e),d=a.getMemberAttributes("_a");assert(1===d.getItemsCount()),assert(!0===d.has(b)),assert(!1===d.has(c))}),it("filters on attribute type",function(){var a=new gpf.attributes.Map(g),d=a.getMemberAttributes("_c"),e=d.filter(b),f=d.filter(c);assert(2===d.getItemsCount()),assert(!0===e.has(b)),assert(!1===e.has(c)),assert(!1===f.has(b)),assert(!0===f.has(c))}),it("offers an enumeration function based on [].forEach",function(){var a=new gpf.attributes.Map(g),b=a.getMemberAttributes("_c"),c={},d=b.forEach(function(a,b,d){assert("number"==typeof b),assert(a instanceof gpf.attributes.Attribute),assert(d instanceof Array),assert(2===d.length),c[a.constructor.compatibleName()]=[a]});assert(void 0===d),assert(1===c.Test1ValueAttribute.length),assert(1===c.Test2ValueAttribute.length)}),it("offers an enumeration function based on [].every",function(){var a,c=new gpf.attributes.Map(g),d=c.getMemberAttributes("_c"),e=d.every(function(c,d,e){return assert("number"==typeof d),assert(2===e.length),a=c,!(c instanceof b)});assert(!1===e),assert(a instanceof b)})}),describe("gpf.attributes.Map",function(){it("lists members that have attributes",function(){var a=new gpf.attributes.Map(e),b=a.getMembers();assert(3===b.length),assert(void 0!==gpf.test(b,"_a")),assert(void 0!==gpf.test(b,"_c")),assert(void 0!==gpf.test(b,"constructor"))}),it("filters on attribute type",function(){var a=new gpf.attributes.Map(g),b=a.filter(c);assert(2===b.getCount()),assert(1===b.getMemberAttributes("_c").getItemsCount())}),it("offers an enumeration function based on [].forEach",function(){var a=new gpf.attributes.Map(e),b=[],c=a.forEach(function(a,c,d){assert("string"==typeof c),assert(a instanceof gpf.attributes.Array),assert(null!==d),b.push(c)});assert(void 0===c),assert(3===b.length),assert(void 0!==gpf.test(b,"_a")),assert(void 0!==gpf.test(b,"_c")),assert(void 0!==gpf.test(b,"constructor"))}),it("is modifiable without altering initial list",function(){var a,b,d=new gpf.attributes.Map(e);d.add("_a",new c),assert(4===d.getCount()),a=d.getMemberAttributes("_a"),assert(2===a.getItemsCount()),b=new gpf.attributes.Map(e),assert(3===b.getCount()),a=b.getMemberAttributes("_a"),assert(1===a.getItemsCount())})})}),describe("attributes/attributes",function(){var a=gpf.attributes.Attribute;describe("gpf.$ClassAttribute",function(){it("can't be used on non-attribute classes",function(){var a=null;try{gpf.define("TestClass",{"[Class]":[gpf.$ClassAttribute()]})}catch(b){a=b}assert(null!==a),assert("onlyForAttributeClass"===a.name)});var b=gpf.define("TestAttribute",a,{"[Class]":[gpf.$ClassAttribute()]});it("can be used on Class",function(){var a=null;try{gpf.define("TestClass",{"[Class]":[new b]})}catch(c){a=c}assert(null===a)}),it("can't be used on members",function(){var a=null;try{gpf.define("TestClass",{"[a]":[new b],a:0})}catch(c){a=c}assert(null!==a),assert("classOnlyAttribute"===a.name)})}),describe("gpf.$MemberAttribute",function(){it("can't be used on non-attribute classes",function(){var a=null;try{gpf.define("TestClass",{"[Class]":[gpf.$MemberAttribute()]})}catch(b){a=b}assert(null!==a),assert("onlyForAttributeClass"===a.name)});var b=gpf.define("TestAttribute",a,{"[Class]":[gpf.$MemberAttribute()]});it("can be used on members",function(){var a=null;try{gpf.define("TestClass",{"[a]":[new b],a:0})}catch(c){a=c}assert(null===a)}),it("can't be used on Class",function(){var a=null;try{gpf.define("TestClass",{"[Class]":[new b]})}catch(c){a=c}assert(null!==a),assert("memberOnlyAttribute"===a.name)})}),describe("gpf.$UniqueAttribute",function(){it("can't be used on non-attribute classes",function(){var a=null;try{gpf.define("TestClass",{"[Class]":[gpf.$UniqueAttribute()]})}catch(b){a=b}assert(null!==a),assert("onlyForAttributeClass"===a.name)}),describe("(true) for the whole class",function(){it("should allow at least one instance",function(){var b=null;try{gpf.define("TestAttribute",a,{"[Class]":[gpf.$UniqueAttribute(!0)]})}catch(c){b=c}assert(null===b)});var b=gpf.define("TestAttribute",a,{"[Class]":[gpf.$UniqueAttribute(!0)]}),c=gpf.define("TestClass",{"[a]":[new b],a:0});it("prevents defining the attribute twice (define)",function(){var a=null;try{gpf.define("TestClass2",c,{"[b]":[new b],b:0})}catch(d){a=d}assert(null!==a),assert("uniqueAttributeConstraint"===a.name)}),it("prevents defining the attribute twice (add)",function(){var a=null;try{gpf.attributes.add(c,"Class",new b)}catch(d){a=d}assert(null!==a),assert("uniqueAttributeConstraint"===a.name)})}),describe("(false) for members",function(){it("should allow at least one instance",function(){var b=null;try{gpf.define("TestAttribute",a,{"[Class]":[gpf.$UniqueAttribute(!1)]})}catch(c){b=c}assert(null===b)});var b=gpf.define("TestAttribute",a,{"[Class]":[gpf.$UniqueAttribute(!1)]}),c=gpf.define("TestClass",{"[a]":[new b],a:0});it("prevents defining the attribute twice (define)",function(){var a=null;try{gpf.define("TestClass2",c,{"[a]":[new b]})}catch(d){a=d}assert(null!==a),assert("uniqueMemberAttributeConstraint"===a.name)}),it("prevents defining the attribute twice (add)",function(){var a=null;try{gpf.attributes.add(c,"a",new b)}catch(d){a=d}assert(null!==a),assert("uniqueMemberAttributeConstraint"===a.name)}),it("allows use on different members",function(){var a=null;try{gpf.define("TestClass2",c,{"[b]":[new b],b:0})}catch(d){a=d}assert(null===a)})})})}),describe("attributes/class",function(){var a=gpf.define("A",{"private":{"[_a]":[gpf.$ClassProperty(!1)],_a:0,"[aLittleBitMoreThanB]":[gpf.$ClassProperty(!0,"b","public")],aLittleBitMoreThanB:0,"[internalProperty]":[gpf.$ClassProperty(!0)],internalProperty:0},"public":{constructor:function(){this._a=0,this.aLittleBitMoreThanB=1}}}),b=new a;describe("gpf.$ClassProperty",function(){it("declares only one getter for read-only members",function(){assert("function"==typeof b.getA),assert(0===b.getA.length),assert(!b.hasOwnProperty("getA")),assert(void 0===b.setA),assert(0===b.getA())}),it("declares a getter and a setter members",function(){assert("function"==typeof b.getB),assert(0===b.getB.length),assert(!b.hasOwnProperty("getB")),assert("function"==typeof b.setB),assert(1===b.setB.length),assert(!b.hasOwnProperty("setB")),assert(1===b.getB()),assert(1===b.setB(2)),assert(2===b.getB())})})}),describe("interfaces",function(){function a(a,b){return assert(a),assert(b),this}function b(a,b){return assert(a),assert(b),this}function c(a,b){return assert(a),assert(b),null}function d(){}function e(){}var f=gpf.interfaces.IEventDispatcher;d.prototype={addEventListener:a},e.prototype=new d,e.prototype.removeEventListener=b,e.prototype.dispatchEvent=c,describe("gpf.interfaces.isImplementedBy",function(){it("verifies that an object implements an interface",function(){var d={addEventListener:a,removeEventListener:b,dispatchEvent:c};assert(!0===gpf.interfaces.isImplementedBy(d,f))}),it("checks function signatures",function(){var a={addEventListener:function(a,b,c){return a+b+c},removeEventListener:b};assert(!1===gpf.interfaces.isImplementedBy(a,f))}),it("works through inheritance",function(){assert(!0===gpf.interfaces.isImplementedBy(new e,f))}),it("works with classes",function(){assert(!0===gpf.interfaces.isImplementedBy(e,f))})}),describe("gpf.interfaces.query",function(){it("generates an error if interface not available",function(){var a;try{gpf.interfaces.query({},f)}catch(b){a=b}assert(null!==a),assert(a.code===gpf.Error.CODE_INTERFACEEXPECTED),assert(a.code===gpf.Error.interfaceExpected.CODE),assert("interfaceExpected"===a.name),assert("Expected interface not implemented: gpf.interfaces.IEventDispatcher"===a.message)}),it("can also just return null if interface not available",function(){assert(null===gpf.interfaces.query({},f,!1))}),it("retrieves an object for the expected interface",function(){var a=new e,b=gpf.interfaces.query(a,f,!1);assert(null!==b),assert(a===b),assert(!0===gpf.interfaces.isImplementedBy(b,f))})}),describe("IUnknown",function(){function a(){}a.prototype.queryInterface=function(a){return f===a?new e:null},it("exposes queryInterface",function(){assert(!0===gpf.interfaces.isImplementedBy(a,gpf.interfaces.IUnknown))}),it("is used by gpf.interfaces.query",function(){var b=new a,c=gpf.interfaces.query(b,f,!1);assert(null!==c),assert(!0===gpf.interfaces.isImplementedBy(c,f))})}),describe("$InterfaceImplement",function(){describe("serves as documentation (no builder)",function(){var d=gpf.define("TestAttribute","gpf.attributes.Attribute"),e=gpf.define("IMyInterface",{"[myInterfaceMethod]":[new d],myInterfaceMethod:function(){}}),g=gpf.define("SampleDispatcher",{"[Class]":[gpf.$InterfaceImplement(f),gpf.$InterfaceImplement(e)],"public":{addEventListener:a,removeEventListener:b,dispatchEvent:c,myInterfaceMethod:function(){}}});it("does not generate queryInterface",function(){var a=new g,b=gpf.interfaces.query(a,f,!1);assert(null!==b),assert(!0===gpf.interfaces.isImplementedBy(b,f)),assert(void 0===a.queryInterface)}),it("forwards attributes set on the interface",function(){})}),describe("builder as a member name",function(){var a=gpf.define("SampleBuilder",{"[Class]":[gpf.$InterfaceImplement(f,"_getAswEventDispatcher")],"private":{_getAswEventDispatcher:function(){return new e}}});it("exposes queryInterface (when builder is provided)",function(){assert(!0===gpf.interfaces.isImplementedBy(a,gpf.interfaces.IUnknown))}),it("is used by gpf.interfaces.query",function(){var b=new a,c=gpf.interfaces.query(b,f,!1);assert(null!==c),assert(!0===gpf.interfaces.isImplementedBy(c,f))})}),describe("builder as a standalone function",function(){function a(a){return assert(null!==a),{myInterfaceMethod:function(){return"ok"}}}function b(a){return assert(null!==a),new e}var c=gpf.define("IMyInterface",{myInterfaceMethod:function(){}}),d=gpf.define("SampleBuilder",{"[Class]":[gpf.$InterfaceImplement(f,b),gpf.$InterfaceImplement(c,a)]});it("exposes queryInterface",function(){assert(!0===gpf.interfaces.isImplementedBy(d,gpf.interfaces.IUnknown))}),it("is used by gpf.interfaces.query",function(){var a=new d,b=gpf.interfaces.query(a,f,!1);assert(null!==b),assert(!0===gpf.interfaces.isImplementedBy(b,f))})}),describe("builder on top of existing queryInterface",function(){var a=gpf.define("IMyInterface",{myInterfaceMethod:function(){}}),b=gpf.define("SampleBuilder",{"[Class]":[gpf.$InterfaceImplement(f,"_getAswEventDispatcher")],"private":{_getAswEventDispatcher:function(){return new e}},"public":{queryInterface:function(b){if(b===f)assert(!1);else if(b===a)return{myInterfaceMethod:function(){return"ok"}};return null}}});it("wraps existing queryInterface",function(){var c=new b,d=gpf.interfaces.query(c,a,!1);assert(null!==d),assert(!0===gpf.interfaces.isImplementedBy(d,a)),assert("ok"===d.myInterfaceMethod())}),it("it adds declared builders",function(){var a=new b,c=gpf.interfaces.query(a,f,!1);assert(null!==c),assert(!0===gpf.interfaces.isImplementedBy(c,f))})})})}),describe("interfaces/enumerator",function(){describe("IEnumerator",function(){it("is a known and static interface",function(){assert(gpf.interfaces.isImplementedBy({reset:function(){},moveNext:function(a){},current:function(){}},gpf.interfaces.IEnumerator))})});var a=gpf.interfaces,b=gpf.events,c=gpf.define("ArrayEnumerable",{"private":{"[_items]":[gpf.$Enumerable()],_items:[]},"public":{constructor:function(a){this._items=a}}});describe("gpf.attributes.EnumerableAttribute",function(){it("exposes gpf.interfaces.IEnumerator on instances",function(){var a=new c,b=gpf.interfaces.query(a,gpf.interfaces.IEnumerator,!1);assert(null!==b),assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IEnumerator,b))}),it("checks that it was used on an array member",function(){var a=!1;try{gpf.define("NotEnumerable",{"private":{"[_notAnArray]":[gpf.$Enumerable()],_notAnArray:null}})}catch(b){assert(b instanceof gpf.Error),assert(b.code===gpf.Error.CODE_ENUMERABLEINVALIDMEMBER),assert(b.code===gpf.Error.enumerableInvalidMember.CODE),assert("enumerableInvalidMember"===b.name),assert("$Enumerator can be associated to arrays only"===b.message),a=!0}assert(!0===a)}),it("allows sequential (and synchronous) access to items",function(){var b,d;b=new c([1,2,3]),d=a.query(b,a.IEnumerator),assert(null!==d),d.reset(),assert(!0===d.moveNext()),assert(1===d.current()),assert(!0===d.moveNext()),assert(2===d.current()),assert(!0===d.moveNext()),assert(3===d.current()),assert(!1===d.moveNext()),d.reset(),assert(!0===d.moveNext()),assert(1===d.current())}),it("supports (simulated) asynchronous access to items",function(b){function d(a){try{if(a.type===gpf.events.EVENT_END_OF_DATA)return void b();assert(!1)}catch(c){b(c)}}var e,f,g=0;for(e=new c([1,2,3]),f=a.query(e,a.IEnumerator),assert(null!==f),f.reset();f.moveNext(d);)assert(f.current()===++g)})}),describe("IEnumerator.each",function(){function c(a){return{_current:-1,reset:function(){assert(!1)},moveNext:a,current:function(){return this._current}}}function d(a){return++this._current<10?!0:(b.fire(b.EVENT_END_OF_DATA,a),!1)}function e(a){return++this._current<10?b.fire(b.EVENT_DATA,a):b.fire(b.EVENT_END_OF_DATA,a),!1}describe("synchronous callback",function(){it("works with synchronous interface",function(e){var f=0;a.IEnumerator.each(c(d),function(a){assert(f++===a)},function(a){assert(b.EVENT_END_OF_DATA===a.type),assert(10===f),e()})}),it("works with asynchronous interface",function(d){var f=0;a.IEnumerator.each(c(e),function(a){assert(f++===a)},function(a){assert(b.EVENT_END_OF_DATA===a.type),assert(10===f),d()})})}),describe("asynchronous callback",function(){it("works with synchronous interface",function(e){var f=0;a.IEnumerator.each(c(d),function(a,c){assert(f++===a),b.fire(b.EVENT_CONTINUE,c)},function(a){assert(b.EVENT_END_OF_DATA===a.type),assert(10===f),e()})}),it("works with asynchronous interface",function(d){var f=0;a.IEnumerator.each(c(e),function(a,c){assert(f++===a),b.fire(b.EVENT_CONTINUE,c)},function(a){assert(b.EVENT_END_OF_DATA===a.type),assert(10===f),d()})}),it("allows stopping the process",function(d){var f=0;a.IEnumerator.each(c(e),function(a,c){assert(f++===a),5===f?b.fire(b.EVENT_STOP,c):b.fire(b.EVENT_CONTINUE,c)},function(a){assert(b.EVENT_STOPPED===a.type),assert(5===f),d()})})})}),describe("IEnumerator.fromArray",function(){it("encapsulates an array into an IEnumerator interface",function(){var b=a.IEnumerator.fromArray([1,2,3]);assert(null!==b),b.reset(),assert(!0===b.moveNext()),assert(1===b.current()),assert(!0===b.moveNext()),assert(2===b.current()),assert(!0===b.moveNext()),assert(3===b.current()),assert(!1===b.moveNext()),b.reset(),assert(!0===b.moveNext()),assert(1===b.current())})})}),describe("interfaces/array",function(){describe("IReadOnlyArray",function(){it("is a known and static interface",function(){assert(gpf.interfaces.isImplementedBy({getItemsCount:function(){},getItem:function(a){}},gpf.interfaces.IReadOnlyArray))})}),describe("IArray",function(){it("is a known and static interface",function(){assert(gpf.interfaces.isImplementedBy({getItemsCount:function(){},setItemsCount:function(a){},getItem:function(a){},setItem:function(a,b){}},gpf.interfaces.IArray))})}),describe("$ClassIArray(false)",function(){var a=gpf.interfaces,b=gpf.define("A",{"private":{"[_items]":[gpf.$ClassIArray(!1)],_items:[]},"public":{constructor:function(a){this._items=a}}});it("exposes an array member to IReadOnlyArray interface",function(){assert(a.isImplementedBy(b,a.IReadOnlyArray));var c=new b([1,2,3]);assert(a.isImplementedBy(c,a.IReadOnlyArray)),assert(3===c.getItemsCount()),assert(1===c.getItem(0)),assert(2===c.getItem(1)),assert(3===c.getItem(2))})}),describe("$ClassIArray(true)",function(){var a=gpf.interfaces,b=gpf.define("A",{"private":{"[_items]":[gpf.$ClassIArray(!0)],_items:[]},"public":{constructor:function(a){this._items=a}}});it("exposes an array member to IReadOnlyArray interface",function(){assert(a.isImplementedBy(b,a.IReadOnlyArray));var c=new b([1,2,3]);assert(a.isImplementedBy(c,a.IReadOnlyArray)),assert(3===c.getItemsCount()),assert(1===c.getItem(0)),assert(2===c.getItem(1)),assert(3===c.getItem(2))}),it("exposes an array member to IArray interface",function(){assert(a.isImplementedBy(b,a.IArray));var c=new b([]);assert(a.isImplementedBy(c,a.IArray)),assert(0===c.getItemsCount()),c.setItemsCount(2),assert(2===c.getItemsCount()),c.setItem(0,"abc"),assert("abc"===c.getItem(0))})})}),describe("interfaces/stream",function(){describe("IReadableStream",function(){it("is a known and static interface",function(){assert(gpf.interfaces.isImplementedBy({read:function(a,b){}},gpf.interfaces.IReadableStream))})}),describe("IWritableStream",function(){it("is a known and static interface",function(){assert(gpf.interfaces.isImplementedBy({write:function(a,b){}},gpf.interfaces.IWritableStream))})})}),describe("interfaces/filestorage",function(){describe("IFileStorage",function(){it("is a known and static interface",function(){assert(gpf.interfaces.isImplementedBy({getInfo:function(a,b){},readAsBinaryStream:function(a,b){},writeAsBinaryStream:function(a,b){},close:function(a,b){},explore:function(a,b){},createFolder:function(a,b){},deleteFile:function(a,b){},deleteFolder:function(a,b){}},gpf.interfaces.IFileStorage))})})}),describe("fs",function(){function a(a,b){return gpf.events.fire(gpf.events.EVENT_ERROR,{error:gpf.error.notImplemented()},b),a}function b(a,b){var c,d=b.split("/").pop();void 0===a._fileInfo&&(c=a._fileInfo={fileName:d,filePath:b,createdDateTime:new Date,modifiedDateTime:new Date},a._size?(c.type=gpf.fs.TYPE_FILE,c.size=a._size,delete a._size):(c.type=gpf.fs.TYPE_DIRECTORY,c.size=0))}function c(a){var c,d,f=a.split("/"),g=e;if("test"===f.shift()){for(c="test",b(g,c);0<f.length;){if(d=f[0],"object"!=typeof g[d])return;f.shift(),g=g[d],c=c+"/"+d,b(g,c)}return g}}function d(a){var d,e=c(a),f=[];if(void 0!==e)for(d in e)e.hasOwnProperty(d)&&"_fileInfo"!==d&&(b(e[d],a+"/"+d),f.push(a+"/"+d));return f}var e={data:{"file.bin":{_size:256}},unknown:{sub:{unknownType:{_fileInfo:{type:gpf.fs.TYPE_UNKNOWN,size:0,fileName:"unknownType",filePath:"test/unknown/sub/unknownType",createdDateTime:new Date,modifiedDateTime:new Date}}}},error:{noFileInfo:{_fileInfo:null}}},f={getInfo:function(a,b){var d,e=c(a);d=void 0===e?{type:gpf.fs.TYPE_NOT_FOUND}:e._fileInfo,d?gpf.events.fire(gpf.events.EVENT_READY,{info:d},b):gpf.events.fire(gpf.events.EVENT_ERROR,{error:"no file info"},b)},readAsBinaryStream:a,writeAsBinaryStream:a,close:a,explore:function(a,b){if("string"!=typeof a)return void gpf.events.fire(gpf.events.EVENT_ERROR,{error:gpf.Error.invalidParameter()},b);var c=d(a),e=gpf.internals._gpfFsExploreEnumerator(this,c);gpf.events.fire(gpf.events.EVENT_READY,{enumerator:e},b)},createFolder:a,deleteFile:a,deleteFolder:a};gpf.internals&&describe("(internal)",function(){describe("_gpfFsExploreEnumerator",function(){it("helps building explore functions",function(a){gpf.events.getPromiseHandler(function(a){f.explore("test/data",a)}).then(function(b){assert(gpf.events.EVENT_READY===b.type);var c=b.get("enumerator");assert(!0===gpf.interfaces.isImplementedBy(c,gpf.interfaces.IEnumerator)),a()})["catch"](function(b){a(b)})}),it("supports reset",function(a){var b,c;gpf.events.getPromiseHandler(function(a){f.explore("test/data",a)}).then(function(a){return assert(gpf.events.EVENT_READY===a.type),b=a.get("enumerator"),b.reset(),gpf.events.getPromiseHandler(function(a){b.moveNext(a)&&gpf.fire.event(gpf.events.EVENT_DATA,a)})}).then(function(a){return assert(gpf.events.EVENT_DATA===a.type),c=b.current(),assert(null!==c),b.reset(),gpf.events.getPromiseHandler(function(a){b.moveNext(a)&&gpf.fire.event(gpf.events.EVENT_DATA,a)})}).then(function(d){assert(gpf.events.EVENT_DATA===d.type),assert(c===b.current()),a()})["catch"](function(b){a(b)})}),it("forwards errors (from explore)",function(a){gpf.events.getPromiseHandler(function(a){f.explore(null,a)}).then(function(a){assert(gpf.events.EVENT_ERROR!==a.type)})["catch"](function(b){try{assert(gpf.Error.invalidParameter.CODE===b.code),a()}catch(c){a(c)}})}),it("forwards errors (from getInfo)",function(a){gpf.events.getPromiseHandler(function(a){f.explore("test/error",a)}).then(function(a){assert(gpf.events.EVENT_READY===a.type);var b=a.get("enumerator");return gpf.events.getPromiseHandler(function(a){b.moveNext(a)&&gpf.fire.event(gpf.events.EVENT_DATA,a)})}).then(function(a){assert(gpf.events.EVENT_ERROR!==a.type)})["catch"](function(b){try{assert("no file info"===b),a()}catch(c){a(c)}})}),it("provides an asynchronous enumerator",function(a){gpf.events.getPromiseHandler(function(a){f.explore("test/error",a)}).then(function(b){assert(gpf.events.EVENT_READY===b.type);var c=b.get("enumerator");assert(!1===c.moveNext()),a()})["catch"](function(b){a(b)})}),it("automates calling getInfo from file path",function(a){function b(b){try{assert(gpf.events.EVENT_END_OF_DATA===b.type),assert(1===c.length),a()}catch(d){a(d)}}var c=[];f.explore("test/data",function(d){try{assert(gpf.events.EVENT_READY===d.type);var e=d.get("enumerator");gpf.interfaces.IEnumerator.each(e,function(b){try{assert("number"==typeof b.type),assert("string"==typeof b.fileName),assert("string"==typeof b.filePath),assert("number"==typeof b.size),assert(null===b.createdDateTime||b.createdDateTime instanceof Date),assert(null===b.modifiedDateTime||b.modifiedDateTime instanceof Date),c.push(b)}catch(d){a(d)}},b)}catch(f){a(f)}})})}),describe("_gpfFsBuildFindMethod",function(){var a,b=gpf.internals._gpfFsBuildFindMethod;beforeEach(function(){a=b(f)}),it("builds a find method",function(){assert("function"==typeof a),assert(3===a.length)}),it("finds files using path matchers",function(b){gpf.events.getPromiseHandler(function(b){a("test/data","*.bin",b)}).then(function(a){assert(gpf.events.EVENT_DATA===a.type),assert("file.bin"===a.get("path")),b()})["catch"](function(a){b(a)})}),it("forwards errors (initial getInfo)",function(b){gpf.events.getPromiseHandler(function(b){a("test/error/noFileInfo","*.bin",b)}).then(function(){assert(!1)})["catch"](function(a){try{assert("no file info"===a),b()}catch(c){b(c)}})}),it("forwards errors (during enumeration)",function(b){var c=!1;a("test","*.dat",function(a){gpf.events.EVENT_ERROR===a.type?c?b(a):c=!0:gpf.events.EVENT_END_OF_DATA===a.type&&(c?b():b("Error was not raised"))})})})}),null!==gpf.fs.host()&&(describe("Data generator",function(){it("file.bin",function(a){var b=gpf.fs.host();b.getInfo("test/data/file.bin",function(c){function d(c){assert(!c||gpf.events.EVENT_READY===c.type),256===f&&(b.close(e,function(){}),a()),e.write([f++],d)}if(c.type===gpf.events.EVENT_READY&&c.get("info").type===gpf.fs.TYPE_FILE)return void a();var e,f=0;b.writeAsBinaryStream("test/data/file.bin",function(a){assert(gpf.events.EVENT_READY===a.type),e=a.get("stream"),d()})})})}),describe("gpf.fs.host",function(){function a(a){b.close(a,function(){})}var b,c=gpf.interfaces;beforeEach(function(){b=gpf.fs.host()}),it("gives access to a IFileStorage interface",function(){assert(null!==b),null!==b&&assert(c.isImplementedBy(b,c.IFileStorage))}),describe("getInfo",function(){function a(a){assert(null!==a),assert("object"==typeof a),assert("number"==typeof a.type),assert("string"==typeof a.fileName),assert("string"==typeof a.filePath),assert("number"==typeof a.size),assert("object"==typeof a.createdDateTime),assert("object"==typeof a.modifiedDateTime)}it("tells if a file exists",function(c){b.getInfo("src/fs.js",function(b){assert(b.type===gpf.events.EVENT_READY);var d=b.get("info");a(d),assert(d.type===gpf.fs.TYPE_FILE),assert(d.size>0),c()})}),it("tells if a directory exists",function(c){b.getInfo("src",function(b){assert(b.type===gpf.events.EVENT_READY);var d=b.get("info");a(d),assert(d.type===gpf.fs.TYPE_DIRECTORY),c()})}),it("tells if a path does not exists",function(a){b.getInfo("null",function(b){assert(b.type===gpf.events.EVENT_READY);var c=b.get("info");assert(null!==c),assert("object"==typeof c),assert(c.type===gpf.fs.TYPE_NOT_FOUND),a()})})}),describe("readAsBinaryStream",function(){it("reads binary files",function(c){b.readAsBinaryStream("test/data/file.bin",function(b){assert(gpf.events.EVENT_READY===b.type);var d=b.get("stream");d.read(1,function(b){assert(gpf.events.EVENT_DATA===b.type);var e=b.get("buffer");assert(1===e.length),assert(0===e[0]),a(d),c()})})})}),describe("writeAsBinaryStream",function(){it("writes binary files",function(c){b.writeAsBinaryStream("tmp/test/fs_"+gpf.host()+".bin",function(b){assert(gpf.events.EVENT_READY===b.type);var d=b.get("stream");d.write([0,34,75,0,128,255],function(b){assert(gpf.events.EVENT_READY===b.type),a(d),c()})})})}),describe("explore",function(){it("fails on a file",function(a){b.explore("src/fs.js",function(b){assert(gpf.events.EVENT_ERROR===b.type),a()})}),it("gets an IEnumerator on a folder",function(a){b.explore("src",function(b){assert(gpf.events.EVENT_READY===b.type);var c=b.get("enumerator");assert(null!==c),assert(gpf.interfaces.isImplementedBy(c,gpf.interfaces.IEnumerator)),a()})})})}))}),describe("stream",function(){}),describe("stream/pipe",function(){}),describe("string",function(){describe("gpf.capitalize",function(){it("does nothing on empty string",function(){assert(""===gpf.capitalize(""))}),it("uppercases the first letter",function(){assert("Word"===gpf.capitalize("word")),assert("Two words"===gpf.capitalize("two words")),assert("Two words"===gpf.capitalize("Two words"))}),it("also handles accents",function(){assert("Éric"===gpf.capitalize("éric"))})}),describe("gpf.replaceEx",function(){it("replaces strings recursively",function(){assert("add"===gpf.replaceEx("abc",{a:"abc",b:"dc",c:""}))})}),describe("gpf.escapeFor",function(){it("escapes for JavaScript",function(){assert('"abc\\r\\ndef"'===gpf.escapeFor("abc\r\ndef","javascript"))}),it("escapes for xml",function(){assert("&lt;a&amp;b&gt;"===gpf.escapeFor("<a&b>","xml"))}),it("escapes for html",function(){assert("&lt;a&amp;b:&eacute;&egrave;&ecirc;&aacute;&agrave;&gt;"===gpf.escapeFor("<a&b:éèêáà>","html"))})}),describe("gpf.stringToStream",function(){it("supports writing",function(a){var b=gpf.stringToStream(""),c=gpf.interfaces.query(b,gpf.interfaces.IWritableStream);assert(null!==c),gpf.events.getPromiseHandler(function(a){c.write("abc",a)}).then(function(a){return assert(gpf.events.EVENT_READY===a.type),gpf.events.getPromiseHandler(function(a){c.write("def",a)})}).then(function(c){assert(gpf.events.EVENT_READY===c.type),assert("abcdef"===b.toString()),a()})["catch"](function(b){a(b)})}),it("supports reading",function(a){var b=gpf.stringToStream("abcdef"),c=gpf.interfaces.query(b,gpf.interfaces.IReadableStream);assert(null!==c),gpf.events.getPromiseHandler(function(a){c.read(3,a)}).then(function(a){assert(gpf.events.EVENT_DATA===a.type);var b=a.get("buffer");return assert("string"==typeof b),assert(3===b.length),assert("abc"===b),gpf.events.getPromiseHandler(function(a){c.read(2,a)})}).then(function(a){assert(gpf.events.EVENT_DATA===a.type);var b=a.get("buffer");return assert("string"==typeof b),assert(2===b.length),assert("de"===b),gpf.events.getPromiseHandler(function(a){c.read(100,a)})}).then(function(a){assert(gpf.events.EVENT_DATA===a.type);var b=a.get("buffer");return assert("string"==typeof b),assert(1===b.length),assert("f"===b),gpf.events.getPromiseHandler(function(a){c.read(100,a)})}).then(function(b){assert(gpf.events.EVENT_END_OF_DATA===b.type),a()})["catch"](function(b){a(b)})}),it("supports reading and writing",function(a){var b=gpf.stringToStream("abcdef"),c=gpf.interfaces.query(b,gpf.interfaces.IWritableStream),d=gpf.interfaces.query(b,gpf.interfaces.IReadableStream);gpf.events.getPromiseHandler(function(a){c.write("ghi",a)}).then(function(){return gpf.events.getPromiseHandler(function(a){d.read(7,a)})}).then(function(a){var b=a.get("buffer");return assert("string"==typeof b),assert(7===b.length),assert("abcdefg"===b),gpf.events.getPromiseHandler(function(a){c.write("k",a)})}).then(function(){return gpf.events.getPromiseHandler(function(a){d.read(3,a)})}).then(function(b){var c=b.get("buffer");assert("string"==typeof c),assert(3===c.length),assert("hik"===c),a()})["catch"](function(b){a(b)})})}),describe("gpf.stringFromStream",function(){it("converts immediately a StringStream to string",function(a){var b="abcdef",c=gpf.stringToStream(b);gpf.events.getPromiseHandler(function(a){gpf.stringFromStream(c,a)}).then(function(c){assert(gpf.events.EVENT_READY===c.type),assert(b===c.get("buffer")),a()})["catch"](function(b){a(b)})}),it("fills a string by reading a stream",function(a){var b="abcdef",c={pos:0,read:function(a,c){var d;this.pos===b.length?gpf.events.fire.call(this,gpf.events.EVENT_END_OF_DATA,{},c):(d=b.charAt(this.pos++),gpf.events.fire.call(this,gpf.events.EVENT_DATA,{buffer:d},c))}};gpf.events.getPromiseHandler(function(a){gpf.stringFromStream(c,a)}).then(function(c){assert(gpf.events.EVENT_READY===c.type),assert(b===c.get("buffer")),a()})["catch"](function(b){a(b)})}),it("forwards errors",function(a){var b={pos:0,read:function(a,b){0===this.pos?(++this.pos,gpf.events.fire.call(this,gpf.events.EVENT_DATA,{buffer:"abc"},b)):gpf.events.fire.call(this,gpf.events.EVENT_ERROR,{error:"KO"},b)}};gpf.events.getPromiseHandler(function(a){gpf.stringFromStream(b,a)}).then(function(){a("Not supposed to work")})["catch"](function(b){assert("KO"===b),a()})})}),describe("gpf.stream.pipe",function(){it("accepts a chunk size",function(a){var b=gpf.stringToStream("abcdef"),c=gpf.stringToStream();gpf.events.getPromiseHandler(function(a){gpf.stream.pipe({readable:b,writable:c,chunkSize:1},a)}).then(function(b){assert(gpf.events.EVENT_READY===b.type),assert("abcdef"===c.toString()),a()})["catch"](function(b){a(b)})})}),gpf.internals&&describe("Strings array",function(){var a=[{label:"too much",strings:["a","b","c"],size:2,count:2,remaining:0,expectedResult:"ab",expectedStrings:["c"]},{label:"matching",strings:["a","b","c"],size:3,count:3,remaining:0,expectedResult:"abc",expectedStrings:[]},{label:"not enough",strings:["a","b","c"],size:4,count:3,remaining:1,expectedResult:"abc",expectedStrings:[]},{label:"empty strings",strings:[],size:3,count:0,remaining:3,expectedResult:"",expectedStrings:[]},{label:"split required",strings:["abc","def","ghi"],size:4,count:1,remaining:1,expectedResult:"abcd",expectedStrings:["ef","ghi"]}];describe("_gpfStringArrayCountToFit",function(){var b=gpf.internals._gpfStringArrayCountToFit;a.forEach(function(a){var c="counts the number of parts needed to fit requested size ("+a.label+")";it(c,function(){var c=b(a.strings,a.size);assert(a.count===c.count),assert(a.remaining===c.remaining)})})}),describe("_gpfStringArraySplice",function(){var b=gpf.internals._gpfStringArraySplice;a.forEach(function(a){var c="splices the string array and return the concatenated result ("+a.label+")";it(c,function(){var c=[].concat(a.strings),d=b(c,a.count,a.remaining);assert(a.expectedResult===d),assert(!0===gpf.like(a.expectedStrings,c))})})}),describe("_gpfStringArrayExtract",function(){var b=gpf.internals._gpfStringArrayExtract;a.forEach(function(a){var c="extracts a string from a string array ("+a.label+")";it(c,function(){var c=[].concat(a.strings),d=b(c,a.size);assert(a.expectedResult===d),assert(!0===gpf.like(a.expectedStrings,c))})})})})}),describe("array",function(){describe("gpf.arrayToStream",function(){it("can be used for reading",function(a){var b=[1,2,3],c=gpf.arrayToStream(b);gpf.events.getPromiseHandler(function(a){c.read(2,a)}).then(function(a){return assert(gpf.events.EVENT_DATA===a.type),assert(!0===gpf.like(a.get("buffer"),[1,2])),gpf.events.getPromiseHandler(function(a){c.read(2,a)})}).then(function(a){return assert(gpf.events.EVENT_DATA===a.type),assert(!0===gpf.like(a.get("buffer"),[3])),gpf.events.getPromiseHandler(function(a){c.read(2,a)})}).then(function(c){assert(gpf.events.EVENT_END_OF_DATA===c.type),assert(!0===gpf.like(b,[1,2,3])),a()})["catch"](function(b){
a(b)})}),it("can be used for writing",function(a){var b=gpf.arrayToStream();gpf.events.getPromiseHandler(function(a){b.write([1,2],a)}).then(function(a){return assert(gpf.events.EVENT_READY===a.type),gpf.events.getPromiseHandler(function(a){b.write([3],a)})}).then(function(c){assert(gpf.events.EVENT_READY===c.type),assert(!0===gpf.like(b.toArray(),[1,2,3])),a()})["catch"](function(b){a(b)})})}),describe("gpf.arrayFromStream",function(){it("converts immediately an ArrayStream to array",function(a){var b=gpf.arrayToStream([1,2,3]);gpf.events.getPromiseHandler(function(a){gpf.arrayFromStream(b,a)}).then(function(b){assert(gpf.events.EVENT_READY===b.type),assert(!0===gpf.like(b.get("buffer"),[1,2,3])),a()})["catch"](function(b){a(b)})}),it("fills an array by reading a stream",function(a){var b=[0,3475,"abc",!1,!0,null],c={pos:0,read:function(a,c){var d;this.pos===b.length?gpf.events.fire.call(this,gpf.events.EVENT_END_OF_DATA,{},c):(d=b.slice(this.pos++,this.pos),gpf.events.fire.call(this,gpf.events.EVENT_DATA,{buffer:d},c))}};gpf.events.getPromiseHandler(function(a){gpf.arrayFromStream(c,a)}).then(function(c){assert(gpf.events.EVENT_READY===c.type),assert(!0===gpf.like(b,c.get("buffer"))),a()})["catch"](function(b){a(b)})}),it("forwards errors",function(a){var b={pos:0,read:function(a,b){0===this.pos?(++this.pos,gpf.events.fire.call(this,gpf.events.EVENT_DATA,{buffer:[0,1,2]},b)):gpf.events.fire.call(this,gpf.events.EVENT_ERROR,{error:"KO"},b)}};gpf.events.getPromiseHandler(function(a){gpf.arrayFromStream(b,a)}).then(function(){a("Not supposed to work")})["catch"](function(b){assert("KO"===b),a()})})})});