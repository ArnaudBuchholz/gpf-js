<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>GPF-JS</title>
        <link rel="stylesheet" type="text/css" href="res/html.css">
        <link rel="stylesheet" type="text/css" href="res/table.css">
        <link rel="stylesheet" type="text/css" href="res/sources.css">
        <script language="JavaScript" src="build/gpf-debug.js"></script>
        <script language="JavaScript" src="res/xhr.js"></script>
        <script language="JavaScript" src="res/tpl.js"></script>
        <script language="JavaScript" src="sources.js"></script>
        <script language="JavaScript">

var tplFunc,
    sourceRows,
    sources;

function upToRow(target) {
    var current = target;
    while (current && current.tagName.toLowerCase() !== "tr") {
        current = current.parentNode;
    }
    return current;
}

function refresh(target, source) {
    var row = upToRow(target),
        newRow = tplFunc(source, source.getIndex());
    sourceRows.replaceChild(newRow, row);
}

function reload() {
    sources.forEach(function (item, index) {
        sourceRows.appendChild(tplFunc(item, index));
    });
}

function onClick(event) {
    var target = event.target,
        parts,
        source;
    if ("checkbox" === target.getAttribute("type")) {
        parts = target.id.split("_"); // property_sourceIndex
        source = sources.byIndex(parseInt(parts[1], 10));
        if (source.setProperty(parts[0], target.checked)) {
            refresh(target, source);
            document.getElementById("save").removeAttribute("disabled");
        } else {
            target.checked = !target.checked; // Restore value
        }
    } else if ("description" === target.className) {
        alert(target.innerHTML); // TODO propose an text field to edit the description
    }
}

var draggedSourceName;

function onDrag(event) {
    if (!event.target.className) {
        draggedSourceName = event.target.id;
        var minIndex = sources.getMinIndexFor(event.target.id);
        [].slice.call(sourceRows.children).forEach(function (sourceRow, index) {
            if (sourceRow === event.target) {
                sourceRow.className = "dragged";
            } else if (index < minIndex) {
                sourceRow.className = "no-drag";
            } else {
                sourceRow.className = "drag-ok";
            }
        });
    }
}

function onDragEnd(event) {
    [].slice.call(sourceRows.children).forEach(function (sourceRow) {
        sourceRow.className = "";
    });
}

function onDragOver(event) {
    if (-1 < upToRow(event.target).className.indexOf("drag-ok")) {
        event.preventDefault(); // allowed
    }
}

function onDragEnter(event) {
    var row = upToRow(event.target);
    if (-1 === row.className.indexOf(" over")) {
        row.className += " over";
    }
}

function onDragLeave(event) {
    var row = upToRow(event.target);
    if (-1 !== row.className.indexOf(" over")) {
        row.className = row.className.split(" ")[0];
    }
}

function onDrop(event) {
    var targetSource = upToRow(event.target).id;
    console.log(draggedSourceName + " -> " + targetSource);
    event.preventDefault();
}

function onLoad() {
    Promise.all([xhr("src/sources.json").get(), xhr("build/dependencies.json").get()])
        .then(function (responseTexts) {
            var tplRow = document.getElementById("tpl_row");
            tplFunc = tplRow.buildFactory();
            sourceRows = document.getElementById("rows");
            sources = new SourceArray(responseTexts[0], responseTexts[1]);
            reload();
            document.addEventListener("click", onClick);
        }, function (reason) {
            alert("A problem occurred while loading src/sources.json and build/dependencies.json: " + reason);
        });
}

function onSave() {
    xhr("/file/src/sources.json").put(sources.toString())
        .then(function () {
            document.getElementById("save").setAttribute("disabled", true);
        }, function (reason) {
            alert(reason);
        });
}

        </script>
    </head>
    <body onload="onLoad()">
        <table>
            <thead>
                <th>Name</th>
                <th>Dep.</th>
                <th>Ref.</th>
                <th>Load</th>
                <th>Test</th>
                <th>Doc.</th>
                <th>Description</th>
                <th>Implements</th>
            </thead>
            <tbody id="rows" />
        </table>
        <button disabled="true" id="save" onclick="onSave()">Save</button>

        <template id="tpl_row">
{%
    function row() {
        $write("id=\"" + $object.getName() + "\" ");
        if (!$object.isReadOnly()) {
            $write("draggable=\"true\" ");
        }
    }

    function check(propertyName) {
        if ($object.isReadOnly()) {
            $write("disabled=\"true\" ");
        }
        if ($object.testProperty(propertyName)) {
            $write("checked");
        }
    }
%}
            <tr {%%}="row();"
                ondrag="onDrag(event)"
                ondragend="onDragEnd(event)"
                ondragover="onDragOver(event)"
                ondragenter="onDragEnter(event)"
                ondragleave="onDragLeave(event)"
                ondrop="onDrop(event)"
            >
                <td>{% $write($object.getName()); %}</td>
                <td>{%

if ($object.hasDependencies()) {
    %}<span class="dependencies" {%%}="$write('title=\'' + $object.getDependencies().join('\n') + '\'');">{% $write($object.getDependencies().length); %}</span>{%
} else {
    $write("&nbsp;");
}

                %}</td>
                <td>{%

if ($object.isReferenced()) {
    %}<span class="references" {%%}="$write('title=\'' + $object.getDependencyOf().join('\n') + '\'');">{% $write($object.getDependencyOf().length); %}</span>{%
} else {
    $write("&nbsp;");
}

                %}</td>
                <td><input id="load_{{$index}}" type="checkbox" {%%}="check('load');"></td>
                <td><input id="test_{{$index}}" type="checkbox" {%%}="check('test');"></td>
                <td><input id="doc_{{$index}}" type="checkbox" {%%}="check('doc');"></td>
                <td class="description">{% $write($object.getDescription()); %}</td>
                <td><ul class="items">{%

$object.getItems().forEach(function (item) {
    %}<li>{%
    if (item.internal) {
        %}<span class="internal">internal</span>{%
    }
    %}<span class="items">{% $write(item.type); %}</span>{%
    $write(item.name);
    %}</li>{%
});

                %}</ul></td>
            </tr>
        </template>
    </body>
</html>
