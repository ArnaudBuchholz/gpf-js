"use strict";describe("console",function(){if(gpf.internals){var a=gpf.internals._gpfConsoleGenerate;describe("_gpfConsoleGenerate",function(){it("generates an object mocking the console",function(){var b=a();assert("function"==typeof b.log),assert("function"==typeof b.info),assert("function"==typeof b.warn),assert("function"==typeof b.error)}),it("generates a log function prefixing text with padding",function(){var b="";a(function(a){b=a}).log("test"),assert("    test"===b)}),it("generates an info function prefixing text with [?]",function(){var b="";a(function(a){b=a}).info("test"),assert("[?] test"===b)}),it("generates a warn function prefixing text with /!\\",function(){var b="";a(function(a){b=a}).warn("test"),assert("/!\\ test"===b)}),it("generates an error function prefixing text with (X)",function(){var b="";a(function(a){b=a}).error("test"),assert("(X) test"===b)})})}}),describe("arraylike",function(){describe("gpf.isArrayLike",function(){it("checks if an object looks like an array",function(){assert(!0===gpf.isArrayLike([]))}),it("recognizes a simulated array",function(){assert(!0===gpf.isArrayLike({length:2,0:0,1:1}))}),it("recognizes a simulated empty array",function(){assert(!0===gpf.isArrayLike({length:0}))}),it("recognizes a simulated incomplete array",function(){assert(!0===gpf.isArrayLike({length:2,1:1}))}),it("recognizes a simulated non empty array with no items",function(){assert(!0===gpf.isArrayLike({length:2}))}),it("accepts a string as an array like",function(){assert(!0===gpf.isArrayLike("abc"))}),[null,void 0,0,1,!1,!0,{},new Date].forEach(function(a){it("rejects any non fitting value ("+JSON.stringify(a)+")",function(){assert(!1===gpf.isArrayLike(a))})}),it("rejects a simulated array with an invalid length property",function(){assert(!1===gpf.isArrayLike({length:2.5,0:0,1:1}))})})}),describe("foreach",function(){var a=[0,1,2,3,4,5,6,7,8,9],b={"number":1,"string":"Hello World!","null":null,"object":{member:"value"},"function":function(){return"Hello World!"}};describe("gpf.forEach",function(){it("enumerates array content",function(){var b=0,c=0;gpf.forEach(a,function(d,e,f){assert("number"==typeof e),assert(f===a),++b,c+=d}),assert(a.length===b),assert(45===c)}),it("transmits scope on array content",function(){var c,d=0,e=0;c=gpf.forEach(a,function(c,f,g){assert(this===b),assert("number"==typeof f),assert(g===a),++d,e+=c},b),assert(void 0===c),assert(a.length===d),assert(45===e)}),it("enumerates object content and handles null value",function(){var a=[],c=!0;gpf.forEach(b,function(d,e,f){assert("string"==typeof e),assert(f===b),a.push(e),"null"===e&&null!==d&&(c=!1)}),a=a.join(","),assert("number,string,null,object,function"===a),assert(!0===c)}),it("transmits scope on object content",function(){var a=gpf.forEach(b,function(){assert(this===b)},b);assert(void 0===a)})}),gpf.internals&&describe("(internal)",function(){describe("_gpfObjectForEach",function(){var a=gpf.internals._gpfObjectForEach;it("enumerates object keys and values",function(){var c=0;a(b,function(a,d,e){++c,assert(e===b),assert(a===b[d])}),assert(5===c)})}),describe("_gpfArrayForEachFalsy",function(){var b=gpf.internals._gpfArrayForEachFalsy;it("enumerates all values if no truthy result",function(){var c=0,d=b(a,function(b,d,e){++c,assert(e===a),assert(b===a[d])});assert(void 0===d),assert(c===a.length)}),it("stops on first truthy value and return it",function(){var c=0,d={},e=b(a,function(b,e,f){if(4===b)return d;++c,assert(f===a),assert(b===a[e])});assert(e===d),assert(4===c)})})})}),describe("assert",function(){describe("gpf.assert",function(){it("does not accept no message",function(){var a;try{console.expects&&console.expects("warn",/.*/),gpf.assert(!0)}catch(e_){a=e_}assert(a instanceof gpf.Error.AssertionFailed)}),[!0,42,"Hello World!",{}].forEach(function(a){it("does nothing on a truthy condition - "+typeof a+" ("+a.toString()+")",function(){gpf.assert(a,"It works")})}),[!1,0,"",void 0,null].forEach(function(a){var b;b=void 0===b?"undefined":null===b?"null":a.toString(),it("throws an exception on a falsy condition - "+typeof a+" ("+b+")",function(){var b;try{console.expects&&console.expects("warn",/.*/),gpf.assert(a,"It fails")}catch(e_){b=e_}assert(b instanceof gpf.Error.AssertionFailed)})})}),describe("gpf.asserts",function(){it("works with a message / boolean dictionary",function(){gpf.asserts({"It works":!0,"It also works":!0})}),it("fails on first falsy",function(){var a;try{console.expects&&console.expects("warn",/.*/),gpf.asserts({"It works":!0,"It fails":!1})}catch(e_){a=e_}assert(a instanceof gpf.Error.AssertionFailed)})}),describe("gpf.preventAssertWarnings",function(){it("prevents assertion warnings",function(){gpf.preventAssertWarnings(!0);var a;try{gpf.assert(!1,"It fails")}catch(e_){a=e_}assert(a instanceof gpf.Error.AssertionFailed),gpf.preventAssertWarnings(!1)})})}),describe("constants",function(){describe("gpf",function(){it("does not expose any 'private' member",function(){function a(b,c){var d,e;for(d in b)b.hasOwnProperty(d)&&(assert("_"!==d.charAt(0)),"object"==typeof(e=b[d])&&-1===c.indexOf(e)&&(c.push(e),a(e,c)))}a(gpf,[gpf,gpf.internals])}),it("should expose a version",function(){assert("function"==typeof gpf.version),assert("string"==typeof gpf.version());var a=gpf.version();assert(-1!==a.indexOf(".")),assert(null!==a.match(/[0-9]+\.[0-9]+d?/))}),it("should expose the host type",function(){assert("function"==typeof gpf.host),assert("string"==typeof gpf.host());var a=gpf.host();assert(-1!==[gpf.hosts.browser,gpf.hosts.nodejs,gpf.hosts.phantomjs,gpf.hosts.rhino,gpf.hosts.unknown,gpf.hosts.wscript].indexOf(a))}),describe("gpf.hosts enumeration",function(){["browser","nodejs","phantomjs","unknown","wscript"].forEach(function(a){it("declares gpf.hosts."+a,function(){assert(void 0!==gpf.hosts[a])})})})}),gpf.internals&&(describe("(internal) _gpfIsUnsignedByte",function(){var a=gpf.internals._gpfIsUnsignedByte;gpf.forEach({0:!0,"-25":!1,128:!0,256:!1,255:!0},function(b,c){var d=parseInt(c,10);b?it("accepts "+c,function(){assert(!0===a(d))}):it("rejects "+c,function(){assert(!1===a(d))})})}),describe("(internal) _gpfFuncImpl",function(){var a=gpf.internals._gpfFuncImpl;it("fails if function can't be generated",function(){var b;try{a([],"{")}catch(e_){b=e_}assert(b)})}))}),describe("string/capitalize",function(){gpf.internals&&describe("(internal) _gpfStringCapitalize",function(){var a=gpf.internals._gpfStringCapitalize;it("does nothing on empty string",function(){assert(""===a(""))}),it("uppercases the first letter",function(){assert("Word"===a("word")),assert("Two words"===a("two words")),assert("Two words"===a("Two words"))}),it("also handles accents",function(){assert("\xc9ric"===a("\xe9ric"))})})}),describe("string/replaceex",function(){gpf.internals&&describe("(internal) _gpfStringReplaceEx",function(){var a=gpf.internals._gpfStringReplaceEx;it("replaces strings recursively",function(){assert("add"===a("abc",{"a":"abc","b":"dc","c":""}))})})}),describe("string/escapefor",function(){gpf.internals&&describe("(internal) _gpfStringEscapeFor",function(){var a=gpf.internals._gpfStringEscapeFor;it("escapes for JavaScript",function(){assert('"abc\\r\\ndef"'===a("abc\r\ndef","javascript"))}),it("escapes for xml",function(){assert("&lt;a&amp;b&gt;"===a("<a&b>","xml"))}),it("escapes for html",function(){assert("&lt;a&amp;b:&eacute;&egrave;&ecirc;&aacute;&agrave;&gt;"===a("<a&b:\xe9\xe8\xea\xe1\xe0>","html"))})})}),describe("compatibility",function(){function a(a){var b=new Array(5);b[2]=void 0,b[3]=3,a.call(b,function(a,b){assert(2===b||3===b),2===b?assert(void 0===a):assert(3===a)})}function b(a,b,c){var d="must expose the method "+b;a instanceof Function?it(d,function(){assert("function"==typeof a[b])}):it(d+" through prototype",function(){assert("function"==typeof a[b]),assert(!a.hasOwnProperty(b))}),-1!==c&&it(d+" with an expected arity of "+c,function(){assert(a[b].length===c)})}function c(a){var b,c,d,e=a.sample,f=a.testMethod,g=a.label,h=a.methodName,i=e[h];it(g,function(){f(i)}),gpf.internals&&(b=gpf.internals._gpfCompatibility[a.type],c=a.isStatic?b.statics:b.methods,c&&(d=c[h]),d&&d!==i&&it(g+" (compatible)",function(){f(d)}))}function d(a,d,e){return function(){var f,h,i=g[a];f=!0===e.isStatic?i:new i,b(f,d,e.length);for(h in e)e.hasOwnProperty(h)&&"function"==typeof e[h]&&c({type:a,sample:f,methodName:d,isStatic:e.isStatic,label:h,testMethod:e[h]})}}function e(a){var b,c=f[a];for(b in c)c.hasOwnProperty(b)&&describe(b,d(a,b,c[b]))}var f={Array:{every:{length:1,"must return true when it goes over all items":function(a){var b,c=[1,2,3,-6,10],d=0;b=a.call(c,function(a){return d+=a,!0}),assert(!0===b),assert(10===d)},"must return false when it stops on a given item":function(a){var b,c=[1,2,3,-6,10],d=0;b=a.call(c,function(a){return a>0&&(d+=a,!0)}),assert(!1===b),assert(6===d)},"must iterate with a bound context":function(a){var b,c=[1,2,3,-6,10],d={sum:0,index:0};b=a.call(c,function(a,b){var c=this;return assert(c===d),c.index=b,a>0&&(c.sum+=a,!0)},d),assert(!1===b),assert(6===d.sum),assert(3===d.index)},"must ignore undefined members":a},filter:{length:1,"must filter":function(a){var b,c=[1,2,3,4,5];b=a.call(c,function(a){return a%2==0}),assert(2===b.length),assert(2===b[0]),assert(4===b[1])},"must filter with a bound context":function(a){var b,c=[1,2,3,4,5],d={};b=a.call(c,function(a){return assert(this===d),a%2==0},d),assert(2===b.length),assert(2===b[0]),assert(4===b[1])},"must ignore undefined members":a},forEach:{length:1,"must iterate":function(a){var b=[1,2,3],c=0;assert("function"==typeof b.forEach),assert(!b.hasOwnProperty("forEach")),a.call(b,function(a){c+=a}),assert(6===c)},"must iterate with a bound context":function(a){var b=[1,2,3],c={sum:0};a.call(b,function(a){this.sum+=a},c),assert(6===c.sum)},"must ignore undefined members":a},indexOf:{length:1,"must expose indexOf()":function(a){var b={},c=[1,2,3,b,"abc"];assert(-1===a.call(c,4)),assert(0===a.call(c,1)),assert(3===a.call(c,b)),assert(-1===a.call(c,{})),assert(4===a.call(c,"abc"))}},map:{length:1,"must map with a bound context":function(a){var b,c={},d=[1,2,3,c,"abc"];assert("function"==typeof d.map),assert(!d.hasOwnProperty("map")),b=a.call(d,function(a,b){return assert(this===c),assert(a===d[b]),b},c),assert(b.length===d.length),assert(0===b[0]),assert(4===b[4])},"must ignore undefined members":a},reduce:{length:1,"must reduce with no initial value":function(a){function b(a,b,e,f){return assert(c===f),assert(d===e),++d,a+b}var c=[0,1,2,3,4],d=1;assert(10===a.call(c,b))},"must reduce with intial value":function(a){function b(a,b,e,f){return assert(c===f),assert(d===e),++d,a+b}var c=[0,1,2,3,4],d=0;assert(20===a.call(c,b,10))}},some:{length:1,"returns false when all members return false":function(a){var b=[2,5,8,1,4];assert(!1===a.call(b,function(a){return a>10}))},"returns true when at least one member returns true":function(a){var b=[12,5,8,1,4];assert(!0===a.call(b,function(a){return a>10}))}},from:{isStatic:!0,length:1,"works on arguments":function(a){var b=function(){return a.call(Array,arguments)}(1,2,3);assert(b instanceof Array),assert(3===b.length),assert(1===b[0]),assert(2===b[1]),assert(3===b[2])},"works on strings":function(a){var b=a.call(Array,"foo");assert(b instanceof Array),assert(3===b.length),assert("f"===b[0]),assert("o"===b[1]),assert("o"===b[2])},"supports callback mapping":function(a){var b=a.call(Array,[1,2,3],function(a){return a+a});assert(b instanceof Array),assert(3===b.length),assert(2===b[0]),assert(4===b[1]),assert(6===b[2])},"generates a sequence of numbers":function(a){var b=a.call(Array,{length:3},function(a,b){return b});assert(b instanceof Array),assert(3===b.length),assert(0===b[0]),assert(1===b[1]),assert(2===b[2])}},isArray:{isStatic:!0,length:1,"detects an array":function(a){assert(!0===a.call(Array,[]))},"rejects other objects":function(a){assert(!1===a.call(Array,{length:0}))}}},Function:{bind:{length:1,"must bind to a context":function(a){function b(a){assert(this===d),this.member=a}var c,d={member:null};c=a.call(b,d),c(!0),assert(!0===d.member),c.call({},!1),assert(!1===d.member)},"must return the same result":function(a){function b(a){return a}var c=a.call(b,{});assert(!1===c(!1)),assert(!0===c(!0))},"must preserve function signature":function(a){function b(a,b,c){return a+b+c}assert(3===b.length);var c=a.call(b,{});assert(3===c.length)},"must allow additional parameters binding":function(a){function b(a,b,c){return a+b+c}assert(3===b.length);var c=a.call(b,{},1);assert(2===c.length),assert(6===c(2,3))}}},Object:{assign:{isStatic:!0,length:2,"extends objects members":function(a){var b={"member1":"member1","member2":2},c={"newMember":!0},d=a.call(Object,b,c);assert(d===b),assert("member1"===d.member1),assert(2===d.member2),assert(!0===d.newMember),assert(!0===c.newMember)},"overwrites existing members":function(a){var b={"member1":"member1"},c={"member1":!1},d=a.call(Object,b,c);assert(!1===d.member1)},"supports more than one source parameter":function(a){var b={"member1":"member1","member2":2},c=a.call(Object,b,{"source1":1,"member1":"member1.1"},{"source2":2,"member1":"member1.2"});assert("member1.2"===c.member1),assert(2===c.member2),assert(1===c.source1),assert(2===c.source2)}},create:{isStatic:!0,length:-1,"allows creating objects with a given prototype":function(a){var b=a.call(Object,{method:function(){return"myMethod"}});assert(!b.hasOwnProperty("method")),assert("function"==typeof b.method),assert("myMethod"===b.method())},"is compatible with instanceof":function(a){function b(){}b.prototype={a:function(){return"a"}};var c=a.call(Object,b.prototype);assert("a"===c.a()),assert(c instanceof b)},"allows inheritance and use of instanceof":function(a){function b(){}function c(){}b.prototype={a:function(){return"a"}},c.prototype=new b;var d=a.call(Object,c.prototype);assert("a"===d.a()),assert(d instanceof b),assert(d instanceof c)}},getPrototypeOf:{isStatic:!0,length:1,"returns prototype passed to Object.create":function(a){var b,c;b={a:function(){return"a"}},c=Object.create(b),assert(a.call(Object,c)===b)},"returns prototype from constructor":function(a){function b(){}b.prototype={constructor:b,a:function(){return"a"}};var c=new b;assert(a.call(Object,c)===b.prototype)}},keys:{isStatic:!0,length:1,"returns list of indexes of an array":function(a){var b=["a","b","c"],c=a.call(Object,b);assert(3===c.length),assert("0"===c[0]),assert("1"===c[1]),assert("2"===c[2])},"returns list of indexes of an array-like object":function(a){var b={0:"a",1:"b",2:"c"},c=a.call(Object,b);assert(3===c.length),assert(-1<c.indexOf("0")),assert(-1<c.indexOf("1")),assert(-1<c.indexOf("2"))},"returns list of indexes of an array like object with random key ordering":function(a){var b={100:"a",2:"b",7:"c"},c=a.call(Object,b);assert(3===c.length),assert(-1<c.indexOf("2")),assert(-1<c.indexOf("7")),assert(-1<c.indexOf("100"))},"returns list of own keys of an object":function(a){function b(){}b.prototype={a:0,b:1};var c,d=new b;d.c=2,c=a.call(Object,d),assert(1===c.length),assert("c"===c[0])}},values:{isStatic:!0,length:1,"returns list of values of an object":function(a){var b={foo:"bar",baz:42},c=a.call(Object,b);assert(2===c.length),assert(-1<c.indexOf("bar")),assert(-1<c.indexOf(42))},"returns list of values of an array-like object":function(a){var b={0:"a",1:"b",2:"c"},c=a.call(Object,b);assert(3===c.length),assert(-1<c.indexOf("a")),assert(-1<c.indexOf("b")),assert(-1<c.indexOf("c"))},"returns list of values of an array like object with random key ordering":function(a){var b={100:"a",2:"b",7:"c"},c=a.call(Object,b);assert(3===c.length),assert(-1<c.indexOf("a")),assert(-1<c.indexOf("b")),assert(-1<c.indexOf("c"))},"returns list of own values of an object":function(a){function b(){}b.prototype={a:0,b:1};var c,d=new b;d.c=2,c=a.call(Object,d),assert(1===c.length),assert(2===c[0])}}},String:{trim:{length:0,"must trim left and right":function(a){assert("abc"===a.call(" \t  abc\t \t"))}}},Date:{toISOString:{length:0,"converts to UTC string":function(a){var b=new Date("2003-01-22T22:45:00.000Z");assert("2003-01-22T22:45:00.000Z"===a.call(b))}},now:{isStatic:!0,length:0,"Gives current time":function(a){var b=(new Date).getTime(),c=a.call(Date);assert("number"==typeof c),assert(b<=c)}}}},g={Array:Array,Function:Function,Object:Object,String:String,Date:Date};describe("Array",function(){describe("default support",function(){it("must allow building an array with a given size",function(){var a,b=new Array(5);for(assert(5===b.length),a=0;a<5;++a)assert(void 0===b[a]);assert("    "===b.join(" "))}),it("provides standard slice",function(){var a=["Banana","Orange","Lemon","Apple","Mango"],b=a.slice(1,3);assert(2===b.length),assert("Orange"===b[0]),assert("Lemon"===b[1])})}),e("Array")}),describe("Function",function(){describe("default support",function(){it("allows creating function with parameters",function(){var a=Function("value","return value;");assert("function"==typeof a),assert(1===a.length),assert(123===a(123))}),it("must detect undefined parameter",function(){function a(a){assert(arguments.length===a)}a(1),a(2,"abc"),a(2,void 0),a(3,void 0,void 0)})}),describe("name support",function(){if(it("exposes a name",function(){var a=Function,b=new a("return function funcName () {}")();assert("funcName"===b.compatibleName())}),it("supports empty name",function(){assert(""===function(){}.compatibleName())}),gpf.internals&&Function.prototype.compatibleName!==gpf.internals._gpfGetFunctionName){var a=gpf.internals._gpfGetFunctionName;it("exposes a name (compatible)",function(){function b(){}assert("thisName"===a.call(b))}),it("supports empty name",function(){var b=function(){};assert(""===a.call(b))})}}),e("Function")}),describe("Object",function(){e("Object")}),describe("String",function(){e("String")}),describe("Date",function(){describe("constructor",function(){it("accepts UTC string",function(){var a=new Date("2003-01-22T22:45:00.000Z");assert(2003===a.getUTCFullYear()),assert(0===a.getUTCMonth()),assert(22===a.getUTCDate()),assert(22===a.getUTCHours()),assert(45===a.getUTCMinutes()),assert(0===a.getUTCSeconds())}),it("accepts a date only",function(){var a=new Date("2003-01-22");assert(2003===a.getUTCFullYear()),assert(0===a.getUTCMonth()),assert(22===a.getUTCDate()),assert(0===a.getUTCHours()),assert(0===a.getUTCMinutes()),assert(0===a.getUTCSeconds())})}),e("Date"),gpf.internals&&(describe("(internal) _gpfIsISO8601String",function(){var a=gpf.internals._gpfIsISO8601String,b={"2016-02-17T23:13:00.000Z":[2016,1,17,23,13,0,0],"2003-01-22T22:45:34.075Z":[2003,0,22,22,45,34,75],"2003-13-22T22:45:34.075Z":null,"2003-1-22T22:45:34.075Z":null,"2003-01-32T22:45:34.075Z":null,"2003-01-2T22:45:34.075Z":null,"2003-01-22T25:45:34.075Z":null,"2003-01-22T22:60:34.075Z":null,"2003-01-22T22:45:60.075Z":null,"2003-01-22T22:45:34":[2003,0,22,22,45,34,0],"2003-01-22 22:45:34":null,"2003-01-22T22:45:34.075":null,"2016-02-17":[2016,1,17,0,0,0,0],"2003-13-22":null,"2003-01-32":null};for(var c in b)b.hasOwnProperty(c)&&function(b,c){var d;d=c?"accepts":"rejects",d+=' "'+b+'"',it(d,function(){var d=a(b);c?(assert(d),assert(d.length===c.length),c.forEach(function(a,b){assert(d[b]===a)})):assert(!d)})}(c,b[c]);[!0,!1,0,1,{},new Date].forEach(function(b){it("rejects other formats - "+typeof b+" ("+b.toString()+")",function(){assert(void 0===a(b))})})}),describe("(internal) _GpfDate()",function(){var a=gpf.internals._GpfDate;it("allocates a Date object",function(){var b=new a;assert(b instanceof Date)}),it("detects and leverage ISO 8601 format",function(){var b=new a("2003-01-22T22:45:34.075Z");assert(2003===b.getUTCFullYear()),assert(0===b.getUTCMonth()),assert(22===b.getUTCDate()),assert(22===b.getUTCHours()),assert(45===b.getUTCMinutes()),assert(34===b.getUTCSeconds()),assert(75===b.getUTCMilliseconds())}),it("detects and leverage ISO 8601 short format",function(){var b=new a("2003-01-22");assert(2003===b.getUTCFullYear()),assert(0===b.getUTCMonth()),assert(22===b.getUTCDate()),assert(0===b.getUTCHours()),assert(0===b.getUTCMinutes()),assert(0===b.getUTCSeconds()),assert(0===b.getUTCMilliseconds())})}))})}),describe("compatibility/array",function(){}),describe("factory",function(){gpf.internals&&describe("_gpfNewApply",function(){var a=gpf.internals._gpfNewApply;it("calls any constructor",function(){function b(){this.value=42}var c=a(b,[]);assert(c instanceof b),assert(42===c.value)}),it("forwards parameters",function(){var b=a(Array,[42]);assert(b instanceof Array),assert(42===b.length)}),it("adapts to a very long list of parameters",function(){var b=a(Array,[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]);assert(b instanceof Array),assert(15===b.length)})})}),describe("compatibility/date",function(){}),describe("compatibility/function",function(){}),describe("compatibility/object",function(){}),describe("compatibility/string",function(){}),describe("compatibility/promise",function(){function a(a){describe("simple usage",function(){it("waits for synchronous fulfilment",function(b){new a(function(a){assert("function"==typeof a),a("ok")}).then(function(a){assert("ok"===a),b()})["catch"](function(a){b(a)})}),it("waits for asynchronous fulfilment",function(b){var c;new a(function(a){c=a}).then(function(a){assert("ok"===a),b()})["catch"](function(a){b(a)}),c("ok")}),it("waits for synchronous rejection (rejection handler)",function(b){var c=!1;new a(function(a,b){assert("function"==typeof b),b("ko")}).then(function(){c=!0},function(a){assert(!1===c),assert("ko"===a),b()})["catch"](function(a){b(a)})}),it("waits for asynchronous rejection (rejection handler)",function(b){var c,d=!1;new a(function(a,b){c=b}).then(function(){d=!0},function(a){assert(!1===d),assert("ko"===a),b()})["catch"](function(a){b(a)}),c("ko")}),it("waits for synchronous rejection (catch handler)",function(b){new a(function(a,b){b("ko")}).then(function(){assert(!1)})["catch"](function(a){try{assert("ko"===a),b()}catch(e_){b(e_)}})}),it("waits for asynchronous rejection (catch handler)",function(b){var c;new a(function(a,b){c=b}).then(function(){assert(!1)})["catch"](function(a){try{assert("ko"===a),b()}catch(e_){b(e_)}}),c("ko")}),it("rejects automatically on exception",function(b){new a(function(){throw new Error("ko")}).then(function(){assert(!1)},function(a){assert(a instanceof Error),assert("ko"===a.message),b()})["catch"](function(a){b(a)})}),it("catches exception from the fulfilment handler",function(b){new a(function(a){a("ok")}).then(function(a){throw assert("ok"===a),new Error("ko")})["catch"](function(a){try{assert(a instanceof Error),assert("ko"===a.message),b()}catch(e_){b(e_)}})}),it("catches exception from the rejection handler",function(b){new a(function(a,b){b("ko")}).then(function(){assert(!1)},function(a){throw assert("ko"===a),new Error("ko")})["catch"](function(a){try{assert(a instanceof Error),assert("ko"===a.message),b()}catch(e_){b(e_)}})})}),describe("shortcuts",function(){it("offers Promise.resolve",function(b){a.resolve("ok").then(function(a){assert("ok"===a),b()},function(){assert(!1)})["catch"](function(a){b(a)})}),it("offers Promise.reject",function(b){a.reject("ko").then(function(){assert(!1)},function(a){assert("ko"===a),b()})["catch"](function(a){b(a)})})}),describe("chaining",function(){it("chains by passing results from one handler to the other",function(b){new a(function(a){a("ok 1")}).then(function(a){return assert("ok 1"===a),"ok 2"}).then(void 0,function(a){b(a)}).then(function(a){return assert("ok 2"===a),"ok 3"}).then(function(a){return assert("ok 3"===a),"ok 4"}).then(function(a){assert("ok 4"===a),b()})["catch"](function(a){b(a)})}),it("chains by returning a promise in the fulfilment handler",function(b){new a(function(a){a("ok 1")}).then(function(b){return assert("ok 1"===b),a.resolve("ok 2")}).then(function(b){return assert("ok 2"===b),new a(function(a){a("ok 3")})}).then(function(a){assert("ok 3"===a),b()})["catch"](function(a){b(a)})}),it("stops on first error",function(b){new a(function(a){a("ok 1")}).then(function(a){return assert("ok 1"===a),"ok 2"}).then(function(a){throw assert("ok 2"===a),new Error("ko")}).then(function(){assert(!1)})["catch"](function(a){try{assert(a instanceof Error),assert("ko"===a.message),b()}catch(e_){b(e_)}})})}),describe("synchronisation",function(){describe("Promise.all",function(){it("succeeds with an empty array",function(b){a.all([]).then(function(a){assert(0===a.length),b()})["catch"](function(a){b(a)})}),it("works with one promise",function(b){a.all([a.resolve("ok")]).then(function(a){assert(1===a.length),assert("ok"===a[0]),b()})["catch"](function(a){b(a)})}),it("waits for all promises to be resolved",function(b){var c,d=[];for(c=0;c<10;++c)d.push(a.resolve(c));a.all(d).then(function(a){assert(45===a.reduce(function(a,b){return a+b})),b()})["catch"](function(a){b(a)})}),it("fails on the first error",function(b){var c,d=[];for(c=0;c<10;++c)d.push(function(b){return 0==b%2?a.reject(b):a.resolve(b)}(c));a.all(d).then(function(){assert(!1)})["catch"](function(a){try{assert("number"==typeof a),assert(a<10),b()}catch(e_){b(e_)}})})}),describe("Promise.race",function(){it("waits for the first promise that is resolved",function(b){var c,d=[],e=[];for(c=0;c<10;++c)d.push(function(b){return new a(function(a){e.unshift(a.bind(null,b))})}(c));a.race(d).then(function(a){assert(9===a),e[9](),b()})["catch"](function(a){b(a)}),e[0](),e[1](),e[2]()}),it("waits for the first promise that is resolved or rejected",function(b){var c,d=[],e=[];for(c=0;c<10;++c)d.push(function(b){return new a(function(a,c){5===b?e.push(c.bind(null,b)):e.push(a.bind(null,b))})}(c));a.race(d).then(function(){assert(!1)})["catch"](function(a){try{assert("number"==typeof a),assert(5===a),e[9](),b()}catch(e_){b(e_)}}),e[5](),e[0](),e[1]()})})}),describe("branching",function(){it("supports different branches",function(b){var c={};c.promise=new a(function(a,b){c.resolve=a,c.reject=b});var d=c.promise.then(function(a){return a+1}).then(function(a){return a+2}).then(function(a){return a+3}),e=c.promise.then(function(a){return 2*a}).then(function(a){return 3*a});a.all([d,e]).then(function(a){assert(7===a[0]),assert(6===a[1]),b()})["catch"](function(a){b(a)}),c.resolve(1)})})}describe("Promise",function(){a(Promise)}),gpf.internals&&Promise!==gpf.internals._GpfPromise&&describe("(internal) _GpfPromise",function(){a(gpf.internals._GpfPromise)})}),describe("compatibility/timeout",function(){function a(a){function b(){return(new Date).getTime()}function c(d){this._start=b(),this._delay=d,this._id=a.setTimeout(c.prototype.callback.bind(this),d),this._synchronous=!1}var d,e,f;return d=config.timerResolution?config.timerResolution:1,e=2*d,f=e+2*d,c.list=[],c.allocate=function(a){var b=new c(a);return c.list.push(b),b},c.noError=function(){var a,b,d=c.list.length;for(a=0;a<d;++a)if(b=c.list[a],b.error())return!1;return!0},c.check=function(){assert(c.noError())},c.prototype={_start:0,_delay:0,_synchronous:!0,_id:0,_allowed:!1,_triggered:0,_error:null,_done:function(){},id:function(){return this._id},callback:function(){try{if(!this._allowed)throw new Error("Not allowed");if(this._triggered)throw new Error("Already triggered");if(this._triggered=b(),this._synchronous)throw new Error("Triggered too soon (synchronous should be false)");var a=b()-this._start;if(a<this._delay&&this._delay-a>d)throw new Error("Triggered too soon ("+a+" does not respect the timeout delay of "+this._delay+")");this._done()}catch(e_){this._error=e_,this._done(e_)}},clear:function(){a.clearTimeout(this._id),delete this._allowed},clean:function(){this._triggered||this.clear();var a,b=c.list.length;for(a=0;a<b&&c.list[a]!==this;++a);c.list.splice(a,1)},error:function(){return this._error},allow:function(a){this._allowed=!0,this._done=a},triggered:function(){return this._triggered}},function(){var b;before(function(){c.list=[]}),beforeEach(function(){b=c.allocate(f),assert(1===c.list.length),c.check()}),it("allocates a timeout id",function(){assert(void 0!==b.id()),c.check()}),afterEach(function(){b.clean(),c.check()}),describe("clearing",function(){beforeEach(function(){b.clear(),c.check()}),it("removes the callback from the queue",function(){a.handleTimeout(),c.check()}),describe("again",function(){beforeEach(function(){b.clear(),c.check()}),it("does not fail",function(){a.handleTimeout(),c.check()})})}),describe("triggering",function(){beforeEach(function(d){b.allow(d),a.handleTimeout(),c.check()}),it("executes the callback from the queue",function(){assert(b.triggered),c.check()}),it("removes the callback from the queue",function(){a.handleTimeout(),c.check()})}),describe("sequencing with a second timeout",function(){function d(a,b){var c=0;return function(d){d?a(d):b===++c&&a()}}var g;beforeEach(function(){b.clean(),g=c.allocate(e),b=c.allocate(f),c.check()}),it("allocates a different timeout id",function(){assert(void 0!==g.id()),assert(g.id()!==b.id()),c.check()}),afterEach(function(){g.clean(),c.check()}),describe("clearing the second timeout",function(){beforeEach(function(){g.clear(),c.check()}),describe("triggering",function(){beforeEach(function(d){b.allow(d),a.handleTimeout(),c.check()}),it("executes the remaining callback from the queue",function(){assert(b.triggered()),c.check()}),it("removes all callbacks from the queue",function(){a.handleTimeout(),c.check()})})}),describe("creating and cleaning a third timeout",function(){it("prevents execution of the third",function(e){var h=c.allocate(10*f),i=d(e,2);h.clean(),b.allow(i),g.allow(i),a.handleTimeout(),c.check()})}),describe("triggering",function(){beforeEach(function(e){var f=d(e,2);b.allow(f),g.allow(f),a.handleTimeout(),c.check()}),it("executes the callbacks from the queue",function(){assert(b.triggered()),assert(g.triggered()),c.check()}),it("removed all callbacks from the queue",function(){a.handleTimeout(),c.check()})})})}}describe("exposed API",a({setTimeout:function(a,b){return setTimeout(a,b)},clearTimeout:function(a){clearTimeout(a)},handleTimeout:function(){}})),gpf.internals&&setTimeout!==gpf.internals._gpSetTimeoutPolyfill&&describe("(internal)",a({setTimeout:gpf.internals._gpSetTimeoutPolyfill,clearTimeout:gpf.internals._gpfClearTimeoutPolyfill,handleTimeout:gpf.internals._gpfHandleTimeout}))}),describe("compatibility/json",function(){function a(b,c){var d=typeof b;return d===typeof c&&("object"===d&&b&&c?Object.keys(b).every(function(d){return c.hasOwnProperty(d)&&a(b[d],c[d])}):b===c)}var b=[{label:"empty object",obj:{},json:"{}"},{label:"simple string property",obj:{a:"123"},json:'{"a":"123"}'},{label:"simple number property",obj:{a:123},json:'{"a":123}'},{label:"simple boolean properties",obj:{a:!0,b:!1},json:'{"a":true,"b":false}'},{label:"mixed simple properties",obj:{a:"123",b:123,c:!0,d:{}},json:'{"a":"123","b":123,"c":true,"d":{}}'},{label:"function",obj:{a:123,b:function(){}},json:'{"a":123}',parse:!1},{label:"array",obj:{a:[1,2,3]},json:'{"a":[1,2,3]}'},{label:"null",obj:{a:null},json:'{"a":null}'}];describe("JSON object",function(){it("exists",function(){assert("undefined"!=typeof JSON)})}),describe("JSON.stringify",function(){b.forEach(function(a){it("works on "+a.label,function(){assert(JSON.stringify(a.obj)===a.json)})})}),describe("JSON.parse",function(){b.forEach(function(b){!1!==b.parse&&it("works on "+b.label,function(){var c=JSON.parse(b.json);assert(!0===a(c,b.obj))})})}),gpf.internals&&describe("(internal)",function(){describe("_gpfJsonStringifyPolyfill",function(){b.forEach(function(a){it("works on "+a.label,function(){assert(gpf.internals._gpfJsonStringifyPolyfill(a.obj)===a.json)})})}),describe("_gpfJsonParsePolyfill",function(){b.forEach(function(b){!1!==b.parse&&it("works on "+b.label,function(){var c=gpf.internals._gpfJsonParsePolyfill(b.json);assert(!0===a(c,b.obj))})})})})}),describe("context",function(){describe("gpf.context",function(){it("resolves the global context",function(){if(assert("function"==typeof gpf.context),assert(null!==gpf.context()),
gpf.hosts.browser===gpf.host())assert(window===gpf.context());else if(gpf.hosts.nodejs===gpf.host()||gpf.hosts.phantomjs===gpf.host())assert(global===gpf.context());else{var a=function(){return this}();assert(a===gpf.context())}}),it("resolves gpf",function(){assert(gpf===gpf.context("gpf"))}),it("resolves any symbol",function(){assert(gpf.context===gpf.context("gpf.context"))}),it("returns undefined if not existing",function(){assert(void 0===gpf.context("gpf.not-existing"))}),it("returns undefined if not existing (deep dive)",function(){assert(void 0===gpf.context("gpf.not-existing.really-not"))})}),gpf.internals&&describe("_gpfContext",function(){var a=gpf.internals._gpfContext;it("can build a context",function(){var b=gpf.context(),c={};b.testContextJS=c;var d=a(["testContextJS","folder","name"],!0);assert(b.testContextJS===c),assert(b.testContextJS.folder.name===d),delete b.testContextJS})})}),describe("error",function(){describe("gpf.Error",function(){it("is used as an exception",function(){var a;try{gpf.Error.abstractMethod()}catch(e_){a=e_}assert(a instanceof Error),assert(a instanceof gpf.Error),assert(a instanceof gpf.Error.AbstractMethod),assert(a.constructor===gpf.Error.AbstractMethod)}),it("is documented",function(){var a;try{gpf.Error.abstractMethod()}catch(e_){a=e_}assert(a.code===gpf.Error.CODE_ABSTRACTMETHOD),assert(a.code===gpf.Error.abstractMethod.CODE),assert("abstractMethod"===a.name),assert("Abstract method"===a.message)}),it("can use substitution for message",function(){var a;try{gpf.Error.assertionFailed({message:"Test"})}catch(e_){a=e_}assert(a instanceof gpf.Error.AssertionFailed),assert(a.code===gpf.Error.CODE_ASSERTIONFAILED),assert(a.code===gpf.Error.assertionFailed.CODE),assert("assertionFailed"===a.name),assert("Assertion failed: Test"===a.message)})})}),describe("function",function(){if(gpf.internals){var a=gpf.internals._gpfFunctionDescribe;describe("_gpfFunctionDescribe",function(){it("describes a named function",function(){var b=a(function(a,b){return a+b});assert("test"===b.name),assert(2===b.parameters.length),assert("a"===b.parameters[0]),assert("b"===b.parameters[1]),assert(-1!==b.body.indexOf("return a + b;"))}),it("identifies an unnamed function",function(){var b=a(function(){return 0});assert(!b.name),assert(!b.parameters),assert(-1!==b.body.indexOf("return 0;"))}),it("identifies empty function",function(){var b=a(function(){});assert(void 0===b.body)}),it("filters out comments",function(){function b(a,b,c){return a+b+c}var c=a(b);assert("test2"===c.name),assert(3===c.parameters.length),assert("a"===c.parameters[0]),assert("b"===c.parameters[1]),assert("c"===c.parameters[2]),assert(-1===c.body.indexOf("comments are removed"))})}),describe("_gpfFunctionBuild",function(){var a=gpf.internals._gpfFunctionBuild;it("builds an empty anonymous function",function(){var b=a({});assert("function"==typeof b),assert(""===b.compatibleName())}),it("builds a named function",function(){var b=a({name:"test"});assert("test"===b.compatibleName())}),it("builds a function with named parameters",function(){var b=a({parameters:["a","b","c"],body:"return a + b + c;"});assert(3===b.length),assert(6===b(1,2,3))}),it("builds a function with external context",function(){var b=a({body:"return a;"},{a:"Hello World!"});assert(0===b.length),assert("Hello World!"===b())})})}}),describe("abstract",function(){if(gpf.internals){var a=gpf.internals._gpfCreateAbstractFunction;describe("_gpfCreateAbstractFunction",function(){it("generates a function with a given signature",function(){var b=a(3);assert(3===b.length)}),it("generates a function that throws the abstractMethod exception",function(){var b,c=a(0);try{c()}catch(e_){b=e_}assert(b instanceof gpf.Error.AbstractMethod)})})}}),describe("define/check",function(){gpf.internals&&describe("(internal) _GpfEntityDefinition",function(){var a=gpf.internals._GpfEntityDefinition,b=gpf.internals._gpfDefineBuildTypedEntity;it("must have an entity type",function(){var a;try{b({})}catch(e_){a=e_}assert(a instanceof gpf.Error.InvalidEntityType)}),it("checks for a valid name",function(){var a;try{b({$type:"class"})}catch(e_){a=e_}assert(a instanceof gpf.Error.MissingEntityName)}),it("validates minimal requirement (type and name)",function(){b({$type:"class",$name:"Test"})}),it("rejects invalid properties",function(){var a;try{b({$type:"class",$name:"Test",$fail:!0})}catch(e_){a=e_}assert(a instanceof gpf.Error.InvalidEntity$Property)}),it("converts $class into _type and _name",function(){var c=b({$class:"Test"});assert(c instanceof a),assert("class"===c._type),assert("Test"===c._name)}),it("converts $class into _type, _name and _namespace (absolute)",function(){var a=b({$class:"gpf.test.Test"});assert("class"===a._type),assert("Test"===a._name),assert("gpf.test"===a._namespace)}),it("converts $class into _type, _name and _namespace (relative)",function(){var a=b({$class:"test.Test",$namespace:"gpf"});assert("class"===a._type),assert("Test"===a._name),assert("gpf.test"===a._namespace)}),it("prioritize $class over $name",function(){var a=b({$class:"Test",$name:"Any"});assert("class"===a._type),assert("Test"===a._name)}),it("validates namespace",function(){b({$class:"Test",$namespace:"lowerCamelCase.$accepted._also.numbers456"}),b({$class:"Test",$namespace:"simple"}),b({$class:"Test",$namespace:""})}),["endingPointIsNotOK.","startingNumberIsNotOK.4test","$isOKOnlyAtBeginning.test$","_isOKOnlyAtBeginning.test_","CapitalFirstLetterIsNotOK"].forEach(function(a){it("rejects invalid namespace ("+a+")",function(){var c;try{b({$class:"Test",$namespace:a})}catch(e_){c=e_}assert(c instanceof gpf.Error.InvalidEntityNamespace)})})})}),describe("define/class/check",function(){gpf.internals&&describe("(internal) _GpfClassDefinition",function(){var a=gpf.internals._GpfClassDefinition,b=gpf.internals._gpfDefineBuildTypedEntity;it("is used for class definition",function(){var c=b({$class:"Test"});assert(c instanceof a)}),it("accepts a valid class definition",function(){b({$class:"Test",member:function(){}})}),["startingWithLowercaseLetterIsNotOK","The$signIsForbbidenIfNotAtTheBeginning","The_signIsForbbidenIfNotAtTheBeginning"].forEach(function(a){it("rejects invalid class name ("+a+")",function(){var c;try{b({$class:a})}catch(e_){c=e_}assert(c instanceof gpf.Error.InvalidClassName)})}),["StartingWithUppercaseLetterIsNotOK","the$signIsForbbidenIfNotAtTheBeginning","the_signIsForbbidenIfNotAtTheBeginning","class"].forEach(function(a){it("rejects invalid property name ("+a+")",function(){var c,d={$class:"Test"};d[a]=!0;try{b(d)}catch(e_){c=e_}assert(c instanceof gpf.Error.InvalidClassProperty)})}),it("rejects invalid $extend",function(){var a;try{b({$class:"Test",$extend:12})}catch(e_){a=e_}assert(a instanceof gpf.Error.InvalidClassExtend)}),it("accepts native $extend",function(){b({$class:"Test",$extend:String})}),it("accepts contextual $extend",function(){b({$class:"Test",$extend:"String"})})})}),describe("define",function(){function a(a,b,c){Object.keys(c).filter(function(a){return!c[a]}).forEach(function(c){it("rejects invalid "+a+" name ("+c+")",function(){var d,e={};e["$"+a]=c;try{gpf.define(e)}catch(e_){d=e_}assert(d instanceof b)})}),Object.keys(c).filter(function(a){return c[a]}).forEach(function(b){it("accepts valid "+a+" name ("+b+")",function(){var c,d={};d["$"+a]=b;try{gpf.define(d)}catch(e_){c=e_}assert(void 0===c)})})}function b(a){it(a.it,function(){var b;try{gpf.define(a.definition)}catch(e_){b=e_}assert(b instanceof a.exception)})}var c={};before(function(){gpf.context().test=c}),after(function(){delete gpf.context().test}),describe("gpf.define",function(){it("accepts only one parameter",function(){assert("function"==typeof gpf.define),assert(1===gpf.define.length)}),describe("Common validation",function(){b({it:"checks that he entity type is specified",definition:{},exception:gpf.Error.InvalidEntityType})}),describe("Class definition",function(){describe("Validation",function(){a("class",gpf.Error.InvalidClassName,{"1NumberAtTheBeginningIsNotOK":!1,"noUppercaseFirstLetterIsNotOK":!1,"DollarSignAnywhereIsNotOK$":!1,"A":!0,"$B":!0,"_C":!0,"Test123":!0}),[{it:"rejects invalid $ property names",definition:{$class:"Test",$test:!1},exception:gpf.Error.InvalidEntity$Property},{it:"rejects invalid property names (reserved keywords)",definition:{$class:"Test","super":!1},exception:gpf.Error.InvalidClassProperty},{it:"rejects constructor property if not a method",definition:{$class:"Test",constructor:!1},exception:gpf.Error.InvalidClassConstructor}].forEach(b)}),describe("Implementation",function(){var a,b;before(function(){a=gpf.define({$class:"A",_member:"defaultValue",getMember:function(){return this._member},"constructor":function(a){a&&(this._member=a),this._constructorOfA=!0},funcWith3params:function(a,b,c){return a+b+c},throwError:function(){throw new Error("error")}}),b=new a}),it("prevents constructor functions to be used without new",function(){var b;try{a()}catch(e_){b=e_}assert(b instanceof gpf.Error.ClassConstructorFunction)}),it("creates a constructor with the same signature than the constructor property",function(){assert(1===a.length)}),it("handles instanceof",function(){assert(b instanceof a)}),it("calls constructor property",function(){assert(b._constructorOfA)}),it("exposes methods",function(){assert("function"==typeof b.getMember),assert("defaultValue"===b.getMember())}),describe("Subclassing",function(){it("prevents invalid override",function(){var b;try{gpf.define({$class:"Test",$extend:a,getMember:!1})}catch(e_){b=e_}assert(b instanceof gpf.Error.InvalidClassOverride)});var b,d;before(function(){b=gpf.define({$class:"test.B",$extend:a,"constructor":function(a){this.$super("valueOfB"),this._constructorOfB=a},getMember:function(){return this.$super()+"-inB"},setMember:function(a){this._member=a},baseTest:function(){return this.$super.getMember()},invalidSuperMember:function(){return this.$super.doesntExist()},noSuperMember:function(){return this.$super()},differentBinding:function(){return this.$super.getMember.call({_member:"different"})},checkSignature:function(){assert(3===this.$super.funcWith3params.length)},throwError:function(){this.$super()}}),d=new b(3475)}),it("handles instanceof",function(){assert(d instanceof a),assert(d instanceof b)}),it("handles namespace",function(){assert(c.B===b)}),it("calls the constructor function",function(){assert(3475===d._constructorOfB)}),it("calls the proper $super()",function(){assert(d._constructorOfA),assert("valueOfB-inB"===d.getMember())}),it("offers a way to call named base method",function(){assert("valueOfB"===d.baseTest())}),it("fails when accessing an unknown $super member",function(){var a;try{d.invalidSuperMember()}catch(e_){a=e_}assert(a instanceof gpf.Error.InvalidClassSuperMember)}),it("fails when accessing inexistent $super",function(){var a;try{d.noSuperMember()}catch(e_){a=e_}assert(a instanceof gpf.Error.InvalidClassSuper)}),it("allows calling $super member with a different binding",function(){assert("different"===d.differentBinding())}),it("respects methods signature",function(){d.checkSignature()}),it("does not leak $super",function(){assert(void 0===d.$super)}),it("does not leak $super on exception",function(){try{d.throwError()}catch(e_){}assert(void 0===d.$super)}),it("handles several versions of $super",function(){var a=gpf.define({$class:"C",$extend:b,testMethod:function(){return this.$super.getMember()}}),c=new a;assert("valueOfB-inB"===c.testMethod())})})})}),describe("Interface definition",function(){describe("Validation",function(){a("interface",gpf.Error.InvalidInterfaceName,{"1NumberAtTheBeginningIsNotOK":!1,"noUppercaseFirstLetterIsNotOK":!1,"DollarSignAnywhereIsNotOK$":!1,"NotStartingWithUppercaseI":!1,"A":!1,"$B":!1,"_C":!1,"Test123":!1,"ISample":!0,"IS":!0}),[{it:"rejects interface if all members are not methods",definition:{$interface:"ITest",member:!1},exception:gpf.Error.InvalidInterfaceProperty},{it:"rejects invalid property names (reserved keywords)",definition:{$interface:"ITest","super":function(){}},exception:gpf.Error.InvalidInterfaceProperty},{it:"rejects constructor property",definition:{$interface:"ITest",constructor:function(){}},exception:gpf.Error.InvalidInterfaceProperty}].forEach(b)}),describe("Implementation",function(){var a=gpf.define({$interface:"ITest",test:function(a){return a}});it("can't be used as a class extend",function(){var b;try{gpf.define({$class:"Test",$extend:a})}catch(e_){b=e_}assert(b instanceof gpf.Error.InvalidClassExtend)})})})})}),describe("interfaces",function(){describe("gpf.interfaces.IUnknown",function(){it("exists",function(){assert("function"==typeof gpf.interfaces.IUnknown)}),it("is an interface",function(){var a;try{var b=new gpf.interfaces.IUnknown;assert(b)}catch(e_){a=e_}assert(a instanceof gpf.Error.InterfaceConstructorFunction)})}),describe("gpf.interfaces.isImplementedBy",function(){function a(){}a.prototype={queryInterface:function(a){return a}};var b=gpf.define({$class:"TestGPFClass",queryInterface:function(a){return a}});it("validates literal objects (using interface constructor)",function(){assert(!0===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,{queryInterface:function(a){return a}}))}),it("validates instances from a raw JavaScript class (using interface name)",function(){var b=new a;assert(!0===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",b))}),it("validates a raw JavaScript class",function(){assert(!0===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",a))}),it("validates instances from a GPF class",function(){var a=new b;assert(!0===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,a))}),it("validates a GPF class",function(){assert(!0===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,b))}),[!1,null,void 0,0,NaN,""].forEach(function(a){it("rejects "+JSON.stringify(a),function(){assert(!1===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",a))})}),it("rejects member if not a method",function(){assert(!1===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",{queryInterface:"Not a method"}))}),it("rejects member if parameters count does not match (none)",function(){assert(!1===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",{queryInterface:function(){}}))}),it("rejects member if parameters count does not match (more)",function(){assert(!1===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,{queryInterface:function(a,b,c){return a+b+c}}))})}),describe("gpf.interfaces.query",function(){function a(){}a.prototype.test=function(a,b){return a+b},it("returns the object if it implements the interface (using interface name)",function(){var a={queryInterface:function(a){return a}};assert(a===gpf.interfaces.query("gpf.interfaces.IUnknown",a))}),it("returns the object if it implements the interface (using interface specifier)",function(){var b={test:function(a,b){}};assert(b===gpf.interfaces.query(a,b))}),it("returns null if IUnknown is implemented but not the expected interface",function(){assert(null===gpf.interfaces.query(a,{queryInterface:function(a){return null}}))}),it("uses IUnknown to get the expected interface",function(){assert(null!==gpf.interfaces.query(a,{queryInterface:function(b){return assert(b===a),{test:function(a,b){}}}}))}),it("returns undefined if neither the expected interface or IUnknown are implemented",function(){assert(void 0===gpf.interfaces.query(a,{queryInterface:function(){return null}}))})})}),describe("sort",function(){function a(a,b){assert(a.every(function(a,c){return a.id===b[c]}))}var b=[{id:0,num:5,str:"e",group:1},{id:1,num:1,str:"b",group:0},{id:2,num:4,str:"a",group:1},{id:3,num:2,str:"d",group:0},{id:4,num:3,str:"c",group:1}];describe("gpf.createSortFunction",function(){[{label:"sort on numeric values (ascending)",sort:{property:"num"},expected:[1,3,4,2,0]},{label:"sort on string values (descending)",sort:[{property:"str",type:"string",ascending:!1}],expected:[0,3,4,1,2]},{label:"sort on multiple values",sort:[{property:"group",type:"number",ascending:!0},{property:"num",ascending:!1}],expected:[3,1,0,2,4]}].forEach(function(c){it(c.label,function(){a(b.sort(gpf.createSortFunction(c.sort)),c.expected)})})})}),describe("filter",function(){function a(a,b){assert(a.length===b.length),assert(a.every(function(a,c){return a.id===b[c]}))}var b=[{id:0,num:5,str:"e",group:1,search:"first"},{id:1,num:1,str:"b",group:0,search:"second"},{id:2,num:4,str:"a",group:1,search:"third"},{id:3,num:2,str:"d",group:0,search:"fourth"},{id:4,num:3,str:"c",group:1,search:"fifth"}];describe("gpf.createFilterFunction",function(){[{label:"filters on numeric values",filter:{eq:[{property:"num"},1]},expected:[1]},{label:"filters on own values",filter:{eq:[{property:"num"},{property:"id"}]},expected:[1]},{label:"filters on string values",filter:{eq:[{property:"str"},"c"]},expected:[4]},{label:"filters on string values (ne)",filter:{ne:[{property:"str"},"c"]},expected:[0,1,2,3]},{label:"filters with lower than (lt)",filter:{lt:[{property:"num"},3]},expected:[1,3]},{label:"filters with lower than or equal (lte)",filter:{lte:[{property:"num"},3]},expected:[1,3,4]},{label:"filters with greater than (gt)",filter:{gt:[{property:"num"},3]},expected:[0,2]},{label:"filters with greater than or equal (lte)",filter:{gte:[{property:"num"},3]},expected:[0,2,4]},{label:"filters on string values (not eq)",filter:{not:{eq:[{property:"str"},"c"]}},expected:[0,1,2,3]},{label:"filters on string values (like)",filter:{like:{property:"str"},regexp:"[a|c]"},expected:[2,4]},{label:"filters on string values (like with capturing group)",filter:{eq:[{like:{property:"search"},regexp:"f([a-z]*)th",group:1},"if"]},expected:[4]},{label:"filters with or (one condition)",filter:{or:[{eq:[{property:"num"},1]}]},expected:[1]},{label:"filters with or (two conditions)",filter:{or:[{eq:[{property:"num"},1]},{eq:[{property:"str"},"c"]}]},expected:[1,4]},{label:"filters with or (three conditions)",filter:{or:[{eq:[{property:"num"},1]},{eq:[{property:"str"},"c"]},{eq:[{property:"group"},0]}]},expected:[1,3,4]},{label:"filters with and (one condition)",filter:{and:[{eq:[{property:"group"},1]}]},expected:[0,2,4]},{label:"filters with and (two conditions)",filter:{and:[{eq:[{property:"group"},1]},{eq:[{property:"str"},"c"]}]},expected:[4]},{label:"filters with and (three conditions)",filter:{and:[{eq:[{property:"group"},1]},{eq:[{property:"str"},"c"]},{eq:[{property:"num"},3]}]},expected:[4]}].forEach(function(c){it(c.label,function(){a(b.filter(gpf.createFilterFunction(c.filter)),c.expected)})})})}),describe("stream",function(){if(gpf.internals){var a=gpf.internals._gpfStreamQueryReadable,b=gpf.internals._gpfStreamQueryWritable,c=gpf.internals._gpfStreamSecureInstallProgressFlag,d=gpf.internals._gpfStreamSecureRead,e=gpf.internals._gpfStreamSecureWrite,f=["","Hello World !",!1,!0,null,void 0,0,1];describe("(internal)",function(){describe("_gpfStreamQueryReadable",function(){it("checks if the parameters implements gpf.interfaces.IReadableStream",function(){assert(a({read:function(a){assert(a)}}))}),it("fails when the parameters does not implement gpf.interfaces.IReadableStream",function(){var b;try{a({})}catch(e_){b=e_}assert(b instanceof gpf.Error.InterfaceExpected)}),f.forEach(function(b){it("fails when the parameters is invalid - "+JSON.stringify(b),function(){var c;try{a(b)}catch(e_){c=e_}assert(c instanceof gpf.Error.InterfaceExpected)})})}),describe("_gpfStreamQueryWritable",function(){it("checks if the parameters implements gpf.interfaces.IWritableStream",function(){assert(b({write:function(a){assert(a)}}))}),it("fails when the parameters does not implement gpf.interfaces.IWritaableStream",function(){var a;try{b({})}catch(e_){a=e_}assert(a instanceof gpf.Error.InterfaceExpected)}),f.forEach(function(a){it("fails when the parameters is invalid - "+JSON.stringify(a),function(){var c;try{b(a)}catch(e_){c=e_}assert(c instanceof gpf.Error.InterfaceExpected)})})}),describe("_gpfStreamSecureRead",function(){function a(){}a.prototype={read:d(function(a){return a.write("TEST")})},c(a),it("accepts only IWritableStream",function(){var b,c=new a;try{c.read({})}catch(e_){b=e_}assert(b instanceof gpf.Error.InterfaceExpected)}),it("is protected against parallel calls",function(){var b,c={write:function(a){return assert("TEST"===a),new Promise(function(){})}},d=new a;try{d.read(c),d.read(c)}catch(e_){b=e_}assert(b instanceof gpf.Error.ReadInProgress)}),it("writes to an IWritableStream",function(b){var c={write:function(a){return assert("TEST"===a),Promise.resolve()}};(new a).read(c).then(function(){b()})}),it("forwards any error",function(b){var c={write:function(a){return assert("string"==typeof a),Promise.reject(1)}};(new a).read(c).then(function(){},function(a){var c;try{assert(1===a)}catch(e_){c=e_}b(c)})})}),describe("_gpfStreamSecureWrite",function(){function a(){}a.prototype={write:e(function(a){return"OK"===a?Promise.resolve():Promise.reject(a)})},c(a),it("is protected against parallel calls",function(){var b,c=new a;try{c.write("OK"),c.write("OK")}catch(e_){b=e_}assert(b instanceof gpf.Error.WriteInProgress)}),it("forwards any error",function(b){(new a).write("KO").then(function(){},function(a){var c;try{assert("KO"===a)}catch(e_){c=e_}b(c)})})})})}}),describe("stream/string",function(){describe("gpf.stream.ReadableString",function(){it("writes to an IWritableStream",function(a){var b=new gpf.stream.WritableString;new gpf.stream.ReadableString("Hello World").read(b).then(function(){assert("Hello World"===b.toString()),a()})})}),describe("gpf.stream.WritableString",function(){it("supports multiple sequenced calls",function(a){var b=new gpf.stream.WritableString;b.write("Hell").then(function(){return b.write("o ")}).then(function(){return b.write("World")}).then(function(){assert("Hello World"===b.toString()),a()})})})}),describe("fs",function(){var a="test/data";describe("gpf.fs.getFileStorage",function(){function b(a){function b(){if(++d===c.length)return Promise.resolve();var a=c.slice(0,d+1).join("/");return e.getInfo(a).then(function(c){return c.type===gpf.fs.types.directory?b():c.type===gpf.fs.types.notFound?e.createDirectory(a).then(b):Promise.reject("ERROR")})}var c=a.split("/"),d=-1,e=gpf.fs.getFileStorage();return b()}function c(a){function b(){var a=c.join("/");return d.deleteDirectory(a).then(function(){if(c.pop(),c.length>3)return b()})}var c=a.split("/"),d=gpf.fs.getFileStorage();return b()}function d(b){assert(b.type===gpf.fs.types.file),assert("file.bin"===b.fileName),assert(-1!==b.filePath.indexOf(a+"/file.bin")),assert(256===b.size),assert(b.createdDateTime instanceof Date),assert(b.createdDateTime.getUTCFullYear()>2010),assert(b.modifiedDateTime instanceof Date),assert(b.modifiedDateTime.getUTCFullYear()>2010)}function e(b){assert(b.type===gpf.fs.types.directory),assert("folder"===b.fileName),assert(-1!==b.filePath.indexOf(a+"/folder")),assert(b.createdDateTime instanceof Date),assert(b.createdDateTime.getUTCFullYear()>2010),assert(b.modifiedDateTime instanceof Date),assert(b.modifiedDateTime.getUTCFullYear()>2010)}if(gpf.fs.getFileStorage()){var f="tmp/fs/"+gpf.host()+"/"+(new Date).toISOString().replace(/\-|T|\:|\.|Z/g,"")+"/"+Math.floor(100*Math.random());it("returns a file storage interface",function(){assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IFileStorage,gpf.fs.getFileStorage()))}),describe("getInfo",function(){it("can get file information",function(b){gpf.fs.getFileStorage().getInfo(gpf.path.join(a,"file.bin")).then(d).then(b,b)}),it("can get directory information",function(b){gpf.fs.getFileStorage().getInfo(gpf.path.join(a,"folder")).then(e).then(b,b)}),it("does not fail if the file does not exist",function(b){gpf.fs.getFileStorage().getInfo(gpf.path.join(a,"nope")).then(function(a){assert(a.type===gpf.fs.types.notFound)}).then(b,b)})}),describe("openTextStream",function(){function d(a,b){var c=gpf.fs.getFileStorage(),d=new gpf.stream.WritableString;return c.openTextStream(a,gpf.fs.openFor.reading).then(function(a){return assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IReadableStream,a)),a.read(d).then(function(){return b&&assert(d.toString()===b),c.close(a).then(function(){return d.toString()})})})}describe("read",function(){it("reads a small text file",function(b){d(gpf.path.join(a,"folder/hello world.txt"),"hello world\n").then(function(){b()},b)}),it("reads a larger text file",function(b){d(gpf.path.join(a,"folder/lorem ipsum.txt")).then(function(a){assert(-1!==a.indexOf("Phasellus posuere.")),b()})["catch"](b)})}),describe("write",function(){function a(a,b){var c=gpf.fs.getFileStorage();return c.openTextStream(a,gpf.fs.openFor.appending).then(function(a){return a.write(b).then(function(){return c.close(a)})})}before(function(a){b(f).then(function(){a()},a)}),after(function(a){c(f).then(function(){a()},a)}),describe("initial",function(){var b=gpf.path.join(f,"hello world.txt");before(function(c){a(b,"hello world\n").then(c,c)}),after(function(a){gpf.fs.getFileStorage().deleteFile(b).then(a,a)}),it("writes a text file",function(a){d(b,"hello world\n").then(function(){a()},a)}),describe("append",function(){it("appends a text file",function(c){a(b,"goodbye\n").then(function(){return d(b,"hello world\ngoodbye\n")}).then(function(){c()},c)})})})})}),describe("close",function(){it("rejects invalid streams",function(a){gpf.fs.getFileStorage().close({}).then(function(){throw new Error}).then(void 0,function(a){assert(a instanceof gpf.Error.IncompatibleStream)}).then(a,a)})}),describe("explore",function(){it("lists the content of a folder",function(b){gpf.fs.getFileStorage().explore(a).then(function(a){function c(b){var c=a.getCurrent();return b.type===gpf.fs.types.file?(d(b),d(c)):(e(b),e(c)),a.moveNext()}return assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IEnumerator,a)),a.reset().then(function(){return a.moveNext()}).then(c).then(c).then(function(a){assert(void 0===a)}).then(b,b)})}),it("fails on a file",function(b){gpf.fs.getFileStorage().explore(gpf.path.join(a,"file.bin")).then(function(){b(new Error("unexpected"))},function(){b()})}),it("fails with an invalid path",function(b){gpf.fs.getFileStorage().explore(gpf.path.join(a,"nothing")).then(function(){b(new Error("unexpected"))},function(){b()})})})}else it("does not return a file storage interface",function(){var a=gpf.fs.getFileStorage();assert(null===a)})}),gpf.host()!==gpf.hosts.browser&&describe("gpf.fs.read",function(){it("gives a generic read access to the file system",function(b){gpf.fs.read(gpf.path.join(a,"folder/hello world.txt")).then(function(a){try{assert("hello world\n"===a),b()}catch(e_){b(e_)}},b)}),it("fails if the file does not exist",function(b){gpf.fs.read(gpf.path.join(a,"nope")).then(function(){b(new Error("Should not happen"))},function(a){try{assert(a instanceof Error),b()}catch(e_){b(e_)}})})})}),describe("path",function(){function a(a){function c(a){return new e("assert(gpf.path."+a+");")}var d;d="/"===a?a:"\\\\",describe("gpf.path.join ("+a+")",function(){var c;c="/"===a?b.join:function(){var c=Array.from(arguments,function(b){return b.split("/").join(a)});return b.join.apply(b,c)},it("concatenates paths",function(){assert("abc/def/ghi/jkl"===c("abc/def","ghi/jkl"))}),it("handles trailing separator",function(){assert("abc/def/ghi/jkl"===c("abc/def/","ghi/jkl/"))}),it("handles relative paths",function(){assert("abc/ghi"===c("abc/def","../ghi"))}),it("handles multiple joins",function(){assert("abc/ghi/jkl"===c("abc","def","../ghi/jkl","../jkl"))}),it("resolves on known parent",function(){assert("ghi"===c("abc","../ghi"))}),it("goes up with ..",function(){assert("abc"===c("abc/def",".."))}),it("does not resolve on unknown parent",function(){var a;try{c("abc","../../ghi")}catch(e_){a=e_}assert(a instanceof gpf.Error.UnreachablePath)})}),describe("gpf.path.parent ("+a+")",function(){it("retrieves the parent path",function(){assert("abc"===b.parent("abc"+a+"def"))}),it("returns empty on a root",function(){assert(""===b.parent(a+"abc"))}),it("returns empty when no parent",function(){assert(""===b.parent("abc"))}),it("fails when empty",function(){var a;try{b.parent("")}catch(e_){a=e_}assert(a instanceof gpf.Error.UnreachablePath)})});var e=Function,f=[{label:"considers the last name of path",path:"abc"+d+"def.ghi",name:"def.ghi",nameOnly:"def",extension:".ghi"},{label:"handles trailing separator",path:"abc"+d+"def.ghi"+d,name:"def.ghi",nameOnly:"def",extension:".ghi"},{label:"handles trailing separator (no extension)",path:"abc"+d+"def"+d,name:"def",nameOnly:"def",extension:""},{label:"handles name only",path:"abc.defgh",name:"abc.defgh",nameOnly:"abc",extension:".defgh"},{label:"handles name only (no extension)",path:"abc",name:"abc",nameOnly:"abc",extension:""},{label:"handles root",path:"/",name:"",nameOnly:"",extension:""},{label:"handles empty path",path:"",name:"",nameOnly:"",extension:""}];describe("gpf.path.name ("+a+")",function(){f.forEach(function(a){it(a.label,c('name("'+a.path+'") === "'+a.name+'"'))})}),describe("gpf.path.nameOnly ("+a+")",function(){f.forEach(function(a){it(a.label,c('nameOnly("'+a.path+'") === "'+a.nameOnly+'"'))})}),describe("gpf.path.extension ("+a+")",function(){f.forEach(function(a){it(a.label,c('extension("'+a.path+'") === "'+a.extension+'"'))})}),describe("gpf.path.relative ("+a+")",function(){var c;c="/"===a?b.relative:function(){var c=Array.from(arguments,function(b){return b.split("/").join(a)});return b.relative.apply(b,c)},it("solves the relative path",function(){assert("../ghi"===c("abc/def","abc/ghi"))}),it("handles trailing separator",function(){assert("../ghi"===c("abc/def/","abc/ghi"))}),it("works on non matching roots",function(){assert("../../ghi/jkl"===c("abc/def","ghi/jkl"))}),it("works on non matching roots (any level)",function(){assert("../../../g/h/i/jkl"===c("a/bc/def","g/h/i/jkl"))}),it("handles edge cases (left empty)",function(){assert("abc/ghi"===c("","abc/ghi"))}),it("handles edge cases (right empty)",function(){assert("../.."===c("abc/ghi",""))}),it("handles edge cases (both empty)",function(){assert(""===c("",""))})})}var b=gpf.path;a("/"),a("\\"),gpf.internals&&describe("(internal)",function(){describe("_gpfPathNormalize",function(){var a={"a/":"a","/a/":"/a","a/b":"a/b","a\\b":"a/b","a\\":"a","\\a\\":"/a"};gpf.internals._gpfObjectForEach(a,function(a,b){it('transforms "'+b+'" into "'+a+'"',function(){assert(a===gpf.internals._gpfPathNormalize(b))})})})})}),describe("stream/node",function(){function a(){this._events={}}a.prototype={_events:{},_fire:function(a){var b=[].slice.call(arguments,1);this._events[a].apply(null,b)},on:function(a,b){return assert(!this._events[a]),this._events[a]=b,this},once:function(a,b){return this.on(a,function(){b(),delete this._events[a]}.bind(this))}},gpf.hosts.nodejs===gpf.host()&&(describe("gpf.node.ReadableStream",function(){it("configures the stream by hooking the events",function(b){var c=new a,d=new gpf.node.ReadableStream(c),e=new gpf.stream.WritableString;assert("function"==typeof c._events.error),d.read(e).then(b,b),assert("function"==typeof c._events.data),assert("function"==typeof c._events.end),c._fire("end")}),it("supports several read events",function(b){var c=new a,d=new gpf.node.ReadableStream(c),e=new gpf.stream.WritableString;d.read(e).then(function(){assert("Hello World"===e.toString())}).then(b,b);var f=!1,g=0;c.pause=function(){assert(!f),f=!0},c.resume=function(){assert(f),f=!1,setTimeout(function(){++g,1===g?c._fire("data","World"):c._fire("end")},0)},c._fire("data","Hello ")}),it("handles errors",function(b){var c=new a,d=new gpf.node.ReadableStream(c),e=new gpf.stream.WritableString;d.read(e).then(function(){assert(!1)}).then(void 0,function(a){assert("error"===a)}).then(b,b);var f=!1;c.pause=function(){assert(!f),f=!0},c.resume=function(){assert(f),f=!1,setTimeout(function(){c._fire("error","error")},0)},c._fire("data","Hello ")}),it("handles errors of write stream",function(b){var c=new a,d=new gpf.node.ReadableStream(c),e={write:function(a){return Promise.reject(a)}};c.pause=function(){},
d.read(e).then(function(){assert(!1)},function(a){assert("error"===a)}).then(b,b),c._fire("data","error")}),it("prevents any subsequent use when an error occurred",function(b){var c=new a,d=new gpf.node.ReadableStream(c),e=new gpf.stream.WritableString;d.read(e).then(function(){assert(!1)}).then(void 0,function(a){return assert("error"===a),d.read(e)}).then(void 0,function(a){assert(a instanceof gpf.Error.InvalidStreamState)}).then(b,b),c._fire("error","error")}),it("prevents any subsequent use when ended",function(b){var c=new a,d=new gpf.node.ReadableStream(c),e=new gpf.stream.WritableString;d.read(e).then(function(){return d.read(e)}).then(void 0,function(a){assert(a instanceof gpf.Error.InvalidStreamState)}).then(b,b),c._fire("end")})}),describe("gpf.node.ReadableStream",function(){it("configures the stream by hooking the events",function(){var b=new a,c=new gpf.node.WritableStream(b);assert(c),assert("function"==typeof b._events.error)}),it("passes the buffer to the inner stream",function(b){var c=new a,d=new gpf.node.WritableStream(c);assert("function"==typeof c._events.error),c.write=function(a){return assert("Hello World"===a),!0},d.write("Hello World").then(b,b),assert(!c._events.drain)}),it("supports several write calls",function(b){var c=new a,d=new gpf.node.WritableStream(c),e="";assert("function"==typeof c._events.error),c.write=function(a){return e+=a,!0},d.write("Hello ").then(function(){return d.write("World")}).then(function(){assert("Hello World"===e)}).then(b,b),assert(!c._events.drain)}),it("waits for the drain event if the stream is full",function(b){var c=new a,d=new gpf.node.WritableStream(c),e=!1;assert("function"==typeof c._events.error),c.write=function(a){return assert("Hello World"===a),!1},d.write("Hello World").then(function(){assert(e),assert(!c._events.drain)}).then(b,b),assert("function"==typeof c._events.drain),e=!0,c._fire("drain")}),it("handles errors",function(b){var c=new a,d=new gpf.node.WritableStream(c);assert("function"==typeof c._events.error),c.write=function(){c._fire("error","error")},d.write("Hello World").then(void 0,function(a){assert("error"===a)}).then(b,b)}),it("prevents any subsequent use when an error occurred",function(b){var c=new a,d=new gpf.node.WritableStream(c);assert("function"==typeof c._events.error),c.write=function(){c._fire("error","error")},d.write("Hello World").then(void 0,function(a){return assert("error"===a),d.write("Hello World")}).then(void 0,function(a){assert(a instanceof gpf.Error.InvalidStreamState)}).then(b,b)})}))}),describe("fs/node",function(){if(gpf.hosts.nodejs===gpf.host()&&(it("forwards inner errors (generic API)",function(a){gpf.fs.getFileStorage().deleteFile("test/data/notFound.bin").then(function(){throw new Error("Should fail")},function(b){assert("ENOENT"===b.code),a()})["catch"](function(b){a(b)})}),gpf.internals)){var a=gpf.internals._gpfFsNodeGetType;it("uses unknown file type if not file or directory",function(){assert(gpf.fs.types.unknown===a({isDirectory:function(){return!1},isFile:function(){return!1}}))})}}),describe("literal",function(){describe("gpf.isLiteralObject",function(){function a(){}[{value:{},result:!0},{value:{member:"a"},result:!0},{value:new Object,result:!0},{value:null},{value:void 0},{value:new a,label:"new A()"},{value:[]},{value:new Date,label:"new Date()"},{value:!0}].forEach(function(a){var b=a.label||JSON.stringify(a.value),c=!0===a.result,d={"true":"recognizes","false":"rejects"}[c];it(d+" "+b,function(){assert(c===gpf.isLiteralObject(a.value))})})})}),describe("web/tag",function(){function a(a,b,c){this._namespace=a,this._name=b,this._value=c}function b(a,b,c){this.ownerDocument=a,this._namespace=b,this.nodeName=c,this._attributes=[],this._children=[]}a.prototype={_namespace:"",_name:"",_value:void 0},b.prototype={ownerDocument:null,_namespace:"",nodeName:"",_attributes:[],_children:[],appendChild:function(a){return this._children.push(a),a},setAttribute:function(b,c){this._attributes.push(new a("",b,c))},setAttributeNS:function(b,c,d){this._attributes.push(new a(b,c,d))},_hasAttribute:function(a,b){var c;return this._attributes.every(function(d){return d._namespace!==a||d._name!==b||(c=d._value,!1)}),c}};var c={createElement:function(a){return new b(this,"",a)},createElementNS:function(a,c){return new b(this,a,c)},createTextNode:function(a){return a}};describe("gpf.web.createTagFunction",function(){it("requires node name when calling the function",function(){var a;try{gpf.web.createTagFunction()}catch(e_){a=e_}assert(a instanceof gpf.Error.MissingNodeName)}),it("creates shortcut for tag generation",function(){var a=gpf.web.createTagFunction("div");assert("<div>Hello World!</div>"===a("Hello World!").toString())}),it("generates closed tags when empty",function(){var a=gpf.web.createTagFunction("div");assert("<div/>"===a().toString())}),it("supports tree building (parameters)",function(){var a=gpf.web.createTagFunction("div"),b=gpf.web.createTagFunction("span"),c=a({className:"test1"},"Hello ",b({className:"test2"},"World!"));assert('<div class="test1">Hello <span class="test2">World!</span></div>'===c.toString())}),it("supports tree building (array parameter)",function(){var a=gpf.web.createTagFunction("div"),b=gpf.web.createTagFunction("span"),c=a({width:"80%"},"Hello ",[b("Wor"),b("ld!")]);assert('<div width="80%">Hello <span>Wor</span><span>ld!</span></div>'===c.toString())}),it("allows DOM injection",function(){var a=c.createElement("any"),d=gpf.web.createTagFunction("div"),e=gpf.web.createTagFunction("span"),f=d({className:"test"},"Hello ",e("World!")),g=f.appendTo(a);assert(g instanceof b),assert(g.ownerDocument===c),assert("div"===g.nodeName),assert("test"===g._hasAttribute("","class")),assert(2===g._children.length),assert("Hello "===g._children[0]),assert(g._children[1]instanceof b),assert("World!"===g._children[1]._children[0])}),describe("Namespace handling",function(){it("permits namespaces for node appending",function(){var a=c.createElement("any"),d=gpf.web.createTagFunction("svg:image"),e=d({x:0,y:0,"xlink:href":"test.png"}),f=e.appendTo(a);assert(f instanceof b),assert(f.ownerDocument===c),assert("image"===f.nodeName),assert("http://www.w3.org/2000/svg"===f._namespace),assert("test.png"===f._hasAttribute("http://www.w3.org/1999/xlink","href")),assert(0===f._hasAttribute("","x"))}),it("fails if namespace is unknown",function(){var a,b=c.createElement("any"),d=gpf.web.createTagFunction("svg2:image"),e=d({x:0,y:0,"xlink:href":"test.png"});try{e.appendTo(b)}catch(e_){a=e_}assert(a instanceof gpf.Error.UnknownNamespacePrefix)}),it("fails when used for string generation",function(){var a,b=gpf.web.createTagFunction("svg:image"),c=b({x:0,y:0,"xlink:href":"test.png"});try{c.toString()}catch(e_){a=e_}assert(a instanceof gpf.Error.UnableToUseNamespaceInString)})})})}),describe("gpf.interfaces.IThenable",function(){function a(a){return a}function b(b){var c=gpf[b].bind(gpf);[null,0,"",!1,!0,{},"Hello World!",7].forEach(function(a){it("converts "+JSON.stringify(a)+" into a promise",function(b){try{c(a).then(function(c){assert(a===c),b()})}catch(e_){b(e_)}})}),it("returns the promise parameter",function(){var a=Promise.resolve();assert(a===c(a))}),it("returns the IThenable parameter",function(b){try{var d={then:function(b,c){a(c),b("ok")}},e=c(d);assert(d===e),e.then(function(a){assert("ok"===a),b()})}catch(e_){b(e_)}})}describe("gpf.promisify",function(){it("converts undefined into a promise",function(a){try{gpf.promisify().then(function(b){assert(void 0===b),a()})}catch(e_){a(e_)}}),b("promisify")}),describe("gpf.promisifyDefined",function(){it("returns undefined with undefined",function(){assert(void 0===gpf.promisifyDefined(void 0))}),b("promisifyDefined")})}),describe("gpf.http.mock",function(){var a;before(function(){a="http://localhost:"+config.httpPort+"/echo/"}),it("exposes a method to mock requests",function(){assert("function"==typeof gpf.http.mock)}),it("exposes a method to remove one specific mocking",function(){assert("function"==typeof gpf.http.mock.remove)}),it("exposes a method to reset all mocking",function(){assert("function"==typeof gpf.http.mock.reset)}),describe("Simple mocking example",function(){var b;beforeEach(function(){b=gpf.http.mock({method:gpf.http.methods.get,url:/echo\/\?status=([0-9]+)/,response:function(a,b){if("400"!==b)return{status:parseInt(b,10)+1,headers:{"x-mock":!0},responseText:"It works"}}})}),afterEach(function(){b&&gpf.http.mock.remove(b)}),it("matches request URL and method",function(b){gpf.http.get(a+"?status=200").then(function(a){assert(201===a.status),assert(!0===a.headers["x-mock"]),assert("It works"===a.responseText),b()})["catch"](b)}),0!==config.httpPort&&(it("matches request URL and method (non matching URL)",function(b){gpf.http.get(a).then(function(a){assert(200===a.status),assert(void 0===a.headers["x-mock"]),b()})["catch"](b)}),it("matches request URL and method (non matching method)",function(b){gpf.http.put(a,"?status=200").then(function(a){assert(200===a.status),assert(void 0===a.headers["x-mock"]),b()})["catch"](b)}),it("may decide to not mock",function(b){gpf.http.get(a+"?status=400").then(function(a){assert(400===a.status),assert(void 0===a.headers["x-mock"]),b()})["catch"](b)}),it("does not mock once removed",function(c){gpf.http.mock.remove(b),b=void 0,gpf.http.get(a+"?status=200").then(function(a){assert(200===a.status),assert(void 0===a.headers["x-mock"]),c()})["catch"](c)}),it("does not mock once removed (reset)",function(c){gpf.http.mock.reset(),b=void 0,gpf.http.get(a+"?status=200").then(function(a){assert(200===a.status),assert(void 0===a.headers["x-mock"]),c()})["catch"](c)}),it("does not fail if removed twice",function(){gpf.http.mock.reset(),gpf.http.mock.remove(b),b=void 0}))}),describe("Advanced mocking example",function(){var b;beforeEach(function(){function a(a){return function(){return{status:200,headers:{},responseText:"answer-"+a}}}gpf.http.mock({method:gpf.http.methods.get,url:/echo\/lifo/,response:a(1)}),gpf.http.mock({method:gpf.http.methods.get,url:/echo\/lifo/,response:a(2)}),b=gpf.http.mock({method:gpf.http.methods.get,url:/echo\/lifo/,response:a(3)}),gpf.http.mock({method:gpf.http.methods.put,url:/echo\/lifo/,response:a(4)}),gpf.http.mock({method:gpf.http.methods.get,url:/echo\/redirect/,response:function(a){return gpf.http.get(a.url.replace("/redirect","/lifo"))}})}),afterEach(function(){gpf.http.mock.reset()}),it("uses LIFO priority",function(b){gpf.http.get(a+"lifo").then(function(a){assert(200===a.status),assert("answer-3"===a.responseText),b()})["catch"](b)}),it("preserves the order when removing a mocked request",function(c){gpf.http.mock.remove(b),gpf.http.get(a+"lifo").then(function(a){assert(200===a.status),assert("answer-2"===a.responseText),c()})["catch"](c)}),it("allows redirection",function(b){gpf.http.get(a+"redirect").then(function(a){assert(200===a.status),assert("answer-3"===a.responseText),b()})["catch"](b)})})}),describe("http",function(){it("knows config.httpPort",function(){assert("object"==typeof config&&"number"==typeof config.httpPort)}),describe("gpf.http",function(){if(0===config.httpPort)return void it("is not tested in this environment because config.httpPorty = 0",function(){assert(!0)});var a;before(function(){a="http://localhost:"+config.httpPort+"/echo/?"}),it("allows the GET operation",function(b){gpf.http.request({method:gpf.http.methods.get,url:a+"status=200"}).then(function(a){assert(200===a.status);var c=JSON.parse(a.responseText);assert("GET"===c.method),assert("/echo/?status=200"===c.url),b()})["catch"](b)}),it("offers the GET shortcut (using string parameter)",function(b){gpf.http.get(a+"status=200").then(function(a){assert(200===a.status);var c=JSON.parse(a.responseText);assert("GET"===c.method),assert("/echo/?status=200"===c.url),b()})["catch"](b)}),it("offers the GET shortcut (using object parameter)",function(b){gpf.http.get({url:a+"status=200&response=Hello%20World"}).then(function(a){assert(200===a.status),assert("Hello World"===a.responseText),b()})["catch"](b)}),it("succeeds when the HTTP request fails",function(b){gpf.http.get(a+"status=500").then(function(a){assert(500===a.status),b()})["catch"](b)}),it("succeeds when the HTTP response is empty",function(b){gpf.http.get(a+"response=").then(function(a){assert(""===a.responseText),b()})["catch"](b)}),it("forwards request headers",function(b){gpf.http.request({method:gpf.http.methods.get,url:a+"status=200",headers:{"x-test":"Value"}}).then(function(a){assert(200===a.status),assert("Value"===a.headers["x-test"]),b()})["catch"](b)}),it("gives access to response headers",function(b){gpf.http.request({method:gpf.http.methods.get,url:a+'status=200&headers={"x-test-1":"OK","x-test-2":123}'}).then(function(a){assert(200===a.status),assert("OK"===a.headers["x-test-1"]),assert("123"===a.headers["x-test-2"]),b()})["catch"](b)}),["post","put","options","delete","head"].forEach(function(b,c){var d,e,f=b.toUpperCase();c<2&&(d="Hello World"),e="head"===b?function(){}:function(a){var b=JSON.parse(a);assert(b.method===f),assert("/echo/?status=200"===b.url),d?assert(b.body===d):assert(!b.body)},it("allows the "+f+" operation",function(c){gpf.http.request({method:gpf.http.methods[b],url:a+"status=200",data:d}).then(function(a){assert(200===a.status),e(a.responseText),c()})["catch"](c)}),it("offers the "+f+" shortcut",function(c){gpf.http[b](a+"status=200",d).then(function(a){assert(200===a.status),e(a.responseText),c()})["catch"](c)})})})}),describe("stream/rhino",function(){gpf.hosts.rhino===gpf.host()&&describe("gpf.rhino.ReadableStream",function(){it("forwards any error",function(a){var b=new gpf.rhino.ReadableStream({close:function(){}}),c={_ignore:function(){},write:function(a){this._ignore(a)}};b.read(c).then(function(){a(new Error("Not expected"))},function(b){try{assert(b),a()}catch(e_){a(e_)}})})})}),describe("stream/bufferedread",function(){describe("gpf.stream.BufferedRead",function(){function a(a){var b=new gpf.stream.WritableArray;return gpf.stream.pipe(a,b).then(function(){return b.toArray()})}function b(b,c){a(b).then(function(a){assert(2===a.length),assert("Hello"===a[0]),assert("World!"===a[1]),c()})["catch"](c)}var c=gpf.define({$class:"TestReadable",$extend:"gpf.stream.BufferedRead",appendToReadBuffer:function(){return this._appendToReadBuffer.apply(this,arguments)},completeReadBuffer:function(){return this._completeReadBuffer.apply(this,arguments)},setReadError:function(){return this._setReadError.apply(this,arguments)}});it("exposes IReadableStream",function(){assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IReadableStream,c))}),describe("data output",function(){it("outputs data before reading",function(a){var d=new c;d.appendToReadBuffer("Hello","World!").completeReadBuffer(),b(d,a)}),it("outputs data while reading",function(a){var d=new c;d.appendToReadBuffer("Hello"),b(d,a),d.appendToReadBuffer("World!").completeReadBuffer()}),it("outputs data after reading",function(a){var d=new c;b(d,a),d.appendToReadBuffer("Hello","World!").completeReadBuffer()})}),describe("error management",function(){function b(a){return a}function d(b,c){a(b).then(function(){throw new Error("Should fail")},function(a){assert("FAIL"===a.message),c()})["catch"](c)}function e(a,b){var d=new c;d.appendToReadBuffer("Hello","World!").completeReadBuffer(),gpf.stream.pipe(d,a).then(function(){throw new Error("Should fail")},function(a){assert("FAIL"===a.message),b()})["catch"](b)}it("generates errors before reading",function(a){var b=new c;b.appendToReadBuffer("Hello","World!").setReadError(new Error("FAIL")),d(b,a)}),it("generates errors while reading",function(a){var b=new c;b.appendToReadBuffer("Hello"),d(b,a),b.appendToReadBuffer("World!").setReadError(new Error("FAIL"))}),it("generates errors after reading",function(a){var b=new c;d(b,a),b.appendToReadBuffer("Hello","World!").setReadError(new Error("FAIL"))}),it("forwards errors (exception)",function(a){e({write:function(a){throw b(a),new Error("FAIL")}},a)}),it("forwards errors (reject)",function(a){e({write:function(a){return b(a),Promise.reject(new Error("FAIL"))}},a)})})})}),describe("stream/line",function(){function a(a){return a.write("abc").then(function(){return a.write("def\n")}).then(function(){return a.write("gh")}).then(function(){return a.write("ijkl\r")})}function b(a){return a.write("\nmnopqr\n").then(function(){return a.write("stuvwx\nyz")})}function c(){return{_index:0,write:function(a){return a!==d[this._index]?Promise.reject("No match"):(++this._index,Promise.resolve())}}}var d=["abcdef","ghijkl","mnopqr","stuvwx","yz"];it("generates lines out of any stream (read first)",function(e){var f=new gpf.stream.LineAdapter,g=c();f.read(g).then(function(){assert(g._index===d.length),e()})["catch"](e),a(f).then(function(){return b(f)}).then(function(){f.flush()})}),it("generates lines out of any stream (write first)",function(e){var f=new gpf.stream.LineAdapter,g=c();a(f).then(function(){return b(f)}).then(function(){return f.write("\n")}).then(function(){return f.flush()}).then(function(){return f.read(g)}).then(function(){assert(g._index===d.length),e()})["catch"](e)}),it("generates lines out of any stream (mixed)",function(e){var f=new gpf.stream.LineAdapter,g=c();a(f).then(function(){f.read(g).then(function(){assert(g._index===d.length),e()})["catch"](e),b(f).then(function(){f.flush()})})})}),describe("require",function(){var a;before(function(){a=0===config.httpPort?"/gpf/test-resources/require":"/test/require",gpf.require.configure({base:a})}),describe("gpf.require.resolve",function(){it("resolves relative path",function(){assert(gpf.require.resolve("file.js")===a+"/file.js")}),it("resolves relative path with folders",function(){assert(gpf.require.resolve("folder/file.js")===a+"/folder/file.js")}),it("resolves relative path with folders (use of ..)",function(){assert(gpf.require.resolve("../file.js")===a.split("/").slice(0,-1).join("/")+"/file.js")})}),describe("gpf.require.configure",function(){it("fails on invalid options",function(){var a;try{gpf.require.configure({unknown:!0})}catch(e_){a=e_}assert(a instanceof gpf.Error.InvalidRequireConfigureOption)})}),describe("gpf.require.define",function(){function a(a){assert("object"==typeof a),assert("value"===a.member)}function b(b,c,d){assert("object"==typeof b),assert(c===b.type),d&&a(b.data)}describe("Asynchronous loading",function(){beforeEach(function(){gpf.require.configure({clearCache:!0})}),it("loads JSON file as an object",function(b){gpf.require.define({data:"data.json"},function(c){try{a(c.data),b()}catch(e_){b(e_)}})}),it("supports CommonJS format (static requires)",function(a){gpf.require.define({commonjs:"commonjs.js"},function(c){try{b(c.commonjs,"commonjs",!0),a()}catch(e_){a(e_)}})}),it("doesn't supports CommonJS format with static and dynamic requires",function(a){gpf.require.define({commonjs:"mixed_commonjs.js"}).then(function(){a(new Error("Should not happen"))},function(b){try{assert(b instanceof gpf.Error.NoCommonJSDynamicRequire),a()}catch(e_){a(e_)}})}),it("doesn't supports CommonJS format with only dynamic requires",function(a){gpf.require.define({commonjs:"dynamic_commonjs.js"}).then(function(){a(new Error("Should not happen"))},function(b){try{assert(b instanceof gpf.Error.NoCommonJSDynamicRequire),a()}catch(e_){a(e_)}})}),it("supports AMD format (named with factory)",function(a){gpf.require.define({amd:"amd.js"},function(c){try{b(c.amd,"amd",!0),a()}catch(e_){a(e_)}})}),it("supports AMD format (no name)",function(a){gpf.require.define({amd:"anonymous_amd.js"},function(c){try{b(c.amd,"amd",!1),assert(""===c.amd.name),a()}catch(e_){a(e_)}})}),it("supports AMD format (anonymous static)",function(a){gpf.require.define({amd:"static_amd.js"},function(c){try{b(c.amd,"amd",!1),assert("static"===c.amd.name),a()}catch(e_){a(e_)}})}),it("supports GPF modules (gpf is defined)",function(a){gpf.require.define({gpf:"gpf.js"},function(c){try{b(c.gpf,"gpf",!0),a()}catch(e_){a(e_)}})}),it("supports GPF modules without constant value",function(a){gpf.require.define({constants:"constants.js"},function(b){try{assert("World!"===b.constants.hello),a()}catch(e_){a(e_)}})}),it("supports JavaScript file (no result)",function(a){gpf.context().test={},gpf.require.define({js:"empty.js"},function(b){try{assert(void 0===b.js),assert(gpf.context().test.empty),a()}catch(e_){a(e_)}finally{delete gpf.context().test}})}),it("supports text file (no processor)",function(a){gpf.require.define({text:"../data/folder/hello world.txt"},function(b){try{assert("hello world\n"===b.text),a()}catch(e_){a(e_)}})})}),describe("Recursive loading",function(){beforeEach(function(){gpf.require.configure({clearCache:!0})}),it("loads everything recursively",function(c){gpf.require.define({all:"folder/all.js"},function(d){try{b(d.all.amd,"amd",!0),b(d.all.commonjs,"commonjs",!0),a(d.all.data),b(d.all.gpf,"gpf",!0),c()}catch(e_){c(e_)}})})}),describe("Error handling",function(){it("fails if resource does not exist",function(a){gpf.require.define({notFound:"notFound.js"}).then(function(){a(new Error("Should not happen"))},function(b){try{assert(b instanceof Error),assert("Should not happen"!==b.message),a()}catch(e_){a(e_)}})}),it("fails if one javascript resource fails",function(a){gpf.require.define({error:"error.js"}).then(function(){a(new Error("Should not happen"))},function(b){try{assert(b instanceof Error),assert("FAIL!"===b.message),a()}catch(e_){a(e_)}})})})}),describe("caching",function(){beforeEach(function(){gpf.require.configure({clearCache:!0})}),describe("caching of loaded parts",function(){var a={};beforeEach(function(b){gpf.require.define({data:"data.json"},function(c){try{c.data.additional=a,b()}catch(e_){b(e_)}})}),it("keeps modified objects",function(b){gpf.require.define({data:"data.json"},function(c){try{assert(a===c.data.additional),b()}catch(e_){b(e_)}})})}),describe("cache injection",function(){var a={};beforeEach(function(){var b={};b[gpf.require.resolve("data.json")]=a,gpf.require.configure({clearCache:!0,cache:b})}),it("keeps injected objects",function(b){gpf.require.define({data:"data.json"},function(c){try{assert(a===c.data),b()}catch(e_){b(e_)}})})})})}),describe("stream/array",function(){function a(a,c){try{assert(b.length===a.length),b.forEach(function(b,c){assert(b===a[c])}),c()}catch(e_){c(e_)}}var b=["Hell","o ","World",null,{}];describe("gpf.stream.ReadableArray",function(){it("writes each array item sequentially",function(c){var d=new gpf.stream.ReadableArray(b),e=[];d.read({write:function(a){return e.push(a),Promise.resolve()}}).then(function(){a(e,c)},c)})}),describe("gpf.stream.WritableArray",function(){it("stores each call as an array item",function(c){function d(){b.length===f?a(e.toArray(),c):e.write(b[f++]).then(d,c)}var e=new gpf.stream.WritableArray,f=0;d()})})}),describe("stream/pipe",function(){function a(a){return a}function b(b){return a(b),Promise.reject("FAIL")}function c(b){throw a(b),new Error("FAIL")}function d(b){return a(b),Promise.reject("FAIL")}function e(b){throw a(b),new Error("FAIL")}function f(a,b){a.then(function(){throw new Error("Should fail")},function(a){assert("FAIL"===a),b()})["catch"](b)}function g(a,b){a.then(function(){throw new Error("Should fail")},function(a){assert("FAIL"===a.message),b()})["catch"](b)}function h(){function a(){b=void 0,c=void 0}var b,c;return{read:function(d){if(c)throw new Error("Already reading");return c=d,void 0!==b?c.write(b).then(a):Promise.resolve()},write:function(d){if(b)throw new Error("Buffer full");return b=d,c?c.write(d).then(a):Promise.resolve()}}}function i(a){var b=new gpf.stream.ReadableArray(["Hello ","World!","\n","Goodbye!"]),c=new gpf.stream.WritableArray;return gpf.stream.pipe.apply(gpf.stream,[b].concat(a,c)).then(function(){return c})}function j(a,b){i(a).then(function(a){var c=a.toArray();assert(2===c.length),assert("Hello World!"===c[0]),assert("Goodbye!"===c[1]),b()})["catch"](b)}describe("parameters validation",function(){function b(b){a(b)}function c(b){a(b)}it("fails if the first parameter is not an IReadableStream",function(){var a;try{gpf.stream.pipe({})}catch(e_){a=e_}assert(a instanceof gpf.Error.InterfaceExpected)}),it("fails if no destination",function(){var a;try{gpf.stream.pipe({read:b})}catch(e_){a=e_}assert(a instanceof gpf.Error.InterfaceExpected)}),describe("handling a sequence with more than two streams",function(){it("misses intermediate read",function(){var a;try{gpf.stream.pipe({read:b},{write:c},{write:c})}catch(e_){a=e_}assert(a instanceof gpf.Error.InterfaceExpected)}),it("misses intermediate write",function(){var a;try{gpf.stream.pipe({read:b},{read:b},{write:c})}catch(e_){a=e_}assert(a instanceof gpf.Error.InterfaceExpected)}),it("does not end with write",function(){var a;try{gpf.stream.pipe({read:b},{read:b,write:c},{})}catch(e_){a=e_}assert(a instanceof gpf.Error.InterfaceExpected)})})}),describe("IReadableStream -> IWritableStream",function(){it("Transfer data",function(a){var b=new gpf.stream.WritableString;gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),b).then(function(){assert("Hello World"===b.toString()),a()})["catch"](a)}),it("Triggers flush when the read ends",function(a){var b=new gpf.stream.WritableString,c=!1;b.flush=function(){return c=!0,Promise.resolve()},gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),b).then(function(){assert("Hello World"===b.toString()),assert(c),a()})["catch"](a)}),it("Forward errors (read - reject)",function(a){var c=new gpf.stream.WritableString,d={read:b};f(gpf.stream.pipe(d,c),a)}),it("Forward errors (read - exception)",function(a){var b=new gpf.stream.WritableString,d={read:c};g(gpf.stream.pipe(d,b),a)}),it("Forward errors (write - reject)",function(a){var b={write:d};f(gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),b),a)}),it("Forward errors (write - exception)",function(a){var b={write:e};g(gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),b),a)})}),describe("IReadableStream -> IReadableStream/IWritableStream* -> IWritableStream",function(){it("handles the whole stream",function(a){j([new gpf.stream.LineAdapter],a)}),it("handles non flushable intermediate stream",function(a){j([h(),new gpf.stream.LineAdapter],a)}),it("Forward errors (read - reject)",function(a){var c=h();c.read=b,f(i([c,new gpf.stream.LineAdapter]),a)}),it("Forward errors (read - exception)",function(a){var b=h();b.read=c,g(i([b,new gpf.stream.LineAdapter]),a)}),it("Forward errors (write - reject)",function(a){var b=h();b.write=d,f(i([b,new gpf.stream.LineAdapter]),a)}),it("Forward errors (write - exception)",function(a){var b=h();b.write=e,g(i([b,new gpf.stream.LineAdapter]),a)}),it("Forward errors (second read - reject)",function(a){var c=h(),d=h();d.read=b,f(i([c,d,new gpf.stream.LineAdapter]),a)}),it("Forward errors (second read - exception)",function(a){var b=h(),d=h();d.read=c,g(i([b,d,new gpf.stream.LineAdapter]),a)}),it("Forward errors (second write - reject)",function(a){var b=h(),c=h();c.write=d,f(i([b,c,new gpf.stream.LineAdapter]),a)}),it("Forward errors (second write - exception)",function(a){var b=h(),c=h();c.write=e,g(i([b,c,new gpf.stream.LineAdapter]),a)})})}),describe("stream/csv/parser",function(){describe("gpf.stream.csv.Parser",function(){function a(a){var b=new gpf.stream.ReadableArray(a.lines),c=new gpf.stream.WritableArray;return gpf.stream.pipe(b,a.parser,c).then(function(){return c.toArray()})}function b(b,c){a(b).then(function(a){assert(a.length===b.expected.length),a.forEach(function(a,c){var d=b.expected[c],e=Object.keys(a);assert(e.join(",")===Object.keys(d).join(",")),e.forEach(function(b){assert(a[b]===d[b])})}),c()})["catch"](c)}it("reads a one-column CSV file",function(a){b({lines:["LINE","0","1"],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0"},{LINE:"1"}]},a)}),it("reads a CSV file",function(a){b({lines:["LINE;VALUE","0;ABC","1;DEF"],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0",VALUE:"ABC"},{LINE:"1",VALUE:"DEF"}]},a)}),it("supports value quoting",function(a){b({lines:["LINE;VALUE",'0;"ABC"',"1;DEF",'2;GH"I','3;"JK""L"','4;"MN','O"'],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0",VALUE:"ABC"},{LINE:"1",VALUE:"DEF"},{LINE:"2",VALUE:'GH"I'},{LINE:"3",VALUE:'JK"L'},{LINE:"4",VALUE:"MN\nO"}]},a)}),it("supports quoting the separator as well",function(a){b({lines:["LINE;VALUE",'0;"A;BC"'],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0",VALUE:"A;BC"}]},a)}),it("supports header being specified as an option",function(a){b({lines:["0;ABC","1;DEF"],parser:new gpf.stream.csv.Parser({header:"LINE;VALUE"}),expected:[{LINE:"0",VALUE:"ABC"},{LINE:"1",VALUE:"DEF"}]},a)}),it("supports empty values",function(a){b({lines:["LINE;VALUE;VALUE2",";AB;CD","1;;EF","2;GH"],parser:new gpf.stream.csv.Parser,expected:[{LINE:"",VALUE:"AB",VALUE2:"CD"},{LINE:"1",VALUE:"",VALUE2:"EF"},{LINE:"2",VALUE:"GH"}]},a)}),it("detects unterminated quoted string",function(b){a({lines:["LINE;VALUE",'0;"A',"BC"],parser:new gpf.stream.csv.Parser}).then(function(){b(new Error("Should fail"))},function(a){assert(a instanceof gpf.Error.InvalidCSV),b()})["catch"](b)}),it("detects invalid quoted string",function(b){a({lines:["LINE;VALUE",'0;"A"BC"'],parser:new gpf.stream.csv.Parser}).then(function(){b(new Error("Should fail"))},function(a){assert(a instanceof gpf.Error.InvalidCSV),b()})["catch"](b)}),it("supports different separator, quote and new line specifiers",function(a){b({lines:["LINE\tVALUE\tVALUE2","0\t\t'A''B","\tC'"],parser:new gpf.stream.csv.Parser({separator:"\t",quote:"'",newLine:"\r\n"}),expected:[{LINE:"0",VALUE:"",VALUE2:"A'B\r\n\tC"}]},a)})})});