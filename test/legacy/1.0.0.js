!function(){"use strict";var safeFunc=Function,context=safeFunc("return this;")(),_includes={"isclass.es6":'"use strict";describe("isclass.es6",function(){class A{}describe("gpf.isclass",function(){it("recognizes ES6 classes",function(){assert(gpf.isClass(A))})})});',"define/class/abstract.es6":'"use strict";describe("define/class/abstract.es6",function(){describe("$abstract",function(){class A{get member(){return this._member}constructor(t){t&&(this._member=t)}}let t,e;before(function(){t=gpf.define({$class:"B",$extend:A,$abstract:!0});e=class extends t{}}),it("prevents instantiation of abstract class (B)",function(){!function(t){var e;try{var s=new t;throw new Error(s.toString())}catch(e_){e=e_}assert(e instanceof gpf.Error.AbstractClass)}(t)}),it("enables instantiation on subclass (C)",function(){const t=new e("defaultValue");assert("defaultValue"===t.member)})})});',"define/class/singleton.es6":'"use strict";describe("define/class/singleton.es6",function(){describe("$singleton",function(){describe("in a sub class",function(){class B{get uniqueObject(){return this._unique}constructor(){this._unique={}}}let e;before(function(){e=gpf.define({$class:"C",$extend:B,$singleton:!0})}),it("does not alter base class behavior",function(){var n=new B,s=new e,t=s.uniqueObject,i=new B,u=new e;assert(n!==i),assert(n.uniqueObject!==i.uniqueObject),assert(s===u),assert(t===u.uniqueObject)})})})});',"define.es6":'"use strict";describe("define.es6",function(){describe("gpf.define",function(){describe("Class definition",function(){describe("Implementation",function(){describe("Subclassing an ES6 class",function(){class A{constructor(t){this._a="A",this._value=t}a(){return this._a}value(){return this._value}}class B extends A{constructor(t){super(t),this._b="B"}b(){return this._b}}let t,e;before(function(){t=gpf.define({$class:"C",$extend:B,"constructor":function(t){this.$super(t)},a:function(){return this.$super()},c:function(){return this.a()+this.b()}}),e=new t(3475)}),it("handles instanceof",function(){assert(e instanceof A),assert(e instanceof B),assert(e instanceof t)}),it("calls the constructor function",function(){assert(3475===e.value())}),it("offers a way to call named base method",function(){assert("AB"===e.c())}),it("does not leak $super",function(){assert(void 0===e.$super)})})})})})});',"attributes.es6":'"use strict";describe("attributes.es6",function(){var t={$extend:"gpf.attributes.Attribute",_value:void 0,getValue:function(){return this._value},constructor:function(t){this._value=t}},e=gpf.define(Object.assign({$class:"MyAttribute1"},t)),s=gpf.define(Object.assign({$class:"MyAttribute2"},t)),a=gpf.define({$class:"MyClass",$attributes:[new e("A"),new e("B"),new s("C")],"[value]":[new e("D")],value:0});class MyNativeClass extends a{}describe("gpf.attributes.get",function(){describe("with native inheritance",function(){it("retrieves all attributes (on class)",function(){var t=gpf.attributes.get(MyNativeClass);assert(2===Object.keys(t).length),assert(3===t.$attributes.length),assert(1===t.value.length),assert("D"===t.value[0].getValue())}),it("retrieves all attributes (on instance)",function(){var t=new MyNativeClass,e=gpf.attributes.get(t);assert(2===Object.keys(e).length),assert(3===e.$attributes.length),assert(1===e.value.length),assert("D"===e.value[0].getValue())})})})});',"serial/raw/to.propertydescriptor":'"use strict";describe("serial/raw/to.propertydescriptor",function(){describe("gpf.serial.toRaw",function(){var e,t;function a(e){var t=gpf.serial.toRaw(e,function(t,a,r){return assert(this===e),"_id"===r?(assert("id"===a.name),assert(!0===a.readOnly),assert("123"===t),"ID"):"_name"===r?(assert("name"===a.name),assert(!1===a.readOnly),assert("Test"===t),"TEST"):"_created"===r?(assert("created"===a.name),void assert(!0===a.readOnly)):"_modified"===r?t.toISOString():void assert(!1)});assert(3===Object.keys(t).length),assert("ID"===t.id),assert("TEST"===t.name),assert("2018-09-19T12:50:12.000Z"===t.modified)}before(function(){e=gpf.define({$class:"A","[_id]":[new gpf.attributes.Serializable({required:!0})],_id:"","[_name]":[new gpf.attributes.Serializable],_name:"","[_created]":[new gpf.attributes.Serializable({type:gpf.serial.datetime})],_created:null,"[_modified]":[new gpf.attributes.Serializable({type:gpf.serial.datetime})],_modified:null,constructor:function(e,t,a){Object.defineProperty(this,"_id",{value:e,writable:!1}),this._name=t,this.__created=new Date,this._modified=a||null}}),Object.defineProperty(e.prototype,"_created",{configurable:!1,get:function(){return this.__created}}),t=gpf.define({$class:"B",$extend:e})}),it("converts properties\' value",function(){a(new e("123","Test",new Date(Date.UTC(2018,8,19,12,50,12,0))))}),it("converts properties\' value (sub class)",function(){a(new t("123","Test",new Date(Date.UTC(2018,8,19,12,50,12,0))))})})});',"serial/raw/from.propertydescriptor":'"use strict";describe("serial/raw/from.propertydescriptor",function(){describe("gpf.serial.fromRaw",function(){var e,t;function i(e){var t=e._created;gpf.serial.fromRaw(e,{id:"ID",name:void 0,created:"",modified:"2018-09-19T12:50:12.000Z"},function(t,i,r){return assert(this===e),"_id"===r?(assert("id"===i.name),void assert(!0===i.readOnly)):"_name"===r?(assert("name"===i.name),assert(!1===i.readOnly),assert(void 0===t),"Test"):"_created"===r?(assert("created"===i.name),void assert(!0===i.readOnly)):r.type===gpf.serial.datetime?(assert("_modified"===r),new Date(t)):void assert(!1)}),assert("123"===e._id),assert("Test"===e._name),assert(e._created===t),assert(2018===e._modified.getUTCFullYear()),assert(8===e._modified.getUTCMonth()),assert(19===e._modified.getUTCDate()),assert(12===e._modified.getUTCHours()),assert(50===e._modified.getUTCMinutes()),assert(12===e._modified.getUTCSeconds())}before(function(){e=gpf.define({$class:"A","[_id]":[new gpf.attributes.Serializable({required:!0})],_id:"","[_name]":[new gpf.attributes.Serializable],_name:"","[_created]":[new gpf.attributes.Serializable({type:gpf.serial.datetime})],_created:null,"[_modified]":[new gpf.attributes.Serializable({type:gpf.serial.datetime})],_modified:null,constructor:function(e,t,i){Object.defineProperty(this,"_id",{value:e,writable:!1}),this._name=t,this.__created=new Date,this._modified=i||null}}),Object.defineProperty(e.prototype,"_created",{configurable:!1,get:function(){return this.__created}}),t=gpf.define({$class:"B",$extend:e})}),it("converts properties\' value",function(){i(new e("123"))}),it("converts properties\' value (sub class)",function(){i(new t("123"))})})});',"attributes/decorator.es6":'"use strict";describe("attributes/decorator.es6",function(){before(function(){gpf.require.configure({base:config.testPath+"require"})}),describe("Defining attributes on an ES6 class using decorators",function(){var e,s,t;before(function(r){gpf.require.configure({clearCache:!0}),gpf.require.define({classes:"es6/class_with_attributes.js"},function(a){e=a.classes.Attribute,s=a.classes.Test,t=a.classes.SubclassOfTest,r()}).then(void 0,r)}),it("offers decorators to add attributes on class",function(){var t=gpf.attributes.get(s);assert(2===Object.keys(t).length),assert(1===t.id.length),assert(t.id[0]instanceof e),assert(1===t.id[0].value),assert(1===t.reset.length),assert(t.reset[0]instanceof e),assert(2===t.reset[0].value)}),it("works on sub classes",function(){var s=gpf.attributes.get(t);assert(2===Object.keys(s).length),assert(1===s.id.length),assert(2===s.reset.length);var r=0;s.reset.forEach(function(s){assert(s instanceof e),assert(2===s.value||3===s.value),r+=s.value}),assert(5===r)})})});'};context.include=function(source){eval(_includes[source])}}();"use strict";describe("console",function(){if(gpf.internals){var n=gpf.internals._gpfConsoleGenerate;describe("_gpfConsoleGenerate",function(){it("generates an object mocking the console",function(){var e=n();assert("function"==typeof e.log),assert("function"==typeof e.info),assert("function"==typeof e.warn),assert("function"==typeof e.error)}),it("generates a log function prefixing text with padding",function(){var t="";n(function(e){t=e}).log("test"),assert("    test"===t)}),it("generates an info function prefixing text with [?]",function(){var t="";n(function(e){t=e}).info("test"),assert("[?] test"===t)}),it("generates a warn function prefixing text with /!\\",function(){var t="";n(function(e){t=e}).warn("test"),assert("/!\\ test"===t)}),it("generates an error function prefixing text with (X)",function(){var t="";n(function(e){t=e}).error("test"),assert("(X) test"===t)})})}}),describe("arraylike",function(){describe("gpf.isArrayLike",function(){it("checks if an object looks like an array",function(){assert(!0===gpf.isArrayLike([]))}),it("recognizes a simulated array",function(){assert(!0===gpf.isArrayLike({length:2,0:0,1:1}))}),it("recognizes a simulated empty array",function(){assert(!0===gpf.isArrayLike({length:0}))}),it("recognizes a simulated incomplete array",function(){assert(!0===gpf.isArrayLike({length:2,1:1}))}),it("recognizes a simulated non empty array with no items",function(){assert(!0===gpf.isArrayLike({length:2}))}),it("accepts a string as an array like",function(){assert(!0===gpf.isArrayLike("abc"))}),[null,undefined,0,1,!1,!0,{},new Date].forEach(function(e){it("rejects any non fitting value ("+JSON.stringify(e)+")",function(){assert(!1===gpf.isArrayLike(e))})}),it("rejects a simulated array with an invalid length property",function(){assert(!1===gpf.isArrayLike({length:2.5,0:0,1:1}))})})}),describe("foreach",function(){var e="Hello World!",i=[0,1,2,3,4,5,6,7,8,9],a={"number":1,"string":e,"null":null,"object":{member:"value"},"function":function(){return e}};describe("gpf.forEach",function(){it("enumerates array content",function(){var r=0,s=0;gpf.forEach(i,function(e,t,n){assert("number"==typeof t),assert(n===i),++r,s+=e}),assert(i.length===r),assert(45===s)}),it("transmits scope on array content",function(){var e,r=0,s=0;e=gpf.forEach(i,function(e,t,n){assert(this===a),assert("number"==typeof t),assert(n===i),++r,s+=e},a),assert(undefined===e),assert(i.length===r),assert(45===s)}),it("enumerates object content and handles null value",function(){var r=[],s=!0;gpf.forEach(a,function(e,t,n){assert("string"==typeof t),assert(n===a),r.push(t),"null"===t&&null!==e&&(s=!1)}),r=r.join(","),assert("number,string,null,object,function"===r),assert(!0===s)}),it("transmits scope on object content",function(){var e=gpf.forEach(a,function(){assert(this===a)},a);assert(undefined===e)}),it("does not skip undefined values",function(){var e=new Array(3),t=0;gpf.forEach(e,function(e){assert(undefined===e),++t}),assert(3===t)}),it("does not enumerate inherited values",function(){var e=Object.create({inherited:1});e.own=2,gpf.forEach(e,function(e,t){assert(2===e),assert("own"===t)})})}),gpf.internals&&describe("(internal)",function(){describe("_gpfObjectForEach",function(){var e=gpf.internals._gpfObjectForEach;it("enumerates object keys and values",function(){var r=0;e(a,function(e,t,n){++r,assert(n===a),assert(e===a[t])}),assert(5===r)})}),describe("_gpfArrayForEachFalsy",function(){var t=gpf.internals._gpfArrayForEachFalsy;it("enumerates all values if no truthy result",function(){var r=0,e=t(i,function(e,t,n){++r,assert(n===i),assert(e===i[t])});assert(e===undefined),assert(r===i.length)}),it("stops on first truthy value and return it",function(){var r=0,s={},e=t(i,function(e,t,n){if(4===e)return s;++r,assert(n===i),assert(e===i[t])});assert(e===s),assert(4===r)})})})}),describe("assert",function(){describe("gpf.assert",function(){it("does not accept no message",function(){var e;try{console.expects&&console.expects("warn",/.*/),gpf.assert(!0)}catch(e_){e=e_}assert(e instanceof gpf.Error.AssertionFailed)}),[!0,42,"Hello World!",{}].forEach(function(e){it("does nothing on a truthy condition - "+typeof e+" ("+e.toString()+")",function(){gpf.assert(e,"It works")})}),[!1,0,"",undefined,null].forEach(function(n){var e;e=undefined===n?"undefined":null===n?"null":n.toString(),it("throws an exception on a falsy condition - "+typeof n+" ("+e+")",function(){var e;try{console.expects&&console.expects("warn",/.*/),gpf.assert(n,"It fails")}catch(e_){e=e_}assert(e instanceof gpf.Error.AssertionFailed)})})}),describe("gpf.asserts",function(){it("works with a message / boolean dictionary",function(){gpf.asserts({"It works":!0,"It also works":!0})}),it("fails on first falsy",function(){var e;try{console.expects&&console.expects("warn",/.*/),gpf.asserts({"It works":!0,"It fails":!1})}catch(e_){e=e_}assert(e instanceof gpf.Error.AssertionFailed)})}),describe("gpf.preventAssertWarnings",function(){it("prevents assertion warnings",function(){var e;gpf.preventAssertWarnings(!0);try{gpf.assert(!1,"It fails")}catch(e_){e=e_}assert(e instanceof gpf.Error.AssertionFailed),gpf.preventAssertWarnings(!1)})})}),describe("constants",function(){describe("gpf",function(){it("does not expose any 'private' member",function(){!function s(e,t){var n,r;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&(assert("_"!==n.charAt(0)),"object"==typeof(r=e[n])&&-1===t.indexOf(r)&&(t.push(r),s(r,t)))}(gpf,[gpf,gpf.internals])}),it("should expose a version",function(){assert("function"==typeof gpf.version),assert("string"==typeof gpf.version());var e=gpf.version();assert(-1!==e.indexOf(".")),assert(null!==e.match(/[0-9]+\.[0-9]+d?/))}),it("should expose the host type",function(){assert("function"==typeof gpf.host),assert("string"==typeof gpf.host());var e=gpf.host();assert(-1!==[gpf.hosts.browser,gpf.hosts.nashorn,gpf.hosts.nodejs,gpf.hosts.phantomjs,gpf.hosts.rhino,gpf.hosts.unknown,gpf.hosts.wscript].indexOf(e))}),describe("gpf.hosts enumeration",function(){["browser","nodejs","phantomjs","unknown","wscript"].forEach(function(e){it("declares gpf.hosts."+e,function(){assert(undefined!==gpf.hosts[e])})})})}),gpf.internals&&(describe("(internal) _gpfIsUnsignedByte",function(){var r=gpf.internals._gpfIsUnsignedByte;gpf.forEach({0:!0,"-25":!1,128:!0,256:!1,255:!0},function(e,t){var n=parseInt(t,10);e?it("accepts "+t,function(){assert(!0===r(n))}):it("rejects "+t,function(){assert(!1===r(n))})})}),describe("(internal) _gpfFuncImpl",function(){var n=gpf.internals._gpfFuncImpl;it("fails if function can't be generated",function(){var e;try{n([],"{")}catch(e_){e=e_}assert(e)})}))}),describe("string/capitalize",function(){gpf.internals&&describe("(internal) _gpfStringCapitalize",function(){var e=gpf.internals._gpfStringCapitalize;it("does nothing on empty string",function(){assert(""===e(""))}),it("uppercases the first letter",function(){assert("Word"===e("word")),assert("Two words"===e("two words")),assert("Two words"===e("Two words"))}),it("also handles accents",function(){assert("\xc9ric"===e("\xe9ric"))})})}),describe("string/replaceex",function(){gpf.internals&&describe("(internal) _gpfStringReplaceEx",function(){var e=gpf.internals._gpfStringReplaceEx;it("replaces strings recursively",function(){assert("add"===e("abc",{"a":"abc","b":"dc","c":""}))})})}),describe("string/escapefor",function(){gpf.internals&&describe("(internal) _gpfStringEscapeFor",function(){var e=gpf.internals._gpfStringEscapeFor;it("escapes for JavaScript",function(){assert('"abc\\r\\ndef"'===e("abc\r\ndef","javascript"))}),it("escapes for xml",function(){assert("&lt;a&amp;b&gt;"===e("<a&b>","xml"))}),it("escapes for html",function(){assert("&lt;a&amp;b:&eacute;&egrave;&ecirc;&aacute;&agrave;&gt;"===e("<a&b:\xe9\xe8\xea\xe1\xe0>","html"))})})}),describe("compatibility",function(){function e(e){var t=new Array(5);t[2]=undefined,t[3]=3,e.call(t,function(e,t){assert(2===t||3===t),2===t?assert(undefined===e):assert(3===e)})}var r={Array:{every:{length:1,"must return true when it goes over all items":function(e){var t,n=0;t=e.call([1,2,3,-6,10],function(e){return n+=e,!0}),assert(!0===t),assert(10===n)},"must return false when it stops on a given item":function(e){var t,n=0;t=e.call([1,2,3,-6,10],function(e){return 0<e&&(n+=e,!0)}),assert(!1===t),assert(6===n)},"must iterate with a bound context":function(e){var t,n={sum:0,index:0};t=e.call([1,2,3,-6,10],function(e,t){return assert(this===n),this.index=t,0<e&&(this.sum+=e,!0)},n),assert(!1===t),assert(6===n.sum),assert(3===n.index)},"must ignore undefined members":e},filter:{length:1,"must filter":function(e){var t;t=e.call([1,2,3,4,5],function(e){return e%2==0}),assert(2===t.length),assert(2===t[0]),assert(4===t[1])},"must filter with a bound context":function(e){var t,n={};t=e.call([1,2,3,4,5],function(e){return assert(this===n),e%2==0},n),assert(2===t.length),assert(2===t[0]),assert(4===t[1])},"must ignore undefined members":e},forEach:{length:1,"must iterate":function(e){var t=[1,2,3],n=0;assert("function"==typeof t.forEach),assert(!Object.prototype.hasOwnProperty.call(t,"forEach")),e.call(t,function(e){n+=e}),assert(6===n)},"must iterate with a bound context":function(e){var t={sum:0};e.call([1,2,3],function(e){this.sum+=e},t),assert(6===t.sum)},"must ignore undefined members":e},includes:{length:1,"indicates if the parameter is in the array":function(e){var t={},n=[1,2,3,t,"abc"];assert(e.call(n,t))},"indicates if the parameter is not in the array":function(e){assert(!e.call([1,2,3,"abc"],{}))},"supports fromIndex parameter":function(e){var t=[1,2,3,"abc"];assert(e.call(t,3,2)),assert(!e.call(t,3,3))}},indexOf:{length:1,"must expose indexOf()":function(e){var t={},n=[1,2,3,t,"abc"];assert(-1===e.call(n,4)),assert(0===e.call(n,1)),assert(3===e.call(n,t)),assert(-1===e.call(n,{})),assert(4===e.call(n,"abc"))},"supports fromIndex parameter":function(e){var t=[1,2,3,"abc"];assert(2===e.call(t,3,2)),assert(-1===e.call(t,3,3))}},map:{length:1,"must map with a bound context":function(e){var t,n={},r=[1,2,3,n,"abc"];assert("function"==typeof r.map),assert(!Object.prototype.hasOwnProperty.call(r,"map")),t=e.call(r,function(e,t){return assert(this===n),assert(e===r[t]),t},n),assert(t.length===r.length),assert(0===t[0]),assert(4===t[4])},"must ignore undefined members":e},reduce:{length:1,"must reduce with no initial value":function(e){var s=[0,1,2,3,4],i=1;assert(10===e.call(s,function a(e,t,n,r){return assert(s===r),assert(i===n),++i,e+t}))},"must reduce with intial value":function(e){var s=[0,1,2,3,4],i=0;assert(20===e.call(s,function a(e,t,n,r){return assert(s===r),assert(i===n),++i,e+t},10))}},some:{length:1,"returns false when all members return false":function(e){assert(!1===e.call([2,5,8,1,4],function(e){return 10<e}))},"returns true when at least one member returns true":function(e){assert(!0===e.call([12,5,8,1,4],function(e){return 10<e}))}},from:{isStatic:!0,length:1,"works on arguments":function(e){var t=function n(){return e.call(Array,arguments)}(1,2,3);assert(t instanceof Array),assert(3===t.length),assert(1===t[0]),assert(2===t[1]),assert(3===t[2])},"works on strings":function(e){var t=e.call(Array,"foo");assert(t instanceof Array),assert(3===t.length),assert("f"===t[0]),assert("o"===t[1]),assert("o"===t[2])},"supports callback mapping":function(e){var t=e.call(Array,[1,2,3],function(e){return e+e});assert(t instanceof Array),assert(3===t.length),assert(2===t[0]),assert(4===t[1]),assert(6===t[2])},"generates a sequence of numbers":function(e){var t=e.call(Array,{length:3},function(e,t){return t});assert(t instanceof Array),assert(3===t.length),assert(0===t[0]),assert(1===t[1]),assert(2===t[2])}},isArray:{isStatic:!0,length:1,"detects an array":function(e){assert(!0===e.call(Array,[]))},"rejects other objects":function(e){assert(!1===e.call(Array,{length:0}))}}},Function:{bind:{length:1,"must bind to a context":function(e){var t,n={member:null};(t=e.call(function r(e){assert(this===n),this.member=e},n))(!0),assert(!0===n.member),t.call({},!1),assert(!1===n.member)},"must return the same result":function(e){var t=e.call(function n(e){return e},{});assert(!1===t(!1)),assert(!0===t(!0))},"must preserve function signature":function(e){function t(e,t,n){return e+t+n}assert(3===t.length);var n=e.call(t,{});assert(3===n.length)},"must allow additional parameters binding":function(e){function t(e,t,n){return e+t+n}assert(3===t.length);var n=e.call(t,{},1);assert(2===n.length),assert(6===n(2,3))}}},Object:{assign:{isStatic:!0,length:2,"extends objects members":function(e){var t={"member1":"member1","member2":2},n={"newMember":!0},r=e.call(Object,t,n);assert(r===t),assert("member1"===r.member1),assert(2===r.member2),assert(!0===r.newMember),assert(!0===n.newMember)},"overwrites existing members":function(e){var t=e.call(Object,{"member1":"member1"},{"member1":!1});assert(!1===t.member1)},"supports more than one source parameter":function(e){var t=e.call(Object,{"member1":"member1","member2":2},{"source1":1,"member1":"member1.1"},{"source2":2,"member1":"member1.2"});assert("member1.2"===t.member1),assert(2===t.member2),assert(1===t.source1),assert(2===t.source2)}},create:{isStatic:!0,length:-1,"allows creating objects with a given prototype":function(e){var t=e.call(Object,{method:function(){return"myMethod"}});assert(!Object.prototype.hasOwnProperty.call(t,"method")),assert("function"==typeof t.method),assert("myMethod"===t.method())},"is compatible with instanceof":function(e){function t(){}t.prototype={a:function(){return"a"}};var n=e.call(Object,t.prototype);assert("a"===n.a()),assert(n instanceof t)},"allows inheritance and use of instanceof":function(e){function t(){}function n(){}t.prototype={a:function(){return"a"}},n.prototype=new t;var r=e.call(Object,n.prototype);assert("a"===r.a()),assert(r instanceof t),assert(r instanceof n)}},getPrototypeOf:{isStatic:!0,length:1,"returns prototype passed to Object.create":function(e){var t,n;t={a:function(){return"a"}},n=Object.create(t),assert(e.call(Object,n)===t)},"returns prototype from constructor":function(e){function t(){}t.prototype={constructor:t,a:function(){return"a"}};var n=new t;assert(e.call(Object,n)===t.prototype)},"works with standard objects (Array)":function(e){var t=e.call(Object,Array.prototype);assert(t.constructor===Object)},"works with standard objects (Date)":function(e){var t=e.call(Object,Date.prototype);assert(t.constructor===Object)},"works with standard objects (Error)":function(e){var t=e.call(Object,Error.prototype);assert(t.constructor===Object)},"works with standard objects (Function)":function(e){var t=e.call(Object,Function.prototype);assert(t.constructor===Object)},"works with standard objects (Number)":function(e){var t=e.call(Object,Number.prototype);assert(t.constructor===Object)},"works with standard objects (RegExp)":function(e){var t=e.call(Object,RegExp.prototype);assert(t.constructor===Object)},"works with standard objects (String)":function(e){var t=e.call(Object,String.prototype);assert(t.constructor===Object)}},keys:{isStatic:!0,length:1,"returns list of indexes of an array":function(e){var t=e.call(Object,["a","b","c"]);assert(3===t.length),assert("0"===t[0]),assert("1"===t[1]),assert("2"===t[2])},"returns list of indexes of an array-like object":function(e){var t=e.call(Object,{0:"a",1:"b",2:"c"});assert(3===t.length),assert(-1<t.indexOf("0")),assert(-1<t.indexOf("1")),assert(-1<t.indexOf("2"))},"returns list of indexes of an array like object with random key ordering":function(e){var t=e.call(Object,{100:"a",2:"b",7:"c"});assert(3===t.length),assert(-1<t.indexOf("2")),assert(-1<t.indexOf("7")),assert(-1<t.indexOf("100"))},"returns list of own keys of an object":function(e){function t(){}t.prototype={a:0,b:1};var n,r=new t;r.c=2,n=e.call(Object,r),assert(1===n.length),assert("c"===n[0])}},values:{isStatic:!0,length:1,"returns list of values of an object":function(e){var t=e.call(Object,{foo:"bar",baz:42});assert(2===t.length),assert(-1<t.indexOf("bar")),assert(-1<t.indexOf(42))},"returns list of values of an array-like object":function(e){var t=e.call(Object,{0:"a",1:"b",2:"c"});assert(3===t.length),assert(-1<t.indexOf("a")),assert(-1<t.indexOf("b")),assert(-1<t.indexOf("c"))},"returns list of values of an array like object with random key ordering":function(e){var t=e.call(Object,{100:"a",2:"b",7:"c"});assert(3===t.length),assert(-1<t.indexOf("a")),assert(-1<t.indexOf("b")),assert(-1<t.indexOf("c"))},"returns list of own values of an object":function(e){function t(){}t.prototype={a:0,b:1};var n,r=new t;r.c=2,n=e.call(Object,r),assert(1===n.length),assert(2===n[0])}}},String:{endsWith:{length:1,"must return true if string ends by the provided one":function(e){assert(e.call("To be, or not to be, that is the question.","question."))},"must return false if string does not end by the provided one":function(e){assert(!e.call("To be, or not to be, that is the question.","to be"))},"accepts a length parameter to fix input string size":function(e){assert(e.call("To be, or not to be, that is the question.","to be",19))}},includes:{length:1,"must return true if string includes the provided one":function(e){assert(e.call("To be, or not to be, that is the question.","or not to be"))},"must return false if string does not include the provided one":function(e){assert(!e.call("To be, or not to be, that is the question.","not be"))},"accepts a position parameter":function(e){assert(!e.call("To be, or not to be, that is the question.","To be",14))}},padEnd:{length:1,"must not change the value if long enough":function(e){assert("12"===e.call("12",2,"0"))},"must not change the value if longer":function(e){assert("123"===e.call("123",2,"0"))},"must pad the value when shorter":function(e){assert("10"===e.call("1",2,"0"))},"must pad the value when empty":function(e){assert("00"===e.call("",2,"0"))},"must pad the value with a default character":function(e){assert("1 "===e.call("1",2))}},padStart:{length:1,"must not change the value if long enough":function(e){assert("12"===e.call("12",2,"0"))},"must not change the value if longer":function(e){assert("123"===e.call("123",2,"0"))},"must pad the value when shorter":function(e){assert("01"===e.call("1",2,"0"))},"must pad the value when empty":function(e){assert("00"===e.call("",2,"0"))},"must pad the value with a default character":function(e){assert(" 1"===e.call("1",2))}},startsWith:{length:1,"must return true if string starts by the provided one":function(e){assert(e.call("To be, or not to be, that is the question.","To be"))},"must return false if string does not start by the provided one":function(e){assert(!e.call("To be, or not to be, that is the question.","question."))},"accepts a position parameter":function(e){assert(e.call("To be, or not to be, that is the question.","to be",14))}},trim:{length:0,"must trim left and right":function(e){assert("abc"===e.call(" \t  abc\t \t"))}}},Date:{toISOString:{length:0,"converts to UTC string":function(e){var t=new Date("2003-01-22T22:45:00.000Z");assert("2003-01-22T22:45:00.000Z"===e.call(t))}},now:{isStatic:!0,length:0,"Gives current time":function(e){var t=(new Date).getTime(),n=e.call(Date);assert("number"==typeof n),assert(t<=n)}}}},o={Array:Array,Function:Function,Object:Object,String:String,Date:Date};function c(e){var t,n,r,s=e.sample,i=e.testMethod,a=e.label,o=e.methodName,c=s[o];it(a,function(){i(c)}),gpf.internals&&(t=gpf.internals._gpfCompatibility[e.type],(n=e.isStatic?t.statics:t.methods)&&(r=n[o]),r&&r!==c&&it(a+" (compatible)",function(){i(r)}))}function s(r,i,a){return function(){var e,t,n=o[r];for(t in function s(e,t,n){var r="must expose the method "+t;e instanceof Function?it(r,function(){assert("function"==typeof e[t])}):it(r+" through prototype",function(){assert("function"==typeof e[t]),assert(!Object.prototype.hasOwnProperty.call(e,t))}),-1!==n&&it(r+" with an expected arity of "+n,function(){assert(e[t].length===n)})}(e=!0===a.isStatic?n:new n,i,a.length),a)Object.prototype.hasOwnProperty.call(a,t)&&"function"==typeof a[t]&&c({type:r,sample:e,methodName:i,isStatic:a.isStatic,label:t,testMethod:a[t]})}}function t(e){var t,n=r[e];for(t in n)Object.prototype.hasOwnProperty.call(n,t)&&describe(t,s(e,t,n[t]))}describe("Array",function(){describe("default support",function(){it("must allow building an array with a given size",function(){var e,t=new Array(5);for(assert(5===t.length),e=0;e<5;++e)assert(undefined===t[e]);assert("    "===t.join(" "))}),it("provides standard slice",function(){var e=["Banana","Orange","Lemon","Apple","Mango"].slice(1,3);assert(2===e.length),assert("Orange"===e[0]),assert("Lemon"===e[1])})}),t("Array")}),describe("Function",function(){describe("default support",function(){it("allows creating function with parameters",function(){var e=Function("value","return value;");assert(1===e.length),assert(123===e(123))}),it("must detect undefined parameter",function(){function e(e){assert(arguments.length===e)}e(1),e(2,"abc"),e(2,undefined),e(3,undefined,undefined)})}),t("Function")}),describe("Object",function(){t("Object")}),describe("String",function(){t("String")}),describe("Date",function(){describe("constructor",function(){it("accepts UTC string",function(){var e=new Date("2003-01-22T22:45:00.000Z");assert(2003===e.getUTCFullYear()),assert(0===e.getUTCMonth()),assert(22===e.getUTCDate()),assert(22===e.getUTCHours()),assert(45===e.getUTCMinutes()),assert(0===e.getUTCSeconds())}),it("accepts a date only",function(){var e=new Date("2003-01-22");assert(2003===e.getUTCFullYear()),assert(0===e.getUTCMonth()),assert(22===e.getUTCDate()),assert(0===e.getUTCHours()),assert(0===e.getUTCMinutes()),assert(0===e.getUTCSeconds())})}),t("Date"),gpf.internals&&(describe("(internal) _gpfIsISO8601String",function(){var r=gpf.internals._gpfIsISO8601String,e={"2016-02-17T23:13:00.000Z":[2016,1,17,23,13,0,0],"2003-01-22T22:45:34.075Z":[2003,0,22,22,45,34,75],"2003-13-22T22:45:34.075Z":null,"2003-1-22T22:45:34.075Z":null,"2003-01-32T22:45:34.075Z":null,"2003-01-2T22:45:34.075Z":null,"2003-01-22T25:45:34.075Z":null,"2003-01-22T22:60:34.075Z":null,"2003-01-22T22:45:60.075Z":null,"2003-01-22T22:45:34":[2003,0,22,22,45,34,0],"2003-01-22 22:45:34":null,"2003-01-22T22:45:34.075":null,"2016-02-17":[2016,1,17,0,0,0,0],"2003-13-22":null,"2003-01-32":null};function t(e,t){var n;n=t?"accepts":"rejects",n+=' "'+e+'"',it(n,function(){var n=r(e);t?(assert(n),assert(n.length===t.length),t.forEach(function(e,t){assert(n[t]===e)})):assert(!n)})}for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n]);[!0,!1,0,1,{},new Date].forEach(function(e){it("rejects other formats - "+typeof e+" ("+e.toString()+")",function(){assert(undefined===r(e))})})}),describe("(internal) _GpfDate()",function(){var t=gpf.internals._GpfDate;it("allocates a Date object",function(){var e=new t;assert(e instanceof Date)}),it("detects and leverage ISO 8601 format",function(){var e=new t("2003-01-22T22:45:34.075Z");assert(2003===e.getUTCFullYear()),assert(0===e.getUTCMonth()),assert(22===e.getUTCDate()),assert(22===e.getUTCHours()),assert(45===e.getUTCMinutes()),assert(34===e.getUTCSeconds()),assert(75===e.getUTCMilliseconds())}),it("detects and leverage ISO 8601 short format",function(){var e=new t("2003-01-22");assert(2003===e.getUTCFullYear()),assert(0===e.getUTCMonth()),assert(22===e.getUTCDate()),assert(0===e.getUTCHours()),assert(0===e.getUTCMinutes()),assert(0===e.getUTCSeconds()),assert(0===e.getUTCMilliseconds())})}))})}),describe("compatibility/array",function(){}),describe("factory",function(){gpf.internals&&describe("_gpfNewApply",function(){var n=gpf.internals._gpfNewApply;it("calls any constructor",function(){function e(){this.value=42}var t=n(e,[]);assert(t instanceof e),assert(42===t.value)}),it("forwards parameters",function(){var e=n(Array,[42]);assert(e instanceof Array),assert(42===e.length)}),it("adapts to a very long list of parameters",function(){var e=n(Array,[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]);assert(e instanceof Array),assert(15===e.length)})})}),describe("compatibility/function",function(){}),describe("compatibility/object",function(){}),describe("compatibility/string",function(){}),describe("compatibility/date",function(){}),describe("compatibility/promise",function(){function e(i){describe("simple usage",function(){it("waits for synchronous fulfilment",function(t){new i(function(e){assert("function"==typeof e),e("ok")}).then(function(e){assert("ok"===e),t()})["catch"](function(e){t(e)})}),it("waits for asynchronous fulfilment",function(t){var n;new i(function(e){n=e}).then(function(e){assert("ok"===e),t()})["catch"](function(e){t(e)}),n("ok")}),it("waits for synchronous rejection (rejection handler)",function(t){var n=!1;new i(function(e,t){assert("function"==typeof t),t("ko")}).then(function(){n=!0},function(e){assert(!1===n),assert("ko"===e),t()})["catch"](function(e){t(e)})}),it("waits for asynchronous rejection (rejection handler)",function(t){var n,r=!1;new i(function(e,t){n=t}).then(function(){r=!0},function(e){assert(!1===r),assert("ko"===e),t()})["catch"](function(e){t(e)}),n("ko")}),it("waits for synchronous rejection (catch handler)",function(n){new i(function(e,t){t("ko")}).then(function(){assert(!1)})["catch"](function(e){try{assert("ko"===e),n()}catch(e_){n(e_)}})}),it("waits for asynchronous rejection (catch handler)",function(n){var r;new i(function(e,t){r=t}).then(function(){assert(!1)})["catch"](function(e){try{assert("ko"===e),n()}catch(e_){n(e_)}}),r("ko")}),it("rejects automatically on exception",function(t){new i(function(){throw new Error("ko")}).then(function(){assert(!1)},function(e){assert(e instanceof Error),assert("ko"===e.message),t()})["catch"](function(e){t(e)})}),it("catches exception from the fulfilment handler",function(n){new i(function(e){e("ok")}).then(function(e){throw assert("ok"===e),new Error("ko")})["catch"](function(e){try{assert(e instanceof Error),assert("ko"===e.message),n()}catch(e_){n(e_)}})}),it("catches exception from the rejection handler",function(n){new i(function(e,t){t("ko")}).then(function(){assert(!1)},function(e){throw assert("ko"===e),new Error("ko")})["catch"](function(e){try{assert(e instanceof Error),assert("ko"===e.message),n()}catch(e_){n(e_)}})})}),describe("shortcuts",function(){it("offers Promise.resolve",function(t){i.resolve("ok").then(function(e){assert("ok"===e),t()},function(){assert(!1)})["catch"](function(e){t(e)})}),it("offers Promise.reject",function(t){i.reject("ko").then(function(){assert(!1)},function(e){assert("ko"===e),t()})["catch"](function(e){t(e)})})}),describe("chaining",function(){it("chains by passing results from one handler to the other",function(t){new i(function(e){e("ok 1")}).then(function(e){return assert("ok 1"===e),"ok 2"}).then(undefined,function(e){t(e)}).then(function(e){return assert("ok 2"===e),"ok 3"}).then(function(e){return assert("ok 3"===e),"ok 4"}).then(function(e){assert("ok 4"===e),t()})["catch"](function(e){t(e)})}),it("chains by returning a promise in the fulfilment handler",function(t){new i(function(e){e("ok 1")}).then(function(e){return assert("ok 1"===e),i.resolve("ok 2")}).then(function(e){return assert("ok 2"===e),new i(function(e){e("ok 3")})}).then(function(e){assert("ok 3"===e),t()})["catch"](function(e){t(e)})}),it("stops on first error",function(n){new i(function(e){e("ok 1")}).then(function(e){return assert("ok 1"===e),"ok 2"}).then(function(e){throw assert("ok 2"===e),new Error("ko")}).then(function(){assert(!1)})["catch"](function(e){try{assert(e instanceof Error),assert("ko"===e.message),n()}catch(e_){n(e_)}})})}),describe("synchronisation",function(){describe("Promise.all",function(){it("succeeds with an empty array",function(t){i.all([]).then(function(e){assert(0===e.length),t()})["catch"](function(e){t(e)})}),it("works with one promise",function(t){i.all([i.resolve("ok")]).then(function(e){assert(1===e.length),assert("ok"===e[0]),t()})["catch"](function(e){t(e)})}),it("waits for all promises to be resolved",function(t){var e,n=[];for(e=0;e<10;++e)n.push(i.resolve(e));i.all(n).then(function(e){assert(45===e.reduce(function(e,t){return e+t})),t()})["catch"](function(e){t(e)})}),it("fails on the first error",function(n){var e,t,r=[];for(e=0;e<10;++e)r.push((t=e)%2==0?i.reject(t):i.resolve(t));i.all(r).then(function(){assert(!1)})["catch"](function(e){try{assert("number"==typeof e),assert(e<10),n()}catch(e_){n(e_)}})})}),describe("Promise.race",function(){it("waits for the first promise that is resolved",function(t){var e,n=[],r=[];function s(t){return new i(function(e){r.unshift(e.bind(null,t))})}for(e=0;e<10;++e)n.push(s(e));i.race(n).then(function(e){assert(9===e),r[9](),t()})["catch"](function(e){t(e)}),r[0](),r[1](),r[2]()}),it("waits for the first promise that is resolved or rejected",function(n){var e,t=[],r=[];function s(n){return new i(function(e,t){5===n?r.push(t.bind(null,n)):r.push(e.bind(null,n))})}for(e=0;e<10;++e)t.push(s(e));i.race(t).then(function(){assert(!1)})["catch"](function(e){try{assert("number"==typeof e),assert(5===e),r[9](),n()}catch(e_){n(e_)}}),r[5](),r[0](),r[1]()})})}),describe("branching",function(){it("supports different branches",function(t){var n={};n.promise=new i(function(e,t){n.resolve=e,n.reject=t});var e=n.promise.then(function(e){return e+1}).then(function(e){return e+2}).then(function(e){return e+3}),r=n.promise.then(function(e){return 2*e}).then(function(e){return 3*e});i.all([e,r]).then(function(e){assert(7===e[0]),assert(6===e[1]),t()})["catch"](function(e){t(e)}),n.resolve(1)})})}describe("Promise",function(){e(Promise)}),gpf.internals&&Promise!==gpf.internals._GpfPromise&&describe("(internal) _GpfPromise",function(){e(gpf.internals._GpfPromise)})}),describe("compatibility/timeout",function(){function e(a){var n,e,o;function r(){return(new Date).getTime()}function c(e){this._start=r(),this._delay=e,this._id=a.setTimeout(c.prototype.callback.bind(this),e),this._synchronous=!1}return n=config.timerResolution?config.timerResolution:1,o=(e=2*n)+2*n,c.list=[],c.allocate=function(e){var t=new c(e);return c.list.push(t),t},c.noError=function(){var e,t=c.list.length;for(e=0;e<t;++e)if(c.list[e].error())return!1;return!0},c.check=function(){assert(c.noError())},c.prototype={_start:0,_delay:0,_synchronous:!0,_id:0,_allowed:!1,_triggered:0,_error:null,_done:function(){},id:function(){return this._id},_isAllowed:function(){if(!this._allowed)throw new Error("Not allowed")},_isTriggered:function(){if(this._triggered)throw new Error("Already triggered")},_isSynchronous:function(){if(this._synchronous)throw new Error("Triggered too soon (synchronous should be false)")},callback:function(){try{this._isAllowed(),this._isTriggered(),this._triggered=r(),this._isSynchronous();var e=r()-this._start;if(e<this._delay&&this._delay-e>n)throw new Error("Triggered too soon ("+e+" does not respect the timeout delay of "+this._delay+")");this._done()}catch(e_){this._error=e_,this._done(e_)}},clear:function(){a.clearTimeout(this._id),delete this._allowed},clean:function(){this._triggered||this.clear();var e,t=c.list.length;for(e=0;e<t&&c.list[e]!==this;++e);c.list.splice(e,1)},error:function(){return this._error},allow:function(e){this._allowed=!0,this._done=e},triggered:function(){return this._triggered}},function(){var i;before(function(){c.list=[]}),beforeEach(function(){i=c.allocate(o),assert(1===c.list.length),c.check()}),it("allocates a timeout id",function(){assert(undefined!==i.id()),c.check()}),afterEach(function(){i.clean(),c.check()}),describe("clearing",function(){beforeEach(function(){i.clear(),c.check()}),it("removes the callback from the queue",function(){a.handleTimeout(),c.check()}),describe("again",function(){beforeEach(function(){i.clear(),c.check()}),it("does not fail",function(){a.handleTimeout(),c.check()})})}),describe("triggering",function(){beforeEach(function(e){i.allow(e),a.handleTimeout(),c.check()}),it("executes the callback from the queue",function(){assert(i.triggered),c.check()}),it("removes the callback from the queue",function(){a.handleTimeout(),c.check()})}),describe("sequencing with a second timeout",function(){var r;function s(t,n){var r=0;return function(e){e?t(e):n===++r&&t()}}beforeEach(function(){i.clean(),r=c.allocate(e),i=c.allocate(o),c.check()}),it("allocates a different timeout id",function(){assert(undefined!==r.id()),assert(r.id()!==i.id()),c.check()}),afterEach(function(){r.clean(),c.check()}),describe("clearing the second timeout",function(){beforeEach(function(){r.clear(),c.check()}),describe("triggering",function(){beforeEach(function(e){i.allow(e),a.handleTimeout(),c.check()}),it("executes the remaining callback from the queue",function(){assert(i.triggered()),c.check()}),it("removes all callbacks from the queue",function(){a.handleTimeout(),c.check()})})}),describe("creating and cleaning a third timeout",function(){it("prevents execution of the third",function(e){var t=c.allocate(10*o),n=s(e,2);t.clean(),i.allow(n),r.allow(n),a.handleTimeout(),c.check()})}),describe("triggering",function(){beforeEach(function(e){var t=s(e,2);i.allow(t),r.allow(t),a.handleTimeout(),c.check()}),it("executes the callbacks from the queue",function(){assert(i.triggered()),assert(r.triggered()),c.check()}),it("removed all callbacks from the queue",function(){a.handleTimeout(),c.check()})})})}}config.performance?it("is not relevant for performance testing",function(){assert(!0)}):(describe("exposed API",e({setTimeout:function(e,t){return setTimeout(e,t)},clearTimeout:function(e){clearTimeout(e)},handleTimeout:function(){}})),gpf.internals&&setTimeout!==gpf.internals._gpSetTimeoutPolyfill&&describe("(internal)",e({setTimeout:gpf.internals._gpSetTimeoutPolyfill,clearTimeout:gpf.internals._gpfClearTimeoutPolyfill,handleTimeout:gpf.internals._gpfHandleTimeout})))}),describe("compatibility/json",function(){var e=[{label:"empty object",obj:{},json:"{}"},{label:"simple string property",obj:{a:"123"},json:'{"a":"123"}'},{label:"simple number property",obj:{a:123},json:'{"a":123}'},{label:"simple boolean properties",obj:{a:!0,b:!1},json:'{"a":true,"b":false}'},{label:"mixed simple properties",obj:{a:"123",b:123,c:!0,d:{}},json:'{"a":"123","b":123,"c":true,"d":{}}'},{label:"function",obj:{a:123,b:function(){}},json:'{"a":123}',parse:!1},{label:"array",obj:{a:[1,2,3]},json:'{"a":[1,2,3]}'},{label:"null",obj:{a:null},json:'{"a":null}'}];function s(t,n){var e=typeof t;return e===typeof n&&("object"===e&&t&&n?Object.keys(t).every(function(e){return Object.prototype.hasOwnProperty.call(n,e)&&s(t[e],n[e])}):t===n)}function t(t){it("has the expected arity",function(){assert(3===t.length)});var n={"null":null,0:0,"false":!1,"true":!0,'"Hello World!"':"Hello World!",'"\\"string\\""':'"string"'};Object.keys(n).forEach(function(e){it("converts "+e,function(){assert(t(n[e])===e)})}),e.forEach(function(e){it("works on "+e.label,function(){assert(t(e.obj)===e.json)})}),it("filters out special values",function(){var e=t({x:undefined,y:Object});assert("{}"===e)}),it("uses the replacer function on object",function(){var e=t({hello:"World",code:0},function(e,t){return"string"==typeof t?undefined:t});assert('{"code":0}'===e)}),it("uses the replacer function on array",function(){var e=t(["Hello","World!"],function(e,t){return"0"===e.toString()?undefined:t});assert('[null,"World!"]'===e)}),it("uses the replacer whitelist",function(){var e=t({hello:"World",code:0},["hello"]);assert('{"hello":"World"}'===e)}),it("uses the space argument",function(){var e=t({a:2},null," ");assert('{\n "a": 2\n}'===e)}),it("uses the space argument (empty string)",function(){var e=t({a:2},null,"");assert('{"a":2}'===e)}),it("uses the space argument (tab)",function(){var e=t({a:2},null,"\t");assert('{\n\t"a": 2\n}'===e)}),it("uses the space argument (tab) on an array",function(){var e=t([1,2],null,"\t");assert("[\n\t1,\n\t2\n]"===e)}),it("uses the space argument (number < 10)",function(){var e=t({a:2},null,5);assert('{\n     "a": 2\n}'===e)}),it("uses the space argument (number > 10)",function(){var e=t({a:2},null,11);assert('{\n          "a": 2\n}'===e)})}function n(r){it("has the expected arity",function(){assert(2===r.length)}),e.forEach(function(t){!1!==t.parse&&it("works on "+t.label,function(){var e=r(t.json);assert(!0===s(e,t.obj))})}),it("supports reviver parameter - simple",function(){var e=r('{"a": 5, "b": "6"}',function(e,t){return"number"==typeof t?2*t:t});assert(!0===s(e,{a:10,b:"6"}))}),it("supports reviver parameter - traversing",function(){var n=[];r('{"1": 1, "2": 2, "3": {"4": 4, "5": {"6": 6}}}',function(e,t){return n.push(e.toString()),t}),assert(7===n.length),["1","2","4","6","5","3",""].forEach(function(e,t){assert(n[t]===e)})})}describe("JSON object",function(){it("exists",function(){assert("undefined"!=typeof JSON)})}),describe("JSON.stringify",function(){t(JSON.stringify)}),describe("JSON.parse",function(){n(JSON.parse.bind(JSON))}),gpf.internals&&describe("(internal)",function(){describe("_gpfJsonStringifyPolyfill",function(){t(gpf.internals._gpfJsonStringifyPolyfill)}),describe("_gpfJsonParsePolyfill",function(){n(gpf.internals._gpfJsonParsePolyfill)})})}),describe("compatibility/base64",function(){var r={"Hello":"SGVsbG8=","Hello ":"SGVsbG8g","Hello World !":"SGVsbG8gV29ybGQgIQ==","!@#$%?&*()":"IUAjJCU/JiooKQ=="};function e(e){return function(){describe("atob",function(){var n=e.atob;Object.keys(r).forEach(function(e){var t=r[e];it("turns "+JSON.stringify(t)+" into "+JSON.stringify(e),function(){assert(n(t)===e)})}),it("rejects strings with invalid characters",function(){var e;try{n("<")}catch(e_){e=e_}assert(e)})}),describe("btoa",function(){var n=e.btoa;Object.keys(r).forEach(function(e){var t=r[e];it("turns "+JSON.stringify(e)+" into "+JSON.stringify(t),function(){assert(n(e)===t)})}),it("rejects strings with non latin characters",function(){var e;try{n("\u2665")}catch(e_){e=e_}assert(e)})})}}describe("exposed API",e({atob:atob,btoa:btoa})),gpf.internals&&atob!==gpf.internals._gpfAtob&&describe("(internal)",e({atob:gpf.internals._gpfAtob,btoa:gpf.internals._gpfBtoa}))}),describe("context",function(){describe("gpf.context",function(){var t=Function;it("resolves the global context",function(){if(assert("function"==typeof gpf.context),assert(null!==gpf.context()),gpf.hosts.browser===gpf.host())assert(window===gpf.context());else if(gpf.hosts.nodejs===gpf.host()||gpf.hosts.phantomjs===gpf.host())assert(global===gpf.context());else{var e=t("return this;")();assert(e===gpf.context())}}),it("resolves gpf",function(){assert(gpf===gpf.context("gpf"))}),it("resolves any symbol",function(){assert(gpf.context===gpf.context("gpf.context"))}),it("returns undefined if not existing",function(){assert(undefined===gpf.context("gpf.not-existing"))}),it("returns undefined if not existing (deep dive)",function(){assert(undefined===gpf.context("gpf.not-existing.really-not"))})}),gpf.internals&&describe("_gpfContext",function(){var r=gpf.internals._gpfContext;it("can build a context",function(){var e=gpf.context(),t={};e.testContextJS=t;var n=r(["testContextJS","folder","name"],!0);assert(t.folder.name===n),delete e.testContextJS})})}),describe("function",function(){if(gpf.internals){var t=gpf.internals._gpfFunctionDescribe,n=gpf.internals._gpfFunctionBuild,r=gpf.internals._gpfExtractFunctionName;describe("_gpfFunctionDescribe",function(){it("describes a named function",function(){var e=t(function(e,t){return e+t});assert("test"===e.name),assert(2===e.parameters.length),assert("a"===e.parameters[0]),assert("b"===e.parameters[1]),assert(-1!==e.body.indexOf("return a + b;"))}),it("identifies an unnamed function",function(){var e=t(function(){return 0});assert(!e.name),assert(!e.parameters),assert(-1!==e.body.indexOf("return 0;"))}),it("identifies empty function",function(){var e=t(function(){});assert(undefined===e.body)}),it("filters out comments",function(){var e=t(function r(e,t,n){return e+t+n});assert("test2"===e.name),assert(3===e.parameters.length),assert("a"===e.parameters[0]),assert("b"===e.parameters[1]),assert("c"===e.parameters[2]),assert(-1===e.body.indexOf("comments are removed"))})}),describe("_gpfFunctionBuild",function(){it("builds an empty anonymous function",function(){var e=n({});assert("function"==typeof e),assert(""===r(e))}),it("builds a named function",function(){var e=n({name:"test"});assert("test"===r(e))}),it("builds a function with named parameters",function(){var e=n({parameters:["a","b","c"],body:"return a + b + c;"});assert(3===e.length),assert(6===e(1,2,3))}),it("builds a function with external context",function(){var e=n({body:"return a;"},{a:"Hello World!"});assert(0===e.length),assert("Hello World!"===e())})}),describe("_gpfExtractFunctionName",function(){it("gets function name",function(){assert("thisName"===r(function e(){}))}),it("supports empty name",function(){assert(""===r(function(){}))})})}}),describe("error",function(){describe("gpf.Error",function(){it("is used as an exception",function(){var e;try{gpf.Error.abstractMethod()}catch(e_){e=e_}assert(e instanceof Error),assert(e instanceof gpf.Error),assert(e instanceof gpf.Error.AbstractMethod),assert(e.constructor===gpf.Error.AbstractMethod)}),it("is documented",function(){var e;try{gpf.Error.abstractMethod()}catch(e_){e=e_}assert(e.code===gpf.Error.CODE_ABSTRACTMETHOD),assert(e.code===gpf.Error.abstractMethod.CODE),assert("abstractMethod"===e.name),assert("Abstract method"===e.message)}),it("can use substitution for message",function(){var e;try{gpf.Error.assertionFailed({message:"Test"})}catch(e_){e=e_}assert(e instanceof gpf.Error.AssertionFailed),assert(e.code===gpf.Error.CODE_ASSERTIONFAILED),assert(e.code===gpf.Error.assertionFailed.CODE),assert("assertionFailed"===e.name),assert("Assertion failed: Test"===e.message)})})}),describe("isclass",function(){describe("gpf.isclass",function(){[undefined,null,!1,!0,"","Hello World!",0,1,function(){}].forEach(function(e){it("fails on "+JSON.stringify(e),function(){assert(!gpf.isClass(e))})})})}),config.features.es6class&&include("isclass.es6"),describe("abstract",function(){if(gpf.internals){var r=gpf.internals._gpfCreateAbstractFunction;describe("_gpfCreateAbstractFunction",function(){it("generates a function with a given signature",function(){var e=r(3);assert(3===e.length)}),it("generates a function that throws the abstractMethod exception",function(){var e,t=r(0);try{t()}catch(e_){e=e_}assert(e instanceof gpf.Error.AbstractMethod)})})}}),describe("define/check",function(){gpf.internals&&describe("(internal) _GpfEntityDefinition",function(){var t=gpf.internals._GpfEntityDefinition,r=gpf.internals._gpfDefineBuildTypedEntity;it("must have an entity type",function(){var e;try{r({})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidEntityType)}),it("checks for a valid name",function(){var e;try{r({$type:"class"})}catch(e_){e=e_}assert(e instanceof gpf.Error.MissingEntityName)}),it("validates minimal requirement (type and name)",function(){r({$type:"class",$name:"Test"})}),it("rejects invalid properties",function(){var e;try{r({$type:"class",$name:"Test",$fail:!0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidEntity$Property)}),it("converts $class into _type and _name",function(){var e=r({$class:"Test"});assert(e instanceof t),assert("class"===e._type),assert("Test"===e._name)}),it("converts $class into _type, _name and _namespace (absolute)",function(){var e=r({$class:"gpf.test.Test"});assert("class"===e._type),assert("Test"===e._name),assert("gpf.test"===e._namespace)}),it("converts $class into _type, _name and _namespace (relative)",function(){var e=r({$class:"test.Test",$namespace:"gpf"});assert("class"===e._type),assert("Test"===e._name),assert("gpf.test"===e._namespace)}),it("prioritize $class over $name",function(){var e=r({$class:"Test",$name:"Any"});assert("class"===e._type),assert("Test"===e._name)}),it("validates namespace",function(){r({$class:"Test",$namespace:"lowerCamelCase.$accepted._also.numbers456"}),r({$class:"Test",$namespace:"simple"}),r({$class:"Test",$namespace:""})}),["endingPointIsNotOK.","startingNumberIsNotOK.4test","$isOKOnlyAtBeginning.test$","_isOKOnlyAtBeginning.test_","CapitalFirstLetterIsNotOK"].forEach(function(n){it("rejects invalid namespace ("+n+")",function(){var e;try{r({$class:"Test",$namespace:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidEntityNamespace)})})})}),describe("define/class/check",function(){gpf.internals&&describe("(internal) _GpfClassDefinition",function(){var t=gpf.internals._GpfClassDefinition,s=gpf.internals._gpfDefineBuildTypedEntity;it("is used for class definition",function(){var e=s({$class:"Test"});assert(e instanceof t)}),it("accepts a valid class definition",function(){s({$class:"Test",member:function(){}})}),["startingWithLowercaseLetterIsNotOK","The$signIsForbbidenIfNotAtTheBeginning","The_signIsForbbidenIfNotAtTheBeginning"].forEach(function(n){it("rejects invalid class name ("+n+")",function(){var e;try{s({$class:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassName)})}),["StartingWithUppercaseLetterIsNotOK","the$signIsForbbidenIfNotAtTheBeginning","the_signIsForbbidenIfNotAtTheBeginning","class"].forEach(function(r){it("rejects invalid property name ("+r+")",function(){var e,t={$class:"Test"};t[r]=!0;try{s(t)}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassProperty)})}),it("rejects invalid $extend",function(){var e;try{s({$class:"Test",$extend:12})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassExtend)}),it("accepts native $extend",function(){s({$class:"Test",$extend:String})}),it("accepts contextual $extend",function(){s({$class:"Test",$extend:"String"})})})}),describe("define/class/abstract",function(){gpf.internals&&describe("(internal) _GpfClassDefinition",function(){var r=gpf.internals._gpfDefineBuildTypedEntity;[undefined,!1,0,"",{},1,"Hello World!"].forEach(function(n){it("supports only $abstract = true ("+JSON.stringify(n)+")",function(){var e;try{r({$type:"class",$name:"Test",$abstract:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClass$AbstractSpecification)})})}),describe("$abstract",function(){var e,t,n;function r(e){var t;try{var n=new e;throw new Error(n.toString())}catch(e_){t=e_}assert(t instanceof gpf.Error.AbstractClass)}before(function(){e=gpf.define({$class:"A",$abstract:!0,_member:"defaultValue",getMember:function(){return this._member},"constructor":function(e){e&&(this._member=e)}}),t=gpf.define({$class:"B",$extend:e}),n=gpf.define({$class:"C",$extend:t,$abstract:!0})}),it("prevents instantiation of abstract class (A)",function(){r(e)}),it("enables instantiation on subclass (B)",function(){var e=new t;assert("defaultValue"===e.getMember())}),it("prevents instantiation of abstract class (C)",function(){r(n)})})}),config.features.es6class&&include("define/class/abstract.es6"),describe("define/class/singleton",function(){gpf.internals&&describe("(internal) _GpfClassDefinition",function(){var r=gpf.internals._gpfDefineBuildTypedEntity;[undefined,!1,0,"",{},1,"Hello World!"].forEach(function(n){it("supports only $singleton = true ("+JSON.stringify(n)+")",function(){var e;try{r({$type:"class",$name:"Test",$singleton:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClass$SingletonSpecification)})})}),describe("$singleton",function(){var r,e={_unique:null,getUniqueObject:function(){return this._unique},"constructor":function(){this._unique={}}};before(function(){r=gpf.define(Object.assign({$class:"A",$singleton:!0},e))}),it("allows only one instantation of the class",function(){var e=new r,t=e.getUniqueObject(),n=new r;assert(e===n),assert(t===n.getUniqueObject())}),describe("in a sub class",function(){var i,a;before(function(){i=gpf.define(Object.assign({$class:"B"},e)),a=gpf.define({$class:"C",$extend:i,$singleton:!0})}),it("does not alter base class behavior",function(){var e=new i,t=new a,n=t.getUniqueObject(),r=new i,s=new a;assert(e!==r),assert(e.getUniqueObject()!==r.getUniqueObject()),assert(t===s),assert(n===s.getUniqueObject())})})})}),config.features.es6class&&include("define/class/singleton.es6"),describe("define",function(){var s={};function e(s,i,t){Object.keys(t).filter(function(e){return!t[e]}).forEach(function(r){it("rejects invalid "+s+" name ("+r+")",function(){var e,t={};t["$"+s]=r;try{gpf.define(t)}catch(e_){e=e_}assert(e instanceof i)})}),Object.keys(t).filter(function(e){return t[e]}).forEach(function(r){it("accepts valid "+s+" name ("+r+")",function(){var e,t={};t["$"+s]=r;try{gpf.define(t)}catch(e_){e=e_}assert(undefined===e)})})}function t(n){it(n.it,function(){var e;try{gpf.define(n.definition)}catch(e_){e=e_}assert(e instanceof n.exception)})}before(function(){gpf.context().test=s}),after(function(){delete gpf.context().test}),describe("gpf.define",function(){it("accepts only one parameter",function(){assert("function"==typeof gpf.define),assert(1===gpf.define.length)}),describe("Common validation",function(){t({it:"checks that the entity type is specified",definition:{},exception:gpf.Error.InvalidEntityType})}),describe("Class definition",function(){describe("Validation",function(){e("class",gpf.Error.InvalidClassName,{"1NumberAtTheBeginningIsNotOK":!1,"noUppercaseFirstLetterIsNotOK":!1,"DollarSignAnywhereIsNotOK$":!1,"A":!0,"$B":!0,"_C":!0,"Test123":!0}),[{it:"rejects invalid $ property names",definition:{$class:"Test",$test:!1},exception:gpf.Error.InvalidEntity$Property},{it:"rejects invalid property names (reserved keywords)",definition:{$class:"Test","super":!1},exception:gpf.Error.InvalidClassProperty},{it:"rejects constructor property if not a method",definition:{$class:"Test",constructor:!1},exception:gpf.Error.InvalidClassConstructor}].forEach(t)}),describe("Implementation",function(){var r,e;before(function(){r=gpf.define({$class:"A",_member:"defaultValue",getMember:function(){return this._member},"constructor":function(e){e&&(this._member=e),this._constructorOfA=!0},funcWith3params:function(e,t,n){return e+t+n},throwError:function(){throw new Error("error")}}),e=new r}),it("prevents constructor functions to be used without new",function(){var e;try{r()}catch(e_){e=e_}assert(e instanceof gpf.Error.ClassConstructorFunction)}),it("creates a constructor with the same signature than the constructor property",function(){assert(1===r.length)}),it("handles instanceof",function(){assert(e instanceof r)}),it("calls constructor property",function(){assert(e._constructorOfA)}),it("exposes methods",function(){assert("function"==typeof e.getMember),assert("defaultValue"===e.getMember())}),describe("Subclassing",function(){var t,n;it("prevents invalid override",function(){var e;try{gpf.define({$class:"Test",$extend:r,getMember:!1})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassOverride)}),before(function(){t=gpf.define({$class:"test.B",$extend:r,"constructor":function(e){this.$super("valueOfB"),this._constructorOfB=e},getMember:function(){return this.$super()+"-inB"},setMember:function(e){this._member=e},baseTest:function(){return this.$super.getMember()},invalidSuperMember:function(){return this.$super.doesntExist()},noSuperMember:function(){return this.$super()},differentBinding:function(){return this.$super.getMember.call({_member:"different"})},checkSignature:function(){assert(3===this.$super.funcWith3params.length)},throwError:function(){this.$super()}}),n=new t(3475)}),it("handles instanceof",function(){assert(n instanceof r),assert(n instanceof t)}),it("handles namespace",function(){assert(s.B===t)}),it("calls the constructor function",function(){assert(3475===n._constructorOfB)}),it("calls the proper $super()",function(){assert(n._constructorOfA),assert("valueOfB-inB"===n.getMember())}),it("offers a way to call named base method",function(){assert("valueOfB"===n.baseTest())}),it("fails when accessing an unknown $super member",function(){var e;try{n.invalidSuperMember()}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassSuperMember)}),it("fails when accessing inexistent $super",function(){var e;try{n.noSuperMember()}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassSuper)}),it("allows calling $super member with a different binding",function(){assert("different"===n.differentBinding())}),it("respects methods signature",function(){n.checkSignature()}),it("does not leak $super",function(){assert(undefined===n.$super)}),it("does not leak $super on exception",function(){try{n.throwError()}catch(e_){}assert(undefined===n.$super)}),it("handles several versions of $super",function(){var e=new(gpf.define({$class:"C",$extend:t,testMethod:function(){return this.$super.getMember()}}));assert("valueOfB-inB"===e.testMethod())})})})}),describe("Interface definition",function(){describe("Validation",function(){e("interface",gpf.Error.InvalidInterfaceName,{"1NumberAtTheBeginningIsNotOK":!1,"noUppercaseFirstLetterIsNotOK":!1,"DollarSignAnywhereIsNotOK$":!1,"NotStartingWithUppercaseI":!1,"A":!1,"$B":!1,"_C":!1,"Test123":!1,"ISample":!0,"IS":!0}),[{it:"rejects interface if all members are not methods",definition:{$interface:"ITest",member:!1},exception:gpf.Error.InvalidInterfaceProperty},{it:"rejects invalid property names (reserved keywords)",definition:{$interface:"ITest","super":function(){}},exception:gpf.Error.InvalidInterfaceProperty},{it:"rejects constructor property",definition:{$interface:"ITest",constructor:function(){}},exception:gpf.Error.InvalidInterfaceProperty}].forEach(t)}),describe("Implementation",function(){var n=gpf.define({$interface:"ITest",test:function(e){return e}});it("can't be used as a class extend",function(){var e;try{gpf.define({$class:"Test",$extend:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassExtend)})})})})}),config.features.es6class&&include("define.es6"),describe("interfaces",function(){describe("gpf.interfaces.IUnknown",function(){it("exists",function(){assert("function"==typeof gpf.interfaces.IUnknown)}),it("is an interface",function(){var e;try{var t=new gpf.interfaces.IUnknown;assert("function"==typeof t.queryInterface)}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceConstructorFunction)})}),describe("gpf.interfaces.isImplementedBy",function(){function t(){}t.prototype={queryInterface:function(e){return e}};var n=gpf.define({$class:"TestGPFClass",queryInterface:function(e){return e}});it("validates literal objects (using interface constructor)",function(){assert(!0===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,{queryInterface:function(e){return e}}))}),it("validates instances from a raw JavaScript class (using interface name)",function(){var e=new t;assert(!0===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",e))}),it("validates a raw JavaScript class",function(){assert(!0===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",t))}),it("validates instances from a GPF class",function(){var e=new n;assert(!0===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,e))}),it("validates a GPF class",function(){assert(!0===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,n))}),[!1,null,undefined,0,NaN,""].forEach(function(e){it("rejects "+JSON.stringify(e),function(){assert(!1===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",e))})}),it("rejects member if not a method",function(){assert(!1===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",{queryInterface:"Not a method"}))}),it("rejects member if parameters count does not match (none)",function(){assert(!1===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",{queryInterface:function(){}}))}),it("rejects member if parameters count does not match (more)",function(){assert(!1===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,{queryInterface:function(e,t,n){return e+t+n}}))})}),describe("gpf.interfaces.query",function(){function t(){}t.prototype.test=function(e,t){return e+t},it("returns the object if it implements the interface (using interface name)",function(){var e={queryInterface:function(e){return e}};assert(e===gpf.interfaces.query("gpf.interfaces.IUnknown",e))}),it("returns the object if it implements the interface (using interface specifier)",function(){var e={test:function(e,t){}};assert(e===gpf.interfaces.query(t,e))}),it("returns null if IUnknown is implemented but not the expected interface",function(){assert(null===gpf.interfaces.query(t,{queryInterface:function(e){return null}}))}),it("uses IUnknown to get the expected interface",function(){assert(null!==gpf.interfaces.query(t,{queryInterface:function(e){return assert(e===t),{test:function(e,t){}}}}))}),it("returns undefined if neither the expected interface or IUnknown are implemented",function(){assert(undefined===gpf.interfaces.query(t,{queryInterface:function(){return null}}))})})}),describe("sort",function(){var n=[{id:0,num:5,str:"e",group:1},{id:1,num:1,str:"b",group:0},{id:2,num:4,str:"a",group:1},{id:3,num:2,str:"d",group:0},{id:4,num:3,str:"c",group:1}];describe("gpf.createSortFunction",function(){[{label:"sort on numeric values (ascending)",sort:{property:"num"},expected:[1,3,4,2,0]},{label:"sort on string values (descending)",sort:[{property:"str",type:"string",ascending:!1}],expected:[0,3,4,1,2]},{label:"sort on multiple values",sort:[{property:"group",type:"number",ascending:!0},{property:"num",ascending:!1}],expected:[3,1,0,2,4]}].forEach(function(e){it(e.label,function(){!function t(e,n){assert(e.every(function(e,t){return e.id===n[t]}))}(n.sort(gpf.createSortFunction(e.sort)),e.expected)})})})}),describe("filter",function(){var n=[{id:0,num:5,str:"e",group:1,search:"first"},{id:1,num:1,str:"b",group:0,search:"second"},{id:2,num:4,str:"a",group:1,search:"third"},{id:3,num:2,str:"d",group:0,search:"fourth"},{id:4,num:3,str:"c",group:1,search:"fifth"}];describe("gpf.createFilterFunction",function(){[{label:"filters on numeric values",filter:{eq:[{property:"num"},1]},expected:[1]},{label:"filters on own values",filter:{eq:[{property:"num"},{property:"id"}]},expected:[1]},{label:"filters on string values",filter:{eq:[{property:"str"},"c"]},expected:[4]},{label:"filters on string values (ne)",filter:{ne:[{property:"str"},"c"]},expected:[0,1,2,3]},{label:"filters with lower than (lt)",filter:{lt:[{property:"num"},3]},expected:[1,3]},{label:"filters with lower than or equal (lte)",filter:{lte:[{property:"num"},3]},expected:[1,3,4]},{label:"filters with greater than (gt)",filter:{gt:[{property:"num"},3]},expected:[0,2]},{label:"filters with greater than or equal (lte)",filter:{gte:[{property:"num"},3]},expected:[0,2,4]},{label:"filters on string values (not eq)",filter:{not:{eq:[{property:"str"},"c"]}},expected:[0,1,2,3]},{label:"filters on string values (like)",filter:{like:{property:"str"},regexp:"[a|c]"},expected:[2,4]},{label:"filters on string values (like with capturing group)",filter:{eq:[{like:{property:"search"},regexp:"f([a-z]*)th",group:1},"if"]},expected:[4]},{label:"filters with or (one condition)",filter:{or:[{eq:[{property:"num"},1]}]},expected:[1]},{label:"filters with or (two conditions)",filter:{or:[{eq:[{property:"num"},1]},{eq:[{property:"str"},"c"]}]},expected:[1,4]},{label:"filters with or (three conditions)",filter:{or:[{eq:[{property:"num"},1]},{eq:[{property:"str"},"c"]},{eq:[{property:"group"},0]}]},expected:[1,3,4]},{label:"filters with and (one condition)",filter:{and:[{eq:[{property:"group"},1]}]},expected:[0,2,4]},{label:"filters with and (two conditions)",filter:{and:[{eq:[{property:"group"},1]},{eq:[{property:"str"},"c"]}]},expected:[4]},{label:"filters with and (three conditions)",filter:{and:[{eq:[{property:"group"},1]},{eq:[{property:"str"},"c"]},{eq:[{property:"num"},3]}]},expected:[4]}].forEach(function(e){it(e.label,function(){!function t(e,n){assert(e.length===n.length),assert(e.every(function(e,t){return e.id===n[t]}))}(n.filter(gpf.createFilterFunction(e.filter)),e.expected)})})})}),describe("stream",function(){if(gpf.internals){var r=gpf.internals._gpfStreamQueryReadable,s=gpf.internals._gpfStreamQueryWritable,e=gpf.internals._gpfStreamSecureInstallProgressFlag,t=gpf.internals._gpfStreamSecureRead,n=gpf.internals._gpfStreamSecureWrite,i=["","Hello World !",!1,!0,null,undefined,0,1];describe("(internal)",function(){describe("_gpfStreamQueryReadable",function(){it("checks if the parameters implements gpf.interfaces.IReadableStream",function(){assert(r({read:function(e){assert(e)}}))}),it("fails when the parameters does not implement gpf.interfaces.IReadableStream",function(){var e;try{r({})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),i.forEach(function(n){it("fails when the parameters is invalid - "+JSON.stringify(n),function(){var e;try{r(n)}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)})})}),describe("_gpfStreamQueryWritable",function(){it("checks if the parameters implements gpf.interfaces.IWritableStream",function(){assert(s({write:function(e){assert(e)}}))}),it("fails when the parameters does not implement gpf.interfaces.IWritaableStream",function(){var e;try{s({})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),i.forEach(function(n){it("fails when the parameters is invalid - "+JSON.stringify(n),function(){var e;try{s(n)}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)})})}),describe("_gpfStreamSecureRead",function(){function s(){}s.prototype={read:t(function(e){return e.write("TEST")})},e(s),it("accepts only IWritableStream",function(){var e,t=new s;try{t.read({})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),it("is protected against parallel calls",function(){var e,t={write:function(e){return assert("TEST"===e),new Promise(function(){})}},n=new s;try{n.read(t),n.read(t)}catch(e_){e=e_}assert(e instanceof gpf.Error.ReadInProgress)}),it("writes to an IWritableStream",function(e){var t={write:function(e){return assert("TEST"===e),Promise.resolve()}};(new s).read(t).then(function(){e()})}),it("forwards any error",function(r){var e={write:function(e){return assert("string"==typeof e),Promise.reject(1)}};(new s).read(e).then(function(){},function(e){var t;try{assert(1===e)}catch(e_){t=e_}r(t)})})}),describe("_gpfStreamSecureWrite",function(){function s(){}s.prototype={write:n(function(e){return"OK"===e?Promise.resolve():Promise.reject(e)})},e(s),it("is protected against parallel calls",function(){var e,t=new s;try{t.write("OK"),t.write("OK")}catch(e_){e=e_}assert(e instanceof gpf.Error.WriteInProgress)}),it("forwards any error",function(r){(new s).write("KO").then(function(){},function(e){var t;try{assert("KO"===e)}catch(e_){t=e_}r(t)})})})})}}),describe("stream/string",function(){describe("gpf.stream.ReadableString",function(){it("writes to an IWritableStream",function(e){var t=new gpf.stream.WritableString;new gpf.stream.ReadableString("Hello World").read(t).then(function(){assert("Hello World"===t.toString()),e()})})}),describe("gpf.stream.WritableString",function(){it("supports multiple sequenced calls",function(e){var t=new gpf.stream.WritableString;t.write("Hell").then(function(){return t.write("o ")}).then(function(){return t.write("World")}).then(function(){assert("Hello World"===t.toString()),e()})})})}),describe("fs",function(){if(config.performance)it("is not relevant for performance testing",function(){assert(!0)});else{var n="test/data";describe("gpf.fs.getFileStorage",function(){function r(e){assert(e.type===gpf.fs.types.file),assert("file.bin"===e.fileName),assert(-1!==e.filePath.indexOf(n+"/file.bin")),assert(256===e.size),assert(e.createdDateTime instanceof Date),assert(2010<e.createdDateTime.getUTCFullYear()),assert(e.modifiedDateTime instanceof Date),assert(2010<e.modifiedDateTime.getUTCFullYear())}function s(e){assert(e.type===gpf.fs.types.directory),assert("folder"===e.fileName),assert(-1!==e.filePath.indexOf(n+"/folder")),assert(e.createdDateTime instanceof Date),assert(2010<e.createdDateTime.getUTCFullYear()),assert(e.modifiedDateTime instanceof Date),assert(2010<e.modifiedDateTime.getUTCFullYear())}if(gpf.fs.getFileStorage()){var i="tmp/fs/"+gpf.host()+"/"+(new Date).toISOString().replace(/-|T|:|\.|Z/g,"")+"/"+Math.floor(100*Math.random());it("returns a file storage interface",function(){assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IFileStorage,gpf.fs.getFileStorage()))}),describe("getInfo",function(){it("can get file information",function(e){gpf.fs.getFileStorage().getInfo(gpf.path.join(n,"file.bin")).then(r).then(e,e)}),it("can get directory information",function(e){gpf.fs.getFileStorage().getInfo(gpf.path.join(n,"folder")).then(s).then(e,e)}),it("does not fail if the file does not exist",function(e){gpf.fs.getFileStorage().getInfo(gpf.path.join(n,"nope")).then(function(e){assert(e.type===gpf.fs.types.notFound)}).then(e,e)})}),describe("openTextStream",function(){function r(e,t){var n=gpf.fs.getFileStorage(),r=new gpf.stream.WritableString;return n.openTextStream(e,gpf.fs.openFor.reading).then(function(e){return assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IReadableStream,e)),e.read(r).then(function(){return t&&assert(r.toString()===t),n.close(e).then(function(){return r.toString()})})})}describe("read",function(){it("reads a small text file",function(e){r(gpf.path.join(n,"folder/hello world.txt"),"hello world\n").then(function(){e()},e)}),it("reads a larger text file",function(t){r(gpf.path.join(n,"folder/lorem ipsum.txt")).then(function(e){assert(-1!==e.indexOf("Phasellus posuere.")),t()})["catch"](t)})}),describe("write",function(){function n(e,t){var n=gpf.fs.getFileStorage();return n.openTextStream(e,gpf.fs.openFor.appending).then(function(e){return e.write(t).then(function(){return n.close(e)})})}before(function(e){(function t(e){var n=e.split("/"),r=-1,s=gpf.fs.getFileStorage();return function i(){if(++r===n.length)return Promise.resolve();var t=n.slice(0,r+1).join("/");return s.getInfo(t).then(function(e){return e.type===gpf.fs.types.directory?i():e.type===gpf.fs.types.notFound?s.createDirectory(t).then(i):Promise.reject("ERROR")})}()})(i).then(function(){e()},e)}),after(function(e){(function s(e){var t=e.split("/"),n=gpf.fs.getFileStorage();return function r(){var e=t.join("/");return n.deleteDirectory(e).then(function(){if(t.pop(),3<t.length)return r()})}()})(i).then(function(){e()},e)}),describe("initial",function(){var t=gpf.path.join(i,"hello world.txt");before(function(e){n(t,"hello world\n").then(e,e)}),after(function(e){gpf.fs.getFileStorage().deleteFile(t).then(e,e)}),it("writes a text file",function(e){r(t,"hello world\n").then(function(){e()},e)}),describe("append",function(){it("appends a text file",function(e){n(t,"goodbye\n").then(function(){return r(t,"hello world\ngoodbye\n")}).then(function(){e()},e)})})})})}),describe("close",function(){it("rejects invalid streams",function(e){gpf.fs.getFileStorage().close({}).then(function(){throw new Error}).then(undefined,function(e){assert(e instanceof gpf.Error.IncompatibleStream)}).then(e,e)})}),describe("explore",function(){it("lists the content of a folder",function(t){gpf.fs.getFileStorage().explore(n).then(function(n){function e(e){var t=n.getCurrent();return e.type===gpf.fs.types.file?(r(e),r(t)):(s(e),s(t)),n.moveNext()}return assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IEnumerator,n)),n.reset().then(function(){return n.moveNext()}).then(e).then(e).then(function(e){assert(e===undefined)}).then(t,t)})}),it("fails on a file",function(e){gpf.fs.getFileStorage().explore(gpf.path.join(n,"file.bin")).then(function(){e(new Error("unexpected"))},function(){e()})}),it("fails with an invalid path",function(e){gpf.fs.getFileStorage().explore(gpf.path.join(n,"nothing")).then(function(){e(new Error("unexpected"))},function(){e()})})})}else it("does not return a file storage interface",function(){var e=gpf.fs.getFileStorage();assert(null===e)})})}}),describe("path",function(){var i=gpf.path;function e(t){var e;e="/"===t?t:"\\\\",describe("gpf.path.join ("+t+")",function(){var n;n="/"===t?i.join:function(){var e=Array.from(arguments,function(e){return e.split("/").join(t)});return i.join.apply(i,e)},it("concatenates paths",function(){assert("abc/def/ghi/jkl"===n("abc/def","ghi/jkl"))}),it("handles trailing separator",function(){assert("abc/def/ghi/jkl"===n("abc/def/","ghi/jkl/"))}),it("handles relative paths",function(){assert("abc/ghi"===n("abc/def","../ghi"))}),it("handles multiple joins",function(){assert("abc/ghi/jkl"===n("abc","def","../ghi/jkl","../jkl"))}),it("resolves on known parent",function(){assert("ghi"===n("abc","../ghi"))}),it("goes up with ..",function(){assert("abc"===n("abc/def",".."))}),it("does not resolve on unknown parent",function(){var e;try{n("abc","../../ghi")}catch(e_){e=e_}assert(e instanceof gpf.Error.UnreachablePath)}),it("restarts on root path",function(){assert("/ghi"===n("abc/def","/ghi"))}),it("restarts on root path (last)",function(){assert("/ghi"===n("abc","def","/ghi"))}),it("restarts on root path (middle)",function(){assert("/def/ghi"===n("abc","/def","ghi"))})}),describe("gpf.path.parent ("+t+")",function(){it("retrieves the parent path",function(){assert("abc"===i.parent("abc"+t+"def"))}),it("returns empty on a root",function(){assert(""===i.parent(t+"abc"))}),it("returns empty when no parent",function(){assert(""===i.parent("abc"))}),it("fails when empty",function(){var e;try{i.parent("")}catch(e_){e=e_}assert(e instanceof gpf.Error.UnreachablePath)})});var n=Function,r=[{label:"considers the last name of path",path:"abc"+e+"def.ghi",name:"def.ghi",nameOnly:"def",extension:".ghi"},{label:"handles trailing separator",path:"abc"+e+"def.ghi"+e,name:"def.ghi",nameOnly:"def",extension:".ghi"},{label:"handles trailing separator (no extension)",path:"abc"+e+"def"+e,name:"def",nameOnly:"def",extension:""},{label:"handles name only",path:"abc.defgh",name:"abc.defgh",nameOnly:"abc",extension:".defgh"},{label:"handles name only (no extension)",path:"abc",name:"abc",nameOnly:"abc",extension:""},{label:"handles root",path:"/",name:"",nameOnly:"",extension:""},{label:"handles empty path",path:"",name:"",nameOnly:"",extension:""}];function s(e){return new n("assert(gpf.path."+e+");")}describe("gpf.path.name ("+t+")",function(){r.forEach(function(e){it(e.label,s('name("'+e.path+'") === "'+e.name+'"'))})}),describe("gpf.path.nameOnly ("+t+")",function(){r.forEach(function(e){it(e.label,s('nameOnly("'+e.path+'") === "'+e.nameOnly+'"'))})}),describe("gpf.path.extension ("+t+")",function(){r.forEach(function(e){it(e.label,s('extension("'+e.path+'") === "'+e.extension+'"'))})}),describe("gpf.path.relative ("+t+")",function(){var e;e="/"===t?i.relative:function(){var e=Array.from(arguments,function(e){return e.split("/").join(t)});return i.relative.apply(i,e)},it("solves the relative path",function(){assert("../ghi"===e("abc/def","abc/ghi"))}),it("handles trailing separator",function(){assert("../ghi"===e("abc/def/","abc/ghi"))}),it("works on non matching roots",function(){assert("../../ghi/jkl"===e("abc/def","ghi/jkl"))}),it("works on non matching roots (any level)",function(){assert("../../../g/h/i/jkl"===e("a/bc/def","g/h/i/jkl"))}),it("handles edge cases (left empty)",function(){assert("abc/ghi"===e("","abc/ghi"))}),it("handles edge cases (right empty)",function(){assert("../.."===e("abc/ghi",""))}),it("handles edge cases (both empty)",function(){assert(""===e("",""))})})}e("/"),e("\\"),gpf.internals&&describe("(internal)",function(){describe("_gpfPathNormalize",function(){gpf.internals._gpfObjectForEach({"a/":"a","/a/":"/a","a/b":"a/b","a\\b":"a/b","a\\":"a","\\a\\":"/a"},function(e,t){it('transforms "'+t+'" into "'+e+'"',function(){assert(e===gpf.internals._gpfPathNormalize(t))})})})})}),describe("stream/node",function(){function a(){this._events={}}a.prototype={_events:{},_fire:function(e){var t=[].slice.call(arguments,1);this._events[e].apply(null,t)},on:function(e,t){return assert(!this._events[e]),this._events[e]=t,this},once:function(e,t){return this.on(e,function(){t(),delete this._events[e]}.bind(this))}},gpf.hosts.nodejs===gpf.host()&&(describe("gpf.node.ReadableStream",function(){it("configures the stream by hooking the events",function(e){var t=new a,n=new gpf.node.ReadableStream(t),r=new gpf.stream.WritableString;assert("function"==typeof t._events.error),n.read(r).then(e,e),assert("function"==typeof t._events.data),assert("function"==typeof t._events.end),t._fire("end")}),it("supports several read events",function(e){var t=new a,n=new gpf.node.ReadableStream(t),r=new gpf.stream.WritableString;n.read(r).then(function(){assert("Hello World"===r.toString())}).then(e,e);var s=!1,i=0;t.pause=function(){assert(!s),s=!0},t.resume=function(){assert(s),s=!1,setTimeout(function(){1===++i?t._fire("data","World"):t._fire("end")},0)},t._fire("data","Hello ")}),it("handles errors",function(e){var t=new a,n=new gpf.node.ReadableStream(t),r=new gpf.stream.WritableString;n.read(r).then(function(){assert(!1)}).then(undefined,function(e){assert("error"===e)}).then(e,e);var s=!1;t.pause=function(){assert(!s),s=!0},t.resume=function(){assert(s),s=!1,setTimeout(function(){t._fire("error","error")},0)},t._fire("data","Hello ")}),it("handles errors of write stream",function(e){var t=new a,n=new gpf.node.ReadableStream(t),r={write:function(e){return Promise.reject(e)}};t.pause=function(){},n.read(r).then(function(){assert(!1)},function(e){assert("error"===e)}).then(e,e),t._fire("data","error")}),it("prevents any subsequent use when an error occurred",function(e){var t=new a,n=new gpf.node.ReadableStream(t),r=new gpf.stream.WritableString;n.read(r).then(function(){assert(!1)}).then(undefined,function(e){return assert("error"===e),n.read(r)}).then(undefined,function(e){assert(e instanceof gpf.Error.InvalidStreamState)}).then(e,e),t._fire("error","error")}),it("prevents any subsequent use when ended",function(e){var t=new a,n=new gpf.node.ReadableStream(t),r=new gpf.stream.WritableString;n.read(r).then(function(){return n.read(r)}).then(undefined,function(e){assert(e instanceof gpf.Error.InvalidStreamState)}).then(e,e),t._fire("end")})}),describe("gpf.node.WritableStream",function(){it("configures the stream by hooking the events",function(){var e=new a,t=new gpf.node.WritableStream(e);assert("function"==typeof t.write),assert("function"==typeof e._events.error)}),it("passes the buffer to the inner stream",function(e){var t=new a,n=new gpf.node.WritableStream(t);assert("function"==typeof t._events.error),t.write=function(e,t){return assert("Hello World"===e),setTimeout(function(){t(null)},0),!0},n.write("Hello World").then(e,e),assert(!t._events.drain)}),it("supports several write calls",function(e){var t=new a,n=new gpf.node.WritableStream(t),r="";assert("function"==typeof t._events.error),t.write=function(e,t){return r+=e,setTimeout(function(){t(null)},0),!0},n.write("Hello ").then(function(){return n.write("World")}).then(function(){assert("Hello World"===r)}).then(e,e),assert(!t._events.drain)}),it("waits for the drain event if the stream is full",function(e){var t=new a,n=new gpf.node.WritableStream(t),r=!1;assert("function"==typeof t._events.error),t.write=function(e,t){return assert("Hello World"===e),setTimeout(function(){t(null)},0),!1},n.write("Hello World").then(function(){assert(r),assert(!t._events.drain)}).then(e,e),assert("function"==typeof t._events.drain),r=!0,t._fire("drain")}),it("handles errors",function(e){var n=new a,t=new gpf.node.WritableStream(n);assert("function"==typeof n._events.error),n.write=function(e,t){t("error"),n._fire("error","error")},t.write("Hello World").then(undefined,function(e){assert("error"===e)}).then(e,e)}),it("prevents any subsequent use when an error occurred",function(e){var t=new a,n=new gpf.node.WritableStream(t);assert("function"==typeof t._events.error),t.write=function(){t._fire("error","error")},n.write("Hello World").then(undefined,function(e){return assert("error"===e),n.write("Hello World")}).then(undefined,function(e){assert(e instanceof gpf.Error.InvalidStreamState)}).then(e,e)})}))}),describe("fs/node",function(){if(config.performance)it("is not relevant for performance testing",function(){assert(!0)});else if(gpf.hosts.nodejs===gpf.host()&&(it("forwards inner errors (generic API)",function(t){gpf.fs.getFileStorage().deleteFile("test/data/notFound.bin").then(function(){throw new Error("Should fail")},function(e){assert("ENOENT"===e.code),t()})["catch"](function(e){t(e)})}),gpf.internals)){var e=gpf.internals._gpfFsNodeGetType;it("uses unknown file type if not file or directory",function(){assert(gpf.fs.types.unknown===e({isDirectory:function(){return!1},isFile:function(){return!1}}))})}}),describe("literal",function(){describe("gpf.isLiteralObject",function(){[{value:{},result:!0},{value:{member:"a"},result:!0},{value:new Object,result:!0},{value:null},{value:undefined},{value:new function e(){},label:"new A()"},{value:[]},{value:new Date,label:"new Date()"},{value:!0}].forEach(function(e){var t=e.label||JSON.stringify(e.value),n=!0===e.result;it({"true":"recognizes","false":"rejects"}[n]+" "+t,function(){assert(n===gpf.isLiteralObject(e.value))})})})}),describe("web/tag",function(){function r(e,t,n){this._namespace=e,this._name=t,this._value=n}function n(e,t,n){this.ownerDocument=e,this._namespace=t,this.nodeName=n,this._attributes=[],this._children=[]}r.prototype={_namespace:"",_name:"",_value:undefined},n.prototype={ownerDocument:null,_namespace:"",nodeName:"",_attributes:[],_children:[],appendChild:function(e){return this._children.push(e),e},setAttribute:function(e,t){this._attributes.push(new r("",e,t))},setAttributeNS:function(e,t,n){this._attributes.push(new r(e,t,n))},_hasAttribute:function(t,n){var r;return this._attributes.every(function(e){return e._namespace!==t||e._name!==n||(r=e._value,!1)}),r}};var s={createElement:function(e){return new n(this,"",e)},createElementNS:function(e,t){return new n(this,e,t)},createTextNode:function(e){return e}};describe("gpf.web.createTagFunction",function(){it("requires node name when calling the function",function(){var e;try{gpf.web.createTagFunction()}catch(e_){e=e_}assert(e instanceof gpf.Error.MissingNodeName)}),it("creates shortcut for tag generation",function(){var e=gpf.web.createTagFunction("div");assert("<div>Hello World!</div>"===e("Hello World!").toString())}),it("generates closed tags when empty",function(){var e=gpf.web.createTagFunction("div");assert("<div/>"===e().toString())}),it("supports tree building (parameters)",function(){var e=gpf.web.createTagFunction("div")({className:"test1"},"Hello ",gpf.web.createTagFunction("span")({className:"test2"},"World!"));assert('<div class="test1">Hello <span class="test2">World!</span></div>'===e.toString())}),it("supports tree building (array parameter)",function(){var e=gpf.web.createTagFunction("div"),t=gpf.web.createTagFunction("span"),n=e({width:"80%"},"Hello ",[t("Wor"),t("ld!")]);assert('<div width="80%">Hello <span>Wor</span><span>ld!</span></div>'===n.toString())}),it("allows DOM injection",function(){var e=s.createElement("any"),t=gpf.web.createTagFunction("div")({className:"test"},"Hello ",gpf.web.createTagFunction("span")("World!")).appendTo(e);assert(t instanceof n),assert(t.ownerDocument===s),assert("div"===t.nodeName),assert("test"===t._hasAttribute("","class")),assert(2===t._children.length),assert("Hello "===t._children[0]),assert(t._children[1]instanceof n),assert("World!"===t._children[1]._children[0])}),describe("Namespace handling",function(){it("permits namespaces for node appending",function(){var e=s.createElement("any"),t=gpf.web.createTagFunction("svg:image")({x:0,y:0,"xlink:href":"test.png"}).appendTo(e);assert(t instanceof n),assert(t.ownerDocument===s),assert("image"===t.nodeName),assert("http://www.w3.org/2000/svg"===t._namespace),assert("test.png"===t._hasAttribute("http://www.w3.org/1999/xlink","href")),assert(0===t._hasAttribute("","x"))}),it("fails if namespace is unknown",function(){var e,t=s.createElement("any"),n=gpf.web.createTagFunction("svg2:image")({x:0,y:0,"xlink:href":"test.png"});try{n.appendTo(t)}catch(e_){e=e_}assert(e instanceof gpf.Error.UnknownNamespacePrefix)}),it("fails when used for string generation",function(){var e,t=gpf.web.createTagFunction("svg:image")({x:0,y:0,"xlink:href":"test.png"});try{t.toString()}catch(e_){e=e_}assert(e instanceof gpf.Error.UnableToUseNamespaceInString)})})})}),describe("interfaces/thenable",function(){describe("gpf.interfaces.IThenable",function(){function e(e){var s=gpf[e].bind(gpf);[null,0,"",!1,!0,{},"Hello World!",7].forEach(function(n){it("converts "+JSON.stringify(n)+" into a promise",function(t){try{s(n).then(function(e){assert(n===e),t()})}catch(e_){t(e_)}})}),it("returns the promise parameter",function(){var e=Promise.resolve();assert(e===s(e))}),it("returns the IThenable parameter",function(t){try{var e={then:function(e,t){!function n(e){return e}(t),e("ok")}},n=s(e);assert(e===n),n.then(function(e){assert("ok"===e),t()})}catch(e_){t(e_)}})}describe("gpf.promisify",function(){it("converts undefined into a promise",function(t){try{gpf.promisify().then(function(e){assert(undefined===e),t()})}catch(e_){t(e_)}}),e("promisify")}),describe("gpf.promisifyDefined",function(){it("returns undefined with undefined",function(){assert(gpf.promisifyDefined(undefined)===undefined)}),e("promisifyDefined")})})}),describe("http",function(){it("knows config.httpPort",function(){assert("object"==typeof config&&"number"==typeof config.httpPort)}),describe("gpf.http",function(){var i;config.performance?it("is not relevant for performance testing",function(){assert(!0)}):0!==config.httpPort?(before(function(){i="http://localhost:"+config.httpPort+"/echo/?"}),describe("basics",function(){it("allows the GET operation",function(n){gpf.http.request({method:gpf.http.methods.get,url:i+"status=200"}).then(function(e){assert(200===e.status);var t=JSON.parse(e.responseText);assert("GET"===t.method),assert("/echo/?status=200"===t.url),n()})["catch"](n)}),it("offers the GET shortcut (using string parameter)",function(n){gpf.http.get(i+"status=200").then(function(e){assert(200===e.status);var t=JSON.parse(e.responseText);assert("GET"===t.method),assert("/echo/?status=200"===t.url),n()})["catch"](n)}),it("offers the GET shortcut (using object parameter)",function(t){gpf.http.get({url:i+"status=200&response=Hello%20World"}).then(function(e){assert(200===e.status),assert("Hello World"===e.responseText),t()})["catch"](t)}),it("succeeds when the HTTP request fails",function(t){gpf.http.get(i+"status=500").then(function(e){assert(500===e.status),t()})["catch"](t)}),it("succeeds when the HTTP response is empty",function(t){gpf.http.get(i+"response=").then(function(e){assert(""===e.responseText),t()})["catch"](t)})}),describe("headers",function(){it("forwards request headers",function(t){gpf.http.request({method:gpf.http.methods.get,url:i+"status=200",headers:{"x-test":"Value"}}).then(function(e){assert(200===e.status),assert("Value"===e.headers["x-test"]),t()})["catch"](t)}),it("gives access to response headers",function(t){gpf.http.request({method:gpf.http.methods.get,url:i+'status=200&headers={"x-test-1":"OK","x-test-2":123}'}).then(function(e){assert(200===e.status),assert("OK"===e.headers["x-test-1"]),assert("123"===e.headers["x-test-2"]),t()})["catch"](t)})}),describe("methods",function(){["post","put","options","delete","head"].forEach(function(e,t){var n,r,s=e.toUpperCase();t<2&&(n="Hello World"),r="head"===e?function(){}:function(e){var t=JSON.parse(e);assert(t.method===s),assert("/echo/?status=200"===t.url),n?assert(t.body===n):assert(!t.body)},it("allows the "+s+" operation",function(t){gpf.http.request({method:gpf.http.methods[e],url:i+"status=200",data:n}).then(function(e){assert(200===e.status),r(e.responseText),t()})["catch"](t)}),it("offers the "+s+" shortcut",function(t){gpf.http[e](i+"status=200",n).then(function(e){assert(200===e.status),r(e.responseText),t()})["catch"](t)})}),-1!==[gpf.hosts.nodejs].indexOf(gpf.host())&&it("allows any verb (MERGE)",function(n){gpf.http.request({method:"merge",url:i+"status=200"}).then(function(e){assert(200===e.status);var t=JSON.parse(e.responseText);assert("MERGE"===t.method),assert("/echo/?status=200"===t.url),n()})["catch"](n)})}),gpf.hosts.browser!==gpf.host()&&describe("https",function(){it("handles https access",function(t){gpf.http.get("https://www.google.com/").then(function(e){assert(200===e.status),t()})["catch"](t)})})):it("is not tested in this environment because config.httpPort = 0",function(){assert(!0)})})}),describe("stream/java",function(){gpf.hosts.rhino===gpf.host()&&describe("gpf.java.ReadableStream",function(){it("forwards any error",function(n){new gpf.java.ReadableStream({close:function(){}}).read({_ignore:function(){},write:function(e){this._ignore(e)}}).then(function(){n(new Error("Not expected"))},function(e){try{assert(e),n()}catch(e_){n(e_)}})})})}),describe("gpf.http.mock",function(){var r;before(function(){r="http://localhost:"+config.httpPort+"/echo/"}),it("exposes a method to mock requests",function(){assert("function"==typeof gpf.http.mock)}),it("exposes a method to remove one specific mocking",function(){assert("function"==typeof gpf.http.mock.remove)}),it("exposes a method to reset all mocking",function(){assert("function"==typeof gpf.http.mock.reset)}),describe("Simple mocking example",function(){var e;beforeEach(function(){e=gpf.http.mock({method:gpf.http.methods.get,url:/echo\/\?status=([0-9]+)/,response:function(e,t){if("400"!==t)return{status:parseInt(t,10)+1,headers:{"x-mock":!0},responseText:"It works"}}})}),afterEach(function(){e&&gpf.http.mock.remove(e)}),it("matches request URL and method",function(t){gpf.http.get(r+"?status=200").then(function(e){assert(201===e.status),assert(!0===e.headers["x-mock"]),assert("It works"===e.responseText),t()})["catch"](t)}),0===config.httpPort||config.performance||(it("matches request URL and method (non matching URL)",function(t){gpf.http.get(r).then(function(e){assert(200===e.status),assert(e.headers["x-mock"]===undefined),t()})["catch"](t)}),it("matches request URL and method (non matching method)",function(t){gpf.http.put(r,"?status=200").then(function(e){assert(200===e.status),assert(e.headers["x-mock"]===undefined),t()})["catch"](t)}),it("may decide to not mock",function(t){gpf.http.get(r+"?status=400").then(function(e){assert(400===e.status),assert(e.headers["x-mock"]===undefined),t()})["catch"](t)}),it("does not mock once removed",function(t){gpf.http.mock.remove(e),e=undefined,gpf.http.get(r+"?status=200").then(function(e){assert(200===e.status),assert(e.headers["x-mock"]===undefined),t()})["catch"](t)}),it("does not mock once removed (reset)",function(t){gpf.http.mock.reset(),e=undefined,gpf.http.get(r+"?status=200").then(function(e){assert(200===e.status),assert(e.headers["x-mock"]===undefined),t()})["catch"](t)}),it("does not fail if removed twice",function(){gpf.http.mock.reset(),gpf.http.mock.remove(e),e=undefined}))}),describe("Advanced mocking example",function(){var n;beforeEach(function(){function e(e){return function(){return{status:200,headers:{},responseText:"answer-"+e}}}gpf.http.mock({method:gpf.http.methods.get,url:/echo\/lifo/,response:e(1)}),gpf.http.mock({method:gpf.http.methods.get,url:/echo\/lifo/,response:e(2)}),n=gpf.http.mock({method:gpf.http.methods.get,url:/echo\/lifo/,response:e(3)}),gpf.http.mock({method:gpf.http.methods.put,url:/echo\/lifo/,response:e(4)}),gpf.http.mock({method:gpf.http.methods.get,url:/echo\/redirect/,response:function(e){return gpf.http.get(e.url.replace("/redirect","/lifo"))}})}),afterEach(function(){gpf.http.mock.reset()}),it("uses LIFO priority",function(t){gpf.http.get(r+"lifo").then(function(e){assert(200===e.status),assert("answer-3"===e.responseText),t()})["catch"](t)}),it("preserves the order when removing a mocked request",function(t){gpf.http.mock.remove(n),gpf.http.get(r+"lifo").then(function(e){assert(200===e.status),assert("answer-2"===e.responseText),t()})["catch"](t)}),it("allows redirection",function(t){gpf.http.get(r+"redirect").then(function(e){assert(200===e.status),assert("answer-3"===e.responseText),t()})["catch"](t)})})}),describe("stream/bufferedread",function(){describe("gpf.stream.BufferedRead",function(){function r(e){return e}var s=gpf.define({$class:"TestReadable",$extend:"gpf.stream.BufferedRead",appendToReadBuffer:function(e){return r(e),this._appendToReadBuffer.apply(this,arguments)},completeReadBuffer:function(){return this._completeReadBuffer()},setReadError:function(e){return this._setReadError(e)}});function i(e){var t=new gpf.stream.WritableArray;return gpf.stream.pipe(e,t).then(function(){return t.toArray()})}function n(e,t){i(e).then(function(e){assert(2===e.length),assert("Hello"===e[0]),assert("World!"===e[1]),t()})["catch"](t)}it("exposes IReadableStream",function(){assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IReadableStream,s))}),describe("data output",function(){it("outputs data before reading",function(e){var t=new s;t.appendToReadBuffer("Hello","World!").completeReadBuffer(),n(t,e)}),it("outputs data while reading",function(e){var t=new s;t.appendToReadBuffer("Hello"),n(t,e),t.appendToReadBuffer("World!").completeReadBuffer()}),it("outputs data after reading",function(e){var t=new s;n(t,e),t.appendToReadBuffer("Hello","World!").completeReadBuffer()})}),describe("error management",function(){function n(e,t){i(e).then(function(){throw new Error("Should fail")},function(e){assert("FAIL"===e.message),t()})["catch"](t)}function t(e,t){var n=new s;n.appendToReadBuffer("Hello","World!").completeReadBuffer(),gpf.stream.pipe(n,e).then(function(){throw new Error("Should fail")},function(e){assert("FAIL"===e.message),t()})["catch"](t)}it("generates errors before reading",function(e){var t=new s;t.appendToReadBuffer("Hello","World!").setReadError(new Error("FAIL")),n(t,e)}),it("generates errors while reading",function(e){var t=new s;t.appendToReadBuffer("Hello"),n(t,e),t.appendToReadBuffer("World!").setReadError(new Error("FAIL"))}),it("generates errors after reading",function(e){var t=new s;n(t,e),t.appendToReadBuffer("Hello","World!").setReadError(new Error("FAIL"))}),it("forwards errors (exception)",function(e){t({write:function(e){throw r(e),new Error("FAIL")}},e)}),it("forwards errors (reject)",function(e){t({write:function(e){return r(e),Promise.reject(new Error("FAIL"))}},e)})})})}),describe("stream/line",function(){function r(e){return e.write("abc").then(function(){return e.write("def\n")}).then(function(){return e.write("gh")}).then(function(){return e.write("ijkl\r")})}function s(e){return e.write("\nmnopqr\n").then(function(){return e.write("stuvwx\nyz")})}var i=["abcdef","ghijkl","mnopqr","stuvwx","yz"];function a(){return{_index:0,write:function(e){return e!==i[this._index]?Promise.reject("No match"):(++this._index,Promise.resolve())}}}it("generates lines out of any stream (read first)",function(e){var t=new gpf.stream.LineAdapter,n=a();t.read(n).then(function(){assert(n._index===i.length),e()})["catch"](e),r(t).then(function(){return s(t)}).then(function(){t.flush()})}),it("generates lines out of any stream (write first)",function(e){var t=new gpf.stream.LineAdapter,n=a();r(t).then(function(){return s(t)}).then(function(){return t.write("\n")}).then(function(){return t.flush()}).then(function(){return t.read(n)}).then(function(){assert(n._index===i.length),e()})["catch"](e)}),it("generates lines out of any stream (mixed)",function(e){var t=new gpf.stream.LineAdapter,n=a();r(t).then(function(){t.read(n).then(function(){assert(n._index===i.length),e()})["catch"](e),s(t).then(function(){t.flush()})})})}),describe("read",function(){var e=config.testPath+"data";describe("gpf.read",function(){it("gives a generic read access to the file system",function(n){gpf.read(gpf.path.join(e,"folder/hello world.txt")).then(function(e){try{assert("hello world\n"===e),n()}catch(e_){n(e_)}},n)}),it("fails if the file does not exist",function(n){gpf.read(gpf.path.join(e,"nope")).then(function(){n(new Error("Should not happen"))},function(e){try{assert(e instanceof Error),n()}catch(e_){n(e_)}})})})}),describe("require",function(){var a=config.testPath+"require";before(function(){gpf.require.configure({base:a})}),describe("gpf.require.resolve",function(){it("resolves relative path",function(){assert(gpf.require.resolve("file.js")===a+"/file.js")}),it("resolves relative path with folders",function(){assert(gpf.require.resolve("folder/file.js")===a+"/folder/file.js")}),it("resolves relative path with folders (use of ..)",function(){assert(gpf.require.resolve("../file.js")===a.split("/").slice(0,-1).join("/")+"/file.js")})}),describe("gpf.require.configure",function(){it("fails on invalid options",function(){var e;try{gpf.require.configure({unknown:!0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidRequireConfigureOption)});var e=[0,1,!1,!0,"","Hello World",{},new Date,function(){}];function t(e){return"object"!=typeof e}var n={base:function r(e){return"string"!=typeof e},cache:t,clearCache:function s(e){return"boolean"!=typeof e},preload:t,preprocess:function i(e){return"function"!=typeof e}};Object.keys(n).forEach(function(s){e.filter(n[s]).forEach(function(r){it("fails on invalid option value: "+s+"="+JSON.stringify(r),function(){var e;try{var t={};t[s]=r,gpf.require.configure(t)}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidRequireConfigureOptionValue)})})}),after(function(){gpf.require.configure({base:a})})}),describe("gpf.require.define",function(){function r(e){assert("object"==typeof e),assert("value"===e.member)}function t(e,t,n){assert("object"==typeof e),assert(t===e.type),n&&r(e.data)}describe("Asynchronous loading",function(){beforeEach(function(){gpf.require.configure({clearCache:!0})}),it("loads JSON file as an object",function(e){gpf.require.define({data:"data.json"},function(e){r(e.data)}).then(e,e)}),it("supports CommonJS format (static requires)",function(e){gpf.require.define({commonjs:"commonjs.js"},function(e){t(e.commonjs,"commonjs",!0)}).then(e,e)}),it("doesn't supports CommonJS format with static and dynamic requires",function(e){gpf.require.define({commonjs:"mixed_commonjs.js"}).then(function(){e(new Error("Should not happen"))},function(e){assert(e instanceof gpf.Error.NoCommonJSDynamicRequire)}).then(e,e)}),it("supports independant CommonJS format (no require)",function(e){gpf.require.define({commonjs:"indep_commonjs.js"},function(e){t(e.commonjs,"indep_commonjs",!0)}).then(e,e)}),it("doesn't supports CommonJS format with only dynamic requires",function(e){gpf.require.define({commonjs:"dynamic_commonjs.js"}).then(function(){e(new Error("Should not happen"))},function(e){assert(e instanceof gpf.Error.NoCommonJSDynamicRequire)}).then(e,e)}),it("supports AMD format (named with factory)",function(e){gpf.require.define({amd:"amd.js"},function(e){t(e.amd,"amd",!0)}).then(e,e)}),it("supports AMD format (no name)",function(e){gpf.require.define({amd:"anonymous_amd.js"},function(e){t(e.amd,"amd",!1),assert(""===e.amd.name)}).then(e,e)}),it("supports AMD format (anonymous static)",function(e){gpf.require.define({amd:"static_amd.js"},function(e){t(e.amd,"amd",!1),assert("static"===e.amd.name)}).then(e,e)}),it("supports GPF modules (gpf is defined)",function(e){gpf.require.define({gpf:"gpf.js"},function(e){t(e.gpf,"gpf",!0)}).then(e,e)}),it("supports GPF modules without constant value",function(e){gpf.require.define({constants:"constants.js"},function(e){assert("World!"===e.constants.hello)}).then(e,e)}),it("supports JavaScript file (no result)",function(e){gpf.context().test={},gpf.require.define({js:"empty.js"},function(e){try{assert(e.js===undefined),assert(gpf.context().test.empty)}finally{delete gpf.context().test}}).then(e,e)}),it("supports text file (no processor)",function(e){gpf.require.define({text:"../data/folder/hello world.txt"},function(e){assert("hello world\n"===e.text)}).then(e,e)})}),describe("Recursive loading",function(){beforeEach(function(){gpf.require.configure({clearCache:!0})}),it("loads everything recursively",function(e){gpf.require.define({all:"folder/all.js"},function(e){t(e.all.amd,"amd",!0),t(e.all.commonjs,"commonjs",!0),r(e.all.data),t(e.all.gpf,"gpf",!0)}).then(e,e)})}),describe("Error handling",function(){it("fails if resource does not exist",function(e){gpf.require.define({notFound:"notFound.js"}).then(function(){e(new Error("Should not happen"))},function(e){assert(e instanceof Error),assert("Should not happen"!==e.message)}).then(e,e)}),it("fails if one javascript resource fails",function(e){gpf.require.define({error:"error.js"}).then(function(){e(new Error("Should not happen"))},function(e){assert(e instanceof Error),assert("FAIL!"===e.message)}).then(e,e)})})}),describe("caching",function(){beforeEach(function(){gpf.require.configure({clearCache:!0})}),describe("caching of loaded parts",function(){var t={};beforeEach(function(e){gpf.require.define({data:"data.json"},function(e){e.data.additional=t}).then(e,e)}),it("keeps modified objects",function(e){gpf.require.define({data:"data.json"},function(e){assert(t===e.data.additional)}).then(e,e)})}),describe("cache injection",function(){var t={};function e(){it("keeps injected objects",function(e){gpf.require.define({data:"data.json"},function(e){assert(t===e.data)}).then(e,e)})}beforeEach(function(){var e={};e[gpf.require.resolve("data.json")]=t,gpf.require.configure({clearCache:!0,cache:e})}),e(),describe("clearCache = false",function(){beforeEach(function(){gpf.require.configure({clearCache:!1})}),e()})}),describe("error documentation",function(){function r(e,t,n){assert(e instanceof Error),assert(Array.isArray(e.requires)),assert(e.requires.length>t),assert(-1!==e.requires[t].indexOf(n))}it("documents the failing resource name (missing json)",function(e){gpf.require.define({test:"notFound.json"}).then(function(){return Promise.reject(0)})["catch"](function(e){r(e,0,"require/notFound.json")}).then(e,e)}),it("documents the failing resource name (error in javascript)",function(e){gpf.require.define({test:"syntax_error.js"}).then(function(){return Promise.reject(0)})["catch"](function(e){r(e,0,"require/syntax_error.js")}).then(e,e)}),it("documents the loading stack",function(n){gpf.require.define({test:"error_stack.js"}).then(function(){return Promise.reject(0)})["catch"](function(e){try{r(e,0,"require/syntax_error.js"),r(e,1,"require/error_stack.js"),n()}catch(e_){n(e_)}})}),"function"==typeof SyntaxError&&it("transmits the native error",function(n){gpf.require.define({test:"syntax_error.js"}).then(function(){return Promise.reject(0)})["catch"](function(e){try{r(e,0,"require/syntax_error.js"),assert(e instanceof SyntaxError),n()}catch(e_){n(e_)}})})})}),describe("preloading",function(){function e(){gpf.require.define({data:"data.js"},function(e){return e.data})}function t(){module.exports="Hello World!"}function n(e){var t=e.toString(),n=t.indexOf("{"),r=t.lastIndexOf("}");return t.substring(n+1,r)}beforeEach(function(){gpf.require.configure({clearCache:!0,base:"",preload:{"preload/test.js":n(e),"preload/data.js":n(t)}})}),it("loads everything recursively",function(e){gpf.require.define({result:"preload/test.js"},function(e){assert("Hello World!"===e.result)}).then(e,e)})}),describe("preprocessing",function(){it("allows on the fly modification of a resource",function(e){gpf.require.configure({clearCache:!0,base:a,preprocess:function(e){return e.name.endsWith("preprocess.ext")&&(assert(e.content.startsWith("WILL BE REPLACED")),assert(".ext"===e.type),e.content="module.exports = 'Hello World!';",e.type=".js"),Promise.resolve(e)}}),gpf.require.define({result:"preprocess.ext"},function(e){assert("Hello World!"===e.result)}).then(e,e)})})}),describe("stream/array",function(){var s=["Hell","o ","World",null,{}];function i(n,e){try{assert(s.length===n.length),s.forEach(function(e,t){assert(e===n[t])}),e()}catch(e_){e(e_)}}describe("gpf.stream.ReadableArray",function(){it("writes each array item sequentially",function(e){var t=new gpf.stream.ReadableArray(s),n=[];t.read({write:function(e){return n.push(e),Promise.resolve()}}).then(function(){i(n,e)},e)})}),describe("gpf.stream.WritableArray",function(){it("stores each call as an array item",function(e){var t=new gpf.stream.WritableArray,n=0;!function r(){s.length===n?i(t.toArray(),e):t.write(s[n++]).then(r,e)}()})})}),describe("stream/pipe",function(){function t(e){return e}describe("parameters validation",function(){function n(e){t(e)}function r(e){t(e)}it("fails if the first parameter is not an IReadableStream",function(){var e;try{gpf.stream.pipe({})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),it("fails if no destination",function(){var e;try{gpf.stream.pipe({read:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),describe("handling a sequence with more than two streams",function(){it("misses intermediate read",function(){var e;try{gpf.stream.pipe({read:n},{write:r},{write:r})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),it("misses intermediate write",function(){var e;try{gpf.stream.pipe({read:n},{read:n},{write:r})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),it("does not end with write",function(){var e;try{gpf.stream.pipe({read:n},{read:n,write:r},{})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)})})});var r={_readRejectError:function(e){return t(e),Promise.reject("FAIL")},_readThrowError:function(e){throw t(e),new Error("FAIL")},_writeRejectError:function(e){return t(e),Promise.reject("FAIL")},_writeThrowError:function(e){throw t(e),new Error("FAIL")},_wrapForRejectionHandler:function(e,t){e.then(function(){throw new Error("Should fail")},function(e){assert("FAIL"===e),t()})["catch"](t)},_wrapForExceptionHandler:function(e,t){e.then(function(){throw new Error("Should fail")},function(e){assert("FAIL"===e.message),t()})["catch"](t)}};function s(){var r,s,i,a,o;function t(){if(i||(i=new Promise(function(e,t){a=e,o=t})),s&&r){var e=i,t=a,n=o;return s.write(r).then(t,n),r=undefined,s=undefined,i=undefined,a=undefined,o=undefined,e}return i}return{read:function(e){if(s)throw new Error("Already reading");return s=e,t()},write:function(e){if(r)throw new Error("Buffer full");return r=e,t()}}}function i(e){var t=new gpf.stream.ReadableArray(["Hello ","World!","\n","Goodbye!"]),n=new gpf.stream.WritableArray;return gpf.stream.pipe.apply(gpf.stream,[t].concat(e,n)).then(function(){return n})}function n(e,n){i(e).then(function(e){var t=e.toArray();assert(2===t.length),assert("Hello World!"===t[0]),assert("Goodbye!"===t[1]),n()})["catch"](n)}describe("IReadableStream -> IWritableStream",function(){it("Transfer data",function(e){var t=new gpf.stream.WritableString;gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),t).then(function(){assert("Hello World"===t.toString()),e()})["catch"](e)}),it("Triggers flush when the read ends",function(e){var t=new gpf.stream.WritableString,n=!1;t.flush=function(){return n=!0,Promise.resolve()},gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),t).then(function(){assert("Hello World"===t.toString()),assert(n),e()})["catch"](e)}),it("Forward errors (read - reject)",function(e){var t=new gpf.stream.WritableString,n={read:r._readRejectError};r._wrapForRejectionHandler(gpf.stream.pipe(n,t),e)}),it("Forward errors (read - exception)",function(e){var t=new gpf.stream.WritableString,n={read:r._readThrowError};r._wrapForExceptionHandler(gpf.stream.pipe(n,t),e)}),it("Forward errors (write - reject)",function(e){var t={write:r._writeRejectError};r._wrapForRejectionHandler(gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),t),e)}),it("Forward errors (write - exception)",function(e){var t={write:r._writeThrowError};r._wrapForExceptionHandler(gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),t),e)})}),describe("IReadableStream -> IReadableStream/IWritableStream* -> IWritableStream",function(){it("handles the whole stream",function(e){n([new gpf.stream.LineAdapter],e)}),it("handles non flushable intermediate stream",function(e){n([s(),new gpf.stream.LineAdapter],e)}),it("Forward errors (read - reject)",function(e){var t=s();t.read=r._readRejectError,r._wrapForRejectionHandler(i([t,new gpf.stream.LineAdapter]),e)}),it("Forward errors (read - exception)",function(e){var t=s();t.read=r._readThrowError,r._wrapForExceptionHandler(i([t,new gpf.stream.LineAdapter]),e)}),it("Forward errors (write - reject)",function(e){var t=s();t.write=r._writeRejectError,r._wrapForRejectionHandler(i([t,new gpf.stream.LineAdapter]),e)}),it("Forward errors (write - exception)",function(e){var t=s();t.write=r._writeThrowError,r._wrapForExceptionHandler(i([t,new gpf.stream.LineAdapter]),e)}),it("Forward errors (second read - reject)",function(e){var t=s(),n=s();n.read=r._readRejectError,r._wrapForRejectionHandler(i([t,n,new gpf.stream.LineAdapter]),e)}),it("Forward errors (second read - exception)",function(e){var t=s(),n=s();n.read=r._readThrowError,r._wrapForExceptionHandler(i([t,n,new gpf.stream.LineAdapter]),e)}),it("Forward errors (second write - reject)",function(e){var t=s(),n=s();n.write=r._writeRejectError,r._wrapForRejectionHandler(i([t,n,new gpf.stream.LineAdapter]),e)}),it("Forward errors (second write - exception)",function(e){var t=s(),n=s();n.write=r._writeThrowError,r._wrapForExceptionHandler(i([t,n,new gpf.stream.LineAdapter]),e)})}),gpf.stream.BufferedRead&&gpf.stream.ReadableArray&&gpf.stream.WritableArray&&(describe("Data demultiplexing (one read generates several writes)",function(){var n;before(function(){n=gpf.define({$class:"Demultiplexer",$extend:"gpf.stream.BufferedRead",write:function(e){return this._appendToReadBuffer(3*e),this._appendToReadBuffer(3*e+1),this._appendToReadBuffer(3*e+2),Promise.resolve()},flush:function(){return this._completeReadBuffer(),Promise.resolve()}})}),it("Waits for all data to be processed",function(r){var e=new gpf.stream.ReadableArray([0,1,2]),t=new n,s=new gpf.stream.WritableArray;gpf.stream.pipe(e,t,s).then(function(){try{var e,t=s.toArray();for(assert(9===t.length),e=0;e<9;++e)assert(t[e]===e);r()}catch(e_){r(e_)}})})}),describe("Data multiplexing (several reads generate one write)",function(){var n;before(function(){n=gpf.define({$class:"Multiplexer",$extend:"gpf.stream.BufferedRead",write:function(e){return e%3==2&&this._appendToReadBuffer((e-2)/3),Promise.resolve()},flush:function(){return this._completeReadBuffer(),Promise.resolve()}})}),it("Waits for all data to be processed",function(r){var e=new gpf.stream.ReadableArray([0,1,2,3,4,5,6,7,8]),t=new n,s=new gpf.stream.WritableArray;gpf.stream.pipe(e,t,s).then(function(){try{var e,t=s.toArray();for(assert(3===t.length),e=0;e<3;++e)assert(t[e]===e);r()}catch(e_){r(e_)}})})}))}),describe("stream/csv/parser",function(){describe("gpf.stream.csv.Parser",function(){function e(e){var t=new gpf.stream.ReadableArray(e.lines),n=new gpf.stream.WritableArray;return gpf.stream.pipe(t,e.parser,n).then(function(){return n.toArray()})}function t(s,t){e(s).then(function(e){assert(e.length===s.expected.length),e.forEach(function(t,e){var n=s.expected[e],r=Object.keys(t);assert(r.join(",")===Object.keys(n).join(",")),r.forEach(function(e){assert(t[e]===n[e])})}),t()})["catch"](t)}it("reads a one-column CSV file",function(e){t({lines:["LINE","0","1"],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0"},{LINE:"1"}]},e)}),it("reads a CSV file",function(e){t({lines:["LINE;VALUE","0;ABC","1;DEF"],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0",VALUE:"ABC"},{LINE:"1",VALUE:"DEF"}]},e)}),it("supports value quoting",function(e){t({lines:["LINE;VALUE",'0;"ABC"',"1;DEF",'2;GH"I','3;"JK""L"','4;"MN','O"'],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0",VALUE:"ABC"},{LINE:"1",VALUE:"DEF"},{LINE:"2",VALUE:'GH"I'},{LINE:"3",VALUE:'JK"L'},{LINE:"4",VALUE:"MN\nO"}]},e)}),it("supports quoting the separator as well",function(e){t({lines:["LINE;VALUE",'0;"A;BC"'],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0",VALUE:"A;BC"}]},e)}),it("supports header being specified as an option",function(e){t({lines:["0;ABC","1;DEF"],parser:new gpf.stream.csv.Parser({header:"LINE;VALUE"}),expected:[{LINE:"0",VALUE:"ABC"},{LINE:"1",VALUE:"DEF"}]},e)}),it("supports empty values",function(e){t({lines:["LINE;VALUE;VALUE2",";AB;CD","1;;EF","2;GH"],parser:new gpf.stream.csv.Parser,expected:[{LINE:"",VALUE:"AB",VALUE2:"CD"},{LINE:"1",VALUE:"",VALUE2:"EF"},{LINE:"2",VALUE:"GH"}]},e)}),it("detects unterminated quoted string",function(t){e({lines:["LINE;VALUE",'0;"A',"BC"],parser:new gpf.stream.csv.Parser}).then(function(){t(new Error("Should fail"))},function(e){assert(e instanceof gpf.Error.InvalidCSV),t()})["catch"](t)}),it("detects invalid quoted string",function(t){e({lines:["LINE;VALUE",'0;"A"BC"'],parser:new gpf.stream.csv.Parser}).then(function(){t(new Error("Should fail"))},function(e){assert(e instanceof gpf.Error.InvalidCSV),t()})["catch"](t)}),it("supports different separator, quote and new line specifiers",function(e){t({lines:["LINE\tVALUE\tVALUE2","0\t\t'A''B","\tC'"],parser:new gpf.stream.csv.Parser({separator:"\t",quote:"'",newLine:"\r\n"}),expected:[{LINE:"0",VALUE:"",VALUE2:"A'B\r\n\tC"}]},e)})})}),describe("attributes/attribute",function(){it("is abstract",function(){var e;try{var t=new gpf.attributes.Attribute;throw new Error(t.toString())}catch(e_){e=e_}assert(e instanceof gpf.Error.AbstractClass)}),describe("basic usage",function(){var e,t,n,r,s;before(function(){e=gpf.define({$class:"MyAttribute",$extend:gpf.attributes.Attribute}),n=new e,r=new e,s=new e,t=gpf.define({$class:"MyClassWithAttributes",$attributes:[r],"[member]":[s],member:"Hello World"})}),it("does not provide any information when not used",function(){assert(n.getClassConstructor()===undefined),assert(n.getMemberName()===undefined)}),it("provides class constructor information",function(){assert(r.getClassConstructor()===t),assert(s.getClassConstructor()===t)}),it("provides member name information",function(){assert(r.getMemberName()===undefined),assert("member"===s.getMemberName())})}),describe("$singleton usage",function(){var e,t,n;before(function(){e=gpf.define({$class:"MyAttribute",$extend:gpf.attributes.Attribute,$singleton:!0}),t=new e,n=new e,gpf.define({$class:"MyClassWithAttributes",$attributes:[t],"[member]":[n],member:"Hello World"})}),it("does not provide class constructor information",function(){assert(t.getClassConstructor()===undefined),assert(n.getClassConstructor()===undefined)}),it("does not provide member name information",function(){assert(t.getMemberName()===undefined),assert(n.getMemberName()===undefined)})})}),describe("define/class/attributes/check",function(){var t=gpf.define({$class:"MyAttribute",$extend:"gpf.attributes.Attribute",_value:undefined,getValue:function(){return this._value},constructor:function(e){this._value=e}});describe("attributes validation",function(){it("allows only existing members",function(){var e;try{gpf.define({$class:"Test1","[t3st]":[],test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.UnknownAttributesSpecification)}),it("allows only an array (of attributes) - member",function(){var e;try{gpf.define({$class:"Test1","[test]":{},test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidAttributesSpecification)}),it("allows only an array (of attributes) - class",function(){var e;try{gpf.define({$class:"Test1",$attributes:{},test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidAttributesSpecification)}),it("allows only an array of attributes - member",function(){var e;try{gpf.define({$class:"Test1","[test]":[{}],test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidAttributesSpecification)}),it("allows only an array of attributes - class",function(){var e;try{gpf.define({$class:"Test1",$attributes:[{}],test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidAttributesSpecification)})}),describe("attributes definition",function(){it("does not expose new members",function(){var e=gpf.define({$class:"MyClassWithAttributes",$attributes:[new t("class")],"[test]":[new t("member")],test:0});assert(undefined===e.prototype["[test]"])})})}),describe("attributes",function(){var t,e={$extend:"gpf.attributes.Attribute",_value:undefined,getValue:function(){return this._value},constructor:function(e){this._value=e}},n=gpf.define(Object.assign({$class:"MyAttribute1"},e)),r=gpf.define(Object.assign({$class:"MyAttribute2"},e)),s=gpf.define({$class:"MyClassWithoutAttributes"}),i=gpf.define({$class:"MyClass",$attributes:[new n("A"),new n("B"),new r("C")],"[value]":[new n("D")],value:0}),a=gpf.define({$class:"MyClass",$extend:i,$attributes:[new n("E"),new r("F")],"[value]":[new r("G")],"[value2]":[new n("H")],value2:1});function o(){i.apply(this,arguments)}o.prototype=Object.create(i.prototype),Object.assign(o.prototype,{constructor:o,value3:2}),t=gpf.define({$class:"MyClass",$extend:o,$attributes:[new n("E"),new r("F")],"[value]":[new r("G")],"[value3]":[new n("I"),new n("J")],"[value2]":[new n("H")],value2:1}),describe("gpf.attributes.get",function(){[undefined,null,0,1,!1,!0,"","Hello World"].forEach(function(n){it("fails if the parameter is not correct ("+JSON.stringify(n)+")",function(){var e;try{gpf.attributes.get(n)}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidParameter)})}),it("returns an empty object if the class was not allocated by gpf.define",function(){var e=gpf.attributes.get(String);assert(0===Object.keys(e).length)}),it("returns an empty object if no attributes",function(){var e=gpf.attributes.get(s);assert(0===Object.keys(e).length)}),it("retrieves all attributes (on class)",function(){var e=gpf.attributes.get(i);assert(2===Object.keys(e).length),assert(3===e.$attributes.length),assert(1===e.value.length),assert("D"===e.value[0].getValue())}),it("retrieves all attributes (on instance)",function(){var e=new i,t=gpf.attributes.get(e);assert(2===Object.keys(t).length),assert(3===t.$attributes.length),assert(1===t.value.length),assert("D"===t.value[0].getValue())}),it("filters on a given attribute class",function(){var e=gpf.attributes.get(i,r);assert(1===Object.keys(e).length),assert(1===e.$attributes.length),assert("C"===e.$attributes[0].getValue())}),describe("with native inheritance",function(){it("retrieves all attributes (on class)",function(){var e=gpf.attributes.get(o);assert(2===Object.keys(e).length),assert(3===e.$attributes.length),assert(1===e.value.length),assert("D"===e.value[0].getValue())}),it("retrieves all attributes (on instance)",function(){var e=new o,t=gpf.attributes.get(e);assert(2===Object.keys(t).length),assert(3===t.$attributes.length),assert(1===t.value.length),assert("D"===t.value[0].getValue())}),describe("followed by GPF inheritance",function(){it("retrieves all attributes (on class)",function(){var e=gpf.attributes.get(t);assert(4===Object.keys(e).length),assert(5===e.$attributes.length),assert(2===e.value.length),assert(2===e.value3.length),assert("H"===e.value2[0].getValue())})})}),describe("with GPF inheritance",function(){it("retrieves all attributes (on class)",function(){var e=gpf.attributes.get(a);assert(3===Object.keys(e).length),assert(5===e.$attributes.length),assert(2===e.value.length),assert("H"===e.value2[0].getValue())}),it("filters on a given attribute class",function(){var e=gpf.attributes.get(a,n);assert(3===Object.keys(e).length),assert(3===e.$attributes.length),assert("H"===e.value2[0].getValue())})})})}),config.features.es6class&&include("attributes.es6"),describe("stream/filter",function(){var a=[{id:0,num:5,str:"e",group:1,search:"first"},{id:1,num:1,str:"b",group:0,search:"second"},{id:2,num:4,str:"a",group:1,search:"third"},{id:3,num:2,str:"d",group:0,search:"fourth"},{id:4,num:3,str:"c",group:1,search:"fifth"}];function t(e,n,r){var t=new gpf.stream.ReadableArray(a),s=new gpf.stream.Filter(e),i=new gpf.stream.WritableArray;gpf.stream.pipe(t,s,i).then(function(){!function t(e,n){assert(e.length===n.length),assert(e.every(function(e,t){return e.id===n[t]}))}(i.toArray(),n),r()})["catch"](r)}describe("gpf.stream.Filter",function(){it("forwards errors",function(t){var e=new gpf.stream.ReadableArray(a),n=new gpf.stream.Filter(function(){return!0}),r={write:function(e){return Promise.reject("KO")}};gpf.stream.pipe(e,n,r).then(function(){throw new Error("Not expected")},function(e){assert("KO"===e),t()})["catch"](t)}),it("filters data - no result",function(e){t(function(){return!1},[],e)}),it("filters data - one result",function(e){t(function(e){return 1===e.num},[1],e)}),it("filters data - several results",function(e){t(function(e){return 1===e.group},[0,2,4],e)}),it("filters data - all results",function(e){t(function(){return!0},[0,1,2,3,4],e)})})}),describe("stream/map",function(){var a=[{id:0},{id:1},{id:2},{id:3},{id:4}];function r(e,n,r){var t=new gpf.stream.ReadableArray(a),s=new gpf.stream.Map(e),i=new gpf.stream.WritableArray;gpf.stream.pipe(t,s,i).then(function(){!function t(e,n){assert(e.length===n.length),assert(e.every(function(e,t){return e===n[t]}))}(i.toArray(),n),r()})["catch"](r)}function s(e){return e}describe("gpf.stream.Map",function(){it("forwards errors",function(t){var e=new gpf.stream.ReadableArray(a),n=new gpf.stream.Map(s),r={write:function(e){return s(e),Promise.reject("KO")}};gpf.stream.pipe(e,n,r).then(function(){throw new Error("Not expected")},function(e){assert("KO"===e),t()})["catch"](t)}),it("maps data - identity",function(e){r(s,a,e)}),it("filters data - one substitution",function(e){var t={};function n(e){return 2===e.id?t:e}r(n,a.map(n),e)}),it("filters data - several substitutions",function(e){r(function(e){return e.id},[0,1,2,3,4],e)})})}),describe("interfaces/promisify",function(){describe("gpf.interfaces.promisify",function(){var n,r,s;before(function(){n=gpf.define({$interface:"ISample",test:function(e){!function t(e){return e}(e)}}),r=gpf.interfaces.promisify(n),s=gpf.define({$class:"SampleImpl",test:function(e){if(0===e)throw new Error("OK");return e+1}})}),it("accepts only an object implementing the interface",function(){var e;try{r({notTheExpectedTestMethod:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),it("leverages IUnkown",function(){var e;try{r({queryInterface:function(e){if(e===n)return new s}})}catch(e_){e=e_}assert(!e)}),it("allows chaining",function(t){r(new s).test(1).test(2).test(3).then(function(e){assert(4===e),t()})["catch"](t)}),it("forwards errors",function(n){r(new s).test(1).test(0).test(3).then(function(){assert(!1)})["catch"](function(e){try{assert("OK"===e.message),n()}catch(e_){n(e_)}})}),it("offers advanced promise chaining",function(t){r(new s).test(1).test(2).then(function(){return 0}).then(function(e){assert(0===e)}).test(3).then(function(e){assert(4===e),t()})["catch"](t)})})}),describe("xml/writer",function(){var s;function n(t,n){var e=new gpf.xml.Writer,r=new gpf.stream.WritableString;return gpf.stream.pipe(e,r).then(function(){try{n(r.toString()),t()}catch(e_){t(e_)}}),s||(s=gpf.interfaces.promisify(gpf.interfaces.IXmlContentHandler)),s(e)}function r(){assert(!1)}function i(n,r){return function(e){try{assert(e instanceof r),n()}catch(e_){n(e_)}}}function t(e){return i(e,gpf.Error.InvalidXmlWriterState)}function a(e){return i(e,gpf.Error.InvalidXmlUseOfPrefixXml)}describe("Interface specification",function(){it("implements gpf.interfaces.IXmlContentHandler",function(){assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IXmlContentHandler,gpf.xml.Writer))}),it("implements gpf.interfaces.IReadableStream",function(){assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IReadableStream,gpf.xml.Writer))}),it("can be piped",function(e){n(e,function(e){assert("<document/>"===e)}).startDocument().startElement("document").endElement().endDocument()["catch"](e)})}),describe("Basic manipulations",function(){it("allows processing instructions",function(e){n(e,function(e){assert("<?test test-data?>\n<document/>"===e)}).startDocument().processingInstruction("test","test-data").startElement("document").endElement().endDocument()["catch"](e)}),it("supports attributes (string value)",function(e){n(e,function(e){assert('<document test="value"/>'===e)}).startDocument().startElement("document",{"test":"value"}).endElement().endDocument()["catch"](e)}),it("supports attributes (number value)",function(e){n(e,function(e){assert('<document test="2"/>'===e)}).startDocument().startElement("document",{"test":2}).endElement().endDocument()["catch"](e)}),it("supports multiple attributes",function(e){n(e,function(e){assert('<document test1="value1" test2="value2"/>'===e||'<document test2="value2" test1="value1"/>'===e)}).startDocument().startElement("document",{"test1":"value1","test2":"value2"}).endElement().endDocument()["catch"](e)}),it("supports nodes hierarchy",function(e){n(e,function(e){assert("<document><a><b/></a><c/></document>"===e)}).startDocument().startElement("document").startElement("a").startElement("b").endElement().endElement().startElement("c").endElement().endElement().endDocument()["catch"](e)}),it("escapes attributes value",function(e){n(e,function(e){assert('<document test="&lt;&amp;&gt;"/>'===e)}).startDocument().startElement("document",{test:"<&>"}).endElement().endDocument()["catch"](e)}),it("escapes text value",function(e){n(e,function(e){assert("<document>&lt;&amp;&gt;</document>"===e)}).startDocument().startElement("document").characters("<&>").endElement().endDocument()["catch"](e)})}),describe("Namespacing",function(){it("qualifies elements (using prefix)",function(e){n(e,function(e){assert('<test:document xmlns:test="namespace-uri"/>'===e)}).startDocument().startPrefixMapping("test","namespace-uri").startElement("test:document").endElement().endPrefixMapping("test").endDocument()["catch"](e)}),it("qualifies elements (default namespace)",function(e){n(e,function(e){assert('<document xmlns="namespace-uri"/>'===e)}).startDocument().startPrefixMapping("","namespace-uri").startElement("document").endElement().endPrefixMapping("").endDocument()["catch"](e)}),it("qualifies attributes",function(e){n(e,function(e){assert('<document ns0:test="value" xmlns:ns0="namespace-uri"/>'===e||'<document xmlns:ns0="namespace-uri" ns0:test="value"/>'===e)}).startDocument().startPrefixMapping("ns0","namespace-uri").startElement("document",{"ns0:test":"value"}).endElement().endPrefixMapping("ns0").endDocument()["catch"](e)}),it("allows xml namespace prefix",function(e){n(e,function(e){assert('<document xml:space="preserve"> </document>'===e)}).startDocument().startElement("document",{"xml:space":"preserve"}).characters(" ").endElement().endDocument()["catch"](e)})}),describe("Invalid XML state",function(){it("must start with a document",function(e){n(e,r).startElement("document")["catch"](t(e))}),it("forbids processing instructions once an element is added",function(e){n(e,r).startDocument().startElement("document").processingInstruction("test","test-data")["catch"](t(e))}),it("makes sure all opened elements are closed (endElement)",function(e){n(e,r).startDocument().startElement("document").endElement().endElement()["catch"](t(e))}),it("makes sure all opened elements are closed (endDocument)",function(e){n(e,r).startDocument().startElement("document").endDocument()["catch"](t(e))}),it("makes sure a namespace prefix is declared before usage",function(e){n(e,r).startDocument().startElement("test:document")["catch"](function t(e){return i(e,gpf.Error.UnknownXmlNamespacePrefix)}(e))}),it("prevents overloading a namespace prefix at the same level",function(e){n(e,r).startDocument().startPrefixMapping("test","namespace-uri").startPrefixMapping("test","namespace-uri2").endDocument()["catch"](t(e))}),it("prevents overloading of predefined namespace prefix (xml)",function(e){n(e,r).startDocument().startPrefixMapping("xml","namespace-uri")["catch"](a(e))}),it("prevents overloading of predefined namespace prefix (xmlns)",function(e){n(e,r).startDocument().startPrefixMapping("xmlns","namespace-uri")["catch"](function t(e){return i(e,gpf.Error.InvalidXmlUseOfPrefixXmlns)}(e))}),it("validates element name",function(e){n(e,r).startDocument().startElement("docu/ment")["catch"](function t(e){return i(e,gpf.Error.InvalidXmlElementName)}(e))}),it("validates element name (using xml prefix)",function(e){n(e,r).startDocument().startElement("xml:document")["catch"](a(e))}),it("validates attribute name",function(e){n(e,r).startDocument().startElement("document",{"te/st":"value"})["catch"](function t(e){return i(e,gpf.Error.InvalidXmlAttributeName)}(e))}),it("validates namespace prefix",function(e){n(e,r).startDocument().startPrefixMapping("te/st","namespace-uri")["catch"](function t(e){return i(e,gpf.Error.InvalidXmlNamespacePrefix)}(e))}),it("allows only xml:space attribute",function(e){n(e,r).startDocument().startElement("document",{"xml:lang":"en"})["catch"](a(e))})})}),describe("foreachasync",function(){var i=[0,1,2,3,4,5,6,7,8,9],a={};describe("gpf.forEachAsync",function(){[undefined,0,1,!1,!0,null].forEach(function(n){it("rejects invalid parameter ("+JSON.stringify(n)+")",function(){var e;try{gpf.forEachAsync(n,function(){assert(!0)})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidParameter)})}),it("enumerates an array synchronously",function(e){var r=0,s=0;gpf.forEachAsync(i,function(e,t,n){assert(this===a),assert("number"==typeof t),assert(n===i),++r,s+=e},a).then(function(){assert(i.length===r),assert(45===s),e()})["catch"](e)}),it("enumerates an array asynchronously",function(e){var r=0,s=0;gpf.forEachAsync(i,function(e,t,n){return assert(this===a),assert("number"==typeof t),assert(n===i),++r,s+=e,Promise.resolve()},a).then(function(){assert(i.length===r),assert(45===s),e()})["catch"](e)}),it("catches any error",function(t){gpf.forEachAsync(i,function(){throw new Error("OK")}).then(function(){t(new Error("Not expected"))},function(e){assert("OK"===e.message),t()})["catch"](t)}),it("catches any rejected promise",function(t){gpf.forEachAsync(i,function(){return Promise.reject("OK")}).then(function(){t(new Error("Not expected"))},function(e){assert("OK"===e),t()})["catch"](t)})})}),describe("serial/property",function(){if(gpf.internals){var r=gpf.internals._gpfSerialPropertyCheck,e=["",0,1,{},new Date,!0,!1,"123"];describe("_gpfSerialPropertyCheck",function(){it("validates name and default properties",function(){var e=r({name:"OK"});assert(e.type===gpf.serial.types.string),assert(!1===e.required),assert(e.readOnly===undefined)}),it("validates properties",function(){var e;try{r({name:"OK",type:gpf.serial.types.string,required:!1,readOnly:!1})}catch(e_){e=e_}assert(!e)}),e.concat(undefined).forEach(function(n){it("rejects invalid 'name' ("+JSON.stringify(n)+")",function(){var e;try{r({name:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidSerialName)})}),e.forEach(function(n){it("rejects invalid 'type' ("+JSON.stringify(n)+")",function(){var e;try{r({name:"OK",type:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidSerialType)})}),e.filter(function(e){return"boolean"!=typeof e}).forEach(function(n){it("rejects invalid 'required' ("+JSON.stringify(n)+")",function(){var e;try{r({name:"OK",required:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidSerialRequired)})}),e.filter(function(e){return"boolean"!=typeof e}).forEach(function(n){it("rejects invalid 'readOnly' ("+JSON.stringify(n)+")",function(){var e;try{r({name:"OK",readOnly:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidSerialReadOnly)})})})}}),describe("attributes/classattribute",function(){describe("gpf.attributes.ClassAttribute",function(){it("can't be used on a non-attribute class",function(){var e;try{gpf.define({$class:"B",$attributes:[new gpf.attributes.ClassAttribute]})}catch(e_){e=e_}assert(e instanceof gpf.Error.RestrictedBaseClassAttribute)}),it("can't be used on a member of an attribute class",function(){var e;try{gpf.define({$class:"Attribute",$extend:gpf.attributes.Attribute,"[test]":[new gpf.attributes.ClassAttribute],test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.ClassAttributeOnly)}),it("can't be used twice",function(){var e;try{gpf.define({$class:"Attribute",$extend:gpf.attributes.Attribute,$attributes:[new gpf.attributes.ClassAttribute,new gpf.attributes.ClassAttribute],test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.UniqueAttributeUsedTwice)}),describe("When used properly",function(){var e,n;before(function(){e=gpf.define({$class:"Attribute",$extend:gpf.attributes.Attribute,$attributes:[new gpf.attributes.ClassAttribute]}),n=new e}),it("fails definition if used at member level",function(){var e;try{gpf.define({$class:"Test","[test]":[n],test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.ClassAttributeOnly)}),it("accepts definition if used at class level",function(){var e;try{gpf.define({$class:"Test",$attributes:[n]})}catch(e_){e=e_}assert(!e)})})})}),describe("attributes/memberattribute",function(){describe("gpf.attributes.MemberAttribute",function(){it("can't be used on a non-attribute class",function(){var e;try{gpf.define({$class:"B",$attributes:[new gpf.attributes.MemberAttribute]})}catch(e_){e=e_}assert(e instanceof gpf.Error.RestrictedBaseClassAttribute)}),it("can't be used on a member of an attribute class",function(){var e;try{gpf.define({$class:"Attribute",$extend:gpf.attributes.Attribute,"[test]":[new gpf.attributes.MemberAttribute],test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.ClassAttributeOnly)}),it("can't be used twice",function(){var e;try{gpf.define({$class:"Attribute",$attributes:[new gpf.attributes.MemberAttribute,new gpf.attributes.MemberAttribute],$extend:gpf.attributes.Attribute,test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.UniqueAttributeUsedTwice)}),describe("When used properly",function(){var e,n;before(function(){e=gpf.define({$class:"Attribute",$extend:gpf.attributes.Attribute,$attributes:[new gpf.attributes.MemberAttribute]}),n=new e}),it("fails definition if used at class level",function(){var e;try{gpf.define({$class:"Test",$attributes:[n]})}catch(e_){e=e_}assert(e instanceof gpf.Error.MemberAttributeOnly)}),it("accepts definition if used at member level",function(){var e;try{gpf.define({$class:"Test","[test]":[n],test:function(){}})}catch(e_){e=e_}assert(!e)})})})}),describe("attributes/attributeforinstanceof",function(){describe("gpf.attributes.AttributeForInstanceOf",function(){var s,n;before(function(){s=gpf.define({$class:"A",$abstract:!0}),n=new gpf.attributes.AttributeForInstanceOf(s)}),it("requires a base class (no parameter)",function(){var e;try{var t=new gpf.attributes.AttributeForInstanceOf;throw new Error(t.toString())}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidParameter)}),it("requires a base class (not a function)",function(){var e;try{var t=new gpf.attributes.AttributeForInstanceOf(0);throw new Error(t.toString())}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidParameter)}),it("can't be used on a non-attribute class",function(){var e;try{gpf.define({$class:"B",$attributes:[n]})}catch(e_){e=e_}assert(e instanceof gpf.Error.RestrictedBaseClassAttribute)}),it("can't be used on a member of an attribute class",function(){var e;try{gpf.define({$class:"Attribute",$extend:gpf.attributes.Attribute,"[test]":[n],test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.ClassAttributeOnly)}),it("can't be used twice",function(){var e;try{gpf.define({$class:"Attribute",$extend:gpf.attributes.Attribute,$attributes:[n,n],test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.UniqueAttributeUsedTwice)}),describe("When used properly",function(){var e,r;before(function(){e=gpf.define({$class:"AttributeForA",$extend:gpf.attributes.Attribute,$attributes:[n]}),r=new e}),it("fails definition if used on the wrong class",function(){var e;try{gpf.define({$class:"NotAChildOfA",$attributes:[r]})}catch(e_){e=e_}assert(e instanceof gpf.Error.RestrictedBaseClassAttribute)}),it("accepts definition if used on direct child class",function(){var e;try{gpf.define({$class:"DirectChildOfA",$extend:s,$attributes:[r]})}catch(e_){e=e_}assert(!e)}),it("accepts definition if used on child class",function(){var e;try{var t=gpf.define({$class:"DirectChildOfA",$extend:s,$attributes:[r]});gpf.define({$class:"SubChildOfA",$extend:t,$attributes:[r]})}catch(e_){e=e_}assert(!e)})})})}),describe("attributes/uniqueattribute",function(){describe("gpf.attributes.UniqueAttribute",function(){it("can't be used on a non-unique class",function(){var e;try{gpf.define({$class:"Any",$attributes:[new gpf.attributes.UniqueAttribute]})}catch(e_){e=e_}assert(e instanceof gpf.Error.RestrictedBaseClassAttribute)}),it("can't be used on a member of an unique class",function(){var e;try{gpf.define({$class:"UniqueAttribute",$extend:gpf.attributes.UniqueAttribute,"[test]":[new gpf.attributes.UniqueAttribute],test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.ClassAttributeOnly)}),describe("When used properly",function(){var r,s;before(function(){var e=gpf.define({$class:"AttributeThatShouldBeUnique",$extend:gpf.attributes.Attribute,$attributes:[new gpf.attributes.UniqueAttribute]}),t=gpf.define({$class:"AnyAttribute",$extend:gpf.attributes.Attribute});r=new e,s=new t}),it("fails definition if used twice at class level",function(){var e;try{gpf.define({$class:"TestAttribute",$extend:gpf.attributes.Attribute,$attributes:[s,r,r]})}catch(e_){e=e_}assert(e instanceof gpf.Error.UniqueAttributeUsedTwice)}),it("fails definition if used twice at member level",function(){var e;try{gpf.define({$class:"TestAttribute",$extend:gpf.attributes.Attribute,"[test]":[s,r,r],test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.UniqueAttributeUsedTwice)}),it("accepts definition if used once at any level",function(){var e;try{gpf.define({$class:"TestAttribute",$extend:gpf.attributes.Attribute,$attributes:[s,r],"[test]":[s,r],test:function(){}})}catch(e_){e=e_}assert(!e)}),describe("using inheritance",function(){var n;before(function(){n=gpf.define({$class:"BaseTestAttribute",$extend:gpf.attributes.Attribute,$attributes:[s,r],"[test]":[s,r],test:function(){}})}),it("fails definition if used twice at class level",function(){var e;try{gpf.define({$class:"Test",$attributes:[r],$extend:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.UniqueAttributeUsedTwice)}),it("fails definition if used twice at member level",function(){var e;try{gpf.define({$class:"Test",$extend:n,"[test]":[r],test:function(){}})}catch(e_){e=e_}assert(e instanceof gpf.Error.UniqueAttributeUsedTwice)})})})})}),describe("attributes/serializable",function(){var r;before(function(){r=gpf.define({$class:"A","[_member1]":[new gpf.attributes.Serializable({type:gpf.serial.types.string,required:!0})],_member1:"0","[member2]":[new gpf.attributes.Serializable],member2:""})}),describe("gpf.attributes.Serializable",function(){it("provides serialization information on members",function(){var e=gpf.attributes.get(r,gpf.attributes.Serializable),t=e._member1[0].getProperty(),n=e.member2[0].getProperty();assert("member1"===t.name),assert(t.type===gpf.serial.types.string),assert(t.required),assert("member2"===n.name),assert(n.type===gpf.serial.types.string),assert(!n.required)})})}),describe("serial/get",function(){describe("gpf.serial.getProperties",function(){var e;function t(e){assert(2===Object.keys(e).length),assert("id"===e._id.name),assert("name"===e._name.name)}before(function(){e=gpf.define({$class:"A","[_id]":[new gpf.attributes.Serializable({name:"id",required:!0})],_id:"","[_name]":[new gpf.attributes.Serializable({name:"name"})],_name:""})}),it("lists serializable properties (on class)",function(){t(gpf.serial.get(e))}),it("lists serializable properties (on instance)",function(){t(gpf.serial.get(new e))}),it("returns an empty object if no serializable attributes",function(){var e=gpf.serial.get(new Date);assert(0===Object.keys(e).length)})})}),describe("serial/raw/to",function(){describe("gpf.serial.toRaw",function(){var n;before(function(){n=gpf.define({$class:"A","[_id]":[new gpf.attributes.Serializable({name:"id",required:!0,readOnly:!0})],_id:"","[_name]":[new gpf.attributes.Serializable({name:"name"})],_name:"","[_created]":[new gpf.attributes.Serializable({name:"created",type:gpf.serial.datetime,readOnly:!0})],_created:null,"[_modified]":[new gpf.attributes.Serializable({name:"modified",type:gpf.serial.datetime})],_modified:null,constructor:function(e,t,n){this._id=e,this._name=t,this._created=new Date,this._modified=n||null}})}),[undefined,null,0,1,!1,!0,"","Hello World",function(){}].forEach(function(n){it("fails if the parameter is not correct ("+JSON.stringify(n)+")",function(){var e;try{gpf.serial.toRaw(n)}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidParameter)})}),it("generates an object containing only the serializable properties",function(){var e=new n("id","Test"),t=gpf.serial.toRaw(e);assert(2===Object.keys(t).length),assert("Test"===t.name)}),it("converts properties' value",function(){var r=new n("id","Test",new Date(Date.UTC(2018,8,19,12,50,12,0))),e=gpf.serial.toRaw(r,function(e,t,n){return assert(this===r),"_id"===n?(assert("id"===t.name),assert(!0===t.readOnly),assert("id"===e),"ID"):"_name"===n?(assert("name"===t.name),assert(!1===t.readOnly),assert("Test"===e),"TEST"):n.type===gpf.serial.datetime?(assert("_created"===n||"_modified"===n),e.toISOString()):void assert(!1)});assert(4===Object.keys(e).length),assert("ID"===e.id),assert("TEST"===e.name),assert("2018-09-19T12:50:12.000Z"===e.modified)})})}),config.features.propertydescriptor&&include("serial/raw/to.propertydescriptor"),describe("serial/raw/from",function(){describe("gpf.serial.fromRaw",function(){var n;before(function(){n=gpf.define({$class:"A","[_id]":[new gpf.attributes.Serializable({name:"id",required:!0,readOnly:!0})],_id:"","[_name]":[new gpf.attributes.Serializable({name:"name"})],_name:"","[_created]":[new gpf.attributes.Serializable({name:"created",type:gpf.serial.datetime,readOnly:!0})],_created:null,"[_modified]":[new gpf.attributes.Serializable({name:"modified",type:gpf.serial.datetime})],_modified:null})}),[undefined,null,0,1,!1,!0,"","Hello World",function(){}].forEach(function(n){it("fails if the first parameter is not correct ("+JSON.stringify(n)+")",function(){var e;try{gpf.serial.fromRaw(n,{})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidParameter)})}),it("initializes the instance from the object containing the serializable properties",function(){var e=new n,t=gpf.serial.fromRaw(e,{id:"id",name:"Test"});assert(e===t),assert(""===e._id),assert("Test"===e._name)}),it("converts properties' value",function(){var r=new n;gpf.serial.fromRaw(r,{id:"ID",name:undefined,modified:"2018-09-19T12:50:12.000Z"},function(e,t,n){return assert(this===r),"_id"===n?(assert("id"===t.name),assert(!0===t.readOnly),assert("ID"===e),"id"):"_name"===n?(assert("name"===t.name),assert(!1===t.readOnly),assert(e===undefined),"Test"):n.type===gpf.serial.datetime?(assert("_modified"===n),new Date(e)):void assert(!1)}),assert("id"===r._id),assert("Test"===r._name),assert(2018===r._modified.getUTCFullYear()),assert(8===r._modified.getUTCMonth()),assert(19===r._modified.getUTCDate()),assert(12===r._modified.getUTCHours()),assert(50===r._modified.getUTCMinutes()),assert(12===r._modified.getUTCSeconds())})})}),config.features.propertydescriptor&&include("serial/raw/from.propertydescriptor"),describe("attributes/decorator",function(){describe("gpf.attributes.decorator",function(){function n(){}it("can't be used on a non-es6 class",function(){var e;try{gpf.attributes.decorator()(n)}catch(e_){e=e_}assert(e instanceof gpf.Error.Es6classOnly)})})}),config.features.es6class&&include("attributes/decorator.es6");