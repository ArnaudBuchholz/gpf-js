"use strict";describe("console",function(){if(gpf.internals){var e=gpf.internals._gpfConsoleGenerate;describe("_gpfConsoleGenerate",function(){it("generates an object mocking the console",function(){var t=e();assert("function"==typeof t.log),assert("function"==typeof t.info),assert("function"==typeof t.warn),assert("function"==typeof t.error)}),it("generates a log function prefixing text with padding",function(){var t="";e(function(e){t=e}).log("test"),assert("    test"===t)}),it("generates an info function prefixing text with [?]",function(){var t="";e(function(e){t=e}).info("test"),assert("[?] test"===t)}),it("generates a warn function prefixing text with /!\\",function(){var t="";e(function(e){t=e}).warn("test"),assert("/!\\ test"===t)}),it("generates an error function prefixing text with (X)",function(){var t="";e(function(e){t=e}).error("test"),assert("(X) test"===t)})})}}),describe("arraylike",function(){describe("gpf.isArrayLike",function(){it("checks if an object looks like an array",function(){assert(!0===gpf.isArrayLike([]))}),it("recognizes a simulated array",function(){assert(!0===gpf.isArrayLike({length:2,0:0,1:1}))}),it("recognizes a simulated empty array",function(){assert(!0===gpf.isArrayLike({length:0}))}),it("recognizes a simulated incomplete array",function(){assert(!0===gpf.isArrayLike({length:2,1:1}))}),it("recognizes a simulated non empty array with no items",function(){assert(!0===gpf.isArrayLike({length:2}))}),it("accepts a string as an array like",function(){assert(!0===gpf.isArrayLike("abc"))}),[null,undefined,0,1,!1,!0,{},new Date].forEach(function(e){it("rejects any non fitting value ("+JSON.stringify(e)+")",function(){assert(!1===gpf.isArrayLike(e))})}),it("rejects a simulated array with an invalid length property",function(){assert(!1===gpf.isArrayLike({length:2.5,0:0,1:1}))})})}),describe("foreach",function(){var e="Hello World!",t=[0,1,2,3,4,5,6,7,8,9],n={"number":1,"string":e,"null":null,"object":{member:"value"},"function":function(){return e}};describe("gpf.forEach",function(){it("enumerates array content",function(){var e=0,n=0;gpf.forEach(t,function(r,s,i){assert("number"==typeof s),assert(i===t),++e,n+=r}),assert(t.length===e),assert(45===n)}),it("transmits scope on array content",function(){var e,r=0,s=0;e=gpf.forEach(t,function(e,i,a){assert(this===n),assert("number"==typeof i),assert(a===t),++r,s+=e},n),assert(undefined===e),assert(t.length===r),assert(45===s)}),it("enumerates object content and handles null value",function(){var e=[],t=!0;gpf.forEach(n,function(r,s,i){assert("string"==typeof s),assert(i===n),e.push(s),"null"===s&&null!==r&&(t=!1)}),e=e.join(","),assert("number,string,null,object,function"===e),assert(!0===t)}),it("transmits scope on object content",function(){var e=gpf.forEach(n,function(){assert(this===n)},n);assert(undefined===e)})}),gpf.internals&&describe("(internal)",function(){describe("_gpfObjectForEach",function(){var e=gpf.internals._gpfObjectForEach;it("enumerates object keys and values",function(){var t=0;e(n,function(e,r,s){++t,assert(s===n),assert(e===n[r])}),assert(5===t)})}),describe("_gpfArrayForEachFalsy",function(){var e=gpf.internals._gpfArrayForEachFalsy;it("enumerates all values if no truthy result",function(){var n=0,r=e(t,function(e,r,s){++n,assert(s===t),assert(e===t[r])});assert(r===undefined),assert(n===t.length)}),it("stops on first truthy value and return it",function(){var n=0,r={},s=e(t,function(e,s,i){if(4===e)return r;++n,assert(i===t),assert(e===t[s])});assert(s===r),assert(4===n)})})})}),describe("assert",function(){describe("gpf.assert",function(){it("does not accept no message",function(){var e;try{console.expects&&console.expects("warn",/.*/),gpf.assert(!0)}catch(e_){e=e_}assert(e instanceof gpf.Error.AssertionFailed)}),[!0,42,"Hello World!",{}].forEach(function(e){it("does nothing on a truthy condition - "+typeof e+" ("+e.toString()+")",function(){gpf.assert(e,"It works")})}),[!1,0,"",undefined,null].forEach(function(e){var t;t=undefined===e?"undefined":null===e?"null":e.toString(),it("throws an exception on a falsy condition - "+typeof e+" ("+t+")",function(){var t;try{console.expects&&console.expects("warn",/.*/),gpf.assert(e,"It fails")}catch(e_){t=e_}assert(t instanceof gpf.Error.AssertionFailed)})})}),describe("gpf.asserts",function(){it("works with a message / boolean dictionary",function(){gpf.asserts({"It works":!0,"It also works":!0})}),it("fails on first falsy",function(){var e;try{console.expects&&console.expects("warn",/.*/),gpf.asserts({"It works":!0,"It fails":!1})}catch(e_){e=e_}assert(e instanceof gpf.Error.AssertionFailed)})}),describe("gpf.preventAssertWarnings",function(){it("prevents assertion warnings",function(){var e;gpf.preventAssertWarnings(!0);try{gpf.assert(!1,"It fails")}catch(e_){e=e_}assert(e instanceof gpf.Error.AssertionFailed),gpf.preventAssertWarnings(!1)})})}),describe("constants",function(){describe("gpf",function(){it("does not expose any 'private' member",function(){!function e(t,n){var r,s;for(r in t)t.hasOwnProperty(r)&&(assert("_"!==r.charAt(0)),"object"==typeof(s=t[r])&&-1===n.indexOf(s)&&(n.push(s),e(s,n)))}(gpf,[gpf,gpf.internals])}),it("should expose a version",function(){assert("function"==typeof gpf.version),assert("string"==typeof gpf.version());var e=gpf.version();assert(-1!==e.indexOf(".")),assert(null!==e.match(/[0-9]+\.[0-9]+d?/))}),it("should expose the host type",function(){assert("function"==typeof gpf.host),assert("string"==typeof gpf.host());var e=gpf.host();assert(-1!==[gpf.hosts.browser,gpf.hosts.nashorn,gpf.hosts.nodejs,gpf.hosts.phantomjs,gpf.hosts.rhino,gpf.hosts.unknown,gpf.hosts.wscript].indexOf(e))}),describe("gpf.hosts enumeration",function(){["browser","nodejs","phantomjs","unknown","wscript"].forEach(function(e){it("declares gpf.hosts."+e,function(){assert(undefined!==gpf.hosts[e])})})})}),gpf.internals&&(describe("(internal) _gpfIsUnsignedByte",function(){var e=gpf.internals._gpfIsUnsignedByte;gpf.forEach({0:!0,"-25":!1,128:!0,256:!1,255:!0},function(t,n){var r=parseInt(n,10);t?it("accepts "+n,function(){assert(!0===e(r))}):it("rejects "+n,function(){assert(!1===e(r))})})}),describe("(internal) _gpfFuncImpl",function(){var e=gpf.internals._gpfFuncImpl;it("fails if function can't be generated",function(){var t;try{e([],"{")}catch(e_){t=e_}assert(t)})}))}),describe("string/capitalize",function(){gpf.internals&&describe("(internal) _gpfStringCapitalize",function(){var e=gpf.internals._gpfStringCapitalize;it("does nothing on empty string",function(){assert(""===e(""))}),it("uppercases the first letter",function(){assert("Word"===e("word")),assert("Two words"===e("two words")),assert("Two words"===e("Two words"))}),it("also handles accents",function(){assert("\xc9ric"===e("\xe9ric"))})})}),describe("string/replaceex",function(){gpf.internals&&describe("(internal) _gpfStringReplaceEx",function(){var e=gpf.internals._gpfStringReplaceEx;it("replaces strings recursively",function(){assert("add"===e("abc",{"a":"abc","b":"dc","c":""}))})})}),describe("string/escapefor",function(){gpf.internals&&describe("(internal) _gpfStringEscapeFor",function(){var e=gpf.internals._gpfStringEscapeFor;it("escapes for JavaScript",function(){assert('"abc\\r\\ndef"'===e("abc\r\ndef","javascript"))}),it("escapes for xml",function(){assert("&lt;a&amp;b&gt;"===e("<a&b>","xml"))}),it("escapes for html",function(){assert("&lt;a&amp;b:&eacute;&egrave;&ecirc;&aacute;&agrave;&gt;"===e("<a&b:\xe9\xe8\xea\xe1\xe0>","html"))})})}),describe("compatibility",function(){function e(e){var t=new Array(5);t[2]=undefined,t[3]=3,e.call(t,function(e,t){assert(2===t||3===t),2===t?assert(undefined===e):assert(3===e)})}var t={Array:{every:{length:1,"must return true when it goes over all items":function(e){var t,n=0;t=e.call([1,2,3,-6,10],function(e){return n+=e,!0}),assert(!0===t),assert(10===n)},"must return false when it stops on a given item":function(e){var t,n=0;t=e.call([1,2,3,-6,10],function(e){return e>0&&(n+=e,!0)}),assert(!1===t),assert(6===n)},"must iterate with a bound context":function(e){var t,n={sum:0,index:0};t=e.call([1,2,3,-6,10],function(e,t){return assert(this===n),this.index=t,e>0&&(this.sum+=e,!0)},n),assert(!1===t),assert(6===n.sum),assert(3===n.index)},"must ignore undefined members":e},filter:{length:1,"must filter":function(e){var t;t=e.call([1,2,3,4,5],function(e){return e%2==0}),assert(2===t.length),assert(2===t[0]),assert(4===t[1])},"must filter with a bound context":function(e){var t,n={};t=e.call([1,2,3,4,5],function(e){return assert(this===n),e%2==0},n),assert(2===t.length),assert(2===t[0]),assert(4===t[1])},"must ignore undefined members":e},forEach:{length:1,"must iterate":function(e){var t=[1,2,3],n=0;assert("function"==typeof t.forEach),assert(!t.hasOwnProperty("forEach")),e.call(t,function(e){n+=e}),assert(6===n)},"must iterate with a bound context":function(e){var t={sum:0};e.call([1,2,3],function(e){this.sum+=e},t),assert(6===t.sum)},"must ignore undefined members":e},indexOf:{length:1,"must expose indexOf()":function(e){var t={},n=[1,2,3,t,"abc"];assert(-1===e.call(n,4)),assert(0===e.call(n,1)),assert(3===e.call(n,t)),assert(-1===e.call(n,{})),assert(4===e.call(n,"abc"))}},map:{length:1,"must map with a bound context":function(e){var t,n={},r=[1,2,3,n,"abc"];assert("function"==typeof r.map),assert(!r.hasOwnProperty("map")),t=e.call(r,function(e,t){return assert(this===n),assert(e===r[t]),t},n),assert(t.length===r.length),assert(0===t[0]),assert(4===t[4])},"must ignore undefined members":e},reduce:{length:1,"must reduce with no initial value":function(e){var t=[0,1,2,3,4],n=1;assert(10===e.call(t,function(e,r,s,i){return assert(t===i),assert(n===s),++n,e+r}))},"must reduce with intial value":function(e){var t=[0,1,2,3,4],n=0;assert(20===e.call(t,function(e,r,s,i){return assert(t===i),assert(n===s),++n,e+r},10))}},some:{length:1,"returns false when all members return false":function(e){assert(!1===e.call([2,5,8,1,4],function(e){return e>10}))},"returns true when at least one member returns true":function(e){assert(!0===e.call([12,5,8,1,4],function(e){return e>10}))}},from:{isStatic:!0,length:1,"works on arguments":function(e){var t=function(){return e.call(Array,arguments)}(1,2,3);assert(t instanceof Array),assert(3===t.length),assert(1===t[0]),assert(2===t[1]),assert(3===t[2])},"works on strings":function(e){var t=e.call(Array,"foo");assert(t instanceof Array),assert(3===t.length),assert("f"===t[0]),assert("o"===t[1]),assert("o"===t[2])},"supports callback mapping":function(e){var t=e.call(Array,[1,2,3],function(e){return e+e});assert(t instanceof Array),assert(3===t.length),assert(2===t[0]),assert(4===t[1]),assert(6===t[2])},"generates a sequence of numbers":function(e){var t=e.call(Array,{length:3},function(e,t){return t});assert(t instanceof Array),assert(3===t.length),assert(0===t[0]),assert(1===t[1]),assert(2===t[2])}},isArray:{isStatic:!0,length:1,"detects an array":function(e){assert(!0===e.call(Array,[]))},"rejects other objects":function(e){assert(!1===e.call(Array,{length:0}))}}},Function:{bind:{length:1,"must bind to a context":function(e){var t,n={member:null};(t=e.call(function(e){assert(this===n),this.member=e},n))(!0),assert(!0===n.member),t.call({},!1),assert(!1===n.member)},"must return the same result":function(e){var t=e.call(function(e){return e},{});assert(!1===t(!1)),assert(!0===t(!0))},"must preserve function signature":function(e){function t(e,t,n){return e+t+n}assert(3===t.length);var n=e.call(t,{});assert(3===n.length)},"must allow additional parameters binding":function(e){function t(e,t,n){return e+t+n}assert(3===t.length);var n=e.call(t,{},1);assert(2===n.length),assert(6===n(2,3))}}},Object:{assign:{isStatic:!0,length:2,"extends objects members":function(e){var t={"member1":"member1","member2":2},n={"newMember":!0},r=e.call(Object,t,n);assert(r===t),assert("member1"===r.member1),assert(2===r.member2),assert(!0===r.newMember),assert(!0===n.newMember)},"overwrites existing members":function(e){var t=e.call(Object,{"member1":"member1"},{"member1":!1});assert(!1===t.member1)},"supports more than one source parameter":function(e){var t=e.call(Object,{"member1":"member1","member2":2},{"source1":1,"member1":"member1.1"},{"source2":2,"member1":"member1.2"});assert("member1.2"===t.member1),assert(2===t.member2),assert(1===t.source1),assert(2===t.source2)}},create:{isStatic:!0,length:-1,"allows creating objects with a given prototype":function(e){var t=e.call(Object,{method:function(){return"myMethod"}});assert(!t.hasOwnProperty("method")),assert("function"==typeof t.method),assert("myMethod"===t.method())},"is compatible with instanceof":function(e){function t(){}t.prototype={a:function(){return"a"}};var n=e.call(Object,t.prototype);assert("a"===n.a()),assert(n instanceof t)},"allows inheritance and use of instanceof":function(e){function t(){}function n(){}t.prototype={a:function(){return"a"}},n.prototype=new t;var r=e.call(Object,n.prototype);assert("a"===r.a()),assert(r instanceof t),assert(r instanceof n)}},getPrototypeOf:{isStatic:!0,length:1,"returns prototype passed to Object.create":function(e){var t,n;t={a:function(){return"a"}},n=Object.create(t),assert(e.call(Object,n)===t)},"returns prototype from constructor":function(e){function t(){}t.prototype={constructor:t,a:function(){return"a"}};var n=new t;assert(e.call(Object,n)===t.prototype)}},keys:{isStatic:!0,length:1,"returns list of indexes of an array":function(e){var t=e.call(Object,["a","b","c"]);assert(3===t.length),assert("0"===t[0]),assert("1"===t[1]),assert("2"===t[2])},"returns list of indexes of an array-like object":function(e){var t=e.call(Object,{0:"a",1:"b",2:"c"});assert(3===t.length),assert(-1<t.indexOf("0")),assert(-1<t.indexOf("1")),assert(-1<t.indexOf("2"))},"returns list of indexes of an array like object with random key ordering":function(e){var t=e.call(Object,{100:"a",2:"b",7:"c"});assert(3===t.length),assert(-1<t.indexOf("2")),assert(-1<t.indexOf("7")),assert(-1<t.indexOf("100"))},"returns list of own keys of an object":function(e){function t(){}t.prototype={a:0,b:1};var n,r=new t;r.c=2,n=e.call(Object,r),assert(1===n.length),assert("c"===n[0])}},values:{isStatic:!0,length:1,"returns list of values of an object":function(e){var t=e.call(Object,{foo:"bar",baz:42});assert(2===t.length),assert(-1<t.indexOf("bar")),assert(-1<t.indexOf(42))},"returns list of values of an array-like object":function(e){var t=e.call(Object,{0:"a",1:"b",2:"c"});assert(3===t.length),assert(-1<t.indexOf("a")),assert(-1<t.indexOf("b")),assert(-1<t.indexOf("c"))},"returns list of values of an array like object with random key ordering":function(e){var t=e.call(Object,{100:"a",2:"b",7:"c"});assert(3===t.length),assert(-1<t.indexOf("a")),assert(-1<t.indexOf("b")),assert(-1<t.indexOf("c"))},"returns list of own values of an object":function(e){function t(){}t.prototype={a:0,b:1};var n,r=new t;r.c=2,n=e.call(Object,r),assert(1===n.length),assert(2===n[0])}}},String:{trim:{length:0,"must trim left and right":function(e){assert("abc"===e.call(" \t  abc\t \t"))}}},Date:{toISOString:{length:0,"converts to UTC string":function(e){var t=new Date("2003-01-22T22:45:00.000Z");assert("2003-01-22T22:45:00.000Z"===e.call(t))}},now:{isStatic:!0,length:0,"Gives current time":function(e){var t=(new Date).getTime(),n=e.call(Date);assert("number"==typeof n),assert(t<=n)}}}},n={Array:Array,Function:Function,Object:Object,String:String,Date:Date};function r(e){var t,n,r,s=e.sample,i=e.testMethod,a=e.label,o=e.methodName,c=s[o];it(a,function(){i(c)}),gpf.internals&&(t=gpf.internals._gpfCompatibility[e.type],(n=e.isStatic?t.statics:t.methods)&&(r=n[o]),r&&r!==c&&it(a+" (compatible)",function(){i(r)}))}function s(e,t,s){return function(){var i,a,o,c,f,u,l=n[e];for(a in i=!0===s.isStatic?l:new l,o=i,c=t,f=s.length,u="must expose the method "+c,o instanceof Function?it(u,function(){assert("function"==typeof o[c])}):it(u+" through prototype",function(){assert("function"==typeof o[c]),assert(!o.hasOwnProperty(c))}),-1!==f&&it(u+" with an expected arity of "+f,function(){assert(o[c].length===f)}),s)s.hasOwnProperty(a)&&"function"==typeof s[a]&&r({type:e,sample:i,methodName:t,isStatic:s.isStatic,label:a,testMethod:s[a]})}}function i(e){var n,r=t[e];for(n in r)r.hasOwnProperty(n)&&describe(n,s(e,n,r[n]))}describe("Array",function(){describe("default support",function(){it("must allow building an array with a given size",function(){var e,t=new Array(5);for(assert(5===t.length),e=0;e<5;++e)assert(undefined===t[e]);assert("    "===t.join(" "))}),it("provides standard slice",function(){var e=["Banana","Orange","Lemon","Apple","Mango"].slice(1,3);assert(2===e.length),assert("Orange"===e[0]),assert("Lemon"===e[1])})}),i("Array")}),describe("Function",function(){describe("default support",function(){it("allows creating function with parameters",function(){var e=Function("value","return value;");assert(1===e.length),assert(123===e(123))}),it("must detect undefined parameter",function(){function e(e){assert(arguments.length===e)}e(1),e(2,"abc"),e(2,undefined),e(3,undefined,undefined)})}),describe("name support",function(){if(it("exposes a name",function(){var e=new Function("return function funcName () {}")();assert("funcName"===e.compatibleName())}),it("supports empty name",function(){assert(""===function(){}.compatibleName())}),gpf.internals&&Function.prototype.compatibleName!==gpf.internals._gpfGetFunctionName){var e=gpf.internals._gpfGetFunctionName;it("exposes a name (compatible)",function(){assert("thisName"===e.call(function(){}))}),it("supports empty name",function(){assert(""===e.call(function(){}))})}}),i("Function")}),describe("Object",function(){i("Object")}),describe("String",function(){i("String")}),describe("Date",function(){describe("constructor",function(){it("accepts UTC string",function(){var e=new Date("2003-01-22T22:45:00.000Z");assert(2003===e.getUTCFullYear()),assert(0===e.getUTCMonth()),assert(22===e.getUTCDate()),assert(22===e.getUTCHours()),assert(45===e.getUTCMinutes()),assert(0===e.getUTCSeconds())}),it("accepts a date only",function(){var e=new Date("2003-01-22");assert(2003===e.getUTCFullYear()),assert(0===e.getUTCMonth()),assert(22===e.getUTCDate()),assert(0===e.getUTCHours()),assert(0===e.getUTCMinutes()),assert(0===e.getUTCSeconds())})}),i("Date"),gpf.internals&&(describe("(internal) _gpfIsISO8601String",function(){var e=gpf.internals._gpfIsISO8601String,t={"2016-02-17T23:13:00.000Z":[2016,1,17,23,13,0,0],"2003-01-22T22:45:34.075Z":[2003,0,22,22,45,34,75],"2003-13-22T22:45:34.075Z":null,"2003-1-22T22:45:34.075Z":null,"2003-01-32T22:45:34.075Z":null,"2003-01-2T22:45:34.075Z":null,"2003-01-22T25:45:34.075Z":null,"2003-01-22T22:60:34.075Z":null,"2003-01-22T22:45:60.075Z":null,"2003-01-22T22:45:34":[2003,0,22,22,45,34,0],"2003-01-22 22:45:34":null,"2003-01-22T22:45:34.075":null,"2016-02-17":[2016,1,17,0,0,0,0],"2003-13-22":null,"2003-01-32":null};function n(t,n){var r;r=n?"accepts":"rejects",r+=' "'+t+'"',it(r,function(){var r=e(t);n?(assert(r),assert(r.length===n.length),n.forEach(function(e,t){assert(r[t]===e)})):assert(!r)})}for(var r in t)t.hasOwnProperty(r)&&n(r,t[r]);[!0,!1,0,1,{},new Date].forEach(function(t){it("rejects other formats - "+typeof t+" ("+t.toString()+")",function(){assert(undefined===e(t))})})}),describe("(internal) _GpfDate()",function(){var e=gpf.internals._GpfDate;it("allocates a Date object",function(){var t=new e;assert(t instanceof Date)}),it("detects and leverage ISO 8601 format",function(){var t=new e("2003-01-22T22:45:34.075Z");assert(2003===t.getUTCFullYear()),assert(0===t.getUTCMonth()),assert(22===t.getUTCDate()),assert(22===t.getUTCHours()),assert(45===t.getUTCMinutes()),assert(34===t.getUTCSeconds()),assert(75===t.getUTCMilliseconds())}),it("detects and leverage ISO 8601 short format",function(){var t=new e("2003-01-22");assert(2003===t.getUTCFullYear()),assert(0===t.getUTCMonth()),assert(22===t.getUTCDate()),assert(0===t.getUTCHours()),assert(0===t.getUTCMinutes()),assert(0===t.getUTCSeconds()),assert(0===t.getUTCMilliseconds())})}))})}),describe("compatibility/array",function(){}),describe("factory",function(){gpf.internals&&describe("_gpfNewApply",function(){var e=gpf.internals._gpfNewApply;it("calls any constructor",function(){function t(){this.value=42}var n=e(t,[]);assert(n instanceof t),assert(42===n.value)}),it("forwards parameters",function(){var t=e(Array,[42]);assert(t instanceof Array),assert(42===t.length)}),it("adapts to a very long list of parameters",function(){var t=e(Array,[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]);assert(t instanceof Array),assert(15===t.length)})})}),describe("compatibility/date",function(){}),describe("compatibility/function",function(){}),describe("compatibility/object",function(){}),describe("compatibility/string",function(){}),describe("compatibility/promise",function(){function e(e){describe("simple usage",function(){it("waits for synchronous fulfilment",function(t){new e(function(e){assert("function"==typeof e),e("ok")}).then(function(e){assert("ok"===e),t()})["catch"](function(e){t(e)})}),it("waits for asynchronous fulfilment",function(t){var n;new e(function(e){n=e}).then(function(e){assert("ok"===e),t()})["catch"](function(e){t(e)}),n("ok")}),it("waits for synchronous rejection (rejection handler)",function(t){var n=!1;new e(function(e,t){assert("function"==typeof t),t("ko")}).then(function(){n=!0},function(e){assert(!1===n),assert("ko"===e),t()})["catch"](function(e){t(e)})}),it("waits for asynchronous rejection (rejection handler)",function(t){var n,r=!1;new e(function(e,t){n=t}).then(function(){r=!0},function(e){assert(!1===r),assert("ko"===e),t()})["catch"](function(e){t(e)}),n("ko")}),it("waits for synchronous rejection (catch handler)",function(t){new e(function(e,t){t("ko")}).then(function(){assert(!1)})["catch"](function(e){try{assert("ko"===e),t()}catch(e_){t(e_)}})}),it("waits for asynchronous rejection (catch handler)",function(t){var n;new e(function(e,t){n=t}).then(function(){assert(!1)})["catch"](function(e){try{assert("ko"===e),t()}catch(e_){t(e_)}}),n("ko")}),it("rejects automatically on exception",function(t){new e(function(){throw new Error("ko")}).then(function(){assert(!1)},function(e){assert(e instanceof Error),assert("ko"===e.message),t()})["catch"](function(e){t(e)})}),it("catches exception from the fulfilment handler",function(t){new e(function(e){e("ok")}).then(function(e){throw assert("ok"===e),new Error("ko")})["catch"](function(e){try{assert(e instanceof Error),assert("ko"===e.message),t()}catch(e_){t(e_)}})}),it("catches exception from the rejection handler",function(t){new e(function(e,t){t("ko")}).then(function(){assert(!1)},function(e){throw assert("ko"===e),new Error("ko")})["catch"](function(e){try{assert(e instanceof Error),assert("ko"===e.message),t()}catch(e_){t(e_)}})})}),describe("shortcuts",function(){it("offers Promise.resolve",function(t){e.resolve("ok").then(function(e){assert("ok"===e),t()},function(){assert(!1)})["catch"](function(e){t(e)})}),it("offers Promise.reject",function(t){e.reject("ko").then(function(){assert(!1)},function(e){assert("ko"===e),t()})["catch"](function(e){t(e)})})}),describe("chaining",function(){it("chains by passing results from one handler to the other",function(t){new e(function(e){e("ok 1")}).then(function(e){return assert("ok 1"===e),"ok 2"}).then(undefined,function(e){t(e)}).then(function(e){return assert("ok 2"===e),"ok 3"}).then(function(e){return assert("ok 3"===e),"ok 4"}).then(function(e){assert("ok 4"===e),t()})["catch"](function(e){t(e)})}),it("chains by returning a promise in the fulfilment handler",function(t){new e(function(e){e("ok 1")}).then(function(t){return assert("ok 1"===t),e.resolve("ok 2")}).then(function(t){return assert("ok 2"===t),new e(function(e){e("ok 3")})}).then(function(e){assert("ok 3"===e),t()})["catch"](function(e){t(e)})}),it("stops on first error",function(t){new e(function(e){e("ok 1")}).then(function(e){return assert("ok 1"===e),"ok 2"}).then(function(e){throw assert("ok 2"===e),new Error("ko")}).then(function(){assert(!1)})["catch"](function(e){try{assert(e instanceof Error),assert("ko"===e.message),t()}catch(e_){t(e_)}})})}),describe("synchronisation",function(){describe("Promise.all",function(){it("succeeds with an empty array",function(t){e.all([]).then(function(e){assert(0===e.length),t()})["catch"](function(e){t(e)})}),it("works with one promise",function(t){e.all([e.resolve("ok")]).then(function(e){assert(1===e.length),assert("ok"===e[0]),t()})["catch"](function(e){t(e)})}),it("waits for all promises to be resolved",function(t){var n,r=[];for(n=0;n<10;++n)r.push(e.resolve(n));e.all(r).then(function(e){assert(45===e.reduce(function(e,t){return e+t})),t()})["catch"](function(e){t(e)})}),it("fails on the first error",function(t){var n,r,s=[];for(n=0;n<10;++n)s.push(0==(r=n)%2?e.reject(r):e.resolve(r));e.all(s).then(function(){assert(!1)})["catch"](function(e){try{assert("number"==typeof e),assert(e<10),t()}catch(e_){t(e_)}})})}),describe("Promise.race",function(){it("waits for the first promise that is resolved",function(t){var n,r=[],s=[];function i(t){return new e(function(e){s.unshift(e.bind(null,t))})}for(n=0;n<10;++n)r.push(i(n));e.race(r).then(function(e){assert(9===e),s[9](),t()})["catch"](function(e){t(e)}),s[0](),s[1](),s[2]()}),it("waits for the first promise that is resolved or rejected",function(t){var n,r=[],s=[];function i(t){return new e(function(e,n){5===t?s.push(n.bind(null,t)):s.push(e.bind(null,t))})}for(n=0;n<10;++n)r.push(i(n));e.race(r).then(function(){assert(!1)})["catch"](function(e){try{assert("number"==typeof e),assert(5===e),s[9](),t()}catch(e_){t(e_)}}),s[5](),s[0](),s[1]()})})}),describe("branching",function(){it("supports different branches",function(t){var n={};n.promise=new e(function(e,t){n.resolve=e,n.reject=t});var r=n.promise.then(function(e){return e+1}).then(function(e){return e+2}).then(function(e){return e+3}),s=n.promise.then(function(e){return 2*e}).then(function(e){return 3*e});e.all([r,s]).then(function(e){assert(7===e[0]),assert(6===e[1]),t()})["catch"](function(e){t(e)}),n.resolve(1)})})}describe("Promise",function(){e(Promise)}),gpf.internals&&Promise!==gpf.internals._GpfPromise&&describe("(internal) _GpfPromise",function(){e(gpf.internals._GpfPromise)})}),describe("compatibility/timeout",function(){function e(e){var t,n,r;function s(){return(new Date).getTime()}function i(t){this._start=s(),this._delay=t,this._id=e.setTimeout(i.prototype.callback.bind(this),t),this._synchronous=!1}return t=config.timerResolution?config.timerResolution:1,r=(n=2*t)+2*t,i.list=[],i.allocate=function(e){var t=new i(e);return i.list.push(t),t},i.noError=function(){var e,t=i.list.length;for(e=0;e<t;++e)if(i.list[e].error())return!1;return!0},i.check=function(){assert(i.noError())},i.prototype={_start:0,_delay:0,_synchronous:!0,_id:0,_allowed:!1,_triggered:0,_error:null,_done:function(){},id:function(){return this._id},_isAllowed:function(){if(!this._allowed)throw new Error("Not allowed")},_isTriggered:function(){if(this._triggered)throw new Error("Already triggered")},_isSynchronous:function(){if(this._synchronous)throw new Error("Triggered too soon (synchronous should be false)")},callback:function(){try{this._isAllowed(),this._isTriggered(),this._triggered=s(),this._isSynchronous();var e=s()-this._start;if(e<this._delay&&this._delay-e>t)throw new Error("Triggered too soon ("+e+" does not respect the timeout delay of "+this._delay+")");this._done()}catch(e_){this._error=e_,this._done(e_)}},clear:function(){e.clearTimeout(this._id),delete this._allowed},clean:function(){this._triggered||this.clear();var e,t=i.list.length;for(e=0;e<t&&i.list[e]!==this;++e);i.list.splice(e,1)},error:function(){return this._error},allow:function(e){this._allowed=!0,this._done=e},triggered:function(){return this._triggered}},function(){var t;before(function(){i.list=[]}),beforeEach(function(){t=i.allocate(r),assert(1===i.list.length),i.check()}),it("allocates a timeout id",function(){assert(undefined!==t.id()),i.check()}),afterEach(function(){t.clean(),i.check()}),describe("clearing",function(){beforeEach(function(){t.clear(),i.check()}),it("removes the callback from the queue",function(){e.handleTimeout(),i.check()}),describe("again",function(){beforeEach(function(){t.clear(),i.check()}),it("does not fail",function(){e.handleTimeout(),i.check()})})}),describe("triggering",function(){beforeEach(function(n){t.allow(n),e.handleTimeout(),i.check()}),it("executes the callback from the queue",function(){assert(t.triggered),i.check()}),it("removes the callback from the queue",function(){e.handleTimeout(),i.check()})}),describe("sequencing with a second timeout",function(){var s;function a(e,t){var n=0;return function(r){r?e(r):t===++n&&e()}}beforeEach(function(){t.clean(),s=i.allocate(n),t=i.allocate(r),i.check()}),it("allocates a different timeout id",function(){assert(undefined!==s.id()),assert(s.id()!==t.id()),i.check()}),afterEach(function(){s.clean(),i.check()}),describe("clearing the second timeout",function(){beforeEach(function(){s.clear(),i.check()}),describe("triggering",function(){beforeEach(function(n){t.allow(n),e.handleTimeout(),i.check()}),it("executes the remaining callback from the queue",function(){assert(t.triggered()),i.check()}),it("removes all callbacks from the queue",function(){e.handleTimeout(),i.check()})})}),describe("creating and cleaning a third timeout",function(){it("prevents execution of the third",function(n){var o=i.allocate(10*r),c=a(n,2);o.clean(),t.allow(c),s.allow(c),e.handleTimeout(),i.check()})}),describe("triggering",function(){beforeEach(function(n){var r=a(n,2);t.allow(r),s.allow(r),e.handleTimeout(),i.check()}),it("executes the callbacks from the queue",function(){assert(t.triggered()),assert(s.triggered()),i.check()}),it("removed all callbacks from the queue",function(){e.handleTimeout(),i.check()})})})}}describe("exposed API",e({setTimeout:function(e,t){return setTimeout(e,t)},clearTimeout:function(e){clearTimeout(e)},handleTimeout:function(){}})),gpf.internals&&setTimeout!==gpf.internals._gpSetTimeoutPolyfill&&describe("(internal)",e({setTimeout:gpf.internals._gpSetTimeoutPolyfill,clearTimeout:gpf.internals._gpfClearTimeoutPolyfill,handleTimeout:gpf.internals._gpfHandleTimeout}))}),describe("compatibility/json",function(){var e=[{label:"empty object",obj:{},json:"{}"},{label:"simple string property",obj:{a:"123"},json:'{"a":"123"}'},{label:"simple number property",obj:{a:123},json:'{"a":123}'},{label:"simple boolean properties",obj:{a:!0,b:!1},json:'{"a":true,"b":false}'},{label:"mixed simple properties",obj:{a:"123",b:123,c:!0,d:{}},json:'{"a":"123","b":123,"c":true,"d":{}}'},{label:"function",obj:{a:123,b:function(){}},json:'{"a":123}',parse:!1},{label:"array",obj:{a:[1,2,3]},json:'{"a":[1,2,3]}'},{label:"null",obj:{a:null},json:'{"a":null}'}];function t(e,n){var r=typeof e;return r===typeof n&&("object"===r&&e&&n?Object.keys(e).every(function(r){return n.hasOwnProperty(r)&&t(e[r],n[r])}):e===n)}function n(t){it("has the expected arity",function(){assert(3===t.length)});var n={"null":null,0:0,"false":!1,"true":!0,'"Hello World!"':"Hello World!",'"\\"string\\""':'"string"'};Object.keys(n).forEach(function(e){it("converts "+e,function(){assert(t(n[e])===e)})}),e.forEach(function(e){it("works on "+e.label,function(){assert(t(e.obj)===e.json)})}),it("filters out special values",function(){var e=t({x:undefined,y:Object});assert("{}"===e)}),it("uses the replacer function on object",function(){var e=t({hello:"World",code:0},function(e,t){return"string"==typeof t?undefined:t});assert('{"code":0}'===e)}),it("uses the replacer function on array",function(){var e=t(["Hello","World!"],function(e,t){return"0"===e.toString()?undefined:t});assert('[null,"World!"]'===e)}),it("uses the replacer whitelist",function(){var e=t({hello:"World",code:0},["hello"]);assert('{"hello":"World"}'===e)}),it("uses the space argument",function(){var e=t({a:2},null," ");assert('{\n "a": 2\n}'===e)}),it("uses the space argument (empty string)",function(){var e=t({a:2},null,"");assert('{"a":2}'===e)}),it("uses the space argument (tab)",function(){var e=t({a:2},null,"\t");assert('{\n\t"a": 2\n}'===e)}),it("uses the space argument (tab) on an array",function(){var e=t([1,2],null,"\t");assert("[\n\t1,\n\t2\n]"===e)}),it("uses the space argument (number < 10)",function(){var e=t({a:2},null,5);assert('{\n     "a": 2\n}'===e)}),it("uses the space argument (number > 10)",function(){var e=t({a:2},null,11);assert('{\n          "a": 2\n}'===e)})}function r(n){it("has the expected arity",function(){assert(2===n.length)}),e.forEach(function(e){!1!==e.parse&&it("works on "+e.label,function(){var r=n(e.json);assert(!0===t(r,e.obj))})}),it("supports reviver parameter - simple",function(){var e=n('{"a": 5, "b": "6"}',function(e,t){return"number"==typeof t?2*t:t});assert(!0===t(e,{a:10,b:"6"}))}),it("supports reviver parameter - traversing",function(){var e=[];n('{"1": 1, "2": 2, "3": {"4": 4, "5": {"6": 6}}}',function(t,n){return e.push(t.toString()),n}),assert(7===e.length),["1","2","4","6","5","3",""].forEach(function(t,n){assert(e[n]===t)})})}describe("JSON object",function(){it("exists",function(){assert("undefined"!=typeof JSON)})}),describe("JSON.stringify",function(){n(JSON.stringify)}),describe("JSON.parse",function(){r(JSON.parse.bind(JSON))}),gpf.internals&&describe("(internal)",function(){describe("_gpfJsonStringifyPolyfill",function(){n(gpf.internals._gpfJsonStringifyPolyfill)}),describe("_gpfJsonParsePolyfill",function(){r(gpf.internals._gpfJsonParsePolyfill)})})}),describe("context",function(){describe("gpf.context",function(){var e=Function;it("resolves the global context",function(){if(assert("function"==typeof gpf.context),assert(null!==gpf.context()),gpf.hosts.browser===gpf.host())assert(window===gpf.context());else if(gpf.hosts.nodejs===gpf.host()||gpf.hosts.phantomjs===gpf.host())assert(global===gpf.context());else{var t=e("return this;")();assert(t===gpf.context())}}),it("resolves gpf",function(){assert(gpf===gpf.context("gpf"))}),it("resolves any symbol",function(){assert(gpf.context===gpf.context("gpf.context"))}),it("returns undefined if not existing",function(){assert(undefined===gpf.context("gpf.not-existing"))}),it("returns undefined if not existing (deep dive)",function(){assert(undefined===gpf.context("gpf.not-existing.really-not"))})}),gpf.internals&&describe("_gpfContext",function(){var e=gpf.internals._gpfContext;it("can build a context",function(){var t=gpf.context(),n={};t.testContextJS=n;var r=e(["testContextJS","folder","name"],!0);assert(n.folder.name===r),delete t.testContextJS})})}),describe("error",function(){describe("gpf.Error",function(){it("is used as an exception",function(){var e;try{gpf.Error.abstractMethod()}catch(e_){e=e_}assert(e instanceof Error),assert(e instanceof gpf.Error),assert(e instanceof gpf.Error.AbstractMethod),assert(e.constructor===gpf.Error.AbstractMethod)}),it("is documented",function(){var e;try{gpf.Error.abstractMethod()}catch(e_){e=e_}assert(e.code===gpf.Error.CODE_ABSTRACTMETHOD),assert(e.code===gpf.Error.abstractMethod.CODE),assert("abstractMethod"===e.name),assert("Abstract method"===e.message)}),it("can use substitution for message",function(){var e;try{gpf.Error.assertionFailed({message:"Test"})}catch(e_){e=e_}assert(e instanceof gpf.Error.AssertionFailed),assert(e.code===gpf.Error.CODE_ASSERTIONFAILED),assert(e.code===gpf.Error.assertionFailed.CODE),assert("assertionFailed"===e.name),assert("Assertion failed: Test"===e.message)})})}),describe("function",function(){if(gpf.internals){var e=gpf.internals._gpfFunctionDescribe;describe("_gpfFunctionDescribe",function(){it("describes a named function",function(){var t=e(function(e,t){return e+t});assert("test"===t.name),assert(2===t.parameters.length),assert("a"===t.parameters[0]),assert("b"===t.parameters[1]),assert(-1!==t.body.indexOf("return a + b;"))}),it("identifies an unnamed function",function(){var t=e(function(){return 0});assert(!t.name),assert(!t.parameters),assert(-1!==t.body.indexOf("return 0;"))}),it("identifies empty function",function(){var t=e(function(){});assert(undefined===t.body)}),it("filters out comments",function(){var t=e(function(e,t,n){return e+t+n});assert("test2"===t.name),assert(3===t.parameters.length),assert("a"===t.parameters[0]),assert("b"===t.parameters[1]),assert("c"===t.parameters[2]),assert(-1===t.body.indexOf("comments are removed"))})}),describe("_gpfFunctionBuild",function(){var e=gpf.internals._gpfFunctionBuild;it("builds an empty anonymous function",function(){var t=e({});assert("function"==typeof t),assert(""===t.compatibleName())}),it("builds a named function",function(){var t=e({name:"test"});assert("test"===t.compatibleName())}),it("builds a function with named parameters",function(){var t=e({parameters:["a","b","c"],body:"return a + b + c;"});assert(3===t.length),assert(6===t(1,2,3))}),it("builds a function with external context",function(){var t=e({body:"return a;"},{a:"Hello World!"});assert(0===t.length),assert("Hello World!"===t())})})}}),describe("abstract",function(){if(gpf.internals){var e=gpf.internals._gpfCreateAbstractFunction;describe("_gpfCreateAbstractFunction",function(){it("generates a function with a given signature",function(){var t=e(3);assert(3===t.length)}),it("generates a function that throws the abstractMethod exception",function(){var t,n=e(0);try{n()}catch(e_){t=e_}assert(t instanceof gpf.Error.AbstractMethod)})})}}),describe("define/check",function(){gpf.internals&&describe("(internal) _GpfEntityDefinition",function(){var e=gpf.internals._GpfEntityDefinition,t=gpf.internals._gpfDefineBuildTypedEntity;it("must have an entity type",function(){var e;try{t({})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidEntityType)}),it("checks for a valid name",function(){var e;try{t({$type:"class"})}catch(e_){e=e_}assert(e instanceof gpf.Error.MissingEntityName)}),it("validates minimal requirement (type and name)",function(){t({$type:"class",$name:"Test"})}),it("rejects invalid properties",function(){var e;try{t({$type:"class",$name:"Test",$fail:!0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidEntity$Property)}),it("converts $class into _type and _name",function(){var n=t({$class:"Test"});assert(n instanceof e),assert("class"===n._type),assert("Test"===n._name)}),it("converts $class into _type, _name and _namespace (absolute)",function(){var e=t({$class:"gpf.test.Test"});assert("class"===e._type),assert("Test"===e._name),assert("gpf.test"===e._namespace)}),it("converts $class into _type, _name and _namespace (relative)",function(){var e=t({$class:"test.Test",$namespace:"gpf"});assert("class"===e._type),assert("Test"===e._name),assert("gpf.test"===e._namespace)}),it("prioritize $class over $name",function(){var e=t({$class:"Test",$name:"Any"});assert("class"===e._type),assert("Test"===e._name)}),it("validates namespace",function(){t({$class:"Test",$namespace:"lowerCamelCase.$accepted._also.numbers456"}),t({$class:"Test",$namespace:"simple"}),t({$class:"Test",$namespace:""})}),["endingPointIsNotOK.","startingNumberIsNotOK.4test","$isOKOnlyAtBeginning.test$","_isOKOnlyAtBeginning.test_","CapitalFirstLetterIsNotOK"].forEach(function(e){it("rejects invalid namespace ("+e+")",function(){var n;try{t({$class:"Test",$namespace:e})}catch(e_){n=e_}assert(n instanceof gpf.Error.InvalidEntityNamespace)})})})}),describe("define/class/check",function(){gpf.internals&&describe("(internal) _GpfClassDefinition",function(){var e=gpf.internals._GpfClassDefinition,t=gpf.internals._gpfDefineBuildTypedEntity;it("is used for class definition",function(){var n=t({$class:"Test"});assert(n instanceof e)}),it("accepts a valid class definition",function(){t({$class:"Test",member:function(){}})}),["startingWithLowercaseLetterIsNotOK","The$signIsForbbidenIfNotAtTheBeginning","The_signIsForbbidenIfNotAtTheBeginning"].forEach(function(e){it("rejects invalid class name ("+e+")",function(){var n;try{t({$class:e})}catch(e_){n=e_}assert(n instanceof gpf.Error.InvalidClassName)})}),["StartingWithUppercaseLetterIsNotOK","the$signIsForbbidenIfNotAtTheBeginning","the_signIsForbbidenIfNotAtTheBeginning","class"].forEach(function(e){it("rejects invalid property name ("+e+")",function(){var n,r={$class:"Test"};r[e]=!0;try{t(r)}catch(e_){n=e_}assert(n instanceof gpf.Error.InvalidClassProperty)})}),it("rejects invalid $extend",function(){var e;try{t({$class:"Test",$extend:12})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassExtend)}),it("accepts native $extend",function(){t({$class:"Test",$extend:String})}),it("accepts contextual $extend",function(){t({$class:"Test",$extend:"String"})})})}),describe("define",function(){var e={};function t(e,t,n){Object.keys(n).filter(function(e){return!n[e]}).forEach(function(n){it("rejects invalid "+e+" name ("+n+")",function(){var r,s={};s["$"+e]=n;try{gpf.define(s)}catch(e_){r=e_}assert(r instanceof t)})}),Object.keys(n).filter(function(e){return n[e]}).forEach(function(t){it("accepts valid "+e+" name ("+t+")",function(){var n,r={};r["$"+e]=t;try{gpf.define(r)}catch(e_){n=e_}assert(undefined===n)})})}function n(e){it(e.it,function(){var t;try{gpf.define(e.definition)}catch(e_){t=e_}assert(t instanceof e.exception)})}before(function(){gpf.context().test=e}),after(function(){delete gpf.context().test}),describe("gpf.define",function(){it("accepts only one parameter",function(){assert("function"==typeof gpf.define),assert(1===gpf.define.length)}),describe("Common validation",function(){n({it:"checks that he entity type is specified",definition:{},exception:gpf.Error.InvalidEntityType})}),describe("Class definition",function(){describe("Validation",function(){t("class",gpf.Error.InvalidClassName,{"1NumberAtTheBeginningIsNotOK":!1,"noUppercaseFirstLetterIsNotOK":!1,"DollarSignAnywhereIsNotOK$":!1,"A":!0,"$B":!0,"_C":!0,"Test123":!0}),[{it:"rejects invalid $ property names",definition:{$class:"Test",$test:!1},exception:gpf.Error.InvalidEntity$Property},{it:"rejects invalid property names (reserved keywords)",definition:{$class:"Test","super":!1},exception:gpf.Error.InvalidClassProperty},{it:"rejects constructor property if not a method",definition:{$class:"Test",constructor:!1},exception:gpf.Error.InvalidClassConstructor}].forEach(n)}),describe("Implementation",function(){var t,n;before(function(){t=gpf.define({$class:"A",_member:"defaultValue",getMember:function(){return this._member},"constructor":function(e){e&&(this._member=e),this._constructorOfA=!0},funcWith3params:function(e,t,n){return e+t+n},throwError:function(){throw new Error("error")}}),n=new t}),it("prevents constructor functions to be used without new",function(){var e;try{t()}catch(e_){e=e_}assert(e instanceof gpf.Error.ClassConstructorFunction)}),it("creates a constructor with the same signature than the constructor property",function(){assert(1===t.length)}),it("handles instanceof",function(){assert(n instanceof t)}),it("calls constructor property",function(){assert(n._constructorOfA)}),it("exposes methods",function(){assert("function"==typeof n.getMember),assert("defaultValue"===n.getMember())}),describe("Subclassing",function(){var n,r;it("prevents invalid override",function(){var e;try{gpf.define({$class:"Test",$extend:t,getMember:!1})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassOverride)}),before(function(){n=gpf.define({$class:"test.B",$extend:t,"constructor":function(e){this.$super("valueOfB"),this._constructorOfB=e},getMember:function(){return this.$super()+"-inB"},setMember:function(e){this._member=e},baseTest:function(){return this.$super.getMember()},invalidSuperMember:function(){return this.$super.doesntExist()},noSuperMember:function(){return this.$super()},differentBinding:function(){return this.$super.getMember.call({_member:"different"})},checkSignature:function(){assert(3===this.$super.funcWith3params.length)},throwError:function(){this.$super()}}),r=new n(3475)}),it("handles instanceof",function(){assert(r instanceof t),assert(r instanceof n)}),it("handles namespace",function(){assert(e.B===n)}),it("calls the constructor function",function(){assert(3475===r._constructorOfB)}),it("calls the proper $super()",function(){assert(r._constructorOfA),assert("valueOfB-inB"===r.getMember())}),it("offers a way to call named base method",function(){assert("valueOfB"===r.baseTest())}),it("fails when accessing an unknown $super member",function(){var e;try{r.invalidSuperMember()}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassSuperMember)}),it("fails when accessing inexistent $super",function(){var e;try{r.noSuperMember()}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidClassSuper)}),it("allows calling $super member with a different binding",function(){assert("different"===r.differentBinding())}),it("respects methods signature",function(){r.checkSignature()}),it("does not leak $super",function(){assert(undefined===r.$super)}),it("does not leak $super on exception",function(){try{r.throwError()}catch(e_){}assert(undefined===r.$super)}),it("handles several versions of $super",function(){var e=new(gpf.define({$class:"C",$extend:n,testMethod:function(){return this.$super.getMember()}}));assert("valueOfB-inB"===e.testMethod())})})})}),describe("Interface definition",function(){describe("Validation",function(){t("interface",gpf.Error.InvalidInterfaceName,{"1NumberAtTheBeginningIsNotOK":!1,"noUppercaseFirstLetterIsNotOK":!1,"DollarSignAnywhereIsNotOK$":!1,"NotStartingWithUppercaseI":!1,"A":!1,"$B":!1,"_C":!1,"Test123":!1,"ISample":!0,"IS":!0}),[{it:"rejects interface if all members are not methods",definition:{$interface:"ITest",member:!1},exception:gpf.Error.InvalidInterfaceProperty},{it:"rejects invalid property names (reserved keywords)",definition:{$interface:"ITest","super":function(){}},exception:gpf.Error.InvalidInterfaceProperty},{it:"rejects constructor property",definition:{$interface:"ITest",constructor:function(){}},exception:gpf.Error.InvalidInterfaceProperty}].forEach(n)}),describe("Implementation",function(){var e=gpf.define({$interface:"ITest",test:function(e){return e}});it("can't be used as a class extend",function(){var t;try{gpf.define({$class:"Test",$extend:e})}catch(e_){t=e_}assert(t instanceof gpf.Error.InvalidClassExtend)})})})})}),describe("interfaces",function(){describe("gpf.interfaces.IUnknown",function(){it("exists",function(){assert("function"==typeof gpf.interfaces.IUnknown)}),it("is an interface",function(){var e;try{var t=new gpf.interfaces.IUnknown;assert("function"==typeof t.queryInterface)}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceConstructorFunction)})}),describe("gpf.interfaces.isImplementedBy",function(){function e(){}e.prototype={queryInterface:function(e){return e}};var t=gpf.define({$class:"TestGPFClass",queryInterface:function(e){return e}});it("validates literal objects (using interface constructor)",function(){assert(!0===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,{queryInterface:function(e){return e}}))}),it("validates instances from a raw JavaScript class (using interface name)",function(){var t=new e;assert(!0===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",t))}),it("validates a raw JavaScript class",function(){assert(!0===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",e))}),it("validates instances from a GPF class",function(){var e=new t;assert(!0===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,e))}),it("validates a GPF class",function(){assert(!0===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,t))}),[!1,null,undefined,0,NaN,""].forEach(function(e){it("rejects "+JSON.stringify(e),function(){assert(!1===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",e))})}),it("rejects member if not a method",function(){assert(!1===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",{queryInterface:"Not a method"}))}),it("rejects member if parameters count does not match (none)",function(){assert(!1===gpf.interfaces.isImplementedBy("gpf.interfaces.IUnknown",{queryInterface:function(){}}))}),it("rejects member if parameters count does not match (more)",function(){assert(!1===gpf.interfaces.isImplementedBy(gpf.interfaces.IUnknown,{queryInterface:function(e,t,n){return e+t+n}}))})}),describe("gpf.interfaces.query",function(){function e(){}e.prototype.test=function(e,t){return e+t},it("returns the object if it implements the interface (using interface name)",function(){var e={queryInterface:function(e){return e}};assert(e===gpf.interfaces.query("gpf.interfaces.IUnknown",e))}),it("returns the object if it implements the interface (using interface specifier)",function(){var t={test:function(e,t){}};assert(t===gpf.interfaces.query(e,t))}),it("returns null if IUnknown is implemented but not the expected interface",function(){assert(null===gpf.interfaces.query(e,{queryInterface:function(e){return null}}))}),it("uses IUnknown to get the expected interface",function(){assert(null!==gpf.interfaces.query(e,{queryInterface:function(t){return assert(t===e),{test:function(e,t){}}}}))}),it("returns undefined if neither the expected interface or IUnknown are implemented",function(){assert(undefined===gpf.interfaces.query(e,{queryInterface:function(){return null}}))})})}),describe("sort",function(){var e=[{id:0,num:5,str:"e",group:1},{id:1,num:1,str:"b",group:0},{id:2,num:4,str:"a",group:1},{id:3,num:2,str:"d",group:0},{id:4,num:3,str:"c",group:1}];describe("gpf.createSortFunction",function(){[{label:"sort on numeric values (ascending)",sort:{property:"num"},expected:[1,3,4,2,0]},{label:"sort on string values (descending)",sort:[{property:"str",type:"string",ascending:!1}],expected:[0,3,4,1,2]},{label:"sort on multiple values",sort:[{property:"group",type:"number",ascending:!0},{property:"num",ascending:!1}],expected:[3,1,0,2,4]}].forEach(function(t){it(t.label,function(){var n,r;n=e.sort(gpf.createSortFunction(t.sort)),r=t.expected,assert(n.every(function(e,t){return e.id===r[t]}))})})})}),describe("filter",function(){var e=[{id:0,num:5,str:"e",group:1,search:"first"},{id:1,num:1,str:"b",group:0,search:"second"},{id:2,num:4,str:"a",group:1,search:"third"},{id:3,num:2,str:"d",group:0,search:"fourth"},{id:4,num:3,str:"c",group:1,search:"fifth"}];describe("gpf.createFilterFunction",function(){[{label:"filters on numeric values",filter:{eq:[{property:"num"},1]},expected:[1]},{label:"filters on own values",filter:{eq:[{property:"num"},{property:"id"}]},expected:[1]},{label:"filters on string values",filter:{eq:[{property:"str"},"c"]},expected:[4]},{label:"filters on string values (ne)",filter:{ne:[{property:"str"},"c"]},expected:[0,1,2,3]},{label:"filters with lower than (lt)",filter:{lt:[{property:"num"},3]},expected:[1,3]},{label:"filters with lower than or equal (lte)",filter:{lte:[{property:"num"},3]},expected:[1,3,4]},{label:"filters with greater than (gt)",filter:{gt:[{property:"num"},3]},expected:[0,2]},{label:"filters with greater than or equal (lte)",filter:{gte:[{property:"num"},3]},expected:[0,2,4]},{label:"filters on string values (not eq)",filter:{not:{eq:[{property:"str"},"c"]}},expected:[0,1,2,3]},{label:"filters on string values (like)",filter:{like:{property:"str"},regexp:"[a|c]"},expected:[2,4]},{label:"filters on string values (like with capturing group)",filter:{eq:[{like:{property:"search"},regexp:"f([a-z]*)th",group:1},"if"]},expected:[4]},{label:"filters with or (one condition)",filter:{or:[{eq:[{property:"num"},1]}]},expected:[1]},{label:"filters with or (two conditions)",filter:{or:[{eq:[{property:"num"},1]},{eq:[{property:"str"},"c"]}]},expected:[1,4]},{label:"filters with or (three conditions)",filter:{or:[{eq:[{property:"num"},1]},{eq:[{property:"str"},"c"]},{eq:[{property:"group"},0]}]},expected:[1,3,4]},{label:"filters with and (one condition)",filter:{and:[{eq:[{property:"group"},1]}]},expected:[0,2,4]},{label:"filters with and (two conditions)",filter:{and:[{eq:[{property:"group"},1]},{eq:[{property:"str"},"c"]}]},expected:[4]},{label:"filters with and (three conditions)",filter:{and:[{eq:[{property:"group"},1]},{eq:[{property:"str"},"c"]},{eq:[{property:"num"},3]}]},expected:[4]}].forEach(function(t){it(t.label,function(){var n,r;n=e.filter(gpf.createFilterFunction(t.filter)),r=t.expected,assert(n.length===r.length),assert(n.every(function(e,t){return e.id===r[t]}))})})})}),describe("stream",function(){if(gpf.internals){var e=gpf.internals._gpfStreamQueryReadable,t=gpf.internals._gpfStreamQueryWritable,n=gpf.internals._gpfStreamSecureInstallProgressFlag,r=gpf.internals._gpfStreamSecureRead,s=gpf.internals._gpfStreamSecureWrite,i=["","Hello World !",!1,!0,null,undefined,0,1];describe("(internal)",function(){describe("_gpfStreamQueryReadable",function(){it("checks if the parameters implements gpf.interfaces.IReadableStream",function(){assert(e({read:function(e){assert(e)}}))}),it("fails when the parameters does not implement gpf.interfaces.IReadableStream",function(){var t;try{e({})}catch(e_){t=e_}assert(t instanceof gpf.Error.InterfaceExpected)}),i.forEach(function(t){it("fails when the parameters is invalid - "+JSON.stringify(t),function(){var n;try{e(t)}catch(e_){n=e_}assert(n instanceof gpf.Error.InterfaceExpected)})})}),describe("_gpfStreamQueryWritable",function(){it("checks if the parameters implements gpf.interfaces.IWritableStream",function(){assert(t({write:function(e){assert(e)}}))}),it("fails when the parameters does not implement gpf.interfaces.IWritaableStream",function(){var e;try{t({})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),i.forEach(function(e){it("fails when the parameters is invalid - "+JSON.stringify(e),function(){var n;try{t(e)}catch(e_){n=e_}assert(n instanceof gpf.Error.InterfaceExpected)})})}),describe("_gpfStreamSecureRead",function(){function e(){}e.prototype={read:r(function(e){return e.write("TEST")})},n(e),it("accepts only IWritableStream",function(){var t,n=new e;try{n.read({})}catch(e_){t=e_}assert(t instanceof gpf.Error.InterfaceExpected)}),it("is protected against parallel calls",function(){var t,n={write:function(e){return assert("TEST"===e),new Promise(function(){})}},r=new e;try{r.read(n),r.read(n)}catch(e_){t=e_}assert(t instanceof gpf.Error.ReadInProgress)}),it("writes to an IWritableStream",function(t){var n={write:function(e){return assert("TEST"===e),Promise.resolve()}};(new e).read(n).then(function(){t()})}),it("forwards any error",function(t){var n={write:function(e){return assert("string"==typeof e),Promise.reject(1)}};(new e).read(n).then(function(){},function(e){var n;try{assert(1===e)}catch(e_){n=e_}t(n)})})}),describe("_gpfStreamSecureWrite",function(){function e(){}e.prototype={write:s(function(e){return"OK"===e?Promise.resolve():Promise.reject(e)})},n(e),it("is protected against parallel calls",function(){var t,n=new e;try{n.write("OK"),n.write("OK")}catch(e_){t=e_}assert(t instanceof gpf.Error.WriteInProgress)}),it("forwards any error",function(t){(new e).write("KO").then(function(){},function(e){var n;try{assert("KO"===e)}catch(e_){n=e_}t(n)})})})})}}),describe("stream/string",function(){describe("gpf.stream.ReadableString",function(){it("writes to an IWritableStream",function(e){var t=new gpf.stream.WritableString;new gpf.stream.ReadableString("Hello World").read(t).then(function(){assert("Hello World"===t.toString()),e()})})}),describe("gpf.stream.WritableString",function(){it("supports multiple sequenced calls",function(e){var t=new gpf.stream.WritableString;t.write("Hell").then(function(){return t.write("o ")}).then(function(){return t.write("World")}).then(function(){assert("Hello World"===t.toString()),e()})})})}),describe("fs",function(){var e="test/data";describe("gpf.fs.getFileStorage",function(){function t(t){assert(t.type===gpf.fs.types.file),assert("file.bin"===t.fileName),assert(-1!==t.filePath.indexOf(e+"/file.bin")),assert(256===t.size),assert(t.createdDateTime instanceof Date),assert(t.createdDateTime.getUTCFullYear()>2010),assert(t.modifiedDateTime instanceof Date),assert(t.modifiedDateTime.getUTCFullYear()>2010)}function n(t){assert(t.type===gpf.fs.types.directory),assert("folder"===t.fileName),assert(-1!==t.filePath.indexOf(e+"/folder")),assert(t.createdDateTime instanceof Date),assert(t.createdDateTime.getUTCFullYear()>2010),assert(t.modifiedDateTime instanceof Date),assert(t.modifiedDateTime.getUTCFullYear()>2010)}if(gpf.fs.getFileStorage()){var r="tmp/fs/"+gpf.host()+"/"+(new Date).toISOString().replace(/-|T|:|\.|Z/g,"")+"/"+Math.floor(100*Math.random());it("returns a file storage interface",function(){assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IFileStorage,gpf.fs.getFileStorage()))}),describe("getInfo",function(){it("can get file information",function(n){gpf.fs.getFileStorage().getInfo(gpf.path.join(e,"file.bin")).then(t).then(n,n)}),it("can get directory information",function(t){gpf.fs.getFileStorage().getInfo(gpf.path.join(e,"folder")).then(n).then(t,t)}),it("does not fail if the file does not exist",function(t){gpf.fs.getFileStorage().getInfo(gpf.path.join(e,"nope")).then(function(e){assert(e.type===gpf.fs.types.notFound)}).then(t,t)})}),describe("openTextStream",function(){function t(e,t){var n=gpf.fs.getFileStorage(),r=new gpf.stream.WritableString;return n.openTextStream(e,gpf.fs.openFor.reading).then(function(e){return assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IReadableStream,e)),e.read(r).then(function(){return t&&assert(r.toString()===t),n.close(e).then(function(){return r.toString()})})})}describe("read",function(){it("reads a small text file",function(n){t(gpf.path.join(e,"folder/hello world.txt"),"hello world\n").then(function(){n()},n)}),it("reads a larger text file",function(n){t(gpf.path.join(e,"folder/lorem ipsum.txt")).then(function(e){assert(-1!==e.indexOf("Phasellus posuere.")),n()})["catch"](n)})}),describe("write",function(){function e(e,t){var n=gpf.fs.getFileStorage();return n.openTextStream(e,gpf.fs.openFor.appending).then(function(e){return e.write(t).then(function(){return n.close(e)})})}before(function(e){var t,n,s,i;(t=r,n=t.split("/"),s=-1,i=gpf.fs.getFileStorage(),function a(){if(++s===n.length)return Promise.resolve();var e=n.slice(0,s+1).join("/");return i.getInfo(e).then(function(t){return t.type===gpf.fs.types.directory?a():t.type===gpf.fs.types.notFound?i.createDirectory(e).then(a):Promise.reject("ERROR")})}()).then(function(){e()},e)}),after(function(e){var t,n,s;(t=r,n=t.split("/"),s=gpf.fs.getFileStorage(),function i(){var e=n.join("/");return s.deleteDirectory(e).then(function(){if(n.pop(),n.length>3)return i()})}()).then(function(){e()},e)}),describe("initial",function(){var n=gpf.path.join(r,"hello world.txt");before(function(t){e(n,"hello world\n").then(t,t)}),after(function(e){gpf.fs.getFileStorage().deleteFile(n).then(e,e)}),it("writes a text file",function(e){t(n,"hello world\n").then(function(){e()},e)}),describe("append",function(){it("appends a text file",function(r){e(n,"goodbye\n").then(function(){return t(n,"hello world\ngoodbye\n")}).then(function(){r()},r)})})})})}),describe("close",function(){it("rejects invalid streams",function(e){gpf.fs.getFileStorage().close({}).then(function(){throw new Error}).then(undefined,function(e){assert(e instanceof gpf.Error.IncompatibleStream)}).then(e,e)})}),describe("explore",function(){it("lists the content of a folder",function(r){gpf.fs.getFileStorage().explore(e).then(function(e){function s(r){var s=e.getCurrent();return r.type===gpf.fs.types.file?(t(r),t(s)):(n(r),n(s)),e.moveNext()}return assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IEnumerator,e)),e.reset().then(function(){return e.moveNext()}).then(s).then(s).then(function(e){assert(e===undefined)}).then(r,r)})}),it("fails on a file",function(t){gpf.fs.getFileStorage().explore(gpf.path.join(e,"file.bin")).then(function(){t(new Error("unexpected"))},function(){t()})}),it("fails with an invalid path",function(t){gpf.fs.getFileStorage().explore(gpf.path.join(e,"nothing")).then(function(){t(new Error("unexpected"))},function(){t()})})})}else it("does not return a file storage interface",function(){var e=gpf.fs.getFileStorage();assert(null===e)})}),gpf.host()!==gpf.hosts.browser&&describe("gpf.fs.read",function(){it("gives a generic read access to the file system",function(t){gpf.fs.read(gpf.path.join(e,"folder/hello world.txt")).then(function(e){try{assert("hello world\n"===e),t()}catch(e_){t(e_)}},t)}),it("fails if the file does not exist",function(t){gpf.fs.read(gpf.path.join(e,"nope")).then(function(){t(new Error("Should not happen"))},function(e){try{assert(e instanceof Error),t()}catch(e_){t(e_)}})})})}),describe("path",function(){var e=gpf.path;function t(t){var n;n="/"===t?t:"\\\\",describe("gpf.path.join ("+t+")",function(){var n;n="/"===t?e.join:function(){var n=Array.from(arguments,function(e){return e.split("/").join(t)});return e.join.apply(e,n)},it("concatenates paths",function(){assert("abc/def/ghi/jkl"===n("abc/def","ghi/jkl"))}),it("handles trailing separator",function(){assert("abc/def/ghi/jkl"===n("abc/def/","ghi/jkl/"))}),it("handles relative paths",function(){assert("abc/ghi"===n("abc/def","../ghi"))}),it("handles multiple joins",function(){assert("abc/ghi/jkl"===n("abc","def","../ghi/jkl","../jkl"))}),it("resolves on known parent",function(){assert("ghi"===n("abc","../ghi"))}),it("goes up with ..",function(){assert("abc"===n("abc/def",".."))}),it("does not resolve on unknown parent",function(){var e;try{n("abc","../../ghi")}catch(e_){e=e_}assert(e instanceof gpf.Error.UnreachablePath)})}),describe("gpf.path.parent ("+t+")",function(){it("retrieves the parent path",function(){assert("abc"===e.parent("abc"+t+"def"))}),it("returns empty on a root",function(){assert(""===e.parent(t+"abc"))}),it("returns empty when no parent",function(){assert(""===e.parent("abc"))}),it("fails when empty",function(){var t;try{e.parent("")}catch(e_){t=e_}assert(t instanceof gpf.Error.UnreachablePath)})});var r=Function,s=[{label:"considers the last name of path",path:"abc"+n+"def.ghi",name:"def.ghi",nameOnly:"def",extension:".ghi"},{label:"handles trailing separator",path:"abc"+n+"def.ghi"+n,name:"def.ghi",nameOnly:"def",extension:".ghi"},{label:"handles trailing separator (no extension)",path:"abc"+n+"def"+n,name:"def",nameOnly:"def",extension:""},{label:"handles name only",path:"abc.defgh",name:"abc.defgh",nameOnly:"abc",extension:".defgh"},{label:"handles name only (no extension)",path:"abc",name:"abc",nameOnly:"abc",extension:""},{label:"handles root",path:"/",name:"",nameOnly:"",extension:""},{label:"handles empty path",path:"",name:"",nameOnly:"",extension:""}];function i(e){return new r("assert(gpf.path."+e+");")}describe("gpf.path.name ("+t+")",function(){s.forEach(function(e){it(e.label,i('name("'+e.path+'") === "'+e.name+'"'))})}),describe("gpf.path.nameOnly ("+t+")",function(){s.forEach(function(e){it(e.label,i('nameOnly("'+e.path+'") === "'+e.nameOnly+'"'))})}),describe("gpf.path.extension ("+t+")",function(){s.forEach(function(e){it(e.label,i('extension("'+e.path+'") === "'+e.extension+'"'))})}),describe("gpf.path.relative ("+t+")",function(){var n;n="/"===t?e.relative:function(){var n=Array.from(arguments,function(e){return e.split("/").join(t)});return e.relative.apply(e,n)},it("solves the relative path",function(){assert("../ghi"===n("abc/def","abc/ghi"))}),it("handles trailing separator",function(){assert("../ghi"===n("abc/def/","abc/ghi"))}),it("works on non matching roots",function(){assert("../../ghi/jkl"===n("abc/def","ghi/jkl"))}),it("works on non matching roots (any level)",function(){assert("../../../g/h/i/jkl"===n("a/bc/def","g/h/i/jkl"))}),it("handles edge cases (left empty)",function(){assert("abc/ghi"===n("","abc/ghi"))}),it("handles edge cases (right empty)",function(){assert("../.."===n("abc/ghi",""))}),it("handles edge cases (both empty)",function(){assert(""===n("",""))})})}t("/"),t("\\"),gpf.internals&&describe("(internal)",function(){describe("_gpfPathNormalize",function(){gpf.internals._gpfObjectForEach({"a/":"a","/a/":"/a","a/b":"a/b","a\\b":"a/b","a\\":"a","\\a\\":"/a"},function(e,t){it('transforms "'+t+'" into "'+e+'"',function(){assert(e===gpf.internals._gpfPathNormalize(t))})})})})}),describe("stream/node",function(){function e(){this._events={}}e.prototype={_events:{},_fire:function(e){var t=[].slice.call(arguments,1);this._events[e].apply(null,t)},on:function(e,t){return assert(!this._events[e]),this._events[e]=t,this},once:function(e,t){return this.on(e,function(){t(),delete this._events[e]}.bind(this))}},gpf.hosts.nodejs===gpf.host()&&(describe("gpf.node.ReadableStream",function(){it("configures the stream by hooking the events",function(t){var n=new e,r=new gpf.node.ReadableStream(n),s=new gpf.stream.WritableString;assert("function"==typeof n._events.error),r.read(s).then(t,t),assert("function"==typeof n._events.data),assert("function"==typeof n._events.end),n._fire("end")}),it("supports several read events",function(t){var n=new e,r=new gpf.node.ReadableStream(n),s=new gpf.stream.WritableString;r.read(s).then(function(){assert("Hello World"===s.toString())}).then(t,t);var i=!1,a=0;n.pause=function(){assert(!i),i=!0},n.resume=function(){assert(i),i=!1,setTimeout(function(){1===++a?n._fire("data","World"):n._fire("end")},0)},n._fire("data","Hello ")}),it("handles errors",function(t){var n=new e,r=new gpf.node.ReadableStream(n),s=new gpf.stream.WritableString;r.read(s).then(function(){assert(!1)}).then(undefined,function(e){assert("error"===e)}).then(t,t);var i=!1;n.pause=function(){assert(!i),i=!0},n.resume=function(){assert(i),i=!1,setTimeout(function(){n._fire("error","error")},0)},n._fire("data","Hello ")}),it("handles errors of write stream",function(t){var n=new e,r=new gpf.node.ReadableStream(n),s={write:function(e){return Promise.reject(e)}};n.pause=function(){},r.read(s).then(function(){assert(!1)},function(e){assert("error"===e)}).then(t,t),n._fire("data","error")}),it("prevents any subsequent use when an error occurred",function(t){var n=new e,r=new gpf.node.ReadableStream(n),s=new gpf.stream.WritableString;r.read(s).then(function(){assert(!1)}).then(undefined,function(e){return assert("error"===e),r.read(s)}).then(undefined,function(e){assert(e instanceof gpf.Error.InvalidStreamState)}).then(t,t),n._fire("error","error")}),it("prevents any subsequent use when ended",function(t){var n=new e,r=new gpf.node.ReadableStream(n),s=new gpf.stream.WritableString;r.read(s).then(function(){return r.read(s)}).then(undefined,function(e){assert(e instanceof gpf.Error.InvalidStreamState)}).then(t,t),n._fire("end")})}),describe("gpf.node.ReadableStream",function(){it("configures the stream by hooking the events",function(){var t=new e,n=new gpf.node.WritableStream(t);assert("function"==typeof n.write),assert("function"==typeof t._events.error)}),it("passes the buffer to the inner stream",function(t){var n=new e,r=new gpf.node.WritableStream(n);assert("function"==typeof n._events.error),n.write=function(e){return assert("Hello World"===e),!0},r.write("Hello World").then(t,t),assert(!n._events.drain)}),it("supports several write calls",function(t){var n=new e,r=new gpf.node.WritableStream(n),s="";assert("function"==typeof n._events.error),n.write=function(e){return s+=e,!0},r.write("Hello ").then(function(){return r.write("World")}).then(function(){assert("Hello World"===s)}).then(t,t),assert(!n._events.drain)}),it("waits for the drain event if the stream is full",function(t){var n=new e,r=new gpf.node.WritableStream(n),s=!1;assert("function"==typeof n._events.error),n.write=function(e){return assert("Hello World"===e),!1},r.write("Hello World").then(function(){assert(s),assert(!n._events.drain)}).then(t,t),assert("function"==typeof n._events.drain),s=!0,n._fire("drain")}),it("handles errors",function(t){var n=new e,r=new gpf.node.WritableStream(n);assert("function"==typeof n._events.error),n.write=function(){n._fire("error","error")},r.write("Hello World").then(undefined,function(e){assert("error"===e)}).then(t,t)}),it("prevents any subsequent use when an error occurred",function(t){var n=new e,r=new gpf.node.WritableStream(n);assert("function"==typeof n._events.error),n.write=function(){n._fire("error","error")},r.write("Hello World").then(undefined,function(e){return assert("error"===e),r.write("Hello World")}).then(undefined,function(e){assert(e instanceof gpf.Error.InvalidStreamState)}).then(t,t)})}))}),describe("fs/node",function(){if(gpf.hosts.nodejs===gpf.host()&&(it("forwards inner errors (generic API)",function(e){gpf.fs.getFileStorage().deleteFile("test/data/notFound.bin").then(function(){throw new Error("Should fail")},function(t){assert("ENOENT"===t.code),e()})["catch"](function(t){e(t)})}),gpf.internals)){var e=gpf.internals._gpfFsNodeGetType;it("uses unknown file type if not file or directory",function(){assert(gpf.fs.types.unknown===e({isDirectory:function(){return!1},isFile:function(){return!1}}))})}}),describe("literal",function(){describe("gpf.isLiteralObject",function(){[{value:{},result:!0},{value:{member:"a"},result:!0},{value:new Object,result:!0},{value:null},{value:undefined},{value:new function(){},label:"new A()"},{value:[]},{value:new Date,label:"new Date()"},{value:!0}].forEach(function(e){var t=e.label||JSON.stringify(e.value),n=!0===e.result;it({"true":"recognizes","false":"rejects"}[n]+" "+t,function(){assert(n===gpf.isLiteralObject(e.value))})})})}),describe("web/tag",function(){function e(e,t,n){this._namespace=e,this._name=t,this._value=n}function t(e,t,n){this.ownerDocument=e,this._namespace=t,this.nodeName=n,this._attributes=[],this._children=[]}e.prototype={_namespace:"",_name:"",_value:undefined},t.prototype={ownerDocument:null,_namespace:"",nodeName:"",_attributes:[],_children:[],appendChild:function(e){return this._children.push(e),e},setAttribute:function(t,n){this._attributes.push(new e("",t,n))},setAttributeNS:function(t,n,r){this._attributes.push(new e(t,n,r))},_hasAttribute:function(e,t){var n;return this._attributes.every(function(r){return r._namespace!==e||r._name!==t||(n=r._value,!1)}),n}};var n={createElement:function(e){return new t(this,"",e)},createElementNS:function(e,n){return new t(this,e,n)},createTextNode:function(e){return e}};describe("gpf.web.createTagFunction",function(){it("requires node name when calling the function",function(){var e;try{gpf.web.createTagFunction()}catch(e_){e=e_}assert(e instanceof gpf.Error.MissingNodeName)}),it("creates shortcut for tag generation",function(){var e=gpf.web.createTagFunction("div");assert("<div>Hello World!</div>"===e("Hello World!").toString())}),it("generates closed tags when empty",function(){var e=gpf.web.createTagFunction("div");assert("<div/>"===e().toString())}),it("supports tree building (parameters)",function(){var e=gpf.web.createTagFunction("div")({className:"test1"},"Hello ",gpf.web.createTagFunction("span")({className:"test2"},"World!"));assert('<div class="test1">Hello <span class="test2">World!</span></div>'===e.toString())}),it("supports tree building (array parameter)",function(){var e=gpf.web.createTagFunction("div"),t=gpf.web.createTagFunction("span"),n=e({width:"80%"},"Hello ",[t("Wor"),t("ld!")]);assert('<div width="80%">Hello <span>Wor</span><span>ld!</span></div>'===n.toString())}),it("allows DOM injection",function(){var e=n.createElement("any"),r=gpf.web.createTagFunction("div")({className:"test"},"Hello ",gpf.web.createTagFunction("span")("World!")).appendTo(e);assert(r instanceof t),assert(r.ownerDocument===n),assert("div"===r.nodeName),assert("test"===r._hasAttribute("","class")),assert(2===r._children.length),assert("Hello "===r._children[0]),assert(r._children[1]instanceof t),assert("World!"===r._children[1]._children[0])}),describe("Namespace handling",function(){it("permits namespaces for node appending",function(){var e=n.createElement("any"),r=gpf.web.createTagFunction("svg:image")({x:0,y:0,"xlink:href":"test.png"}).appendTo(e);assert(r instanceof t),assert(r.ownerDocument===n),assert("image"===r.nodeName),assert("http://www.w3.org/2000/svg"===r._namespace),assert("test.png"===r._hasAttribute("http://www.w3.org/1999/xlink","href")),assert(0===r._hasAttribute("","x"))}),it("fails if namespace is unknown",function(){var e,t=n.createElement("any"),r=gpf.web.createTagFunction("svg2:image")({x:0,y:0,"xlink:href":"test.png"});try{r.appendTo(t)}catch(e_){e=e_}assert(e instanceof gpf.Error.UnknownNamespacePrefix)}),it("fails when used for string generation",function(){var e,t=gpf.web.createTagFunction("svg:image")({x:0,y:0,"xlink:href":"test.png"});try{t.toString()}catch(e_){e=e_}assert(e instanceof gpf.Error.UnableToUseNamespaceInString)})})})}),describe("gpf.interfaces.IThenable",function(){function e(e){var t=gpf[e].bind(gpf);[null,0,"",!1,!0,{},"Hello World!",7].forEach(function(e){it("converts "+JSON.stringify(e)+" into a promise",function(n){try{t(e).then(function(t){assert(e===t),n()})}catch(e_){n(e_)}})}),it("returns the promise parameter",function(){var e=Promise.resolve();assert(e===t(e))}),it("returns the IThenable parameter",function(e){try{var n={then:function(e,t){e("ok")}},r=t(n);assert(n===r),r.then(function(t){assert("ok"===t),e()})}catch(e_){e(e_)}})}describe("gpf.promisify",function(){it("converts undefined into a promise",function(e){try{gpf.promisify().then(function(t){assert(undefined===t),e()})}catch(e_){e(e_)}}),e("promisify")}),describe("gpf.promisifyDefined",function(){it("returns undefined with undefined",function(){assert(gpf.promisifyDefined(undefined)===undefined)}),e("promisifyDefined")})}),describe("gpf.http.mock",function(){var e;before(function(){e="http://localhost:"+config.httpPort+"/echo/"}),it("exposes a method to mock requests",function(){assert("function"==typeof gpf.http.mock)}),it("exposes a method to remove one specific mocking",function(){assert("function"==typeof gpf.http.mock.remove)}),it("exposes a method to reset all mocking",function(){assert("function"==typeof gpf.http.mock.reset)}),describe("Simple mocking example",function(){var t;beforeEach(function(){t=gpf.http.mock({method:gpf.http.methods.get,url:/echo\/\?status=([0-9]+)/,response:function(e,t){if("400"!==t)return{status:parseInt(t,10)+1,headers:{"x-mock":!0},responseText:"It works"}}})}),afterEach(function(){t&&gpf.http.mock.remove(t)}),it("matches request URL and method",function(t){gpf.http.get(e+"?status=200").then(function(e){assert(201===e.status),assert(!0===e.headers["x-mock"]),assert("It works"===e.responseText),t()})["catch"](t)}),0!==config.httpPort&&(it("matches request URL and method (non matching URL)",function(t){gpf.http.get(e).then(function(e){assert(200===e.status),assert(e.headers["x-mock"]===undefined),t()})["catch"](t)}),it("matches request URL and method (non matching method)",function(t){gpf.http.put(e,"?status=200").then(function(e){assert(200===e.status),assert(e.headers["x-mock"]===undefined),t()})["catch"](t)}),it("may decide to not mock",function(t){gpf.http.get(e+"?status=400").then(function(e){assert(400===e.status),assert(e.headers["x-mock"]===undefined),t()})["catch"](t)}),it("does not mock once removed",function(n){gpf.http.mock.remove(t),t=undefined,gpf.http.get(e+"?status=200").then(function(e){assert(200===e.status),assert(e.headers["x-mock"]===undefined),n()})["catch"](n)}),it("does not mock once removed (reset)",function(n){gpf.http.mock.reset(),t=undefined,gpf.http.get(e+"?status=200").then(function(e){assert(200===e.status),assert(e.headers["x-mock"]===undefined),n()})["catch"](n)}),it("does not fail if removed twice",function(){gpf.http.mock.reset(),gpf.http.mock.remove(t),t=undefined}))}),describe("Advanced mocking example",function(){var t;beforeEach(function(){function e(e){return function(){return{status:200,headers:{},responseText:"answer-"+e}}}gpf.http.mock({method:gpf.http.methods.get,url:/echo\/lifo/,response:e(1)}),gpf.http.mock({method:gpf.http.methods.get,url:/echo\/lifo/,response:e(2)}),t=gpf.http.mock({method:gpf.http.methods.get,url:/echo\/lifo/,response:e(3)}),gpf.http.mock({method:gpf.http.methods.put,url:/echo\/lifo/,response:e(4)}),gpf.http.mock({method:gpf.http.methods.get,url:/echo\/redirect/,response:function(e){return gpf.http.get(e.url.replace("/redirect","/lifo"))}})}),afterEach(function(){gpf.http.mock.reset()}),it("uses LIFO priority",function(t){gpf.http.get(e+"lifo").then(function(e){assert(200===e.status),assert("answer-3"===e.responseText),t()})["catch"](t)}),it("preserves the order when removing a mocked request",function(n){gpf.http.mock.remove(t),gpf.http.get(e+"lifo").then(function(e){assert(200===e.status),assert("answer-2"===e.responseText),n()})["catch"](n)}),it("allows redirection",function(t){gpf.http.get(e+"redirect").then(function(e){assert(200===e.status),assert("answer-3"===e.responseText),t()})["catch"](t)})})}),describe("http",function(){it("knows config.httpPort",function(){assert("object"==typeof config&&"number"==typeof config.httpPort)}),describe("gpf.http",function(){var e;0!==config.httpPort?(before(function(){e="http://localhost:"+config.httpPort+"/echo/?"}),it("allows the GET operation",function(t){gpf.http.request({method:gpf.http.methods.get,url:e+"status=200"}).then(function(e){assert(200===e.status);var n=JSON.parse(e.responseText);assert("GET"===n.method),assert("/echo/?status=200"===n.url),t()})["catch"](t)}),it("offers the GET shortcut (using string parameter)",function(t){gpf.http.get(e+"status=200").then(function(e){assert(200===e.status);var n=JSON.parse(e.responseText);assert("GET"===n.method),assert("/echo/?status=200"===n.url),t()})["catch"](t)}),it("offers the GET shortcut (using object parameter)",function(t){gpf.http.get({url:e+"status=200&response=Hello%20World"}).then(function(e){assert(200===e.status),assert("Hello World"===e.responseText),t()})["catch"](t)}),it("succeeds when the HTTP request fails",function(t){gpf.http.get(e+"status=500").then(function(e){assert(500===e.status),t()})["catch"](t)}),it("succeeds when the HTTP response is empty",function(t){gpf.http.get(e+"response=").then(function(e){assert(""===e.responseText),t()})["catch"](t)}),it("forwards request headers",function(t){gpf.http.request({method:gpf.http.methods.get,url:e+"status=200",headers:{"x-test":"Value"}}).then(function(e){assert(200===e.status),assert("Value"===e.headers["x-test"]),t()})["catch"](t)}),it("gives access to response headers",function(t){gpf.http.request({method:gpf.http.methods.get,url:e+'status=200&headers={"x-test-1":"OK","x-test-2":123}'}).then(function(e){assert(200===e.status),assert("OK"===e.headers["x-test-1"]),assert("123"===e.headers["x-test-2"]),t()})["catch"](t)}),["post","put","options","delete","head"].forEach(function(t,n){var r,s,i=t.toUpperCase();n<2&&(r="Hello World"),s="head"===t?function(){}:function(e){var t=JSON.parse(e);assert(t.method===i),assert("/echo/?status=200"===t.url),r?assert(t.body===r):assert(!t.body)},it("allows the "+i+" operation",function(n){gpf.http.request({method:gpf.http.methods[t],url:e+"status=200",data:r}).then(function(e){assert(200===e.status),s(e.responseText),n()})["catch"](n)}),it("offers the "+i+" shortcut",function(n){gpf.http[t](e+"status=200",r).then(function(e){assert(200===e.status),s(e.responseText),n()})["catch"](n)})}),gpf.hosts.browser!==gpf.host()&&describe("https",function(){it("handles https access",function(e){gpf.http.get("https://github.com/ArnaudBuchholz/gpf-js").then(function(t){assert(200===t.status),e()})["catch"](e)})})):it("is not tested in this environment because config.httpPorty = 0",function(){assert(!0)})})}),describe("stream/java",function(){gpf.hosts.rhino===gpf.host()&&describe("gpf.java.ReadableStream",function(){it("forwards any error",function(e){new gpf.java.ReadableStream({close:function(){}}).read({_ignore:function(){},write:function(e){this._ignore(e)}}).then(function(){e(new Error("Not expected"))},function(t){try{assert(t),e()}catch(e_){e(e_)}})})})}),describe("stream/bufferedread",function(){describe("gpf.stream.BufferedRead",function(){function e(e){return e}var t=gpf.define({$class:"TestReadable",$extend:"gpf.stream.BufferedRead",appendToReadBuffer:function(t){return e(t),this._appendToReadBuffer.apply(this,arguments)},completeReadBuffer:function(){return this._completeReadBuffer()},setReadError:function(e){return this._setReadError(e)}});function n(e){var t=new gpf.stream.WritableArray;return gpf.stream.pipe(e,t).then(function(){return t.toArray()})}function r(e,t){n(e).then(function(e){assert(2===e.length),assert("Hello"===e[0]),assert("World!"===e[1]),t()})["catch"](t)}it("exposes IReadableStream",function(){assert(gpf.interfaces.isImplementedBy(gpf.interfaces.IReadableStream,t))}),describe("data output",function(){it("outputs data before reading",function(e){var n=new t;n.appendToReadBuffer("Hello","World!").completeReadBuffer(),r(n,e)}),it("outputs data while reading",function(e){var n=new t;n.appendToReadBuffer("Hello"),r(n,e),n.appendToReadBuffer("World!").completeReadBuffer()}),it("outputs data after reading",function(e){var n=new t;r(n,e),n.appendToReadBuffer("Hello","World!").completeReadBuffer()})}),describe("error management",function(){function r(e,t){n(e).then(function(){throw new Error("Should fail")},function(e){assert("FAIL"===e.message),t()})["catch"](t)}function s(e,n){var r=new t;r.appendToReadBuffer("Hello","World!").completeReadBuffer(),gpf.stream.pipe(r,e).then(function(){throw new Error("Should fail")},function(e){assert("FAIL"===e.message),n()})["catch"](n)}it("generates errors before reading",function(e){var n=new t;n.appendToReadBuffer("Hello","World!").setReadError(new Error("FAIL")),r(n,e)}),it("generates errors while reading",function(e){var n=new t;n.appendToReadBuffer("Hello"),r(n,e),n.appendToReadBuffer("World!").setReadError(new Error("FAIL"))}),it("generates errors after reading",function(e){var n=new t;r(n,e),n.appendToReadBuffer("Hello","World!").setReadError(new Error("FAIL"))}),it("forwards errors (exception)",function(t){s({write:function(t){throw e(t),new Error("FAIL")}},t)}),it("forwards errors (reject)",function(t){s({write:function(t){return e(t),Promise.reject(new Error("FAIL"))}},t)})})})}),describe("stream/line",function(){function e(e){return e.write("abc").then(function(){return e.write("def\n")}).then(function(){return e.write("gh")}).then(function(){return e.write("ijkl\r")})}function t(e){return e.write("\nmnopqr\n").then(function(){return e.write("stuvwx\nyz")})}var n=["abcdef","ghijkl","mnopqr","stuvwx","yz"];function r(){return{_index:0,write:function(e){return e!==n[this._index]?Promise.reject("No match"):(++this._index,Promise.resolve())}}}it("generates lines out of any stream (read first)",function(s){var i=new gpf.stream.LineAdapter,a=r();i.read(a).then(function(){assert(a._index===n.length),s()})["catch"](s),e(i).then(function(){return t(i)}).then(function(){i.flush()})}),it("generates lines out of any stream (write first)",function(s){var i=new gpf.stream.LineAdapter,a=r();e(i).then(function(){return t(i)}).then(function(){return i.write("\n")}).then(function(){return i.flush()}).then(function(){return i.read(a)}).then(function(){assert(a._index===n.length),s()})["catch"](s)}),it("generates lines out of any stream (mixed)",function(s){var i=new gpf.stream.LineAdapter,a=r();e(i).then(function(){i.read(a).then(function(){assert(a._index===n.length),s()})["catch"](s),t(i).then(function(){i.flush()})})})}),describe("require",function(){var e;before(function(){e=0===config.httpPort?"/gpf/test-resources/require":"/test/require",gpf.require.configure({base:e})}),describe("gpf.require.resolve",function(){it("resolves relative path",function(){assert(gpf.require.resolve("file.js")===e+"/file.js")}),it("resolves relative path with folders",function(){assert(gpf.require.resolve("folder/file.js")===e+"/folder/file.js")}),it("resolves relative path with folders (use of ..)",function(){assert(gpf.require.resolve("../file.js")===e.split("/").slice(0,-1).join("/")+"/file.js")})}),describe("gpf.require.configure",function(){it("fails on invalid options",function(){var e;try{gpf.require.configure({unknown:!0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidRequireConfigureOption)})}),describe("gpf.require.define",function(){function e(e){assert("object"==typeof e),assert("value"===e.member)}function t(t,n,r){assert("object"==typeof t),assert(n===t.type),r&&e(t.data)}describe("Asynchronous loading",function(){beforeEach(function(){gpf.require.configure({clearCache:!0})}),it("loads JSON file as an object",function(t){gpf.require.define({data:"data.json"},function(n){try{e(n.data),t()}catch(e_){t(e_)}}).then(undefined,t)}),it("supports CommonJS format (static requires)",function(e){gpf.require.define({commonjs:"commonjs.js"},function(n){try{t(n.commonjs,"commonjs",!0),e()}catch(e_){e(e_)}}).then(undefined,e)}),it("doesn't supports CommonJS format with static and dynamic requires",function(e){gpf.require.define({commonjs:"mixed_commonjs.js"}).then(function(){e(new Error("Should not happen"))},function(t){try{assert(t instanceof gpf.Error.NoCommonJSDynamicRequire),e()}catch(e_){e(e_)}})}),it("supports independant CommonJS format (no require)",function(e){gpf.require.define({commonjs:"indep_commonjs.js"},function(n){try{t(n.commonjs,"indep_commonjs",!0),e()}catch(e_){e(e_)}}).then(undefined,e)}),it("doesn't supports CommonJS format with only dynamic requires",function(e){gpf.require.define({commonjs:"dynamic_commonjs.js"}).then(function(){e(new Error("Should not happen"))},function(t){try{assert(t instanceof gpf.Error.NoCommonJSDynamicRequire),e()}catch(e_){e(e_)}})}),it("supports AMD format (named with factory)",function(e){gpf.require.define({amd:"amd.js"},function(n){try{t(n.amd,"amd",!0),e()}catch(e_){e(e_)}}).then(undefined,e)}),it("supports AMD format (no name)",function(e){gpf.require.define({amd:"anonymous_amd.js"},function(n){try{t(n.amd,"amd",!1),assert(""===n.amd.name),e()}catch(e_){e(e_)}}).then(undefined,e)}),it("supports AMD format (anonymous static)",function(e){gpf.require.define({amd:"static_amd.js"},function(n){try{t(n.amd,"amd",!1),assert("static"===n.amd.name),e()}catch(e_){e(e_)}}).then(undefined,e)}),it("supports GPF modules (gpf is defined)",function(e){gpf.require.define({gpf:"gpf.js"},function(n){try{t(n.gpf,"gpf",!0),e()}catch(e_){e(e_)}}).then(undefined,e)}),it("supports GPF modules without constant value",function(e){gpf.require.define({constants:"constants.js"},function(t){try{assert("World!"===t.constants.hello),e()}catch(e_){e(e_)}}).then(undefined,e)}),it("supports JavaScript file (no result)",function(e){gpf.context().test={},gpf.require.define({js:"empty.js"},function(t){try{assert(t.js===undefined),assert(gpf.context().test.empty),e()}catch(e_){e(e_)}finally{delete gpf.context().test}}).then(undefined,e)}),it("supports text file (no processor)",function(e){gpf.require.define({text:"../data/folder/hello world.txt"},function(t){try{assert("hello world\n"===t.text),e()}catch(e_){e(e_)}}).then(undefined,e)})}),describe("Recursive loading",function(){beforeEach(function(){gpf.require.configure({clearCache:!0})}),it("loads everything recursively",function(n){gpf.require.define({all:"folder/all.js"},function(r){try{t(r.all.amd,"amd",!0),t(r.all.commonjs,"commonjs",!0),e(r.all.data),t(r.all.gpf,"gpf",!0),n()}catch(e_){n(e_)}})})}),describe("Error handling",function(){it("fails if resource does not exist",function(e){gpf.require.define({notFound:"notFound.js"}).then(function(){e(new Error("Should not happen"))},function(t){try{assert(t instanceof Error),assert("Should not happen"!==t.message),e()}catch(e_){e(e_)}})}),it("fails if one javascript resource fails",function(e){gpf.require.define({error:"error.js"}).then(function(){e(new Error("Should not happen"))},function(t){try{assert(t instanceof Error),assert("FAIL!"===t.message),e()}catch(e_){e(e_)}})})})}),describe("caching",function(){beforeEach(function(){gpf.require.configure({clearCache:!0})}),describe("caching of loaded parts",function(){var e={};beforeEach(function(t){gpf.require.define({data:"data.json"},function(n){try{n.data.additional=e,t()}catch(e_){t(e_)}})}),it("keeps modified objects",function(t){gpf.require.define({data:"data.json"},function(n){try{assert(e===n.data.additional),t()}catch(e_){t(e_)}})})}),describe("cache injection",function(){var e={};beforeEach(function(){var t={};t[gpf.require.resolve("data.json")]=e,gpf.require.configure({clearCache:!0,cache:t})}),it("keeps injected objects",function(t){gpf.require.define({data:"data.json"},function(n){try{assert(e===n.data),t()}catch(e_){t(e_)}})})})})}),describe("stream/array",function(){var e=["Hell","o ","World",null,{}];function t(t,n){try{assert(e.length===t.length),e.forEach(function(e,n){assert(e===t[n])}),n()}catch(e_){n(e_)}}describe("gpf.stream.ReadableArray",function(){it("writes each array item sequentially",function(n){var r=new gpf.stream.ReadableArray(e),s=[];r.read({write:function(e){return s.push(e),Promise.resolve()}}).then(function(){t(s,n)},n)})}),describe("gpf.stream.WritableArray",function(){it("stores each call as an array item",function(n){var r=new gpf.stream.WritableArray,s=0;!function i(){e.length===s?t(r.toArray(),n):r.write(e[s++]).then(i,n)}()})})}),describe("stream/pipe",function(){function e(e){return e}function t(t){return e(t),Promise.reject("FAIL")}function n(t){throw e(t),new Error("FAIL")}function r(t){return e(t),Promise.reject("FAIL")}function s(t){throw e(t),new Error("FAIL")}function i(e,t){e.then(function(){throw new Error("Should fail")},function(e){assert("FAIL"===e),t()})["catch"](t)}function a(e,t){e.then(function(){throw new Error("Should fail")},function(e){assert("FAIL"===e.message),t()})["catch"](t)}function o(){var e,t,n,r,s;function i(){if(n||(n=new Promise(function(e,t){r=e,s=t})),t&&e){var i=n,a=r,o=s;return t.write(e).then(a,o),e=undefined,t=undefined,n=undefined,r=undefined,s=undefined,i}return n}return{read:function(e){if(t)throw new Error("Already reading");return t=e,i()},write:function(t){if(e)throw new Error("Buffer full");return e=t,i()}}}function c(e){var t=new gpf.stream.ReadableArray(["Hello ","World!","\n","Goodbye!"]),n=new gpf.stream.WritableArray;return gpf.stream.pipe.apply(gpf.stream,[t].concat(e,n)).then(function(){return n})}function f(e,t){c(e).then(function(e){var n=e.toArray();assert(2===n.length),assert("Hello World!"===n[0]),assert("Goodbye!"===n[1]),t()})["catch"](t)}describe("parameters validation",function(){function t(t){e(t)}function n(t){e(t)}it("fails if the first parameter is not an IReadableStream",function(){var e;try{gpf.stream.pipe({})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),it("fails if no destination",function(){var e;try{gpf.stream.pipe({read:t})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),describe("handling a sequence with more than two streams",function(){it("misses intermediate read",function(){var e;try{gpf.stream.pipe({read:t},{write:n},{write:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),it("misses intermediate write",function(){var e;try{gpf.stream.pipe({read:t},{read:t},{write:n})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)}),it("does not end with write",function(){var e;try{gpf.stream.pipe({read:t},{read:t,write:n},{})}catch(e_){e=e_}assert(e instanceof gpf.Error.InterfaceExpected)})})}),describe("IReadableStream -> IWritableStream",function(){it("Transfer data",function(e){var t=new gpf.stream.WritableString;gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),t).then(function(){assert("Hello World"===t.toString()),e()})["catch"](e)}),it("Triggers flush when the read ends",function(e){var t=new gpf.stream.WritableString,n=!1;t.flush=function(){return n=!0,Promise.resolve()},gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),t).then(function(){assert("Hello World"===t.toString()),assert(n),e()})["catch"](e)}),it("Forward errors (read - reject)",function(e){var n=new gpf.stream.WritableString,r={read:t};i(gpf.stream.pipe(r,n),e)}),it("Forward errors (read - exception)",function(e){var t=new gpf.stream.WritableString,r={read:n};a(gpf.stream.pipe(r,t),e)}),it("Forward errors (write - reject)",function(e){var t={write:r};i(gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),t),e)}),it("Forward errors (write - exception)",function(e){var t={write:s};a(gpf.stream.pipe(new gpf.stream.ReadableString("Hello World"),t),e)})}),describe("IReadableStream -> IReadableStream/IWritableStream* -> IWritableStream",function(){it("handles the whole stream",function(e){f([new gpf.stream.LineAdapter],e)}),it("handles non flushable intermediate stream",function(e){f([o(),new gpf.stream.LineAdapter],e)}),it("Forward errors (read - reject)",function(e){var n=o();n.read=t,i(c([n,new gpf.stream.LineAdapter]),e)}),it("Forward errors (read - exception)",function(e){var t=o();t.read=n,a(c([t,new gpf.stream.LineAdapter]),e)}),it("Forward errors (write - reject)",function(e){var t=o();t.write=r,i(c([t,new gpf.stream.LineAdapter]),e)}),it("Forward errors (write - exception)",function(e){var t=o();t.write=s,a(c([t,new gpf.stream.LineAdapter]),e)}),it("Forward errors (second read - reject)",function(e){var n=o(),r=o();r.read=t,i(c([n,r,new gpf.stream.LineAdapter]),e)}),it("Forward errors (second read - exception)",function(e){var t=o(),r=o();r.read=n,a(c([t,r,new gpf.stream.LineAdapter]),e)}),it("Forward errors (second write - reject)",function(e){var t=o(),n=o();n.write=r,i(c([t,n,new gpf.stream.LineAdapter]),e)}),it("Forward errors (second write - exception)",function(e){var t=o(),n=o();n.write=s,a(c([t,n,new gpf.stream.LineAdapter]),e)})})}),describe("stream/csv/parser",function(){describe("gpf.stream.csv.Parser",function(){function e(e){var t=new gpf.stream.ReadableArray(e.lines),n=new gpf.stream.WritableArray;return gpf.stream.pipe(t,e.parser,n).then(function(){return n.toArray()})}function t(t,n){e(t).then(function(e){assert(e.length===t.expected.length),e.forEach(function(e,n){var r=t.expected[n],s=Object.keys(e);assert(s.join(",")===Object.keys(r).join(",")),s.forEach(function(t){assert(e[t]===r[t])})}),n()})["catch"](n)}it("reads a one-column CSV file",function(e){t({lines:["LINE","0","1"],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0"},{LINE:"1"}]},e)}),it("reads a CSV file",function(e){t({lines:["LINE;VALUE","0;ABC","1;DEF"],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0",VALUE:"ABC"},{LINE:"1",VALUE:"DEF"}]},e)}),it("supports value quoting",function(e){t({lines:["LINE;VALUE",'0;"ABC"',"1;DEF",'2;GH"I','3;"JK""L"','4;"MN','O"'],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0",VALUE:"ABC"},{LINE:"1",VALUE:"DEF"},{LINE:"2",VALUE:'GH"I'},{LINE:"3",VALUE:'JK"L'},{LINE:"4",VALUE:"MN\nO"}]},e)}),it("supports quoting the separator as well",function(e){t({lines:["LINE;VALUE",'0;"A;BC"'],parser:new gpf.stream.csv.Parser,expected:[{LINE:"0",VALUE:"A;BC"}]},e)}),it("supports header being specified as an option",function(e){t({lines:["0;ABC","1;DEF"],parser:new gpf.stream.csv.Parser({header:"LINE;VALUE"}),expected:[{LINE:"0",VALUE:"ABC"},{LINE:"1",VALUE:"DEF"}]},e)}),it("supports empty values",function(e){t({lines:["LINE;VALUE;VALUE2",";AB;CD","1;;EF","2;GH"],parser:new gpf.stream.csv.Parser,expected:[{LINE:"",VALUE:"AB",VALUE2:"CD"},{LINE:"1",VALUE:"",VALUE2:"EF"},{LINE:"2",VALUE:"GH"}]},e)}),it("detects unterminated quoted string",function(t){e({lines:["LINE;VALUE",'0;"A',"BC"],parser:new gpf.stream.csv.Parser}).then(function(){t(new Error("Should fail"))},function(e){assert(e instanceof gpf.Error.InvalidCSV),t()})["catch"](t)}),it("detects invalid quoted string",function(t){e({lines:["LINE;VALUE",'0;"A"BC"'],parser:new gpf.stream.csv.Parser}).then(function(){t(new Error("Should fail"))},function(e){assert(e instanceof gpf.Error.InvalidCSV),t()})["catch"](t)}),it("supports different separator, quote and new line specifiers",function(e){t({lines:["LINE\tVALUE\tVALUE2","0\t\t'A''B","\tC'"],parser:new gpf.stream.csv.Parser({separator:"\t",quote:"'",newLine:"\r\n"}),expected:[{LINE:"0",VALUE:"",VALUE2:"A'B\r\n\tC"}]},e)})})}),describe("define/class/attributes/check",function(){var e=gpf.define({$class:"MyAttribute",$extend:"gpf.attributes.Attribute",_value:undefined,getValue:function(){return this._value},constructor:function(e){this._value=e}});describe("attributes validation",function(){it("allows only existing members",function(){var e;try{gpf.define({$class:"Test1","[t3st]":[],test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.UnknownAttributesSpecification)}),it("allows only an array (of attributes) - member",function(){var e;try{gpf.define({$class:"Test1","[test]":{},test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidAttributesSpecification)}),it("allows only an array (of attributes) - class",function(){var e;try{gpf.define({$class:"Test1",$attributes:{},test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidAttributesSpecification)}),it("allows only an array of attributes - member",function(){var e;try{gpf.define({$class:"Test1","[test]":[{}],test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidAttributesSpecification)}),it("allows only an array of attributes - class",function(){var e;try{gpf.define({$class:"Test1",$attributes:[{}],test:0})}catch(e_){e=e_}assert(e instanceof gpf.Error.InvalidAttributesSpecification)})}),describe("attributes definition",function(){it("does not expose new members",function(){var t=gpf.define({$class:"MyClassWithAttributes",$attributes:[new e("class")],"[test]":[new e("member")],test:0});assert(undefined===t.prototype["[test]"])})})}),describe("attributes",function(){var e,t={$extend:"gpf.attributes.Attribute",_value:undefined,getValue:function(){return this._value},constructor:function(e){this._value=e}},n=gpf.define(Object.assign({$class:"MyAttribute1"},t)),r=gpf.define(Object.assign({$class:"MyAttribute2"},t)),s=gpf.define({$class:"MyClassWithoutAttributes"}),i=gpf.define({$class:"MyClass",$attributes:[new n("A"),new n("B"),new r("C")],"[value]":[new n("D")],value:0}),a=gpf.define({$class:"MyClass",$extend:i,$attributes:[new n("E"),new r("F")],"[value]":[new r("G")],"[value2]":[new n("H")],value2:1});function o(){i.apply(this,arguments)}o.prototype=Object.create(i.prototype),Object.assign(o.prototype,{value3:2}),e=gpf.define({$class:"MyClass",$extend:o,$attributes:[new n("E"),new r("F")],"[value]":[new r("G")],"[value3]":[new n("I"),new n("J")],"[value2]":[new n("H")],value2:1}),describe("gpf.attributes.get",function(){it("returns an empty object if the class was not allocated by gpf.define",function(){var e=gpf.attributes.get(String);assert(0===Object.keys(e).length)}),it("returns an empty object if no attributes",function(){var e=gpf.attributes.get(s);assert(0===Object.keys(e).length)}),it("retrieves all attributes (on class)",function(){var e=gpf.attributes.get(i);assert(2===Object.keys(e).length),assert(3===e.$attributes.length),assert(1===e.value.length),assert("D"===e.value[0].getValue())}),it("retrieves all attributes (on instance)",function(){var e=new i,t=gpf.attributes.get(e);assert(2===Object.keys(t).length),assert(3===t.$attributes.length),assert(1===t.value.length),assert("D"===t.value[0].getValue())}),it("filters on a given attribute class",function(){var e=gpf.attributes.get(i,r);assert(1===Object.keys(e).length),assert(1===e.$attributes.length),assert("C"===e.$attributes[0].getValue())}),describe("with native inheritance",function(){it("retrieves all attributes (on class)",function(){var e=gpf.attributes.get(o);assert(2===Object.keys(e).length),assert(3===e.$attributes.length),assert(1===e.value.length),assert("D"===e.value[0].getValue())}),describe("and then with GPF inheritance",function(){var e=gpf.attributes.get(o);assert(2===Object.keys(e).length),assert(3===e.$attributes.length),assert(1===e.value.length),assert("D"===e.value[0].getValue())}),describe("followed by GPF inheritance",function(){it("retrieves all attributes (on class)",function(){var t=gpf.attributes.get(e);assert(4===Object.keys(t).length),assert(5===t.$attributes.length),assert(2===t.value.length),assert(2===t.value3.length),assert("H"===t.value2[0].getValue())})})}),describe("with GPF inheritance",function(){it("retrieves all attributes (on class)",function(){var e=gpf.attributes.get(a);assert(3===Object.keys(e).length),assert(5===e.$attributes.length),assert(2===e.value.length),assert("H"===e.value2[0].getValue())}),it("filters on a given attribute class",function(){var e=gpf.attributes.get(a,n);assert(3===Object.keys(e).length),assert(3===e.$attributes.length),assert("H"===e.value2[0].getValue())})})})}),describe("stream/filter",function(){var e=[{id:0,num:5,str:"e",group:1,search:"first"},{id:1,num:1,str:"b",group:0,search:"second"},{id:2,num:4,str:"a",group:1,search:"third"},{id:3,num:2,str:"d",group:0,search:"fourth"},{id:4,num:3,str:"c",group:1,search:"fifth"}];function t(t,n,r){var s=new gpf.stream.ReadableArray(e),i=new gpf.stream.Filter(t),a=new gpf.stream.WritableArray;gpf.stream.pipe(s,i,a).then(function(){var e,t;e=a.toArray(),t=n,assert(e.length===t.length),assert(e.every(function(e,n){return e.id===t[n]})),r()})["catch"](r)}describe("gpf.stream.Filter",function(){it("forwards errors",function(t){var n=new gpf.stream.ReadableArray(e),r=new gpf.stream.Filter(function(){return!0}),s={write:function(e){return Promise.reject("KO")}};gpf.stream.pipe(n,r,s).then(function(){throw new Error("Not expected")},function(e){assert("KO"===e),t()})["catch"](t)}),it("filters data - no result",function(e){t(function(){return!1},[],e)}),it("filters data - one result",function(e){t(function(e){return 1===e.num},[1],e)}),it("filters data - several results",function(e){t(function(e){return 1===e.group},[0,2,4],e)}),it("filters data - all results",function(e){t(function(){return!0},[0,1,2,3,4],e)})})}),describe("stream/map",function(){var e=[{id:0},{id:1},{id:2},{id:3},{id:4}];function t(t,n,r){var s=new gpf.stream.ReadableArray(e),i=new gpf.stream.Map(t),a=new gpf.stream.WritableArray;gpf.stream.pipe(s,i,a).then(function(){var e,t;e=a.toArray(),t=n,assert(e.length===t.length),assert(e.every(function(e,n){return e===t[n]})),r()})["catch"](r)}function n(e){return e}describe("gpf.stream.Map",function(){it("forwards errors",function(t){var r=new gpf.stream.ReadableArray(e),s=new gpf.stream.Map(n),i={write:function(e){return n(e),Promise.reject("KO")}};gpf.stream.pipe(r,s,i).then(function(){throw new Error("Not expected")},function(e){assert("KO"===e),t()})["catch"](t)}),it("maps data - identity",function(r){t(n,e,r)}),it("filters data - one substitution",function(n){var r={};function s(e){return 2===e.id?r:e}t(s,e.map(s),n)}),it("filters data - several substitutions",function(e){t(function(e){return e.id},[0,1,2,3,4],e)})})});