<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>GPF release</title>
		<style type="text/css">

body {
	font-size: 10pt;
	font-family: Verdana, Courrier, Sans Serif;
	background-color: white;
	color: black;
	background-image: url();
	background-repeat: no-repeat;
	background-position: center;
}

span.comment {
	color: darkgreen;
	font-style: italic;
}

span.keyword {
	font-weight: bold;
}

span.string {
	color: darkred;
}

span.symbol {
	color: gray;
}

span.unknown {
	color: red;
	font-weight: bold;
	font-size: 20;
}

span.pos {
	color: magenta;
	font-size: 8;
}

span.parsing {
	color: red;
	font-size: 10;
}

		</style>
		<script language="javascript" src="debug.js"></script>
		<script language="javascript" src="rewriter.js"></script>
		<script language="javascript">

function waitForGPF()
{
	if( !gpf.loaded() )
	{
		console.log( "GPF not loaded yet..." );
		window.setTimeout( waitForGPF, 100 );
		return;
	}
	console.log( "GPF loaded." );
	loaded();
}

/* expected interface
		init
		onTokenFound
		shutdown
		uri
*/

var
	tokenizer = {

		pre: null,
		fullSize: 0,
		reducedSize: 0,

		src: rewriter,

		init: function() {
			this.pre = document.getElementById( "result" );
			this.src.include( "var gpf={loaded:function(){return true;}};" );
		},

		_add: function( tagName, className, text ) {

			var tag = document.createElement( tagName );
			if( className ) tag.className = className;
			if( text ) tag.appendChild( document.createTextNode( text ) );
			this.pre.appendChild( tag );

		},

		onTokenFound: function( type, token, context ) {

			var pos = context.line + "," + context.column + "-" + context.pos;
			if( "error" === type ) {
				alert( "@(" + pos + "): " + token ); 
				return true;
			}

			this.fullSize += token.length;

			/* Syntax highlighting */
			var tag;
/*
			if( "space" !== type ) this._add( "span", "pos", pos );
*/
			this._add( "span", type, ( "\t" === token ) ? "  " : token );

			/* Code rewriting */
			var state = this.src.state();
			var brackets = this.src.brackets();
			var stackSize = this.src.stackSize();
			this.src.process( type, token );
			if( -1 === this.src.state() ) {

				alert( "@(" + pos + "): code rewriter error (" + previousState + ", " + type + ", " + token +")" );
				return true;

			} else {

				var trace = this.src.trace();
				if( trace ) this._add( "span", "parsing", trace );
				if( stackSize != this.src.stackSize() ) this._add( "span", "parsing", stackSize > this.src.stackSize() ? "<<" : ">>" );
				if( state !== this.src.state() ) this._add( "span", "parsing", "(" + this.src.state() + ")" );
				if( brackets !== this.src.brackets() ) this._add( "span", "parsing", "[" + this.src.brackets() + "]" );
			}

			return false;

		},

		shutdown: function() {
		},

		uri: function() {

			/*
				Base 64 needs 6 bits per result char.
				Each source char is represented over 8 bits (considering ASCII).
				Hence, 1 char needs 8 bits = 1 result char + 2 bits
				2 char needs 2 results chars + 4 bits
				3 char needs 3 result chars + 6 bits = 4 result chars

				Process the string by group of 3 chars
			*/

			var
				src = this.src.read(),
				len = src.length,
				idx = Math.floor( ( len + 2 ) / 3 ),
				res = [ "data:text/plain;base64," ],
				offset = 0,
				a, b, c;
			this.reducedSize = len;
			while( idx-- > 0 ) {
				a = src.charCodeAt( offset++ );
				b = offset < len ? src.charCodeAt( offset++ ) : 32;
				c = offset < len ? src.charCodeAt( offset++ ) : 32;
				res.push( gpf.toBase64( ( a * 256 + b ) * 256 + c, 3 ) );
			}
//			alert( offset + " " + len + " : " + a + ", " + b + ", " + c + " => " + res[ res.length - 1 ] );
			return res.join( "" );

		}

	}
;

function loaded()
{
	var
		sources = gpf.sources().split( "," ),
		sourcesIdx = 0,
		sourcesFiles = {},
		sourceName;
	while( sourcesIdx < sources.length )
	{
		sourceName = sources[ sourcesIdx ];
		try
		{
			sourcesFiles[ sourceName ] = gpf.load( sourceName + ".js", "text/plain" );
		}
		catch(e)
		{
			alert( e.message );
		}
		++sourcesIdx;
	}

	console.log( "done." );
	var handler = tokenizer;
	handler.init();
	sourcesIdx = 0;
	var context = undefined;
	while( sourcesIdx < sources.length )
	{
		sourceName = sources[ sourcesIdx ]; 
		context = gpf.tokenizeEx.apply( handler, [ sourcesFiles[ sourceName ], handler.onTokenFound, context ] );
		++sourcesIdx;
	}
	// Finish tokenizing
	gpf.tokenizeEx.apply( handler, [ null, handler.onTokenFound, context ] );
	handler.shutdown();

	var uri = handler.uri();
	if( uri )
	{
		var a = document.createElement( "a" );
		a.setAttribute( "href", uri, "blank" );
		a.innerHTML = "Click here and use save as ("
			+ handler.reducedSize + "/" + handler.fullSize + ": "
			+ ( Math.floor( 10000 * handler.reducedSize / handler.fullSize ) / 100 )
			+ "%)";
		document.body.insertBefore( a, document.body.firstChild );
	}
}

		</script>
	</head>
	<body onload="waitForGPF()">
		<PRE id="result"></PRE>
	</body>
</html>
