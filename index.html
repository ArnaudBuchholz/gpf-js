<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>GPF-JS</title>
        <link rel="stylesheet" type="text/css" href="res/html.css">
        <link rel="stylesheet" type="text/css" href="res/tiles.css">
        <script language="JavaScript" src="res/xhr.js"></script>
        <script language="JavaScript" src="res/tpl.js"></script>
        <script language="JavaScript">

function onLoad () {
    var tplFactory = document.getElementById("tile").buildFactory(),
        tiles = document.getElementById("tiles");

    function tile (id) {
        var args = arguments,
            object = {};
        ["id", "link", "title"].forEach(function (name, index) {
            object[name] = args[index];
        });
        tiles.appendChild(tplFactory(object));
        return document.getElementById(id);
    }

    function testTile () {
        var node = tile.apply(this, arguments);
        var ul = node.appendChild(document.createElement("ul"));
        function version (link, label) {
            var versionNode = ul.appendChild(document.createElement("li"));
            versionNode.setAttribute("link", link);
            versionNode.appendChild(document.createTextNode(label));
        }
        version(arguments[1], "sources");
        version(arguments[3], "debug");
        version(arguments[4], "release");
        return node;
    }

    tile("sources", "sources.html", "Sources");
    testTile("mocha", "test/host/mocha/web.html", "Mocha",
        "test/host/mocha/web_debug.html",
        "test/host/mocha/web_release.html");
    testTile("tests", "test/host/web.html", "Tests",
        "test/host/web.html?debug",
        "test/host/web.html?release");
    tile("plato", "tmp/plato/index.html", "Plato report");
    tile("coverage", "tmp/coverage/reports/lcov-report/index.html", "Code coverage");
    tile("tpl", "test/host/mocha/tpl.html", "Simple template library");

    xhr("tmp/plato/report.json").get().then(function (reportText) {
        var reportData = JSON.parse(reportText),
            maintainability = reportData.summary.average.maintainability,
            div = document.createElement("div");
        div.className = "percentage";
        if (maintainability < 70) {
            div.className += " ko";
        } else {
            div.className += " ok";
        }
        div.innerHTML = maintainability;
        document.getElementById("plato").appendChild(div);
    });

    xhr("src/sources.json").get().then(function (sourcesText) {
        var sources = JSON.parse(sourcesText),
            loaded = sources.filter(function (source) {
                    return source.load !== false;
                }).length,
            div = document.createElement("div");
        div.className = "percentage";
        div.innerHTML = "" + loaded + "/" + sources.length;
        document.getElementById("sources").appendChild(div);
    });

    document.addEventListener("click", function (event) {
        var li = event.target;
        while (li && li.tagName && li.tagName.toLowerCase() !== "li") {
            li = li.parentNode;
        }
        link = li && li.getAttribute && li.getAttribute("link");
        if (link) {
            window.open(link);
        }
    });
}

        </script>
    </head>
    <body onload="onLoad()">
        <ul id="tiles">
        </ul>
        <template id="tile">
            <li id="{{id}}" link="{{link}}">
                <div class="title">{{title}}</div>
            </li>
        </template>
    </body>
</html>
