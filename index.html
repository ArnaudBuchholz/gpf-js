<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>GPF-JS</title>
        <link rel="stylesheet" type="text/css" href="res/html.css">
        <link rel="stylesheet" type="text/css" href="res/tiles.css">
        <script language="JavaScript" src="res/xhr.js"></script>
        <script language="JavaScript" src="res/tpl.js"></script>
        <script language="JavaScript" src="make/coverage.js"></script>
        <script language="JavaScript">

function onLoad () {
    "use strict";

    var tileFactory = document.getElementById("tile").buildFactory(),
        execFactory = document.getElementById("exec").buildFactory(),
        tiles = document.getElementById("tiles");

    function tile (id) {
        var args = arguments,
            object = {};
        ["id", "link", "title"].forEach(function (name, index) {
            object[name] = args[index];
        });
        tiles.appendChild(tileFactory(object));
        return document.getElementById(id);
    }

    tile("sources", "sources.html", "Sources");
    xhr("src/sources.json").get().asJson().then(function (sources) {
        var loaded = sources.filter(function (source) {
                return source.load !== false;
            }).length,
            div = document.createElement("div");
        div.className = "percentage";
        div.innerHTML = "" + loaded + "/" + sources.length;
        document.getElementById("sources").appendChild(div);
    });

    tile("plato", "tmp/plato/index.html", "Plato report")
        .appendChild(execFactory({grunt: "plato"}));
    xhr("tmp/plato/report.json").get().asJson().then(function (reportData) {
        var maintainability = reportData.summary.average.maintainability,
            div = document.createElement("div");
        div.className = "percentage";
        if (maintainability < 70) {
            div.className += " ko";
        } else {
            div.className += " ok";
        }
        div.innerHTML = maintainability;
        document.getElementById("plato").appendChild(div);
    });

    tile("coverage", "tmp/coverage/reports/lcov-report/index.html", "Code coverage");
    xhr("tmp/coverage/reports/coverage.json").get().asJson().then(function (coverageData) {
        var report = new CoverageReport(coverageData),
            global = report.getGlobal();

        function addCoverage (type) {
            var ratio = global[type].getCoverageRatio(),
                div = document.createElement("div");
            div.className = "coverage " + type;
            if (ratio < 90) {
                div.className += " ko";
            } else {
                div.className += " ok";
            }
            div.innerHTML = ratio + "%";
            document.getElementById("coverage").appendChild(div);
        }

        addCoverage("statements");
        addCoverage("functions");
        addCoverage("branches");
    });

    tile("tests", "test/host/web.html", "Tests")
        .appendChild(document.getElementById("tests-details").buildFactory()());

    tile("env", "", "Environments")
        .appendChild(document.getElementById("env-details").buildFactory()());
    xhr("selenium.json").get().asJson().then(function (browserList) {
        var envNames = document.getElementById("envNames"),
            envItemFactory = document.getElementById("env-item").buildFactory();
        browserList.concat([
            "node",
            "phantom",
            "wscript",
            "rhino"
        ]).forEach(function (name) {
            envNames.appendChild(envItemFactory({
                name: name
            }));
        })
    });


    tile("tpl", "test/host/mocha/tpl.html", "Template tests");

    tile("doc", "tmp/docs/index.html", "Documentation")
        .appendChild(execFactory({grunt: "jsdoc"}));

    document.addEventListener("click", function (event) {
        var li = event.target,
            link;
        while (li && !(link = li.getAttribute && li.getAttribute("link"))) {
            li = li.parentNode;
        }
        if (link) {
            window.open(link);
        }
    });
}

        </script>
    </head>
    <body onload="onLoad()">
        <ul id="tiles">
        </ul>
        <template id="tile">
            <li id="{{id}}" link="{{link}}">
                <div class="title">{{title}}</div>
            </li>
        </template>
        <template id="exec">
            <div class="exec" link="grunt/{{grunt}}"></div>
        </template>
        <template id="tests-details">
            <ul>
                <li>
                    <span class="version" link="test/host/web.html">sources</span>
                    <span class="mocha" link="test/host/mocha/web.html">mocha</span>
                </li>
                <li>
                    <span class="version" link="test/host/web.html?debug">debug</span>
                    <span class="mocha" link="test/host/mocha/web_debug.html">mocha</span>
                </li>
                <li>
                    <span class="version" link="test/host/web.html?release">release</span>
                    <span class="mocha" link="test/host/mocha/web_release.html">mocha</span>
                </li>
            </ul>
        </template>
        <template id="env-details">
            <div>
                <select id="envVersion">
                    <option label="source"></option>
                    <option label="debug"></option>
                    <option label="release"></option>
                </select>
                <ul id="envNames">
                </ul>
            </div>
        </template>
        <template id="env-item">
            <li>{{name}}</li>
        </template>
    </body>
</html>
