<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>GPF-JS</title>
        <link rel="stylesheet" type="text/css" href="res/html.css">
        <link rel="stylesheet" type="text/css" href="res/tiles.css">
        <script language="JavaScript" src="res/xhr.js"></script>
        <script language="JavaScript" src="res/tpl.js"></script>
        <script language="JavaScript" src="make/coverage.js"></script>
        <script language="JavaScript">

function onLoad () {
    "use strict";

    var tileFactory = document.getElementById("tile").buildFactory(),
        execFactory = document.getElementById("exec").buildFactory(),
        tiles = document.getElementById("tiles"),
        metrics;

    // Generate a tile
    function tile (id, title) {
        tiles.appendChild(tileFactory({
            id: id,
            title: title
        }));
        return document.getElementById(id);
    }

    // Refresh tiles, each tile requiring refresh must adds a method to this function corresponding to the tile id
    function refresh () {
        [].slice.call(document.querySelectorAll("ul#tiles > li"))
            .forEach(function (tile) {
                var method = tile.id;
                if (refresh[method]) {
                    refresh[method](tile);
                }
            });
    }

    // Remove the provided list of nodes
    function remove (nodes) {
        if (nodes) {
            [].slice.call(nodes).forEach(function (node) {
                node.parentNode.removeChild(node);
            });
        }
    }

    // Generate a div tag with content, classes and a link
    function div (content, className, link) {
        var div = document.createElement("div");
        div.innerHTML = content;
        div.className = className;
        div.setAttribute("link", link);
        return div;
    }

    tile("sources", "Sources")
        .appendChild(execFactory({grunt: "make", title: "Make"}));
    refresh.sources = function (tile) {
        remove(tile.querySelectorAll("div.percentage"));
        xhr("src/sources.json").get().asJson().then(function (sources) {
            var loaded = sources.filter(function (source) {
                    return source.load !== false;
                }).length;
            tile.appendChild(div("" + loaded + "/" + sources.length, "percentage", "sources.html"));
        });
    };

    tile("plato", "Plato report")
        .appendChild(execFactory({grunt: "plato", title: "Execute plato"}));
    refresh.plato = function (tile) {
        remove(tile.querySelectorAll("div.percentage"));
        xhr("tmp/plato/report.json").get().asJson().then(function (reportData) {
            var maintainability = reportData.summary.average.maintainability,
                statusClassName;
            if (maintainability < metrics.maintainability) {
                statusClassName = "ko";
            } else {
                statusClassName = "ok";
            }
            tile.appendChild(div(maintainability, "percentage " + statusClassName, "tmp/plato/index.html"));
        });
    };

    tile("coverage", "Code coverage");
    refresh.coverage = function (tile) {
        remove(tile.querySelectorAll("div.coverage"));
        xhr("tmp/coverage/reports/coverage.json").get().asJson().then(function (coverageData) {
            var report = new CoverageReport(coverageData),
                global = report.getGlobal();

            function addCoverage (type) {
                var ratio = global[type].getCoverageRatio(),
                    statusClassName;
                if (ratio < metrics.coverage[type]) {
                    statusClassName = "ko";
                } else {
                    statusClassName = "ok";
                }
                if (100 === ratio) {
                    ratio = "100.0"
                }
                tile.appendChild(div(ratio + "%", "coverage " + type + " " + statusClassName,
                    "tmp/coverage/reports/lcov-report/index.html"));
            }

            addCoverage("statements");
            addCoverage("functions");
            addCoverage("branches");
        });
    };

    tile("tests", "Tests")
        .appendChild(document.getElementById("tests-details").buildFactory()());

    tile("env", "Environments")
        .appendChild(document.getElementById("env-details").buildFactory()());
    refresh.env = function (tile) {
        remove(tile.querySelectorAll("li[link]"));
        xhr("tmp/selenium.json").get().asJson()
            .then(undefined, function () {
                return [];
            })
            .then(function (browserList) {
                var envNames = document.getElementById("envNames"),
                    envItemFactory = document.getElementById("env-item").buildFactory();
                browserList.concat([
                    "node",
                    "phantom",
                    "wscript",
                    "rhino"
                ]).forEach(function (name) {
                    envNames.appendChild(envItemFactory({
                        name: name
                    }));
                })
            });
    };

    tile("doc", "Documentation")
        .appendChild(execFactory({grunt: "jsdoc:private", title: "Generate documentation"}));
    refresh.doc = function (tile) {
        remove(tile.querySelectorAll("div.version"));
        xhr("/package.json").get().asJson()
            .then(function (packageJson) {
                tile.appendChild(div(packageJson.version, "version", "tmp/doc/private/index.html"));
            });
    };

    tile("misc", "Miscellaneous")
        .appendChild(document.getElementById("other-items").buildFactory()());

    document.addEventListener("click", function (event) {
        var target = event.target,
            link;
        while (target && !(link = target.getAttribute && target.getAttribute("link"))) {
            target = target.parentNode;
        }
        if ("env" === link) {
            var versionSelect = document.getElementById("envVersion"),
                version = versionSelect.options[versionSelect.selectedIndex].value,
                envName = target.innerHTML;
            link = "grunt/exec:test" + envName.charAt(0).toUpperCase() + envName.substr(1) + version;
        }
        if (link) {
            window.open(link);
        }
    });

    xhr("make/metrics.json").get().asJson().then(function (metricsData) {
        metrics = metricsData;
        refresh();
    });

    window.onpopstate = refresh;

}

        </script>
    </head>
    <body onload="onLoad()">
        <ul id="tiles">
        </ul>
        <template id="tile">
            <li id="{{id}}">
                <div class="title">{{title}}</div>
            </li>
        </template>
        <template id="exec">
            <div class="exec" link="grunt/{{grunt}}" title="{{title}}"></div>
        </template>
        <template id="tests-details">
            <ul>
                <li>
                    <span class="version" link="test/host/web.html">sources</span>
                    <span class="mocha" link="test/host/mocha/web.html">mocha</span>
                </li>
                <li>
                    <span class="version" link="test/host/web.html?debug">debug</span>
                    <span class="mocha" link="test/host/mocha/web_debug.html">mocha</span>
                </li>
                <li>
                    <span class="version" link="test/host/web.html?release">release</span>
                    <span class="mocha" link="test/host/mocha/web_release.html">mocha</span>
                </li>
            </ul>
        </template>
        <template id="env-details">
            <div>
                <label for="envVersion">Version: </label>
                <select id="envVersion">
                    <option value="Verbose">source</option>
                    <option value="Debug">debug</option>
                    <option value="Release">release</option>
                </select>
                <ul id="envNames">
                </ul>
            </div>
            <div class="exec" link="grunt/exec:detectSelenium" title="Detect selenium"></div>
        </template>
        <template id="env-item">
            <li id="env-{{name}}" link="env">{{name}}</li>
        </template>
        <template id="other-items">
            <ul>
                <li link="test/host/mocha/tpl.html">Template tests</li>
                <li link="grunt/exec:jsdoc:src/compatibility/date.js">JSDoc plugin test</li>
            </ul>
        </template>
    </body>
</html>
