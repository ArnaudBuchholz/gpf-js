<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>GPF-JS</title>
        <link rel="stylesheet" type="text/css" href="res/html.css">
        <link rel="stylesheet" type="text/css" href="res/tiles.css">
        <script language="JavaScript" src="res/xhr.js"></script>
        <script language="JavaScript" src="res/tpl.js"></script>
        <script language="JavaScript" src="make/coverage.js"></script>
        <script language="JavaScript">

function onLoad () {
    "use strict";

    var tileFactory = document.getElementById("tile").buildFactory(),
        execFactory = document.getElementById("exec").buildFactory(),
        tiles = document.getElementById("tiles");

    function tile (id) {
        var args = arguments,
            object = {},
            node;
        ["id", "link", "title"].forEach(function (name, index) {
            object[name] = args[index];
        });
        tiles.appendChild(tileFactory(object));
        node = document.getElementById(id);
        if (!object.link) {
            node.removeAttribute("link");
        }
        return node;
    }

    function refresh () {
        [].slice.call(document.querySelectorAll("ul#tiles > li"))
            .forEach(function (tile) {
                var method = tile.id;
                if (refresh[method]) {
                    refresh[method](tile);
                }
            });
    }

    function remove (nodes) {
        if (nodes) {
            [].slice.call(nodes).forEach(function (node) {
                node.parentNode.removeChild(node);
            });
        }
    }

    tile("sources", "sources.html", "Sources");
    refresh.sources = function (tile) {
        remove(tile.querySelectorAll("div.percentage"));
        xhr("src/sources.json").get().asJson().then(function (sources) {
            var loaded = sources.filter(function (source) {
                    return source.load !== false;
                }).length,
                div = document.createElement("div");
            div.className = "percentage";
            div.innerHTML = "" + loaded + "/" + sources.length;
            tile.appendChild(div);
        });
    };

    tile("plato", "tmp/plato/index.html", "Plato report")
        .appendChild(execFactory({grunt: "plato", title: "Execute plato"}));
    refresh.plato = function (tile) {
        remove(tile.querySelectorAll("div.percentage"));
        xhr("tmp/plato/report.json").get().asJson().then(function (reportData) {
            var maintainability = reportData.summary.average.maintainability,
                div = document.createElement("div");
            div.className = "percentage";
            if (maintainability < 70) {
                div.className += " ko";
            } else {
                div.className += " ok";
            }
            div.innerHTML = maintainability;
            tile.appendChild(div);
        });
    };

    tile("coverage", "tmp/coverage/reports/lcov-report/index.html", "Code coverage");
    refresh.coverage = function (tile) {
        remove(tile.querySelectorAll("div.coverage"));
        xhr("tmp/coverage/reports/coverage.json").get().asJson().then(function (coverageData) {
            var report = new CoverageReport(coverageData),
                global = report.getGlobal();

            function addCoverage (type) {
                var ratio = global[type].getCoverageRatio(),
                    div = document.createElement("div");
                div.className = "coverage " + type;
                if (ratio < 90) {
                    div.className += " ko";
                } else {
                    div.className += " ok";
                }
                div.innerHTML = ratio + "%";
                document.getElementById("coverage").appendChild(div);
            }

            addCoverage("statements");
            addCoverage("functions");
            addCoverage("branches");
        });
    };

    tile("tests", "", "Tests")
        .appendChild(document.getElementById("tests-details").buildFactory()());

    tile("env", "", "Environments")
        .appendChild(document.getElementById("env-details").buildFactory()());
    refresh.env = function (tile) {
        remove(tile.querySelector("li[link]"));
        xhr("tmp/selenium.json").get().asJson()
            .then(undefined, function () {
                return [];
            })
            .then(function (browserList) {
                var envNames = document.getElementById("envNames"),
                    envItemFactory = document.getElementById("env-item").buildFactory();
                browserList.concat([
                    "node",
                    "phantom",
                    "wscript",
                    "rhino"
                ]).forEach(function (name) {
                    envNames.appendChild(envItemFactory({
                        name: name
                    }));
                })
            });
    };

    tile("tpl", "test/host/mocha/tpl.html", "Template tests");

    tile("doc", "tmp/docs/index.html", "Documentation")
        .appendChild(execFactory({grunt: "jsdoc"}));

    document.addEventListener("click", function (event) {
        var target = event.target,
            link;
        while (target && !(link = target.getAttribute && target.getAttribute("link"))) {
            target = target.parentNode;
        }
        if ("env" === link) {
            var versionSelect = document.getElementById("envVersion"),
                version = versionSelect.options[versionSelect.selectedIndex].value,
                envName = target.innerHTML;
            link = "grunt/exec:test" + envName.charAt(0).toUpperCase() + envName.substr(1) + version;
        }
        if (link) {
            window.open(link);
        }
    });
    refresh();
}

        </script>
    </head>
    <body onload="onLoad()">
        <ul id="tiles">
        </ul>
        <template id="tile">
            <li id="{{id}}" link="{{link}}">
                <div class="title">{{title}}</div>
            </li>
        </template>
        <template id="exec">
            <div class="exec" link="grunt/{{grunt}}" title="{{title}}"></div>
        </template>
        <template id="tests-details">
            <ul>
                <li>
                    <span class="version" link="test/host/web.html">sources</span>
                    <span class="mocha" link="test/host/mocha/web.html">mocha</span>
                </li>
                <li>
                    <span class="version" link="test/host/web.html?debug">debug</span>
                    <span class="mocha" link="test/host/mocha/web_debug.html">mocha</span>
                </li>
                <li>
                    <span class="version" link="test/host/web.html?release">release</span>
                    <span class="mocha" link="test/host/mocha/web_release.html">mocha</span>
                </li>
            </ul>
        </template>
        <template id="env-details">
            <div>
                <label for="envVersion">Version: </label>
                <select id="envVersion">
                    <option value="Verbose">source</option>
                    <option value="Debug">debug</option>
                    <option value="Release">release</option>
                </select>
                <ul id="envNames">
                </ul>
            </div>
            <div class="exec" link="grunt/exec:detectSelenium" title="Detect selenium"></div>
        </template>
        <template id="env-item">
            <li id="env-{{name}}" link="env">{{name}}</li>
        </template>
    </body>
</html>
