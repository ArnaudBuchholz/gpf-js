<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>GPF-JS</title>
        <link rel="stylesheet" type="text/css" href="res/html.css">
        <link rel="stylesheet" type="text/css" href="res/tiles/styles.css">
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script language="JavaScript" src="res/xhr.js"></script>
        <script language="JavaScript" src="res/tpl.js"></script>
        <script language="JavaScript" src="make/coverage.js"></script>
        <script language="JavaScript">

function onLoad () {
    "use strict";

    google.charts.load("current", {"packages":["corechart"]});
    google.charts.setOnLoadCallback(function () {
        xhr("build/releases.json").get().asJson()
            .then(function (releases) {
                var data = google.visualization.arrayToDataTable([
                    [
                        "Release",
                        "maintainability",
                        "coverage (statements)",
                        "coverage (branches)",
                        "coverage (functions)",
                        "tests count",
                        "sources count"
                    ]
                ].concat(releases.map(function (release) {
                    var oReleaseDateParts = release.date.split("-").map(function(value) {
                        return parseInt(value, 10);
                    });
                    return [
                        new Date(oReleaseDateParts[0], oReleaseDateParts[1] - 1, oReleaseDateParts[2]),
                        release.metrics.maintainability,
                        release.metrics.coverage.statements.total,
                        release.metrics.coverage.branches.total,
                        release.metrics.coverage.functions.total,
                        release.metrics.tests,
                        release.metrics.sources
                    ];
                })));
                var options = {
                    backgroundColor: {
                        fill: "transparent"
                    },
                    curveType: "function",
                    title : "Releases",
                    series: {
                        0: {targetAxisIndex: 0},
                        1: {targetAxisIndex: 0},
                        2: {targetAxisIndex: 0},
                        3: {targetAxisIndex: 0},
                        4: {targetAxisIndex: 1},
                        5: {targetAxisIndex: 1, type: "bars"}
                    },
                    vAxes: {
                        0: {title: "Ratio (%)"},
                        1: {title: "Count"}
                    },
                    vAxis: {
                        0: {
                           viewWindow: {
                               max: 100
                           }
                        }
                    },
                    hAxis: {title: "Release date"},
                    seriesType: "lines"
                };
                var chart = new google.visualization.ComboChart(document.getElementById("chart"));
                chart.draw(data, options);
            })
    });

    var tileFactory = document.getElementById("tile").buildFactory(),
        execFactory = document.getElementById("exec").buildFactory(),
        tiles = document.getElementById("tiles"),
        metrics;

    // Generate a tile
    function tile (id, title) {
        tiles.appendChild(tileFactory({
            id: id,
            title: title
        }));
        return document.getElementById(id);
    }

    // Refresh tiles, each tile requiring refresh must adds a method to this function corresponding to the tile id
    function refresh () {
        [].slice.call(document.querySelectorAll("ul#tiles > li"))
            .forEach(function (tile) {
                var method = tile.id;
                if (refresh[method]) {
                    refresh[method](tile);
                }
            });
    }

    // Remove the provided list of nodes
    function remove (nodes) {
        if (nodes) {
            [].slice.call(nodes).forEach(function (node) {
                node.parentNode.removeChild(node);
            });
        }
    }

    // Generate a div tag with content, classes and a link
    function div (content, className, link) {
        var div = document.createElement("div");
        div.innerHTML = content;
        div.className = className;
        div.setAttribute("link", link);
        return div;
    }

    tile("github", "GitHub")
        .appendChild(document.getElementById("github-details").buildFactory()());
    refresh.github = function (tile) {
        remove(tile.querySelectorAll("div.dynamic"));
        xhr("/github/").get().asJson()
            .then(function (status) {
                if (status.error) {
                    var flag = tile.appendChild(div("", "dynamic error", "javascript:alert('link to doc')"));
                    flag.title = status.error;
                } else {
                    var flag = tile.appendChild(div("", "dynamic connected", status.profile.html_url));
                    flag.title = status.profile.name;
                }
            });
    }

    document.addEventListener("click", function (event) {
        var target = event.target,
            link;
        while (target && !(link = target.getAttribute && target.getAttribute("link"))) {
            target = target.parentNode;
        }
        if ("env" === link) {
            var versionSelect = document.getElementById("envVersion"),
                version = versionSelect.options[versionSelect.selectedIndex].value,
                envName = target.innerHTML;
            link = "grunt/exec:test" + envName.charAt(0).toUpperCase() + envName.substr(1) + version;
        }
        if (link) {
            window.open(link);
        }
    });

    xhr("tmp/config.json").get().asJson().then(function (config) {
        metrics = config.metrics;
        refresh();
    });

    window.onpopstate = refresh;

}

        </script>
    </head>
    <body onload="onLoad()">
        <ul id="tiles">
        </ul>
        <div id="chart" style="width: 900px; height: 500px;"></div>
        <template id="tile">
            <li id="{{id}}">
                <div class="title">{{title}}</div>
            </li>
        </template>
        <template id="exec">
            <div class="exec" link="grunt/{{grunt}}" title="{{title}}"></div>
        </template>
        <template id="env-item">
            <li id="env-{{name}}" link="env">{{name}}</li>
        </template>
        <template id="github-details">
            <ul>
                <li link="https://github.com/ArnaudBuchholz/gpf-js/issues?q=is%3Aopen+is%3Aissue+no%3Amilestone">Backlog</li>
                <li link="https://github.com/ArnaudBuchholz/gpf-js/milestones">Milestones</li>
            </ul>
        </template>
    </body>
    <script language="JavaScript">gpfSourcesPath = "/src/";</script>
    <script language="JavaScript" src="/src/boot.js"></script>
    <script language="JavaScript">
        gpf.require.define({main: "/res/tiles/main.js"});
    </script>
</html>
